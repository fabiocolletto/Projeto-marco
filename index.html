<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marco ¬∑ AppBase + MiniApps</title>
    <style>
      :root {
        --bg-primary: #f6f8fc;
        --bg-secondary: #e8edfa;
        --bg-tertiary: #dfe4f6;
        --surface: rgba(255, 255, 255, 0.92);
        --surface-strong: rgba(255, 255, 255, 0.98);
        --surface-base: #ffffff;
        --surface-contrast: rgba(255, 255, 255, 0.86);
        --surface-soft: rgba(255, 255, 255, 0.6);
        --surface-alt: #f6f7ff;
        --accent: #4f6ef7;
        --accent-strong: #1d4ed8;
        --lavender: #7c3aed;
        --accent-surface-soft: rgba(79, 110, 247, 0.1);
        --accent-surface: rgba(79, 110, 247, 0.12);
        --accent-surface-strong: rgba(79, 110, 247, 0.18);
        --accent-border-soft: rgba(79, 110, 247, 0.2);
        --accent-border: rgba(79, 110, 247, 0.32);
        --accent-border-strong: rgba(79, 110, 247, 0.48);
        --accent-focus: rgba(79, 110, 247, 0.8);
        --accent-shadow: rgba(79, 110, 247, 0.18);
        --success: #22c55e;
        --success-soft: rgba(34, 197, 94, 0.12);
        --success-border: rgba(34, 197, 94, 0.3);
        --success-glow: rgba(34, 197, 94, 0.3);
        --warning: #f59e0b;
        --warning-soft: rgba(245, 158, 11, 0.16);
        --warning-border: rgba(245, 158, 11, 0.3);
        --danger: #ef4444;
        --danger-soft: rgba(239, 68, 68, 0.12);
        --danger-border: rgba(239, 68, 68, 0.3);
        --text-primary: #1f2a44;
        --text-secondary: #5f6c8a;
        --border-color: rgba(187, 195, 216, 0.6);
        --border-muted: rgba(187, 195, 216, 0.4);
        --border-strong: rgba(99, 102, 241, 0.28);
        --neutral-border: rgba(148, 163, 184, 0.4);
        --neutral-border-strong: rgba(148, 163, 184, 0.6);
        --neutral-soft: rgba(148, 163, 184, 0.12);
        --neutral-surface: rgba(148, 163, 184, 0.08);
        --shadow-elevated: none;
        --shadow-base: rgba(31, 42, 68, 0.12);
        --shadow-strong: rgba(31, 42, 68, 0.2);
        --shadow-inset: rgba(15, 23, 42, 0.05);
        --status-gradient: linear-gradient(145deg, rgba(14, 165, 233, 0.18), rgba(14, 116, 233, 0.12));
        --storage-surface: rgba(14, 165, 233, 0.12);
        --storage-border: rgba(56, 189, 248, 0.35);
        --timeline-glow: rgba(79, 110, 247, 0.35);
        --radius-large: 0;
        --radius-medium: 0;
        --radius-small: 0;
        --space-2xs: 6px;
        --space-xs: 10px;
        --space-sm: 14px;
        --space-md: 18px;
        --space-lg: 24px;
        --space-xl: 32px;
        --space-xxl: 48px;
        --layout-gutter: clamp(24px, 5vw, 60px);
        --layout-gap: clamp(20px, 3vw, 28px);
      }

      [data-theme='dark'] {
        --bg-primary: #060b18;
        --bg-secondary: #090f1f;
        --bg-tertiary: #0f1a2f;
        --surface: rgba(13, 22, 38, 0.9);
        --surface-strong: rgba(16, 27, 46, 0.96);
        --surface-base: rgba(12, 21, 36, 0.98);
        --surface-contrast: rgba(30, 41, 59, 0.7);
        --surface-soft: rgba(30, 41, 59, 0.6);
        --surface-alt: #131e33;
        --accent: #7b9bff;
        --accent-strong: #93b4ff;
        --lavender: #a78bfa;
        --accent-surface-soft: rgba(99, 102, 241, 0.22);
        --accent-surface: rgba(99, 102, 241, 0.28);
        --accent-surface-strong: rgba(129, 140, 248, 0.35);
        --accent-border-soft: rgba(129, 140, 248, 0.35);
        --accent-border: rgba(99, 102, 241, 0.5);
        --accent-border-strong: rgba(129, 140, 248, 0.65);
        --accent-focus: rgba(165, 180, 252, 0.8);
        --accent-shadow: rgba(99, 102, 241, 0.45);
        --success: #4ade80;
        --success-soft: rgba(74, 222, 128, 0.16);
        --success-border: rgba(74, 222, 128, 0.38);
        --success-glow: rgba(74, 222, 128, 0.55);
        --warning: #facc15;
        --warning-soft: rgba(250, 204, 21, 0.2);
        --warning-border: rgba(250, 204, 21, 0.45);
        --danger: #f87171;
        --danger-soft: rgba(248, 113, 113, 0.2);
        --danger-border: rgba(248, 113, 113, 0.45);
        --text-primary: #f8fafc;
        --text-secondary: #cbd5f5;
        --border-color: rgba(100, 116, 139, 0.45);
        --border-muted: rgba(71, 85, 105, 0.45);
        --border-strong: rgba(129, 140, 248, 0.55);
        --neutral-border: rgba(100, 116, 139, 0.5);
        --neutral-border-strong: rgba(148, 163, 184, 0.45);
        --neutral-soft: rgba(100, 116, 139, 0.24);
        --neutral-surface: rgba(30, 41, 59, 0.6);
        --shadow-elevated: 0 24px 48px rgba(2, 6, 23, 0.5);
        --shadow-base: rgba(2, 6, 23, 0.55);
        --shadow-strong: rgba(15, 23, 42, 0.6);
        --shadow-inset: rgba(15, 23, 42, 0.4);
        --status-gradient: linear-gradient(145deg, rgba(59, 130, 246, 0.35), rgba(129, 140, 248, 0.25));
        --storage-surface: rgba(14, 165, 233, 0.25);
        --storage-border: rgba(56, 189, 248, 0.45);
        --timeline-glow: rgba(129, 140, 248, 0.55);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", "SF Pro Display", -apple-system, system-ui, sans-serif;
        background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-tertiary) 100%);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      header.app-header,
      main,
      footer {
        width: min(1180px, calc(100% - (var(--layout-gutter) * 2)));
        margin: 0 auto;
      }

      a,
      button {
        font-family: inherit;
        color: inherit;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      header.app-header {
        margin-top: var(--space-xl);
        padding: var(--space-lg) var(--layout-gutter);
        display: flex;
        flex-wrap: wrap;
        gap: var(--layout-gap);
        align-items: center;
        justify-content: space-between;
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 0;
        box-shadow: none;
      }

      .logo-area {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .app-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 64px;
        height: 64px;
        border-radius: 18px;
        background: linear-gradient(135deg, var(--accent-strong), var(--lavender));
        font-weight: 700;
        font-size: 1rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .title-group h1 {
        margin: 0;
        font-size: clamp(1.8rem, 3vw, 2.6rem);
      }

      .title-group p {
        margin: 6px 0 0;
        color: var(--text-secondary);
        max-width: 560px;
        font-size: 0.95rem;
      }

      .status-area {
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: flex-end;
      }

      .theme-toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        border: 1px solid var(--accent-border-soft);
        background: var(--surface-strong);
        color: var(--text-primary);
        padding: 8px 16px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
      }

      .theme-toggle:hover {
        transform: translateY(-1px);
        background: var(--accent-surface);
        box-shadow: 0 10px 20px var(--shadow-base);
      }

      .theme-toggle:focus-visible {
        outline: 2px solid var(--accent-focus);
        outline-offset: 2px;
      }

      .theme-toggle[aria-pressed='true'] {
        background: var(--accent-surface);
        color: var(--accent-strong);
        border-color: var(--accent-border);
      }

      .theme-toggle__icon {
        font-size: 1rem;
        line-height: 1;
      }

      .status-indicator {
        padding: 10px 20px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: var(--success-soft);
        color: var(--success);
        border: 1px solid var(--success-border);
      }

      .status-indicator--info {
        background: var(--accent-surface);
        color: var(--accent);
        border-color: var(--accent-border);
      }

      .status-indicator--success {
        background: var(--success-soft);
        color: var(--success);
        border-color: var(--success-border);
      }

      .status-indicator--warning {
        background: var(--warning-soft);
        color: var(--warning);
        border-color: var(--warning-border);
      }

      .status-indicator--danger {
        background: var(--danger-soft);
        color: var(--danger);
        border-color: var(--danger-border);
      }

      .status-indicator::before {
        content: "";
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: currentColor;
        box-shadow: 0 0 10px var(--success-glow);
      }

      .status-meta {
        color: var(--text-secondary);
        font-size: 0.85rem;
        display: flex;
        flex-direction: column;
        gap: 6px;
        text-align: right;
      }

      main {
        flex: 1;
        padding: var(--space-xl) 0 calc(var(--space-xl) + var(--space-xxl));
        width: 100%;
      }

      .view {
        display: none;
      }

      .view.active {
        display: block;
        animation: fadeIn 220ms ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .main-layout {
        margin-top: var(--space-lg);
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-auto-rows: minmax(260px, auto);
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 0;
        overflow: hidden;
        gap: 0;
      }

      .main-layout > .app-block {
        padding: var(--space-lg);
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
        background: var(--surface-strong);
        border-left: 1px solid var(--border-color);
        border-top: 1px solid var(--border-color);
      }

      .main-layout > .app-block:nth-child(1),
      .main-layout > .app-block:nth-child(2) {
        border-top: none;
      }

      .main-layout > .app-block:nth-child(1),
      .main-layout > .app-block:nth-child(3) {
        border-left: none;
      }

      .main-layout .card {
        border: none;
        border-radius: 0;
        box-shadow: none;
        padding: 0;
        background: transparent;
      }

      .app-metrics-grid,
      .app-metrics-highlights {
        display: grid;
        gap: var(--space-sm);
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .app-metric,
      .app-highlight {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .app-metric span,
      .app-highlight span {
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-secondary);
      }

      .app-metric strong,
      .app-highlight strong {
        font-size: clamp(1.4rem, 2.4vw, 1.8rem);
        color: var(--text-primary);
      }

      @media (max-width: 960px) {
        .main-layout {
          grid-template-columns: 1fr;
        }

        .main-layout > .app-block {
          border-left: none;
        }

        .main-layout > .app-block:nth-child(2) {
          border-top: 1px solid var(--border-color);
        }
      }

      @media (max-width: 720px) {
        .app-metrics-grid,
        .app-metrics-highlights {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 520px) {
        .app-metrics-grid,
        .app-metrics-highlights {
          grid-template-columns: 1fr;
        }
      }

      .miniapp-list header {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .miniapp-list header h3 {
        margin: 0;
        font-size: 1rem;
      }

      .miniapp-list header p {
        margin: 0;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .miniapp-list header span {
        font-weight: 600;
        color: var(--accent-strong);
      }

      .miniapp-rail {
        margin-top: var(--space-md);
        display: grid;
        gap: var(--space-sm);
      }

      .mini-app-card {
        border-radius: var(--radius-medium);
        border: 1px solid var(--accent-border);
        background: var(--accent-surface);
        padding: var(--space-sm) var(--space-md);
        display: grid;
        gap: var(--space-xs);
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease, border 120ms ease;
      }

      .mini-app-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 32px var(--accent-shadow);
        border-color: var(--accent-border-strong);
      }

      .mini-app-card:focus-visible {
        outline: 2px solid var(--accent-focus);
        outline-offset: 3px;
      }

      .mini-app-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-xs);
      }

      .mini-app-chip {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 6px 14px;
        border-radius: 999px;
        background: var(--surface-contrast);
        color: var(--accent-strong);
        font-size: 0.85rem;
        font-weight: 600;
      }

      .mini-app-title {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .mini-app-meta {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.8rem;
      }

      .icon-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: var(--accent-surface);
        color: var(--accent-strong);
        cursor: pointer;
        transition: background 120ms ease, border 120ms ease, transform 120ms ease;
      }

      .icon-button:hover {
        background: var(--accent-surface-strong);
      }

      .icon-button:focus-visible {
        outline: 2px solid var(--accent-focus);
        outline-offset: 2px;
      }

      .icon-button svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      .client-panel header,
      .miniapp-panel header {
        display: grid;
        gap: 8px;
      }

      .miniapp-panel {
        position: relative;
        transition: box-shadow 160ms ease, border 160ms ease;
      }

      .miniapp-panel.is-collapsed [data-panel-content] {
        display: none;
      }

      .miniapp-panel.is-collapsed [data-panel-close] {
        display: none;
      }

      .miniapp-panel.is-collapsed [data-panel-placeholder] {
        display: grid;
      }

      .miniapp-panel-header {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
      }

      .miniapp-panel-context {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
        flex-wrap: wrap;
      }

      .miniapp-panel-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-sm);
        flex-wrap: wrap;
      }

      .miniapp-panel-meta p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .miniapp-panel-body {
        margin-top: var(--layout-gap);
        display: grid;
        gap: var(--layout-gap);
      }

      .panel-placeholder {
        border-radius: var(--radius-medium);
        border: 1px dashed var(--neutral-border-strong);
        background: var(--neutral-soft);
        min-height: 160px;
        display: none;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: var(--space-lg);
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .panel-content {
        display: grid;
        gap: var(--layout-gap);
      }

      .miniapp-panel-close {
        margin-left: auto;
      }

      .miniapp-panel.is-active {
        border-color: var(--border-strong);
        box-shadow: 0 24px 48px var(--accent-shadow);
      }

      .client-panel header h2,
      .miniapp-panel header h2 {
        margin: 0;
        font-size: clamp(1.4rem, 2.6vw, 1.8rem);
      }

      .client-panel header p,
      .miniapp-panel header p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .panel-note {
        margin: var(--space-md) 0 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .placeholder-area {
        margin-top: var(--layout-gap);
        border-radius: var(--radius-medium);
        border: 1px dashed var(--neutral-border);
        background: var(--neutral-soft);
      }

      .placeholder-area.large {
        min-height: 220px;
      }

      .master-grid {
        margin-top: var(--layout-gap);
        display: grid;
        gap: var(--layout-gap);
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .master-card {
        border-radius: var(--radius-medium);
        border: 1px dashed var(--accent-border);
        background: var(--accent-surface-soft);
        padding: var(--space-lg);
        display: grid;
        gap: var(--space-sm);
      }

      .master-card h3 {
        margin: 0;
        font-size: 1rem;
      }

      .empty-slot {
        border-radius: var(--radius-small);
        border: 1px dashed var(--neutral-border-strong);
        background: var(--surface-soft);
        min-height: 100px;
      }

      .expansion-master {
        margin-top: var(--layout-gap);
        border-radius: var(--radius-medium);
        border: 1px dashed var(--accent-border);
        background: var(--accent-surface);
        padding: var(--space-lg);
        display: grid;
        gap: var(--space-sm);
      }

      .expansion-master h3 {
        margin: 0;
        font-size: 1rem;
      }

      .empty-slot.tall {
        min-height: 160px;
      }

      .card {
        background: var(--surface);
        border-radius: var(--radius-large);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-elevated);
        padding: var(--space-xl);
        backdrop-filter: blur(18px);
      }

      .card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .card header h2,
      .card header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .card header p {
        margin: 4px 0 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .panel-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .primary-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--layout-gap);
        flex-wrap: wrap;
      }

      .eyebrow {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        background: var(--accent-surface);
        color: var(--accent-strong);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .primary-header h2 {
        margin: 12px 0 4px;
        font-size: clamp(1.8rem, 3vw, 2.4rem);
      }

      .primary-header .meta {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .status-chip-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .status-chip {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid var(--accent-border-soft);
        background: var(--accent-surface-soft);
        color: var(--accent-strong);
      }

      .status-chip--mirror {
        border-color: var(--accent-border);
        background: var(--accent-surface);
      }

      .status-chip--safe {
        border-color: var(--success-border);
        background: var(--success-soft);
        color: var(--success);
      }

      .status-buttons {
        margin-top: var(--layout-gap);
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        align-items: center;
      }

      .status-button {
        border: 1px solid transparent;
        border-radius: 999px;
        padding: 10px 18px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        background: var(--surface-strong);
        color: var(--text-primary);
        transition: transform 120ms ease, box-shadow 120ms ease, border 120ms ease;
      }

      .status-button--new {
        border-color: var(--warning-border);
        background: var(--warning-soft);
        color: var(--warning);
      }

      .status-button--execute {
        border-color: var(--accent-border);
        background: var(--accent-surface);
        color: var(--accent-strong);
      }

      .status-button--ready {
        border-color: var(--success-border);
        background: var(--success-soft);
        color: var(--success);
      }

      .status-button--maintenance {
        border-color: var(--neutral-border);
        background: var(--neutral-soft);
        color: var(--text-secondary);
      }

      .status-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px var(--shadow-base);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        padding: 10px 18px;
        border-radius: 999px;
        background: var(--accent-surface);
        color: var(--accent-strong);
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px dashed var(--accent-border);
      }

      .badge-light {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 999px;
        background: var(--accent-surface);
        color: var(--accent-strong);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .sync-options {
        display: grid;
        gap: var(--layout-gap);
      }

      .option-group {
        display: grid;
        gap: var(--space-xs);
      }

      .group-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-secondary);
        font-weight: 600;
      }

      .option-pills {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-xs);
      }

      .option-pill {
        border-radius: 999px;
        border: 1px solid var(--neutral-border);
        background: var(--neutral-soft);
        color: var(--text-secondary);
        font-size: 0.82rem;
        font-weight: 600;
        padding: 8px 16px;
        cursor: pointer;
      }

      .option-pill--active {
        border-color: var(--accent-border);
        background: var(--accent-surface-strong);
        color: var(--accent-strong);
      }

      .option-pill--ghost {
        background: var(--neutral-surface);
      }

      .option-status {
        font-size: 0.78rem;
        color: var(--text-secondary);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .option-status::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
      }

      .option-status--offline {
        color: var(--danger);
      }

      .option-status--mirroring {
        color: var(--accent-strong);
      }

      .operations-highlights {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .operations-highlights > div {
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        padding: 18px;
        display: grid;
        gap: 6px;
      }

      .operations-highlights p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .field-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .form-field {
        display: grid;
        gap: 8px;
        font-size: 0.85rem;
      }

      .form-field span {
        color: var(--text-secondary);
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .form-field input {
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 10px 14px;
        font-size: 0.95rem;
        font-family: inherit;
        color: var(--text-primary);
        background: var(--surface-base);
        box-shadow: inset 0 1px 2px var(--shadow-inset);
      }

      .form-field input:focus {
        outline: none;
        border-color: var(--accent-border-strong);
        box-shadow: 0 0 0 3px var(--accent-surface-strong);
      }

      .inline-note {
        margin-top: var(--layout-gap);
        border-radius: var(--radius-medium);
        border: 1px dashed var(--accent-border);
        background: var(--accent-surface);
        padding: var(--space-md) var(--space-lg);
        display: grid;
        gap: var(--space-2xs);
      }

      .inline-note p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .action-bar {
        margin-top: var(--layout-gap);
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
      }

      .action-button {
        border-radius: 12px;
        border: 1px solid var(--neutral-border);
        background: var(--surface-strong);
        padding: 12px 18px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease, border 120ms ease;
      }

      .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px var(--shadow-base);
      }

      .action-button--tests {
        border-color: var(--accent-border);
      }

      .action-button--audit {
        border-color: var(--success-border);
      }

      .action-button--control {
        border-color: var(--warning-border);
      }

      .kpi-section {
        display: grid;
        gap: var(--layout-gap);
      }

      .kpi-section header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .kpi-section header p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-md);
      }

      .kpi-card {
        border-radius: var(--radius-medium);
        border: 1px solid var(--accent-border);
        background: var(--accent-surface);
        padding: 18px;
        display: grid;
        gap: 8px;
      }

      .kpi-card span {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .kpi-card strong {
        font-size: 1.6rem;
      }

      .kpi-card small {
        color: var(--text-secondary);
        font-size: 0.78rem;
      }

      .insight-section {
        display: grid;
        gap: var(--layout-gap);
      }

      .insight-section header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .insight-section header p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .insight-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: var(--space-md);
      }

      .insight-card {
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        padding: 20px;
        display: grid;
        gap: 12px;
      }

      .insight-card h4 {
        margin: 0;
        font-size: 1rem;
      }

      .insight-card p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .schedule-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: var(--space-sm);
      }

      .schedule-list li {
        display: flex;
        flex-direction: column;
        gap: var(--space-2xs);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-small);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
      }

      .schedule-title {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .schedule-time {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .panel-actions button,
      .pill-button {
        border: 1px solid var(--accent-border-soft);
        padding: 10px 18px;
        border-radius: 999px;
        background: var(--accent-surface);
        color: var(--accent-strong);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, box-shadow 120ms ease;
      }

      .panel-actions button:hover,
      .pill-button:hover,
      .toggle:not(:disabled):hover {
        transform: translateY(-1px);
        background: var(--accent-surface-strong);
        box-shadow: 0 10px 22px var(--accent-shadow);
      }

      [data-export-button][disabled],
      button[data-exporting='true'] {
        cursor: progress;
        opacity: 0.7;
        pointer-events: none;
      }

      button[data-exporting='true']::after {
        content: '‚Ä¶';
        margin-left: 6px;
        font-weight: 700;
      }

      .panel-body {
        margin-top: var(--layout-gap);
        display: grid;
        gap: var(--layout-gap);
      }

      .status-strip {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: var(--space-md);
      }

      .status-tile {
        border-radius: var(--radius-medium);
        border: 1px solid var(--accent-border);
        background: var(--status-gradient);
        padding: var(--space-md);
      }

      .status-tile strong {
        display: block;
        font-size: 1.6rem;
        margin-bottom: 6px;
      }

      .status-tile span {
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .panel-highlights {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px;
      }

      .highlight-card {
        border-radius: var(--radius-medium);
        background: var(--surface-strong);
        border: 1px solid var(--neutral-border);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .highlight-card h4 {
        margin: 0;
        font-size: 1rem;
      }

      .highlight-card p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
        flex: 1;
      }

      .mini-app-summary {
        margin: 18px 0 10px;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .mini-app-summary strong {
        color: var(--text-primary);
      }

      .mini-app-grid {
        margin-top: 12px;
        display: grid;
        gap: 16px;
      }


      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--neutral-soft);
        color: var(--text-secondary);
      }

      .chip.success {
        background: var(--success-soft);
        color: var(--success);
      }

      .chip.info {
        background: var(--accent-surface-strong);
        color: var(--accent-strong);
      }

      .chip.neutral {
        background: var(--neutral-surface);
        color: var(--text-secondary);
      }

      .chip.warning {
        background: var(--warning-soft);
        color: var(--warning);
      }

      .grid-two {
        margin-top: var(--layout-gap);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: var(--layout-gap);
      }

      .kpi-board {
        display: grid;
        gap: var(--space-sm);
      }

      .kpi-item {
        background: var(--accent-surface);
        border: 1px solid var(--accent-border);
        border-radius: var(--radius-medium);
        padding: 16px;
      }

      .kpi-item strong {
        font-size: 1.4rem;
        display: block;
        margin-bottom: 4px;
      }

      .data-card {
        background: var(--surface-strong);
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        padding: 18px;
        display: grid;
        gap: 10px;
      }

      .data-card h4 {
        margin: 0;
        font-size: 1rem;
      }

      .data-card ul {
        margin: 0;
        padding-left: 18px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        display: grid;
        gap: 6px;
      }

      .expansion-area {
        margin-top: var(--layout-gap);
        background: var(--accent-surface);
        border: 1px dashed var(--accent-border);
        border-radius: var(--radius-medium);
        padding: var(--space-lg);
      }

      .expansion-area h4 {
        margin: 0 0 var(--space-xs);
      }

      .expansion-area p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .table-wrapper {
        margin-top: var(--layout-gap);
        background: var(--surface-strong);
        border-radius: var(--radius-large);
        border: 1px solid var(--border-color);
        padding: var(--space-lg);
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 640px;
      }

      table thead {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        color: var(--text-secondary);
      }

      table th,
      table td {
        padding: var(--space-sm) var(--space-md);
        border-bottom: 1px solid var(--border-muted);
        text-align: left;
      }

      table tbody tr:last-child td {
        border-bottom: none;
      }

      table td strong {
        color: var(--text-primary);
      }

      .system-tips {
        margin-top: var(--space-lg);
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        padding: var(--space-lg);
        display: grid;
        gap: var(--space-sm);
      }

      .system-tips h4 {
        margin: 0;
        font-size: 1rem;
      }

      .system-tips ul {
        margin: 0;
        padding-left: 18px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        display: grid;
        gap: var(--space-2xs);
      }

      .device-list {
        display: grid;
        gap: 14px;
      }

      .device-card {
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        padding: 16px;
        background: var(--surface-strong);
        display: grid;
        gap: 8px;
      }

      .device-card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .device-card header span {
        font-size: 0.82rem;
        color: var(--text-secondary);
      }

      .device-card ul {
        margin: 0;
        padding-left: 18px;
        color: var(--text-secondary);
        font-size: 0.8rem;
        display: grid;
        gap: 4px;
      }

      .storage-grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .storage-card {
        border-radius: var(--radius-medium);
        border: 1px solid var(--storage-border);
        padding: 16px;
        background: var(--storage-surface);
        display: grid;
        gap: 6px;
      }

      .storage-card strong {
        font-size: 0.95rem;
      }

      .storage-card span {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .timeline {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 12px;
      }

      .timeline li {
        position: relative;
        padding-left: 24px;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .timeline li::before {
        content: "";
        position: absolute;
        left: 0;
        top: 6px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent-strong);
        box-shadow: 0 0 10px var(--timeline-glow);
      }

      .market-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: var(--space-md);
        margin-top: var(--layout-gap);
      }

      .market-card {
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        padding: var(--space-lg);
        display: grid;
        gap: var(--space-sm);
      }

      .market-card header h4 {
        margin: 0;
        font-size: 1rem;
      }

      .market-card header p {
        margin: 6px 0 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .market-card footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .toggle {
        border: 1px solid var(--accent-border);
        border-radius: 999px;
        padding: 10px 20px;
        background: var(--accent-surface);
        color: var(--accent-strong);
        font-weight: 600;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease;
      }

      .toggle:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
        background: var(--neutral-surface);
        border-color: var(--neutral-border);
        color: var(--text-secondary);
      }

      .config-block {
        background: var(--surface-strong);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-medium);
        padding: var(--space-lg);
        margin-top: var(--layout-gap);
      }

      .config-block h4 {
        margin: 0 0 var(--space-sm);
      }

      .config-block pre {
        margin: 0;
        white-space: pre-wrap;
        font-size: 0.8rem;
        color: var(--text-secondary);
        max-height: 320px;
        overflow-y: auto;
        background: var(--surface-alt);
        border-radius: var(--radius-small);
        padding: var(--space-md);
        border: 1px solid var(--border-color);
      }

      a.back-action {
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
        margin-top: var(--layout-gap);
        font-size: 0.9rem;
        text-decoration: none;
        color: var(--accent);
        font-weight: 600;
      }

      a.back-action svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }

      footer {
        margin-top: auto;
        padding: var(--space-lg) var(--layout-gutter) var(--space-xl);
        display: flex;
        justify-content: space-between;
        gap: var(--layout-gap);
        flex-wrap: wrap;
        align-items: center;
        font-size: 0.85rem;
        color: var(--text-secondary);
        border-top: 1px solid var(--border-color);
        background: var(--surface);
        border-radius: 0;
        box-shadow: none;
      }

      .footer-brand {
        display: flex;
        align-items: center;
      }

      .footer-brand img {
        height: 32px;
        object-fit: contain;
        display: block;
      }

      .footer-content {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        align-items: center;
      }

      .export-feedback {
        position: fixed;
        right: var(--space-lg);
        bottom: var(--space-lg);
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: 12px 18px;
        border-radius: var(--radius-medium);
        border: 1px solid var(--accent-border);
        background: var(--surface-strong);
        box-shadow: 0 18px 32px var(--shadow-base);
        font-size: 0.85rem;
        z-index: 999;
      }

      .export-feedback[data-state='loading'] {
        border-color: var(--accent-border);
        background: var(--accent-surface);
        color: var(--accent-strong);
      }

      .export-feedback[data-state='success'] {
        border-color: var(--success-border);
        background: var(--success-soft);
        color: var(--success);
      }

      .export-feedback[data-state='error'] {
        border-color: var(--danger-border);
        background: var(--danger-soft);
        color: var(--danger);
      }

      .export-feedback__icon {
        font-size: 1rem;
        line-height: 1;
      }

      @media print {
        body {
          background: #ffffff !important;
          color: #000000 !important;
          box-shadow: none !important;
        }

        header.app-header,
        footer,
        nav,
        .miniapp-panel,
        .panel-actions,
        .miniapp-rail,
        .export-feedback,
        [data-action='home'],
        [data-panel-menu],
        [data-panel-close],
        [data-panel-trigger] {
          display: none !important;
        }

        main {
          width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        .view {
          display: none !important;
          box-shadow: none !important;
          background: transparent !important;
        }

        body[data-print-section] .view.is-print-target {
          display: block !important;
        }

        body[data-print-section] .view.is-print-target .card {
          background: transparent !important;
          border: none !important;
          box-shadow: none !important;
        }

        body[data-print-section] .view.is-print-target .card header {
          page-break-inside: avoid;
        }

        body[data-print-section] .view.is-print-target table {
          page-break-inside: auto;
        }

        a.back-action {
          display: none !important;
        }
      }

      @media (max-width: 1200px) {
        .status-area {
          align-items: flex-start;
        }

        .status-meta {
          text-align: left;
        }
      }

      @media (max-width: 720px) {
        :root {
          --layout-gutter: 20px;
          --layout-gap: 20px;
        }

        header.app-header {
          padding: var(--space-lg) var(--layout-gutter);
        }

        main {
          padding: var(--space-lg) 0 calc(var(--space-lg) + var(--space-xl));
        }

        footer {
          padding: var(--space-lg) var(--layout-gutter) var(--space-xl);
        }

        table {
          min-width: 520px;
        }
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <!-- BEGIN: logo-picture-responsive -->
      <picture>
        <source srcset="/Projeto-marco/assets/app/brand/logo-dark-800.webp 800w, /Projeto-marco/assets/app/brand/logo-dark-400.webp 400w" media="(prefers-color-scheme: dark)" type="image/webp">
        <source srcset="/Projeto-marco/assets/app/brand/logo-light-800.webp 800w, /Projeto-marco/assets/app/brand/logo-light-400.webp 400w" media="(prefers-color-scheme: light)" type="image/webp">
        <img src="/Projeto-marco/assets/app/brand/logo-light-400.webp" alt="Logo 5 Horas" width="400" height="100" loading="eager" decoding="async">
      </picture>
      <!-- END: logo-picture-responsive -->
      <div class="logo-area">
        <div class="app-badge">Marco</div>
        <div class="title-group">
          <h1>Marco ¬∑ AppBase + MiniApps</h1>
          <p>
            Aplicativo demonstrativo do Sistema Operacional Marco, com AppBase local-first
            carregando mini-apps habilitados por tenant e respeitando os contratos do
            blueprint consolidado.
          </p>
        </div>
      </div>
      <div class="status-area">
        <span class="status-indicator" data-ref="status-indicator">Sess√£o ativa</span>
        <button
          type="button"
          class="theme-toggle"
          data-action="toggle-theme"
          aria-pressed="false"
        >
          <span class="theme-toggle__icon" aria-hidden="true">üåì</span>
          <span data-theme-label>Modo claro</span>
        </button>
        <div class="status-meta">
          <span data-ref="status-tenant">Tenant:</span>
          <span data-ref="status-user">Usu√°rio:</span>
          <span data-ref="status-storage">Armazenamento vinculado:</span>
          <span data-ref="status-sync">√öltimo sync:</span>
          <span data-ref="status-ready">Tempo at√© READY:</span>
        </div>
      </div>
    </header>

    <main>
      <section id="tela-principal" class="view active">
        <div class="main-layout">
          <section class="card app-block miniapp-list">
            <header>
              <h3>Mini-app resumos</h3>
              <p>
                <span data-ref="miniapp-count">0</span> habilitados para
                <span data-ref="summary-tenant">-</span>
              </p>
            </header>
            <div class="miniapp-rail" id="mini-app-grid"></div>
          </section>
          <section class="card app-block app-metrics">
            <header>
              <span class="eyebrow">Indicadores</span>
              <h2>Snapshot operacional</h2>
              <p>Resumo r√°pido de fluxo, capacidade e alertas do tenant ativo.</p>
            </header>
            <div class="app-metrics-grid">
              <article class="app-metric">
                <span>Fluxo de tarefas</span>
                <strong data-ref="metric-task-flow">‚Äî</strong>
              </article>
              <article class="app-metric">
                <span>Capacidade</span>
                <strong data-ref="metric-capacity">‚Äî</strong>
              </article>
              <article class="app-metric">
                <span>Alertas</span>
                <strong data-ref="metric-alerts">‚Äî</strong>
              </article>
            </div>
            <div class="app-metrics-highlights">
              <article class="app-highlight">
                <span>Aprova√ß√µes</span>
                <strong data-ref="highlight-approvals">‚Äî</strong>
              </article>
              <article class="app-highlight">
                <span>Equipes em campo</span>
                <strong data-ref="highlight-field-teams">‚Äî</strong>
              </article>
              <article class="app-highlight">
                <span>Tarefas cr√≠ticas</span>
                <strong data-ref="highlight-priority">‚Äî</strong>
              </article>
            </div>
          </section>
          <section class="card app-block client-panel">
            <header>
              <span class="eyebrow">Painel cliente</span>
              <h2>Painel principal</h2>
              <p>√Årea reservada para os componentes do cliente conforme o desenho base.</p>
            </header>
            <div class="placeholder-area large"></div>
          </section>
          <section
            class="card app-block miniapp-panel is-collapsed"
            id="miniapp-panel-card"
            aria-live="polite"
          >
            <header class="miniapp-panel-header">
              <div class="miniapp-panel-context">
                <span class="mini-app-chip" data-panel-chip>Mini-app n√£o selecionado</span>
                <button
                  type="button"
                  class="icon-button"
                  data-panel-menu
                  aria-label="Abrir MiniAppPanel"
                  aria-expanded="false"
                >
                  <svg viewBox="0 0 16 16" aria-hidden="true">
                    <path
                      d="M2.5 8a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm4 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm4 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z"
                    />
                  </svg>
                  <span class="sr-only">Alternar MiniAppPanel</span>
                </button>
              </div>
              <div class="miniapp-panel-meta">
                <p data-panel-meta>Selecione um mini-app na coluna √† esquerda para visualizar os masters.</p>
                <button type="button" class="pill-button miniapp-panel-close" data-panel-close hidden>
                  Fechar painel
                </button>
              </div>
            </header>
            <div class="miniapp-panel-body">
              <div class="panel-placeholder" data-panel-placeholder>
                Selecione um mini-app na coluna √† esquerda e utilize o menu de tr√™s pontos para abrir o MiniAppPanel.
              </div>
              <div class="panel-content" data-panel-content hidden></div>
            </div>
          </section>
        </div>
      </section>

      <template id="panel-template-operations">
        <div class="master-grid">
          <div class="master-card">
            <h3>KPIs do sistema</h3>
            <div class="empty-slot"></div>
          </div>
          <div class="master-card">
            <h3>Dados / Resumos</h3>
            <div class="empty-slot"></div>
          </div>
          <div class="master-card">
            <h3>Outros pain√©is</h3>
            <div class="empty-slot"></div>
          </div>
        </div>
        <div class="expansion-master">
          <h3>√Årea p/ expandir</h3>
          <div class="empty-slot tall"></div>
        </div>
      </template>

      <template id="panel-template-tasks">
        <p class="panel-note">
          O painel mestre do Gestor de Tarefas apresentar√° filtros, status e pr√≥ximos cards definidos nesta fase.
        </p>
        <div class="placeholder-area large"></div>
      </template>

      <template id="panel-template-account">
        <p class="panel-note">
          √Årea reservada para vincular dispositivos, backups e livros-raz√£o diretamente no painel central.
        </p>
        <div class="placeholder-area large"></div>
      </template>

      <template id="panel-template-market">
        <p class="panel-note">
          Em breve: cat√°logo compacto para habilitar ou revogar licen√ßas sem sair da Home.
        </p>
        <div class="placeholder-area large"></div>
      </template>

      <template id="panel-template-settings">
        <p class="panel-note">
          Configura√ß√µes r√°pidas do tenant, schemas registrados e observabilidade sumarizada aparecer√£o aqui.
        </p>
        <div class="placeholder-area large"></div>
      </template>

      <section id="mini-app-painel" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app ‚Ä¢ Painel de Opera√ß√µes</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Painel de Opera√ß√µes</span>
              </p>
            </div>
            <div class="panel-actions">
              <button
                type="button"
                data-export-button
                data-export-target="mini-app-painel"
              >
                Exportar painel
              </button>
            </div>
          </header>
          <p class="panel-note">Masters base preparados para receber os subcards.</p>
          <div class="master-grid">
            <div class="master-card">
              <h3>KPIs do sistema</h3>
              <div class="empty-slot"></div>
            </div>
            <div class="master-card">
              <h3>Dados / Resumos</h3>
              <div class="empty-slot"></div>
            </div>
            <div class="master-card">
              <h3>Outros pain√©is</h3>
              <div class="empty-slot"></div>
            </div>
          </div>
          <div class="expansion-master">
            <h3>√Årea p/ expandir</h3>
            <div class="empty-slot tall"></div>
          </div>
          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>

      <section id="mini-app-tarefas" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app ‚Ä¢ Gestor de Tarefas</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Gestor de Tarefas</span>
              </p>
            </div>
            <div class="panel-actions">
              <button type="button">Criar nova tarefa</button>
              <button
                type="button"
                data-export-button
                data-export-target="mini-app-tarefas"
              >
                Exportar planilha
              </button>
            </div>
          </header>

          <div class="chip-row" style="margin-top: 16px">
            <span class="chip info">Filtro: Hoje</span>
            <span class="chip neutral">Owner: Todos</span>
            <span class="chip warning">4 itens cr√≠ticos</span>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th scope="col">Tarefas</th>
                  <th scope="col">Respons√°veis</th>
                  <th scope="col">Datas</th>
                  <th scope="col">Status</th>
                  <th scope="col">Dados consumidos</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Revisar contrato principal</strong></td>
                  <td>Carla Nogueira</td>
                  <td>12/03 ‚Üí 14/03</td>
                  <td>
                    <span class="status-indicator status-indicator--info">Em curso</span>
                  </td>
                  <td>Base jur√≠dica v2</td>
                </tr>
                <tr>
                  <td><strong>Sincronizar planilha de fornecedores</strong></td>
                  <td>Equipe Opera√ß√µes</td>
                  <td>12/03 ‚Üí 13/03</td>
                  <td>
                    <span class="status-indicator status-indicator--success">Conclu√≠do</span>
                  </td>
                  <td>Invent√°rio homologado</td>
                </tr>
                <tr>
                  <td><strong>Testar backups incrementais</strong></td>
                  <td>Marcos Lima</td>
                  <td>11/03 ‚Üí 15/03</td>
                  <td>
                    <span class="status-indicator status-indicator--warning">Aten√ß√£o</span>
                  </td>
                  <td>Snapshots AWS 22h</td>
                </tr>
                <tr>
                  <td><strong>Validar checklist de campo</strong></td>
                  <td>Fernanda Dias</td>
                  <td>10/03 ‚Üí 12/03</td>
                  <td>
                    <span class="status-indicator status-indicator--danger">Cr√≠tico</span>
                  </td>
                  <td>Dossi√™ Equipes Norte</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="system-tips">
            <h4>Dicas do sistema</h4>
            <ul>
              <li>Use filtros por status para focar nos itens cr√≠ticos do dia.</li>
              <li>Os cart√µes de dados consumidos indicam a fonte principal da tarefa.</li>
              <li>Atualiza√ß√µes autom√°ticas acontecem a cada 15 minutos.</li>
            </ul>
          </div>

          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>

      <section id="mini-app-conta" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app ‚Ä¢ Conta & Backup</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Conta & Backup</span>
              </p>
            </div>
            <div class="panel-actions">
              <button
                type="button"
                data-export-button
                data-export-target="mini-app-conta"
              >
                Exportar relat√≥rio
              </button>
              <button type="button">Gerar link m√°gico</button>
              <button type="button">Desvincular dispositivo</button>
            </div>
          </header>

          <div class="grid-two">
            <div class="data-card">
              <h4>Identidade & Sess√£o</h4>
              <ul>
                <li>
                  Tenant atual: <strong data-ref="detail-tenant">-</strong>
                </li>
                <li>
                  Usu√°rio autenticado: <strong data-ref="detail-user">-</strong>
                </li>
                <li>
                  Login unificado: <span data-ref="detail-logins">-</span>
                </li>
                <li>
                  Modo quiosque: <span data-ref="detail-kiosk">-</span>
                </li>
              </ul>
            </div>
            <div class="data-card">
              <h4>Backup & Storage</h4>
              <ul>
                <li>Backup autom√°tico: <strong data-ref="detail-backup">-</strong></li>
                <li>Arquivos sincronizados: <span data-ref="detail-files">-</span></li>
                <li>√öltima exporta√ß√£o: <span data-ref="detail-export">-</span></li>
              </ul>
            </div>
          </div>

          <div class="storage-grid" id="storage-grid"></div>

          <div class="grid-two">
            <div class="data-card">
              <h4>Dispositivos ativos</h4>
              <div class="device-list" id="device-list"></div>
            </div>
            <div class="data-card">
              <h4>Livro-raz√£o de conformidade</h4>
              <ul class="timeline" id="audit-timeline"></ul>
            </div>
          </div>

          <div class="system-tips">
            <h4>Direitos do titular prontos para 1 clique</h4>
            <ul>
              <li>Acesso completo aos dados exportando o envelope √∫nico.</li>
              <li>Retifica√ß√£o centralizada com versionamento por schema.</li>
              <li>Exclus√£o total com janela de seguran√ßa e recibo.</li>
            </ul>
          </div>

          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>

      <section id="mini-app-market" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app ‚Ä¢ Marketplace</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Marketplace</span>
              </p>
            </div>
            <div class="panel-actions">
              <button type="button">Atualizar cat√°logos</button>
              <button type="button">Ver licen√ßas ativas</button>
            </div>
          </header>

          <div class="market-grid" id="market-grid"></div>

          <div class="system-tips">
            <h4>Como funciona o marketplace</h4>
            <ul>
              <li>Mini-apps obrigat√≥rios ficam bloqueados para desativa√ß√£o.</li>
              <li>Ativa√ß√µes refletem imediatamente na Home e no AppBase.</li>
              <li>
                Licen√ßas adicionais habilitam recursos como backup multi-dispositivo.
              </li>
            </ul>
          </div>

          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>

      <section id="mini-app-config" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app ‚Ä¢ Configura√ß√£o & Opera√ß√£o</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Configura√ß√£o</span>
              </p>
            </div>
            <div class="panel-actions">
              <button
                type="button"
                data-export-button
                data-export-target="mini-app-config"
              >
                Exportar config
              </button>
              <button type="button">Ver auditoria</button>
            </div>
          </header>

          <div class="config-block">
            <h4>Configura√ß√£o resolvida</h4>
            <pre id="config-json"></pre>
          </div>

          <div class="grid-two">
            <div class="data-card">
              <h4>Checklist LGPD-first</h4>
              <ul>
                <li>Consentimentos com recibo individual</li>
                <li>Exporta√ß√£o 1-clique no envelope comum</li>
                <li>Reten√ß√£o configur√°vel por MiniApp</li>
              </ul>
            </div>
            <div class="data-card">
              <h4>Observabilidade</h4>
              <ul>
                <li>Eventos cr√≠ticos monitorados em tempo real</li>
                <li>KPIs alinhados ao blueprint R1.0</li>
                <li>Logs assinados por tenant e usu√°rio</li>
              </ul>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th scope="col">Evento</th>
                  <th scope="col">√öltima captura</th>
                  <th scope="col">Notas</th>
                </tr>
              </thead>
              <tbody id="observability-table"></tbody>
            </table>
          </div>

          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>
    </main>

    <footer>
      <div class="footer-brand">
        <img
          src="https://5horas.com.br/wp-content/uploads/2025/09/Logo-Banner2.png"
          alt="Logo 5horas"
          loading="lazy"
        />
      </div>
      <div class="footer-content">
        <span>¬© 2024 Marco ‚Ä¢ Sistema Operacional Modular</span>
        <span>Vers√£o 0.2.0 ‚Ä¢ Prot√≥tipo naveg√°vel AppBase + MiniApps</span>
      </div>
    </footer>

    <div
      class="export-feedback"
      data-export-feedback
      hidden
      role="status"
      aria-live="polite"
      aria-atomic="true"
    >
      <span class="export-feedback__icon" data-export-icon aria-hidden="true">‚è≥</span>
      <span data-export-message>Preparando exporta√ß√£o‚Ä¶</span>
    </div>

    <script>
      const views = document.querySelectorAll('.view');
      const appRoot = document.documentElement;
      const panelCard = document.getElementById('miniapp-panel-card');
      const panelContent = panelCard?.querySelector('[data-panel-content]');
      const panelPlaceholder = panelCard?.querySelector('[data-panel-placeholder]');
      const panelChip = panelCard?.querySelector('[data-panel-chip]');
      const panelMeta = panelCard?.querySelector('[data-panel-meta]');
      const panelClose = panelCard?.querySelector('[data-panel-close]');
      const panelMenu = panelCard?.querySelector('[data-panel-menu]');
      let activePanelKey = null;
      let activePanelTrigger = null;

      function activateView(id) {
        views.forEach((view) => {
          view.classList.toggle('active', view.id === id);
        });
        if (window.scrollY > 0) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        appRoot.setAttribute('data-view', id);
      }

      const dashboardSnapshot = {
        taskFlow: 82,
        capacity: 92,
        alerts: 3,
        approvals: 12,
        fieldTeams: 9,
        priorityTasks: 4,
      };

      const sessionState = {
        network: 'Online',
        deviceName: 'Marco Tablet Kiosk',
        lastSync: '12/03/2025 17:42',
        timeToReady: '1,4s',
        kioskMode: 'Device Owner ‚Ä¢ Single-App Kiosk',
        devices: [
          {
            id: 'device-01',
            label: 'Marco Tablet Kiosk',
            type: 'Tablet',
            lastActivity: 'h√° 2 minutos',
            status: 'Sess√£o atual',
          },
          {
            id: 'device-02',
            label: 'iPhone 15 ‚Äî Opera√ß√µes',
            type: 'Celular',
            lastActivity: 'h√° 1 hora',
            status: 'Login via Passkey',
          },
          {
            id: 'device-03',
            label: 'Desktop Backoffice',
            type: 'Desktop',
            lastActivity: 'h√° 3 horas',
            status: 'Sess√£o ativa',
          },
        ],
        auditTrail: [
          {
            event: 'export_completed',
            description: 'Exporta√ß√£o 1-clique conclu√≠da',
            timestamp: '12/03 17:21',
          },
          {
            event: 'erasure_requested',
            description: 'Solicita√ß√£o de elimina√ß√£o total agendada',
            timestamp: '12/03 14:02',
          },
          {
            event: 'consent_logged',
            description: 'Consentimento LGPD atualizado',
            timestamp: '11/03 18:45',
          },
        ],
      };

      const backupSnapshot = {
        enabled: true,
        filesSynced: '128 itens',
        lastExport: '12/03 17:21',
        storageStatus: {
          drive: {
            name: 'Google Drive',
            status: 'Operacional',
            lastSync: 'h√° 5 minutos',
          },
          onedrive: {
            name: 'Microsoft OneDrive',
            status: 'Operacional',
            lastSync: 'h√° 8 minutos',
          },
        },
      };

      const marketCatalog = [
        {
          key: 'operations',
          title: 'Painel de Opera√ß√µes',
          description: 'KPIs, dados mestres e status unificado do tenant.',
          capabilities: ['KPIs', 'Alertas', 'Workflow'],
          license: 'Base',
        },
        {
          key: 'tasks',
          title: 'Gestor de Tarefas',
          description: 'Cronogramas, respons√°veis e depend√™ncias cr√≠ticas.',
          capabilities: ['Quadro', 'Alertas', 'Exporta√ß√£o'],
          license: 'Base',
        },
        {
          key: 'account',
          title: 'Conta & Backup',
          description: 'Identidade, dispositivos, direitos do titular e backups.',
          capabilities: ['LGPD', 'Backup', 'Passkeys'],
          license: 'Premium',
        },
        {
          key: 'market',
          title: 'Marketplace',
          description: 'Gest√£o de cat√°logos, licen√ßas e habilita√ß√£o de MiniApps.',
          capabilities: ['Cat√°logo', 'Licen√ßas', 'Provisionamento'],
          license: 'Base',
        },
        {
          key: 'settings',
          title: 'Configura√ß√£o & Opera√ß√£o',
          description: 'Par√¢metros do AppBase, observabilidade e auditoria.',
          capabilities: ['Schemas', 'Observabilidade', 'LGPD'],
          license: 'Base',
        },
        {
          key: 'analytics',
          title: 'Insights Avan√ßados',
          description: 'Visualiza√ß√µes anal√≠ticas e previs√µes operacionais.',
          capabilities: ['Forecast', 'An√°lises', 'Dashboards'],
          license: 'Add-on',
          comingSoon: true,
        },
      ];

      const observabilitySnapshot = [
        {
          event: 'boot_start',
          timestamp: '12/03 17:00',
          notes: 'Fluxo nominal',
        },
        {
          event: 'config_loaded',
          timestamp: '12/03 17:00',
          notes: 'Checksum v√°lido',
        },
        {
          event: 'session_ok',
          timestamp: '12/03 17:01',
          notes: 'Token renovado via PKCE',
        },
        {
          event: 'sync_completed',
          timestamp: '12/03 17:42',
          notes: 'Fila zerada',
        },
        {
          event: 'export_completed',
          timestamp: '12/03 17:21',
          notes: 'Envelope distribu√≠do',
        },
      ];

      const THEME_STORAGE_KEY = 'marco-ui-theme';

      const COMMON_EXPORT_EXCLUDES = [
        'Voltar para a tela principal',
        'Exportar painel',
        'Exportar planilha',
        'Exportar relat√≥rio',
        'Exportar config',
        'Criar nova tarefa',
        'Gerar link m√°gico',
        'Desvincular dispositivo',
        'Atualizar cat√°logos',
        'Ver licen√ßas ativas',
        'Ver auditoria',
      ];

      const exportRegistry = {
        'mini-app-painel': {
          title: 'Marco ¬∑ Painel de Opera√ß√µes',
          subtitle: 'Mini-app ‚Ä¢ Painel de Opera√ß√µes',
          description: 'Resumo do painel operacional com masters e √°reas de expans√£o.',
          fileName: 'painel-operacoes',
          shortLabel: 'Painel de Opera√ß√µes',
          headings: ['KPIs do sistema', 'Dados / Resumos', 'Outros pain√©is', '√Årea p/ expandir'],
          excluded: [
            'Mini-app ‚Ä¢ Painel de Opera√ß√µes',
            'Masters base preparados para receber os subcards.',
          ],
        },
        'mini-app-tarefas': {
          title: 'Marco ¬∑ Gestor de Tarefas',
          subtitle: 'Mini-app ‚Ä¢ Gestor de Tarefas',
          description: 'Exporta√ß√£o da vis√£o de tarefas, filtros ativos e dicas do sistema.',
          fileName: 'gestor-tarefas',
          shortLabel: 'Gestor de Tarefas',
          headings: ['Mini-app ‚Ä¢ Gestor de Tarefas', 'Dicas do sistema'],
          excluded: ['Mini-app ‚Ä¢ Gestor de Tarefas'],
        },
        'mini-app-conta': {
          title: 'Marco ¬∑ Conta & Backup',
          subtitle: 'Mini-app ‚Ä¢ Conta & Backup',
          description: 'Detalhes de identidade, dispositivos ativos e storage sincronizado.',
          fileName: 'conta-backup',
          shortLabel: 'Conta & Backup',
          headings: [
            'Identidade & Sess√£o',
            'Backup & Storage',
            'Dispositivos ativos',
            'Livro-raz√£o de conformidade',
            'Direitos do titular prontos para 1 clique',
          ],
          excluded: ['Mini-app ‚Ä¢ Conta & Backup'],
        },
        'mini-app-config': {
          title: 'Marco ¬∑ Configura√ß√£o & Opera√ß√£o',
          subtitle: 'Mini-app ‚Ä¢ Configura√ß√£o & Opera√ß√£o',
          description: 'Snapshot da configura√ß√£o resolvida e eventos de observabilidade.',
          fileName: 'config-operacao',
          shortLabel: 'Configura√ß√£o & Opera√ß√£o',
          headings: ['Configura√ß√£o resolvida', 'Checklist LGPD-first', 'Observabilidade'],
          excluded: ['Mini-app ‚Ä¢ Configura√ß√£o & Opera√ß√£o'],
        },
      };

      const PRINT_CLEANUP_DELAY = 600;

      const exportFeedback = (() => {
        const container = document.querySelector('[data-export-feedback]');
        const message = container?.querySelector('[data-export-message]');
        const icon = container?.querySelector('[data-export-icon]');
        let hideTimeout = null;

        function setState(state, text) {
          if (!container) {
            return;
          }
          container.dataset.state = state;
          container.hidden = false;
          if (message) {
            message.textContent = text;
          }
          if (icon) {
            icon.textContent = state === 'loading' ? '‚è≥' : state === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
          }
          if (hideTimeout) {
            window.clearTimeout(hideTimeout);
            hideTimeout = null;
          }
          if (state !== 'loading') {
            hideTimeout = window.setTimeout(() => {
              container.hidden = true;
              container.removeAttribute('data-state');
            }, 4000);
          }
        }

        function hide() {
          if (!container) {
            return;
          }
          container.hidden = true;
          container.removeAttribute('data-state');
          if (hideTimeout) {
            window.clearTimeout(hideTimeout);
            hideTimeout = null;
          }
        }

        return {
          loading(text) {
            setState('loading', text);
          },
          success(text) {
            setState('success', text);
          },
          error(text) {
            setState('error', text);
          },
          hide,
        };
      })();

      const AppBase = (() => {
        const modules = new Map();
        const defaults = new Set();
        let enabled = new Set();
        let currentConfig = null;

        function register(key, module) {
          modules.set(key, module);
        }

        function boot(config) {
          currentConfig = config;
          const root = document.documentElement;
          root.dataset.theme = config.ui?.theme ?? 'light';
          defaults.clear();
          (config.defaults?.enabledMiniApps ?? []).forEach((key) => defaults.add(key));
          enabled = new Set([
            ...(config.defaults?.enabledMiniApps ?? []),
            ...(config.user?.enabledMiniApps ?? []),
          ]);
          refreshNav();
        }

        function refreshNav() {
          const enabledKeys = Array.from(enabled).filter((key) => modules.has(key));
          const container = document.getElementById('mini-app-grid');
          if (container) {
            container.innerHTML = '';
            enabledKeys.forEach((key) => {
              const module = modules.get(key);
              container.appendChild(createMiniAppCard(module, key));
            });
          }
          const countRef = document.querySelector('[data-ref="miniapp-count"]');
          if (countRef) {
            countRef.textContent = enabledKeys.length;
          }
          const tenantSummary = document.querySelector('[data-ref="summary-tenant"]');
          if (tenantSummary && currentConfig) {
            tenantSummary.textContent = currentConfig.tenantId;
          }
          connectMiniAppTriggers();
          buildMarketplace();
        }

        function createMiniAppCard(module, key) {
          const article = document.createElement('article');
          article.className = 'mini-app-card';
          article.dataset.miniapp = key;
          article.dataset.miniappView = key;
          article.tabIndex = 0;
          article.setAttribute('role', 'button');
          article.setAttribute('aria-label', `Abrir vis√£o completa de ${module.card.label}`);

          const header = document.createElement('div');
          header.className = 'mini-app-card-header';

          const chip = document.createElement('div');
          chip.className = 'mini-app-chip';

          const title = document.createElement('span');
          title.className = 'mini-app-title';
          title.textContent = module.card.label;
          chip.appendChild(title);

          const trigger = document.createElement('button');
          trigger.type = 'button';
          trigger.className = 'icon-button';
          trigger.dataset.panelTrigger = key;
          trigger.setAttribute('aria-label', `Abrir MiniAppPanel de ${module.card.label}`);
          trigger.setAttribute('aria-expanded', 'false');
          trigger.innerHTML = `
            <svg viewBox="0 0 16 16" aria-hidden="true">
              <path d="M2.5 8a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm4 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm4 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z" />
            </svg>
            <span class="sr-only">Abrir painel de mini-app</span>
          `;

          chip.appendChild(trigger);
          header.appendChild(chip);
          article.appendChild(header);

          if (module.card?.meta) {
            const meta = document.createElement('p');
            meta.className = 'mini-app-meta';
            meta.textContent = module.card.meta;
            article.appendChild(meta);
          }

          article.addEventListener('click', (event) => {
            if (event.target.closest('button')) {
              return;
            }
            activateView(module.id);
          });

          article.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              activateView(module.id);
            }
          });

          article.dataset.bound = 'true';

          return article;
        }

        function toggleMiniApp(key) {
          if (!modules.has(key) && !defaults.has(key)) {
            return;
          }
          const module = modules.get(key);
          if (enabled.has(key)) {
            if (defaults.has(key)) {
              return;
            }
            enabled.delete(key);
            if (activePanelKey === key) {
              hideMiniAppPanel();
            }
            if (module && appRoot.dataset.view === module.id) {
              activateView('tela-principal');
            }
          } else {
            enabled.add(key);
          }
          refreshNav();
        }

        function isEnabled(key) {
          return enabled.has(key);
        }

        function isDefault(key) {
          return defaults.has(key);
        }

        function getResolvedConfig() {
          if (!currentConfig) {
            return null;
          }
          return {
            tenantId: currentConfig.tenantId,
            userId: currentConfig.userId,
            catalogBaseUrl: currentConfig.catalogBaseUrl,
            enabledMiniApps: Array.from(enabled),
            entitlements: currentConfig.user?.entitlements ?? {},
            providers: currentConfig.user?.providers ?? {},
            ui: currentConfig.ui,
            meta: currentConfig.meta,
          };
        }

        function resolve(key) {
          return modules.get(key);
        }

        return {
          register,
          boot,
          toggleMiniApp,
          isEnabled,
          isDefault,
          getResolvedConfig,
          resolve,
        };
      })();

      AppBase.register('operations', {
        id: 'mini-app-painel',
        card: {
          label: 'Painel de Opera√ß√µes',
          meta: 'KPIs, dados mestres e status de recursos',
          cta: 'Abrir painel detalhado',
        },
        badges: ['KPIs', 'Alertas'],
        panel: {
          template: 'panel-template-operations',
          meta: 'Masters do painel operacional prontos para receber subcards.',
        },
      });

      AppBase.register('tasks', {
        id: 'mini-app-tarefas',
        card: {
          label: 'Gestor de Tarefas',
          meta: 'Cronogramas, respons√°veis e dados consumidos',
          cta: 'Abrir lista de tarefas',
        },
        badges: ['Workflow', 'Autosave'],
        panel: {
          template: 'panel-template-tasks',
          meta: 'Masters do gestor focados em filtros e status priorit√°rios.',
        },
      });

      AppBase.register('account', {
        id: 'mini-app-conta',
        card: {
          label: 'Conta & Backup',
          meta: 'Identidade, dispositivos e direitos LGPD',
          cta: 'Gerenciar conta',
        },
        badges: ['LGPD', 'Backup'],
        panel: {
          template: 'panel-template-account',
          meta: 'Masters para direitos do titular, dispositivos e backups.',
        },
      });

      AppBase.register('market', {
        id: 'mini-app-market',
        card: {
          label: 'Marketplace',
          meta: 'Cat√°logo confi√°vel de mini-apps do tenant',
          cta: 'Gerenciar licen√ßas',
        },
        badges: ['Cat√°logo', 'Provisionamento'],
        panel: {
          template: 'panel-template-market',
          meta: 'Preview compacto para habilitar ou revogar licen√ßas.',
        },
      });

      AppBase.register('settings', {
        id: 'mini-app-config',
        card: {
          label: 'Configura√ß√£o & Opera√ß√£o',
          meta: 'Parametros, observabilidade e auditoria',
          cta: 'Abrir configura√ß√µes',
        },
        badges: ['Schemas', 'Logs'],
        panel: {
          template: 'panel-template-settings',
          meta: 'Masters de configura√ß√£o r√°pida e observabilidade do tenant.',
        },
      });

      const bootConfig = {
        tenantId: 'tenant-marco',
        userId: 'ribeiro.l',
        catalogBaseUrl: 'https://cdn.marco.app/catalog',
        defaults: { enabledMiniApps: ['home', 'market', 'settings'] },
        user: {
          enabledMiniApps: ['operations', 'tasks', 'account'],
          entitlements: { backup: true, marketplace: true },
          providers: { login: ['google', 'apple'], storage: ['drive', 'onedrive'] },
        },
        ui: { theme: 'dark', layout: 'tabs' },
        meta: { version: '1.0', signature: 'demo-signature', checksum: 'demo-checksum' },
      };

      AppBase.boot(bootConfig);

      initThemeControls();
      updateHeaderSession(bootConfig, sessionState);
      updateHomeSnapshot(dashboardSnapshot);
      updateAccountDetails(bootConfig, sessionState, backupSnapshot);
      buildObservabilityTable();
      connectMiniAppTriggers();
      initExportActions();
      document.querySelectorAll('[data-action="home"]').forEach((element) => {
        element.addEventListener('click', (event) => {
          event.preventDefault();
          activateView('tela-principal');
        });
      });

      function initThemeControls() {
        const root = document.documentElement;
        let storedTheme = null;
        try {
          storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
        } catch (error) {
          storedTheme = null;
        }
        if (storedTheme !== 'light' && storedTheme !== 'dark') {
          storedTheme = null;
        }
        if (storedTheme) {
          root.dataset.theme = storedTheme;
        }

        const toggle = document.querySelector('[data-action="toggle-theme"]');
        if (!toggle) {
          return;
        }

        const icon = toggle.querySelector('.theme-toggle__icon');
        const label = toggle.querySelector('[data-theme-label]');

        function syncTheme(theme) {
          if (label) {
            label.textContent = theme === 'dark' ? 'Modo escuro' : 'Modo claro';
          }
          if (icon) {
            icon.textContent = theme === 'dark' ? 'üåô' : 'üåû';
          }
          toggle.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
          toggle.setAttribute(
            'aria-label',
            `Alternar para modo ${theme === 'dark' ? 'claro' : 'escuro'}`,
          );
        }

        syncTheme(root.dataset.theme === 'dark' ? 'dark' : 'light');

        toggle.addEventListener('click', () => {
          const current = root.dataset.theme === 'dark' ? 'dark' : 'light';
          const next = current === 'dark' ? 'light' : 'dark';
          root.dataset.theme = next;
          syncTheme(next);
          try {
            localStorage.setItem(THEME_STORAGE_KEY, next);
          } catch (error) {
            // ignore storage errors
          }
        });
      }

      function updateHeaderSession(config, session) {
        const indicator = document.querySelector('[data-ref="status-indicator"]');
        if (indicator) {
          indicator.textContent = `Sess√£o ativa ‚Ä¢ ${session.network}`;
        }
        const tenantRef = document.querySelector('[data-ref="status-tenant"]');
        if (tenantRef) {
          tenantRef.textContent = `Tenant: ${config.tenantId}`;
        }
        const userRef = document.querySelector('[data-ref="status-user"]');
        if (userRef) {
          userRef.textContent = `Usu√°rio: ${config.userId} ‚Ä¢ ${session.deviceName}`;
        }
        const storageProviders = config.user?.providers?.storage ?? [];
        const storageRef = document.querySelector('[data-ref="status-storage"]');
        if (storageRef) {
          storageRef.textContent = storageProviders.length
            ? `Armazenamento vinculado: ${storageProviders
                .map((provider) => provider.toUpperCase())
                .join(' ‚Ä¢ ')}`
            : 'Armazenamento vinculado: n√£o habilitado';
        }
        const syncRef = document.querySelector('[data-ref="status-sync"]');
        if (syncRef) {
          syncRef.textContent = session.lastSync
            ? `√öltimo sync: ${session.lastSync}`
            : 'Sync desativado';
        }
        const readyRef = document.querySelector('[data-ref="status-ready"]');
        if (readyRef) {
          readyRef.textContent = `Tempo at√© READY: ${session.timeToReady}`;
        }
      }

      function updateHomeSnapshot(snapshot) {
        const flow = document.querySelector('[data-ref="metric-task-flow"]');
        if (flow) {
          flow.textContent = `${snapshot.taskFlow}%`;
        }
        const capacity = document.querySelector('[data-ref="metric-capacity"]');
        if (capacity) {
          capacity.textContent = `${snapshot.capacity}%`;
        }
        const alerts = document.querySelector('[data-ref="metric-alerts"]');
        if (alerts) {
          alerts.textContent = snapshot.alerts;
        }
        const approvals = document.querySelector('[data-ref="highlight-approvals"]');
        if (approvals) {
          approvals.textContent = snapshot.approvals;
        }
        const teams = document.querySelector('[data-ref="highlight-field-teams"]');
        if (teams) {
          teams.textContent = snapshot.fieldTeams;
        }
        const priority = document.querySelector('[data-ref="highlight-priority"]');
        if (priority) {
          priority.textContent = snapshot.priorityTasks;
        }
      }

      function updateAccountDetails(config, session, backup) {
        const tenantDetail = document.querySelector('[data-ref="detail-tenant"]');
        if (tenantDetail) {
          tenantDetail.textContent = config.tenantId;
        }
        const userDetail = document.querySelector('[data-ref="detail-user"]');
        if (userDetail) {
          userDetail.textContent = config.userId;
        }
        const loginDetail = document.querySelector('[data-ref="detail-logins"]');
        if (loginDetail) {
          const providers = config.user?.providers?.login ?? [];
          loginDetail.textContent = providers.length
            ? providers.map((provider) => provider.toUpperCase()).join(' ‚Ä¢ ')
            : 'Sem provedores configurados';
        }
        const kioskDetail = document.querySelector('[data-ref="detail-kiosk"]');
        if (kioskDetail) {
          kioskDetail.textContent = session.kioskMode;
        }
        const backupDetail = document.querySelector('[data-ref="detail-backup"]');
        if (backupDetail) {
          backupDetail.textContent = backup.enabled ? 'Ativo' : 'Desativado';
        }
        const filesDetail = document.querySelector('[data-ref="detail-files"]');
        if (filesDetail) {
          filesDetail.textContent = backup.filesSynced;
        }
        const exportDetail = document.querySelector('[data-ref="detail-export"]');
        if (exportDetail) {
          exportDetail.textContent = backup.lastExport;
        }

        const storageGrid = document.getElementById('storage-grid');
        if (storageGrid) {
          storageGrid.innerHTML = '';
          const storageProviders = config.user?.providers?.storage ?? [];
          storageProviders.forEach((providerKey) => {
            const data = backup.storageStatus[providerKey];
            const card = document.createElement('article');
            card.className = 'storage-card';
            card.innerHTML = `
              <strong>${data?.name ?? providerKey.toUpperCase()}</strong>
              <span>Status: ${data?.status ?? 'Desconhecido'}</span>
              <span>√öltimo sync: ${data?.lastSync ?? '‚Äî'}</span>
            `;
            storageGrid.appendChild(card);
          });
        }

        const deviceList = document.getElementById('device-list');
        if (deviceList) {
          deviceList.innerHTML = '';
          session.devices.forEach((device) => {
            const card = document.createElement('article');
            card.className = 'device-card';
            card.innerHTML = `
              <header>
                <strong>${device.label}</strong>
                <span>${device.status}</span>
              </header>
              <ul>
                <li>Tipo: ${device.type}</li>
                <li>√öltima atividade: ${device.lastActivity}</li>
                <li>ID: ${device.id}</li>
              </ul>
            `;
            deviceList.appendChild(card);
          });
        }

        const timeline = document.getElementById('audit-timeline');
        if (timeline) {
          timeline.innerHTML = '';
          session.auditTrail.forEach((entry) => {
            const item = document.createElement('li');
            item.textContent = `${entry.timestamp} ‚Ä¢ ${entry.description}`;
            timeline.appendChild(item);
          });
        }

        const configJson = document.getElementById('config-json');
        if (configJson) {
          const resolved = AppBase.getResolvedConfig();
          configJson.textContent = JSON.stringify(resolved, null, 2);
        }
      }

      function toggleMiniAppPanel(key, trigger) {
        if (!panelCard || !panelContent || !panelPlaceholder) {
          return;
        }
        if (activePanelKey === key && panelCard.classList.contains('is-active')) {
          hideMiniAppPanel();
          return;
        }
        showMiniAppPanel(key, trigger);
      }

      function showMiniAppPanel(key, trigger) {
        const module = AppBase.resolve(key);
        if (!module || !panelCard || !panelContent || !panelPlaceholder) {
          return;
        }

        panelContent.innerHTML = '';
        const templateId = module.panel?.template;
        if (templateId) {
          const template = document.getElementById(templateId);
          if (template) {
            panelContent.appendChild(template.content.cloneNode(true));
          }
        }
        if (!panelContent.hasChildNodes()) {
          const fallback = document.createElement('p');
          fallback.className = 'panel-note';
          fallback.textContent = `Painel em prepara√ß√£o para ${module.card.label}.`;
          panelContent.appendChild(fallback);
        }

        panelPlaceholder.setAttribute('hidden', 'hidden');
        panelContent.removeAttribute('hidden');
        panelCard.classList.add('is-active');
        panelCard.classList.remove('is-collapsed');

        if (panelChip) {
          panelChip.textContent = module.card.label;
        }
        if (panelMeta) {
          panelMeta.textContent = module.panel?.meta ?? module.card?.meta ?? '';
        }

        if (panelClose) {
          panelClose.removeAttribute('hidden');
        }

        if (panelMenu) {
          panelMenu.dataset.panelTrigger = key;
          panelMenu.setAttribute('aria-expanded', 'true');
          panelMenu.setAttribute('aria-label', `Fechar MiniAppPanel de ${module.card.label}`);
        }

        if (activePanelTrigger) {
          activePanelTrigger.setAttribute('aria-expanded', 'false');
        }
        if (trigger) {
          trigger.setAttribute('aria-expanded', 'true');
          activePanelTrigger = trigger;
        } else {
          activePanelTrigger = null;
        }

        activePanelKey = key;
      }

      function hideMiniAppPanel() {
        if (!panelCard || !panelContent || !panelPlaceholder) {
          return;
        }
        panelCard.classList.remove('is-active');
        panelCard.classList.add('is-collapsed');
        panelContent.innerHTML = '';
        panelContent.setAttribute('hidden', 'hidden');
        panelPlaceholder.removeAttribute('hidden');

        if (panelChip) {
          panelChip.textContent = 'Mini-app n√£o selecionado';
        }
        if (panelMeta) {
          panelMeta.textContent = 'Selecione um mini-app na coluna √† esquerda para visualizar os masters.';
        }
        if (panelClose) {
          panelClose.setAttribute('hidden', 'hidden');
        }
        if (panelMenu) {
          panelMenu.removeAttribute('data-panel-trigger');
          panelMenu.setAttribute('aria-expanded', 'false');
          panelMenu.setAttribute('aria-label', 'Abrir MiniAppPanel');
        }
        if (activePanelTrigger) {
          activePanelTrigger.setAttribute('aria-expanded', 'false');
        }
        activePanelTrigger = null;
        activePanelKey = null;
      }

      if (panelClose) {
        panelClose.addEventListener('click', (event) => {
          event.stopPropagation();
          hideMiniAppPanel();
        });
      }

      if (panelMenu) {
        panelMenu.addEventListener('click', (event) => {
          event.stopPropagation();
          const targetKey = panelMenu.dataset.panelTrigger ?? activePanelKey;
          if (targetKey) {
            toggleMiniAppPanel(targetKey, panelMenu);
          }
        });
      }

      function connectMiniAppTriggers() {
        document.querySelectorAll('[data-miniapp-view]').forEach((element) => {
          if (element.dataset.bound === 'true') {
            return;
          }
          const module = AppBase.resolve(element.dataset.miniappView);
          if (!module) {
            return;
          }
          element.dataset.bound = 'true';
          element.addEventListener('click', (event) => {
            if (event.target.closest('button')) {
              return;
            }
            activateView(module.id);
          });
        });

        document.querySelectorAll('[data-panel-trigger]').forEach((button) => {
          if (button.dataset.panelBound === 'true') {
            return;
          }
          button.dataset.panelBound = 'true';
          button.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleMiniAppPanel(button.dataset.panelTrigger, button);
          });
        });
      }

      function buildMarketplace() {
        const container = document.getElementById('market-grid');
        if (!container) {
          return;
        }
        container.innerHTML = '';
        marketCatalog.forEach((item) => {
          const card = document.createElement('article');
          card.className = 'market-card';
          card.dataset.marketCard = item.key;

          const header = document.createElement('header');
          header.innerHTML = `
            <div>
              <h4>${item.title}</h4>
              <p>${item.description}</p>
            </div>
          `;
          card.appendChild(header);

          if (item.capabilities?.length) {
            const chips = document.createElement('div');
            chips.className = 'chip-row';
            item.capabilities.forEach((capability) => {
              const chip = document.createElement('span');
              chip.className = 'chip neutral';
              chip.textContent = capability;
              chips.appendChild(chip);
            });
            card.appendChild(chips);
          }

          const statusRow = document.createElement('div');
          statusRow.className = 'chip-row';
          const statusChip = document.createElement('span');
          if (item.comingSoon) {
            statusChip.className = 'chip neutral';
            statusChip.textContent = 'Em breve';
          } else if (AppBase.isEnabled(item.key)) {
            statusChip.className = 'chip success';
            statusChip.textContent = 'Ativo';
          } else {
            statusChip.className = 'chip info';
            statusChip.textContent = 'Dispon√≠vel';
          }
          statusRow.appendChild(statusChip);

          if (item.license) {
            const licenseChip = document.createElement('span');
            licenseChip.className = 'chip neutral';
            licenseChip.textContent = `Licen√ßa: ${item.license}`;
            statusRow.appendChild(licenseChip);
          }
          card.appendChild(statusRow);

          const footer = document.createElement('footer');
          if (item.comingSoon) {
            const info = document.createElement('span');
            info.className = 'chip neutral';
            info.textContent = 'Cat√°logo agendado para Q3';
            footer.appendChild(info);
          } else {
            const toggle = document.createElement('button');
            toggle.className = 'toggle';
            toggle.type = 'button';
            if (AppBase.isDefault(item.key)) {
              toggle.textContent = 'Obrigat√≥rio';
              toggle.disabled = true;
            } else {
              toggle.textContent = AppBase.isEnabled(item.key) ? 'Desabilitar' : 'Habilitar';
              toggle.addEventListener('click', () => {
                AppBase.toggleMiniApp(item.key);
              });
            }
            footer.appendChild(toggle);
          }
          card.appendChild(footer);

          container.appendChild(card);
        });
      }

      function initExportActions() {
        document.querySelectorAll('[data-export-button]').forEach((button) => {
          if (button.dataset.exportBound === 'true') {
            return;
          }
          button.dataset.exportBound = 'true';
          button.addEventListener('click', () => {
            handleExportRequest(button.dataset.exportTarget, button);
          });
        });
      }

      async function handleExportRequest(targetId, button) {
        if (!targetId || !exportRegistry[targetId]) {
          console.warn('Export target n√£o mapeado', targetId);
          return;
        }
        const section = document.getElementById(targetId);
        if (!section) {
          console.warn('Se√ß√£o de exporta√ß√£o n√£o encontrada', targetId);
          return;
        }
        const config = exportRegistry[targetId];
        const exportDate = new Date();
        exportFeedback.loading(`Preparando exporta√ß√£o de ${config.shortLabel ?? config.title}‚Ä¶`);
        setExportButtonLoading(button, true);
        try {
          const structure = buildExportStructure(section, config, exportDate);
          const entries = mapItemsToEntries(structure);
          const pdfBytes = generateSimplePdf(entries);
          const fileTimestamp = createFileTimestamp(exportDate);
          const fileName = `${config.fileName ?? targetId}-${fileTimestamp}.pdf`;
          const supportsFile = typeof File === 'function';
          const pdfBlob = supportsFile
            ? new File([pdfBytes], fileName, { type: 'application/pdf' })
            : new Blob([pdfBytes], { type: 'application/pdf' });
          triggerDownload(pdfBlob, fileName);
          let shared = false;
          if (
            supportsFile &&
            typeof navigator !== 'undefined' &&
            typeof navigator.canShare === 'function'
          ) {
            try {
              if (navigator.canShare({ files: [pdfBlob] })) {
                await navigator.share({
                  files: [pdfBlob],
                  title: config.title,
                  text: 'Exporta√ß√£o gerada no Sistema Operacional Marco.',
                });
                shared = true;
              }
            } catch (shareError) {
              if (!shareError || shareError.name !== 'AbortError') {
                console.warn('Compartilhamento n√£o conclu√≠do', shareError);
              }
            }
          }
          registerExportAudit(config, exportDate);
          exportFeedback.success(
            shared
              ? `Exporta√ß√£o compartilhada com sucesso para ${config.shortLabel ?? config.title}.`
              : `Exporta√ß√£o gerada para ${config.shortLabel ?? config.title}.`,
          );
        } catch (error) {
          console.error('Erro ao exportar se√ß√£o', error);
          exportFeedback.error('N√£o foi poss√≠vel gerar o PDF desta se√ß√£o.');
          tryPrintFallback(section, targetId);
        } finally {
          setExportButtonLoading(button, false);
        }
      }

      function setExportButtonLoading(button, isLoading) {
        if (!button) {
          return;
        }
        if (isLoading) {
          if (!button.dataset.originalLabel) {
            button.dataset.originalLabel = button.textContent?.trim() ?? '';
          }
          button.dataset.exporting = 'true';
          button.disabled = true;
          button.textContent = 'Exportando';
          return;
        }
        button.disabled = false;
        button.removeAttribute('data-exporting');
        const originalLabel = button.dataset.originalLabel;
        if (typeof originalLabel === 'string') {
          button.textContent = originalLabel;
          delete button.dataset.originalLabel;
        }
      }

      function buildExportStructure(section, config, exportDate) {
        const structure = [{ type: 'title', text: config.title }];
        const subtitle =
          config.subtitle ?? section.querySelector('header h2')?.textContent?.trim() ?? null;
        if (subtitle) {
          structure.push({ type: 'subtitle', text: subtitle });
        }
        structure.push({ type: 'meta', text: `Gerado em: ${formatFullTimestamp(exportDate)}` });
        if (config.description) {
          structure.push({ type: 'meta', text: config.description });
        }
        structure.push({ type: 'spacer' });
        extractSectionLines(section, config).forEach((item) => structure.push(item));
        return structure;
      }

      function extractSectionLines(section, config) {
        const excludes = new Set(COMMON_EXPORT_EXCLUDES);
        (config.excluded ?? []).forEach((phrase) => excludes.add(phrase));
        const ignoreContains = config.ignorePhrases ?? [];
        const rawLines = section.innerText.split('\n').map((line) => line.trim());
        const items = [];
        let previousContent = '';
        rawLines.forEach((line) => {
          if (!line) {
            if (items.length && items[items.length - 1].type !== 'spacer') {
              items.push({ type: 'spacer' });
            }
            previousContent = '';
            return;
          }
          if (excludes.has(line)) {
            return;
          }
          if (ignoreContains.some((phrase) => line.includes(phrase))) {
            return;
          }
          const normalized = line.replace(/\s+/g, ' ').trim();
          if (!normalized || normalized === previousContent) {
            return;
          }
          if (config.headings?.includes(normalized)) {
            if (!items.length || items[items.length - 1].type !== 'spacer') {
              items.push({ type: 'spacer' });
            }
            items.push({ type: 'heading', text: normalized });
            items.push({ type: 'spacer' });
            previousContent = '';
            return;
          }
          if (/^[-‚Ä¢]/.test(normalized)) {
            items.push({ type: 'list', text: normalized.replace(/^[-‚Ä¢]\s*/, '') });
          } else {
            items.push({ type: 'text', text: normalized });
          }
          previousContent = normalized;
        });
        while (items.length && items[items.length - 1].type === 'spacer') {
          items.pop();
        }
        return items;
      }

      function mapItemsToEntries(items) {
        const entries = [];
        items.forEach((item) => {
          switch (item.type) {
            case 'title':
              entries.push({ text: item.text, fontSize: 18, leading: 28, indent: 0 });
              break;
            case 'subtitle':
              entries.push({ text: item.text, fontSize: 12, leading: 20, indent: 0 });
              break;
            case 'meta':
              entries.push({ text: item.text, fontSize: 10, leading: 16, indent: 0 });
              break;
            case 'heading':
              entries.push({ text: item.text, fontSize: 13, leading: 22, indent: 0 });
              break;
            case 'list':
              entries.push({ text: item.text, fontSize: 11, leading: 18, indent: 20, prefix: '-' });
              break;
            case 'spacer':
              entries.push({ text: '', fontSize: 11, leading: 14, indent: 0 });
              break;
            default:
              entries.push({ text: item.text, fontSize: 11, leading: 18, indent: 0 });
              break;
          }
        });
        return entries;
      }

      function generateSimplePdf(entries) {
        const pageWidth = 595.28;
        const pageHeight = 841.89;
        const margin = 56;
        const startY = pageHeight - margin;
        const pages = [];
        let currentPage = [];
        let cursorY = startY;

        entries.forEach((entry) => {
          const fontSize = entry.fontSize ?? 12;
          const leading = entry.leading ?? Math.round(fontSize * 1.35);
          const indent = entry.indent ?? 0;
          const prefix = entry.prefix ?? '';
          if (!entry.text) {
            if (cursorY - leading < margin && currentPage.length) {
              pages.push(currentPage);
              currentPage = [];
              cursorY = startY;
            }
            cursorY -= leading;
            currentPage.push({ text: '', fontSize, indent, prefix: '', leading, y: cursorY });
            return;
          }
          const availableWidth = pageWidth - margin * 2 - indent;
          const maxChars = Math.max(16, Math.floor(availableWidth / (fontSize * 0.55)));
          const wrapped = wrapTextForPdf(entry.text, maxChars);
          wrapped.forEach((line, index) => {
            if (cursorY - leading < margin && currentPage.length) {
              pages.push(currentPage);
              currentPage = [];
              cursorY = startY;
            }
            cursorY -= leading;
            currentPage.push({
              text: line,
              fontSize,
              indent,
              prefix: index === 0 ? prefix : '',
              leading,
              y: cursorY,
            });
          });
        });

        if (currentPage.length || !pages.length) {
          pages.push(currentPage);
        }

        const objects = [];
        const pageIds = [];
        const contentIds = [];
        pages.forEach((_, index) => {
          const pageId = 4 + index * 2;
          const contentId = pageId + 1;
          pageIds.push(pageId);
          contentIds.push(contentId);
        });
        const kidsList = pageIds.map((id) => `${id} 0 R`).join(' ');
        objects.push({ id: 1, body: '<< /Type /Catalog /Pages 2 0 R >>' });
        objects.push({ id: 2, body: `<< /Type /Pages /Kids [${kidsList}] /Count ${pages.length} >>` });
        objects.push({ id: 3, body: '<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>' });

        const textEncoder = new TextEncoder();
        pages.forEach((lines, index) => {
          const pageId = pageIds[index];
          const contentId = contentIds[index];
          const contentParts = ['BT'];
          let currentFontSize = null;
          lines.forEach((line) => {
            if (!line.text && !line.prefix) {
              return;
            }
            const fontSize = line.fontSize ?? 12;
            if (currentFontSize !== fontSize) {
              contentParts.push(`/F1 ${fontSize.toFixed(2)} Tf`);
              currentFontSize = fontSize;
            }
            const y = line.y.toFixed(2);
            if (line.prefix) {
              const prefixText = escapePdfText(line.prefix === '‚Ä¢' ? '-' : line.prefix);
              contentParts.push(`1 0 0 1 ${margin.toFixed(2)} ${y} Tm (${prefixText}) Tj`);
            }
            if (line.text) {
              const x = (margin + line.indent).toFixed(2);
              const content = escapePdfText(line.text);
              contentParts.push(`1 0 0 1 ${x} ${y} Tm (${content}) Tj`);
            }
          });
          contentParts.push('ET');
          const contentString = contentParts.join('\n');
          const contentBytes = textEncoder.encode(contentString);
          const contentBody = `<< /Length ${contentBytes.length} >>\nstream\n${contentString}\nendstream`;
          objects.push({
            id: pageId,
            body: `<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageWidth.toFixed(2)} ${pageHeight.toFixed(2)}] /Resources << /Font << /F1 3 0 R >> >> /Contents ${contentId} 0 R >>`,
          });
          objects.push({ id: contentId, body: contentBody });
        });

        const pdfParts = ['%PDF-1.4\n'];
        const offsets = [0];
        let offset = pdfParts[0].length;
        objects.forEach((object) => {
          const objectString = `${object.id} 0 obj\n${object.body}\nendobj\n`;
          offsets.push(offset);
          pdfParts.push(objectString);
          offset += objectString.length;
        });
        const xrefPosition = offset;
        pdfParts.push(`xref\n0 ${objects.length + 1}\n0000000000 65535 f \n`);
        for (let index = 1; index <= objects.length; index += 1) {
          pdfParts.push(`${offsets[index].toString().padStart(10, '0')} 00000 n \n`);
        }
        pdfParts.push(`trailer\n<< /Size ${objects.length + 1} /Root 1 0 R >>\nstartxref\n${xrefPosition}\n%%EOF`);
        return textEncoder.encode(pdfParts.join(''));
      }

      function wrapTextForPdf(text, maxChars) {
        const clean = text.replace(/\s+/g, ' ').trim();
        if (!clean) {
          return [''];
        }
        const words = clean.split(' ');
        const lines = [];
        let current = '';
        words.forEach((word) => {
          if (!word) {
            return;
          }
          const tentative = current ? `${current} ${word}` : word;
          if (tentative.length > maxChars) {
            if (current) {
              lines.push(current);
              current = '';
            }
            if (word.length > maxChars) {
              let remaining = word;
              while (remaining.length > maxChars) {
                lines.push(remaining.slice(0, maxChars));
                remaining = remaining.slice(maxChars);
              }
              current = remaining;
            } else {
              current = word;
            }
          } else {
            current = tentative;
          }
        });
        if (current) {
          lines.push(current);
        }
        return lines.length ? lines : [''];
      }

      function escapePdfText(text) {
        return text
          .replace(/\\/g, '\\\\')
          .replace(/\(/g, '\\(')
          .replace(/\)/g, '\\)')
          .replace(/\r?\n/g, ' ');
      }

      function triggerDownload(file, fallbackName) {
        if (!file) {
          return;
        }
        const url = URL.createObjectURL(file);
        const anchor = document.createElement('a');
        anchor.href = url;
        anchor.download = 'name' in file && file.name ? file.name : fallbackName;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        window.setTimeout(() => URL.revokeObjectURL(url), 2000);
      }

      function createFileTimestamp(date) {
        const pad = (value) => value.toString().padStart(2, '0');
        return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}-${pad(date.getHours())}${pad(date.getMinutes())}`;
      }

      function formatFullTimestamp(date) {
        const pad = (value) => value.toString().padStart(2, '0');
        return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }

      function formatAuditTimestamp(date) {
        const pad = (value) => value.toString().padStart(2, '0');
        return `${pad(date.getDate())}/${pad(date.getMonth() + 1)} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }

      function registerExportAudit(config, exportDate) {
        const timestamp = formatAuditTimestamp(exportDate);
        sessionState.auditTrail.unshift({
          event: 'export_generated',
          description: `Exporta√ß√£o ${config.shortLabel ?? config.title} conclu√≠da`,
          timestamp,
        });
        if (sessionState.auditTrail.length > 20) {
          sessionState.auditTrail.length = 20;
        }
        backupSnapshot.lastExport = timestamp;
        updateAccountDetails(bootConfig, sessionState, backupSnapshot);
      }

      function tryPrintFallback(section, sectionId) {
        if (!section) {
          return;
        }
        preparePrintLayout(section, sectionId);
        try {
          window.print();
        } catch (printError) {
          console.warn('Impress√£o de fallback n√£o dispon√≠vel', printError);
        } finally {
          window.setTimeout(() => {
            clearPrintLayout(section);
          }, PRINT_CLEANUP_DELAY);
        }
      }

      function preparePrintLayout(section, sectionId) {
        if (!section) {
          return;
        }
        document.body.dataset.printSection = sectionId;
        section.classList.add('is-print-target');
      }

      function clearPrintLayout(section) {
        if (!section) {
          return;
        }
        delete document.body.dataset.printSection;
        section.classList.remove('is-print-target');
      }

      function buildObservabilityTable() {
        const tbody = document.getElementById('observability-table');
        if (!tbody) {
          return;
        }
        tbody.innerHTML = '';
        observabilitySnapshot.forEach((entry) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${entry.event}</strong></td>
            <td>${entry.timestamp}</td>
            <td>${entry.notes}</td>
          `;
          tbody.appendChild(row);
        });
      }
    </script>
  </body>
</html>
