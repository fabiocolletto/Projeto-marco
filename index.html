<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marco · AppBase + MiniApps</title>
    <style>
      :root {
        --bg-primary: #f6f8fc;
        --bg-secondary: #e8edfa;
        --bg-tertiary: #dfe4f6;
        --surface: rgba(255, 255, 255, 0.92);
        --surface-strong: rgba(255, 255, 255, 0.98);
        --accent: #4f6ef7;
        --accent-strong: #1d4ed8;
        --lavender: #7c3aed;
        --success: #22c55e;
        --success-soft: rgba(34, 197, 94, 0.12);
        --warning: #f59e0b;
        --warning-soft: rgba(245, 158, 11, 0.16);
        --danger: #ef4444;
        --danger-soft: rgba(239, 68, 68, 0.12);
        --text-primary: #1f2a44;
        --text-secondary: #5f6c8a;
        --border-color: rgba(187, 195, 216, 0.6);
        --border-strong: rgba(99, 102, 241, 0.28);
        --shadow-elevated: none;
        --radius-large: 0;
        --radius-medium: 0;
        --radius-small: 0;
        --space-2xs: 6px;
        --space-xs: 10px;
        --space-sm: 14px;
        --space-md: 18px;
        --space-lg: 24px;
        --space-xl: 32px;
        --space-xxl: 48px;
        --layout-gutter: clamp(24px, 5vw, 60px);
        --layout-gap: clamp(20px, 3vw, 28px);
      }

      :root[data-theme='dark'] {
        --bg-primary: #0b1220;
        --bg-secondary: #0f1a32;
        --bg-tertiary: #14223d;
        --surface: rgba(15, 23, 42, 0.88);
        --surface-strong: rgba(15, 23, 42, 0.94);
        --accent: #5b8aff;
        --accent-strong: #a5b4fc;
        --lavender: #c084fc;
        --success: #4ade80;
        --success-soft: rgba(74, 222, 128, 0.16);
        --warning: #fbbf24;
        --warning-soft: rgba(251, 191, 36, 0.18);
        --danger: #f87171;
        --danger-soft: rgba(248, 113, 113, 0.18);
        --text-primary: #f8fafc;
        --text-secondary: rgba(226, 232, 240, 0.76);
        --border-color: rgba(148, 163, 184, 0.45);
        --border-strong: rgba(99, 102, 241, 0.45);
        --shadow-elevated: 0 28px 64px rgba(8, 47, 73, 0.38);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", "SF Pro Display", -apple-system, system-ui, sans-serif;
        background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-tertiary) 100%);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      body[data-locked='true'] header.app-header,
      body[data-locked='true'] main,
      body[data-locked='true'] footer {
        filter: blur(8px);
        pointer-events: none;
        user-select: none;
        transition: filter 200ms ease;
      }

      .session-lock-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-xl);
        background: radial-gradient(circle at top, rgba(79, 110, 247, 0.36), rgba(31, 42, 68, 0.9));
        backdrop-filter: blur(18px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 220ms ease;
        z-index: 999;
      }

      .session-lock-overlay::before {
        content: "";
        position: absolute;
        inset: 12px;
        border: 1px solid rgba(124, 58, 237, 0.35);
        border-radius: 28px;
        opacity: 0.4;
        pointer-events: none;
      }

      body[data-locked='true'] .session-lock-overlay {
        opacity: 1;
        pointer-events: auto;
      }

      body[data-locked='false'] .session-lock-overlay {
        opacity: 0;
        pointer-events: none;
      }

      .session-lock-card {
        position: relative;
        width: min(720px, 100%);
        background: rgba(14, 20, 35, 0.86);
        border: 1px solid rgba(99, 102, 241, 0.45);
        border-radius: 24px;
        padding: clamp(24px, 4vw, 40px);
        color: #f5f7ff;
        box-shadow: 0 40px 120px rgba(15, 23, 42, 0.45);
        display: flex;
        flex-direction: column;
        gap: clamp(18px, 3vw, 28px);
      }

      .session-lock-header h2 {
        margin: 0;
        font-size: clamp(1.6rem, 3vw, 2.2rem);
      }

      .session-lock-header p {
        margin: 8px 0 0;
        color: rgba(226, 232, 255, 0.8);
        line-height: 1.5;
      }

      .session-lock-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(79, 110, 247, 0.16);
        color: #c7d2fe;
        font-size: 0.75rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .session-lock-status {
        padding: 14px 18px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(148, 163, 209, 0.35);
        font-size: 0.95rem;
        line-height: 1.4;
        color: #e2e8f0;
      }

      .session-lock-status[data-tone='success'] {
        background: rgba(34, 197, 94, 0.16);
        border-color: rgba(34, 197, 94, 0.45);
        color: #bbf7d0;
      }

      .session-lock-status[data-tone='error'] {
        background: rgba(239, 68, 68, 0.18);
        border-color: rgba(239, 68, 68, 0.55);
        color: #fecaca;
      }

      .session-lock-status[data-tone='warning'] {
        background: rgba(245, 158, 11, 0.2);
        border-color: rgba(245, 158, 11, 0.5);
        color: #fde68a;
      }

      .session-lock-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(148, 163, 209, 0.25);
        border-radius: 18px;
        padding: 18px clamp(18px, 3vw, 24px);
      }

      .session-lock-section h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #dbeafe;
      }

      .session-lock-section p {
        margin: 6px 0 0;
        color: rgba(203, 213, 225, 0.84);
        font-size: 0.9rem;
      }

      .session-lock-note {
        display: block;
        margin-top: 6px;
        font-size: 0.85rem;
        color: rgba(165, 180, 252, 0.85);
      }

      .session-lock-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .session-lock-button {
        appearance: none;
        border: 1px solid rgba(99, 102, 241, 0.45);
        background: linear-gradient(135deg, rgba(79, 110, 247, 0.75), rgba(124, 58, 237, 0.8));
        color: #f8fafc;
        padding: 10px 18px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease;
      }

      .session-lock-button.ghost {
        background: rgba(15, 23, 42, 0.8);
        border-color: rgba(148, 163, 209, 0.35);
        color: #c7d2fe;
      }

      .session-lock-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .session-lock-button:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 30px rgba(15, 23, 42, 0.45);
      }

      .session-lock-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .session-lock-form label {
        font-size: 0.85rem;
        color: rgba(191, 219, 254, 0.9);
      }

      .session-lock-form input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 209, 0.4);
        background: rgba(15, 23, 42, 0.65);
        color: #f8fafc;
        font-size: 1rem;
      }

      .session-lock-form input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .session-lock-form input::placeholder {
        color: rgba(148, 163, 209, 0.7);
      }

      .session-lock-form-actions {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
        justify-content: space-between;
      }

      .session-lock-attempts {
        font-size: 0.8rem;
        color: rgba(251, 191, 36, 0.8);
      }

      .session-lock-footer {
        font-size: 0.8rem;
        color: rgba(203, 213, 225, 0.7);
        text-align: center;
      }

      @media (max-width: 720px) {
        .session-lock-card {
          border-radius: 18px;
          padding: 22px;
        }

        .session-lock-actions {
          flex-direction: column;
          align-items: stretch;
        }
      }

      header.app-header,
      main,
      footer {
        width: min(1180px, calc(100% - (var(--layout-gutter) * 2)));
        margin: 0 auto;
      }

      a,
      button {
        font-family: inherit;
        color: inherit;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      header.app-header {
        margin-top: var(--space-xl);
        padding: var(--space-lg) var(--layout-gutter);
        display: flex;
        flex-wrap: wrap;
        gap: var(--layout-gap);
        align-items: center;
        justify-content: space-between;
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 0;
        box-shadow: none;
      }

      .session-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--space-xs);
        min-width: 220px;
      }

      .session-controls-label {
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-secondary);
        font-weight: 600;
      }

      .theme-toggle {
        display: inline-flex;
        gap: 4px;
        padding: 4px;
        border-radius: 999px;
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        box-shadow: var(--shadow-elevated);
      }

      .theme-toggle button {
        border: none;
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        color: var(--text-secondary);
        background: transparent;
        transition: background 160ms ease, color 160ms ease, transform 160ms ease;
      }

      .theme-toggle button:hover,
      .theme-toggle button:focus-visible {
        background: rgba(79, 110, 247, 0.16);
        color: var(--accent-strong);
        outline: none;
      }

      .theme-toggle button[aria-pressed='true'] {
        background: var(--accent);
        color: #0f172a;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.25);
      }

      :root[data-theme='dark'] .theme-toggle button:hover,
      :root[data-theme='dark'] .theme-toggle button:focus-visible {
        background: rgba(165, 180, 252, 0.16);
        color: var(--accent-strong);
      }

      :root[data-theme='dark'] .theme-toggle button[aria-pressed='true'] {
        color: #0f172a;
      }

      .theme-status {
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      .logo-area {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .app-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 64px;
        height: 64px;
        border-radius: 18px;
        background: linear-gradient(135deg, var(--accent-strong), var(--lavender));
        font-weight: 700;
        font-size: 1rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .title-group h1 {
        margin: 0;
        font-size: clamp(1.8rem, 3vw, 2.6rem);
      }

      .title-group p {
        margin: 6px 0 0;
        color: var(--text-secondary);
        max-width: 560px;
        font-size: 0.95rem;
      }

      .status-area {
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: flex-end;
      }

      .status-area + .session-controls {
        margin-left: auto;
      }

      .status-indicator {
        padding: 10px 20px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: var(--success-soft);
        color: var(--success);
        border: 1px solid rgba(34, 197, 94, 0.3);
      }

      .status-indicator::before {
        content: "";
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: currentColor;
        box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
      }

      .status-meta {
        color: var(--text-secondary);
        font-size: 0.85rem;
        display: flex;
        flex-direction: column;
        gap: 6px;
        text-align: right;
      }

      main {
        flex: 1;
        padding: var(--space-xl) 0 calc(var(--space-xl) + var(--space-xxl));
        width: 100%;
      }

      .view {
        display: none;
      }

      .view.active {
        display: block;
        animation: fadeIn 220ms ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .main-layout {
        margin-top: var(--space-lg);
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-auto-rows: minmax(260px, auto);
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 0;
        overflow: hidden;
        gap: 0;
      }

      .main-layout > .app-block {
        padding: var(--space-lg);
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
        background: var(--surface-strong);
        border-left: 1px solid var(--border-color);
        border-top: 1px solid var(--border-color);
      }

      .main-layout > .app-block:nth-child(1),
      .main-layout > .app-block:nth-child(2) {
        border-top: none;
      }

      .main-layout > .app-block:nth-child(1),
      .main-layout > .app-block:nth-child(3) {
        border-left: none;
      }

      .main-layout .card {
        border: none;
        border-radius: 0;
        box-shadow: none;
        padding: 0;
        background: transparent;
      }

      .app-metrics-grid,
      .app-metrics-highlights {
        display: grid;
        gap: var(--space-sm);
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .app-metric,
      .app-highlight {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .app-metric span,
      .app-highlight span {
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-secondary);
      }

      .app-metric strong,
      .app-highlight strong {
        font-size: clamp(1.4rem, 2.4vw, 1.8rem);
        color: var(--text-primary);
      }

      @media (max-width: 960px) {
        .main-layout {
          grid-template-columns: 1fr;
        }

        .main-layout > .app-block {
          border-left: none;
        }

        .main-layout > .app-block:nth-child(2) {
          border-top: 1px solid var(--border-color);
        }
      }

      @media (max-width: 720px) {
        .app-metrics-grid,
        .app-metrics-highlights {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 520px) {
        .app-metrics-grid,
        .app-metrics-highlights {
          grid-template-columns: 1fr;
        }
      }

      .miniapp-list header {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .miniapp-list header h3 {
        margin: 0;
        font-size: 1rem;
      }

      .miniapp-list header p {
        margin: 0;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .miniapp-list header span {
        font-weight: 600;
        color: var(--accent-strong);
      }

      .miniapp-rail {
        margin-top: var(--space-md);
        display: grid;
        gap: var(--space-sm);
      }

      .mini-app-card {
        border-radius: var(--radius-medium);
        border: 1px solid rgba(79, 110, 247, 0.32);
        background: rgba(79, 110, 247, 0.12);
        padding: var(--space-sm) var(--space-md);
        display: grid;
        gap: var(--space-xs);
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease, border 120ms ease;
      }

      .mini-app-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 32px rgba(79, 110, 247, 0.18);
        border-color: rgba(79, 110, 247, 0.48);
      }

      .mini-app-card:focus-visible {
        outline: 2px solid rgba(79, 110, 247, 0.8);
        outline-offset: 3px;
      }

      .mini-app-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-xs);
      }

      .mini-app-chip {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.86);
        color: var(--accent-strong);
        font-size: 0.85rem;
        font-weight: 600;
      }

      .mini-app-title {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .mini-app-meta {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.8rem;
      }

      .icon-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: rgba(79, 110, 247, 0.15);
        color: var(--accent-strong);
        cursor: pointer;
        transition: background 120ms ease, border 120ms ease, transform 120ms ease;
      }

      .icon-button:hover {
        background: rgba(79, 110, 247, 0.24);
      }

      .icon-button:focus-visible {
        outline: 2px solid rgba(79, 110, 247, 0.72);
        outline-offset: 2px;
      }

      .icon-button svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      .client-panel header,
      .miniapp-panel header {
        display: grid;
        gap: 8px;
      }

      .miniapp-panel {
        position: relative;
        transition: box-shadow 160ms ease, border 160ms ease;
      }

      .miniapp-panel.is-collapsed [data-panel-content] {
        display: none;
      }

      .miniapp-panel.is-collapsed [data-panel-close] {
        display: none;
      }

      .miniapp-panel.is-collapsed [data-panel-placeholder] {
        display: grid;
      }

      .miniapp-panel-header {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
      }

      .miniapp-panel-context {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
        flex-wrap: wrap;
      }

      .miniapp-panel-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-sm);
        flex-wrap: wrap;
      }

      .miniapp-panel-meta p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .miniapp-panel-body {
        margin-top: var(--layout-gap);
        display: grid;
        gap: var(--layout-gap);
      }

      .panel-placeholder {
        border-radius: var(--radius-medium);
        border: 1px dashed rgba(148, 163, 184, 0.6);
        background: rgba(148, 163, 184, 0.12);
        min-height: 160px;
        display: none;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: var(--space-lg);
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .panel-content {
        display: grid;
        gap: var(--layout-gap);
      }

      .miniapp-panel-close {
        margin-left: auto;
      }

      .miniapp-panel.is-active {
        border-color: var(--border-strong);
        box-shadow: 0 24px 48px rgba(79, 110, 247, 0.18);
      }

      .client-panel header h2,
      .miniapp-panel header h2 {
        margin: 0;
        font-size: clamp(1.4rem, 2.6vw, 1.8rem);
      }

      .client-panel header p,
      .miniapp-panel header p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .panel-note {
        margin: var(--space-md) 0 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .placeholder-area {
        margin-top: var(--layout-gap);
        border-radius: var(--radius-medium);
        border: 1px dashed rgba(148, 163, 184, 0.5);
        background: rgba(148, 163, 184, 0.12);
      }

      .placeholder-area.large {
        min-height: 220px;
      }

      .master-grid {
        margin-top: var(--layout-gap);
        display: grid;
        gap: var(--layout-gap);
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .master-card {
        border-radius: var(--radius-medium);
        border: 1px dashed rgba(79, 110, 247, 0.36);
        background: rgba(79, 110, 247, 0.06);
        padding: var(--space-lg);
        display: grid;
        gap: var(--space-sm);
      }

      .master-card h3 {
        margin: 0;
        font-size: 1rem;
      }

      .empty-slot {
        border-radius: var(--radius-small);
        border: 1px dashed rgba(148, 163, 184, 0.6);
        background: rgba(255, 255, 255, 0.6);
        min-height: 100px;
      }

      .expansion-master {
        margin-top: var(--layout-gap);
        border-radius: var(--radius-medium);
        border: 1px dashed rgba(79, 110, 247, 0.4);
        background: rgba(79, 110, 247, 0.08);
        padding: var(--space-lg);
        display: grid;
        gap: var(--space-sm);
      }

      .expansion-master h3 {
        margin: 0;
        font-size: 1rem;
      }

      .empty-slot.tall {
        min-height: 160px;
      }

      .card {
        background: var(--surface);
        border-radius: var(--radius-large);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-elevated);
        padding: var(--space-xl);
        backdrop-filter: blur(18px);
      }

      .card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .card header h2,
      .card header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .card header p {
        margin: 4px 0 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .panel-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .primary-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--layout-gap);
        flex-wrap: wrap;
      }

      .eyebrow {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(79, 110, 247, 0.12);
        color: var(--accent-strong);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .primary-header h2 {
        margin: 12px 0 4px;
        font-size: clamp(1.8rem, 3vw, 2.4rem);
      }

      .primary-header .meta {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .status-chip-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .status-chip {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid rgba(79, 110, 247, 0.2);
        background: rgba(79, 110, 247, 0.1);
        color: var(--accent-strong);
      }

      .status-chip--mirror {
        border-color: rgba(79, 110, 247, 0.28);
        background: rgba(79, 110, 247, 0.15);
      }

      .status-chip--safe {
        border-color: rgba(34, 197, 94, 0.25);
        background: var(--success-soft);
        color: var(--success);
      }

      .status-buttons {
        margin-top: var(--layout-gap);
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        align-items: center;
      }

      .status-button {
        border: 1px solid transparent;
        border-radius: 999px;
        padding: 10px 18px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        background: var(--surface-strong);
        color: var(--text-primary);
        transition: transform 120ms ease, box-shadow 120ms ease, border 120ms ease;
      }

      .status-button--new {
        border-color: rgba(245, 158, 11, 0.28);
        background: var(--warning-soft);
        color: var(--warning);
      }

      .status-button--execute {
        border-color: rgba(79, 110, 247, 0.28);
        background: rgba(79, 110, 247, 0.15);
        color: var(--accent-strong);
      }

      .status-button--ready {
        border-color: rgba(34, 197, 94, 0.25);
        background: var(--success-soft);
        color: var(--success);
      }

      .status-button--maintenance {
        border-color: rgba(148, 163, 184, 0.3);
        background: rgba(148, 163, 184, 0.16);
        color: var(--text-secondary);
      }

      .status-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(31, 42, 68, 0.12);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        padding: 10px 18px;
        border-radius: 999px;
        background: rgba(79, 110, 247, 0.12);
        color: var(--accent-strong);
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px dashed rgba(79, 110, 247, 0.4);
      }

      .badge-light {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(79, 110, 247, 0.12);
        color: var(--accent-strong);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .sync-options {
        display: grid;
        gap: var(--layout-gap);
      }

      .option-group {
        display: grid;
        gap: var(--space-xs);
      }

      .group-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-secondary);
        font-weight: 600;
      }

      .option-pills {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-xs);
      }

      .option-pill {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(148, 163, 184, 0.12);
        color: var(--text-secondary);
        font-size: 0.82rem;
        font-weight: 600;
        padding: 8px 16px;
        cursor: pointer;
      }

      .option-pill--active {
        border-color: rgba(79, 110, 247, 0.4);
        background: rgba(79, 110, 247, 0.18);
        color: var(--accent-strong);
      }

      .option-pill--ghost {
        background: rgba(148, 163, 184, 0.08);
      }

      .option-status {
        font-size: 0.78rem;
        color: var(--text-secondary);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .option-status::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
      }

      .option-status--offline {
        color: var(--danger);
      }

      .option-status--mirroring {
        color: var(--accent-strong);
      }

      .operations-highlights {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .operations-highlights > div {
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        padding: 18px;
        display: grid;
        gap: 6px;
      }

      .operations-highlights p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .field-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .form-field {
        display: grid;
        gap: 8px;
        font-size: 0.85rem;
      }

      .form-field span {
        color: var(--text-secondary);
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .form-field input {
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 10px 14px;
        font-size: 0.95rem;
        font-family: inherit;
        color: var(--text-primary);
        background: #ffffff;
        box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.05);
      }

      .form-field input:focus {
        outline: none;
        border-color: rgba(79, 110, 247, 0.6);
        box-shadow: 0 0 0 3px rgba(79, 110, 247, 0.18);
      }

      .inline-note {
        margin-top: var(--layout-gap);
        border-radius: var(--radius-medium);
        border: 1px dashed rgba(79, 110, 247, 0.3);
        background: rgba(79, 110, 247, 0.08);
        padding: var(--space-md) var(--space-lg);
        display: grid;
        gap: var(--space-2xs);
      }

      .inline-note p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .action-bar {
        margin-top: var(--layout-gap);
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
      }

      .action-button {
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: var(--surface-strong);
        padding: 12px 18px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease, border 120ms ease;
      }

      .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(31, 42, 68, 0.12);
      }

      .action-button--tests {
        border-color: rgba(79, 110, 247, 0.35);
      }

      .action-button--audit {
        border-color: rgba(34, 197, 94, 0.3);
      }

      .action-button--control {
        border-color: rgba(245, 158, 11, 0.3);
      }

      .kpi-section {
        display: grid;
        gap: var(--layout-gap);
      }

      .kpi-section header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .kpi-section header p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-md);
      }

      .kpi-card {
        border-radius: var(--radius-medium);
        border: 1px solid rgba(79, 110, 247, 0.18);
        background: rgba(79, 110, 247, 0.12);
        padding: 18px;
        display: grid;
        gap: 8px;
      }

      .kpi-card span {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .kpi-card strong {
        font-size: 1.6rem;
      }

      .kpi-card small {
        color: var(--text-secondary);
        font-size: 0.78rem;
      }

      .insight-section {
        display: grid;
        gap: var(--layout-gap);
      }

      .insight-section header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .insight-section header p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .insight-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: var(--space-md);
      }

      .insight-card {
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        padding: 20px;
        display: grid;
        gap: 12px;
      }

      .insight-card h4 {
        margin: 0;
        font-size: 1rem;
      }

      .insight-card p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .schedule-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: var(--space-sm);
      }

      .schedule-list li {
        display: flex;
        flex-direction: column;
        gap: var(--space-2xs);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-small);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
      }

      .schedule-title {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .schedule-time {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .panel-actions button,
      .pill-button {
        border: 1px solid rgba(79, 110, 247, 0.2);
        padding: 10px 18px;
        border-radius: 999px;
        background: rgba(79, 110, 247, 0.12);
        color: var(--accent-strong);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, box-shadow 120ms ease;
      }

      .panel-actions button:hover,
      .pill-button:hover,
      .toggle:not(:disabled):hover {
        transform: translateY(-1px);
        background: rgba(79, 110, 247, 0.18);
        box-shadow: 0 10px 22px rgba(79, 110, 247, 0.18);
      }

      .panel-body {
        margin-top: var(--layout-gap);
        display: grid;
        gap: var(--layout-gap);
      }

      .status-strip {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: var(--space-md);
      }

      .status-tile {
        border-radius: var(--radius-medium);
        border: 1px solid rgba(59, 130, 246, 0.25);
        background: linear-gradient(145deg, rgba(14, 165, 233, 0.18), rgba(14, 116, 233, 0.12));
        padding: var(--space-md);
      }

      .status-tile strong {
        display: block;
        font-size: 1.6rem;
        margin-bottom: 6px;
      }

      .status-tile span {
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .panel-highlights {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px;
      }

      .highlight-card {
        border-radius: var(--radius-medium);
        background: var(--surface-strong);
        border: 1px solid rgba(148, 163, 184, 0.18);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .highlight-card h4 {
        margin: 0;
        font-size: 1rem;
      }

      .highlight-card p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
        flex: 1;
      }

      .mini-app-summary {
        margin: 18px 0 10px;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .mini-app-summary strong {
        color: var(--text-primary);
      }

      .mini-app-grid {
        margin-top: 12px;
        display: grid;
        gap: 16px;
      }


      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.75rem;
        font-weight: 600;
        background: rgba(148, 163, 184, 0.18);
        color: var(--text-secondary);
      }

      .chip.success {
        background: rgba(34, 197, 94, 0.18);
        color: var(--success);
      }

      .chip.info {
        background: rgba(79, 110, 247, 0.18);
        color: var(--accent-strong);
      }

      .chip.neutral {
        background: rgba(148, 163, 184, 0.14);
        color: var(--text-secondary);
      }

      .chip.warning {
        background: var(--warning-soft);
        color: var(--warning);
      }

      .grid-two {
        margin-top: var(--layout-gap);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: var(--layout-gap);
      }

      .kpi-board {
        display: grid;
        gap: var(--space-sm);
      }

      .kpi-item {
        background: rgba(79, 110, 247, 0.12);
        border: 1px solid rgba(79, 110, 247, 0.3);
        border-radius: var(--radius-medium);
        padding: 16px;
      }

      .kpi-item strong {
        font-size: 1.4rem;
        display: block;
        margin-bottom: 4px;
      }

      .data-card {
        background: var(--surface-strong);
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        padding: 18px;
        display: grid;
        gap: 10px;
      }

      .data-card h4 {
        margin: 0;
        font-size: 1rem;
      }

      .data-card ul {
        margin: 0;
        padding-left: 18px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        display: grid;
        gap: 6px;
      }

      .expansion-area {
        margin-top: var(--layout-gap);
        background: rgba(79, 110, 247, 0.08);
        border: 1px dashed rgba(79, 110, 247, 0.36);
        border-radius: var(--radius-medium);
        padding: var(--space-lg);
      }

      .expansion-area h4 {
        margin: 0 0 var(--space-xs);
      }

      .expansion-area p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .table-wrapper {
        margin-top: var(--layout-gap);
        background: var(--surface-strong);
        border-radius: var(--radius-large);
        border: 1px solid var(--border-color);
        padding: var(--space-lg);
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 640px;
      }

      table thead {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        color: var(--text-secondary);
      }

      table th,
      table td {
        padding: var(--space-sm) var(--space-md);
        border-bottom: 1px solid rgba(187, 195, 216, 0.4);
        text-align: left;
      }

      table tbody tr:last-child td {
        border-bottom: none;
      }

      table td strong {
        color: var(--text-primary);
      }

      .system-tips {
        margin-top: var(--space-lg);
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        padding: var(--space-lg);
        display: grid;
        gap: var(--space-sm);
      }

      .system-tips h4 {
        margin: 0;
        font-size: 1rem;
      }

      .system-tips ul {
        margin: 0;
        padding-left: 18px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        display: grid;
        gap: var(--space-2xs);
      }

      .device-list {
        display: grid;
        gap: 14px;
      }

      .device-card {
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        padding: 16px;
        background: var(--surface-strong);
        display: grid;
        gap: 8px;
      }

      .device-card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .device-card header span {
        font-size: 0.82rem;
        color: var(--text-secondary);
      }

      .device-card ul {
        margin: 0;
        padding-left: 18px;
        color: var(--text-secondary);
        font-size: 0.8rem;
        display: grid;
        gap: 4px;
      }

      .storage-grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .storage-card {
        border-radius: var(--radius-medium);
        border: 1px solid rgba(56, 189, 248, 0.35);
        padding: 16px;
        background: rgba(14, 165, 233, 0.12);
        display: grid;
        gap: 6px;
      }

      .storage-card strong {
        font-size: 0.95rem;
      }

      .storage-card span {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .timeline {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 12px;
      }

      .timeline li {
        position: relative;
        padding-left: 24px;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .timeline li::before {
        content: "";
        position: absolute;
        left: 0;
        top: 6px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent-strong);
        box-shadow: 0 0 10px rgba(79, 110, 247, 0.35);
      }

      .market-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: var(--space-md);
        margin-top: var(--layout-gap);
      }

      .market-card {
        border-radius: var(--radius-medium);
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        padding: var(--space-lg);
        display: grid;
        gap: var(--space-sm);
      }

      .market-card header h4 {
        margin: 0;
        font-size: 1rem;
      }

      .market-card header p {
        margin: 6px 0 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .market-card footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .toggle {
        border: 1px solid rgba(79, 110, 247, 0.25);
        border-radius: 999px;
        padding: 10px 20px;
        background: rgba(79, 110, 247, 0.12);
        color: var(--accent-strong);
        font-weight: 600;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease;
      }

      .toggle:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
        background: rgba(148, 163, 184, 0.2);
        border-color: rgba(148, 163, 184, 0.28);
        color: var(--text-secondary);
      }

      .config-block {
        background: var(--surface-strong);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-medium);
        padding: var(--space-lg);
        margin-top: var(--layout-gap);
      }

      .config-block h4 {
        margin: 0 0 var(--space-sm);
      }

      .config-block pre {
        margin: 0;
        white-space: pre-wrap;
        font-size: 0.8rem;
        color: var(--text-secondary);
        max-height: 320px;
        overflow-y: auto;
        background: #f6f7ff;
        border-radius: var(--radius-small);
        padding: var(--space-md);
        border: 1px solid var(--border-color);
      }

      a.back-action {
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
        margin-top: var(--layout-gap);
        font-size: 0.9rem;
        text-decoration: none;
        color: var(--accent);
        font-weight: 600;
      }

      a.back-action svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }

      footer {
        margin-top: auto;
        padding: var(--space-lg) var(--layout-gutter) var(--space-xl);
        display: flex;
        justify-content: space-between;
        gap: var(--layout-gap);
        flex-wrap: wrap;
        align-items: center;
        font-size: 0.85rem;
        color: var(--text-secondary);
        border-top: 1px solid var(--border-color);
        background: var(--surface);
        border-radius: 0;
        box-shadow: none;
      }

      .footer-brand {
        display: flex;
        align-items: center;
      }

      .footer-brand img {
        height: 32px;
        object-fit: contain;
        display: block;
      }

      .footer-content {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        align-items: center;
      }

      @media (max-width: 1200px) {
        .status-area {
          align-items: flex-start;
        }

        .status-meta {
          text-align: left;
        }

        .session-controls {
          align-items: flex-start;
          min-width: unset;
        }

        .status-area + .session-controls {
          margin-left: 0;
        }
      }

      @media (max-width: 720px) {
        :root {
          --layout-gutter: 20px;
          --layout-gap: 20px;
        }

        header.app-header {
          padding: var(--space-lg) var(--layout-gutter);
        }

        main {
          padding: var(--space-lg) 0 calc(var(--space-lg) + var(--space-xl));
        }

        footer {
          padding: var(--space-lg) var(--layout-gutter) var(--space-xl);
        }

        table {
          min-width: 520px;
        }
      }
    </style>
  </head>
  <body data-locked="true">
    <section
      class="session-lock-overlay"
      data-lock-overlay
      role="alertdialog"
      aria-modal="true"
      aria-labelledby="session-lock-title"
      aria-live="assertive"
    >
      <div class="session-lock-card">
        <header class="session-lock-header">
          <span class="session-lock-badge">Tenant Secure Gate</span>
          <h2 id="session-lock-title">Sessão protegida</h2>
          <p data-lock-hint>
            Esta estação exige validação de credenciais antes de carregar os mini-apps
            do tenant.
          </p>
        </header>
        <div class="session-lock-status" data-lock-status data-tone="neutral">
          Preparando mecanismos de autenticação seguro...
        </div>
        <section class="session-lock-section">
          <header>
            <h3>Passkey / WebAuthn</h3>
            <p>
              Preferencial para dispositivos com biometria ou chaves de segurança.
              <span data-lock-biometric class="session-lock-note"></span>
            </p>
          </header>
          <div class="session-lock-actions">
            <button type="button" class="session-lock-button" data-action="lock-webauthn-signin">
              Entrar com passkey
            </button>
            <button type="button" class="session-lock-button ghost" data-action="lock-webauthn-register">
              Registrar novo dispositivo
            </button>
          </div>
        </section>
        <section class="session-lock-section">
          <header>
            <h3>Fallback PIN</h3>
            <p>Utilize este canal apenas quando passkeys não estiverem disponíveis.</p>
          </header>
          <form class="session-lock-form" data-lock-pin-login novalidate>
            <label for="lock-pin-input">PIN ou senha curta</label>
            <input
              id="lock-pin-input"
              type="password"
              inputmode="numeric"
              pattern="[0-9]*"
              minlength="4"
              maxlength="12"
              autocomplete="one-time-code"
              data-lock-pin-input
              placeholder="••••"
              required
            />
            <div class="session-lock-form-actions">
              <button type="button" class="session-lock-button" data-action="lock-pin-signin">
                Desbloquear com PIN
              </button>
              <span class="session-lock-attempts" data-lock-attempts></span>
            </div>
          </form>
        </section>
        <section class="session-lock-section" data-lock-admin>
          <header>
            <h3>Fluxo administrativo</h3>
            <p>Cadastro inicial, rotação de credenciais ou reset de emergência.</p>
          </header>
          <form class="session-lock-form" data-lock-admin-form novalidate>
            <label for="lock-admin-token">Token administrativo do tenant</label>
            <input
              id="lock-admin-token"
              type="password"
              autocomplete="off"
              data-lock-admin-token
              placeholder="Token emitido pelo backend"
              required
            />
            <div class="session-lock-form-actions">
              <button type="button" class="session-lock-button" data-action="lock-admin-validate">
                Validar token
              </button>
              <button type="button" class="session-lock-button ghost" data-action="lock-admin-reset">
                Resetar PIN cadastrado
              </button>
            </div>
          </form>
          <form class="session-lock-form" data-lock-pin-setup novalidate>
            <label for="lock-pin-new">Cadastrar ou atualizar PIN</label>
            <input
              id="lock-pin-new"
              type="password"
              inputmode="numeric"
              pattern="[0-9]*"
              minlength="4"
              maxlength="12"
              data-lock-pin-new
              placeholder="Novo PIN"
              required
              disabled
            />
            <input
              type="password"
              inputmode="numeric"
              pattern="[0-9]*"
              minlength="4"
              maxlength="12"
              data-lock-pin-confirm
              placeholder="Confirmar PIN"
              required
              disabled
            />
            <div class="session-lock-form-actions">
              <button type="button" class="session-lock-button" data-action="lock-pin-set" disabled>
                Salvar PIN seguro
              </button>
            </div>
          </form>
        </section>
        <footer class="session-lock-footer">
          <p>
            Auditoria: tentativas excedidas são reportadas automaticamente ao serviço de
            segurança do tenant.
          </p>
        </footer>
      </div>
    </section>
    <header class="app-header">
      <!-- BEGIN: logo-picture-responsive -->
      <picture>
        <source srcset="/Projeto-marco/assets/app/brand/logo-dark-800.webp 800w, /Projeto-marco/assets/app/brand/logo-dark-400.webp 400w" media="(prefers-color-scheme: dark)" type="image/webp">
        <source srcset="/Projeto-marco/assets/app/brand/logo-light-800.webp 800w, /Projeto-marco/assets/app/brand/logo-light-400.webp 400w" media="(prefers-color-scheme: light)" type="image/webp">
        <img src="/Projeto-marco/assets/app/brand/logo-light-400.webp" alt="Logo 5 Horas" width="400" height="100" loading="eager" decoding="async">
      </picture>
      <!-- END: logo-picture-responsive -->
      <div class="logo-area">
        <div class="app-badge">Marco</div>
        <div class="title-group">
          <h1>Marco · AppBase + MiniApps</h1>
          <p>
            Aplicativo demonstrativo do Sistema Operacional Marco, com AppBase local-first
            carregando mini-apps habilitados por tenant e respeitando os contratos do
            blueprint consolidado.
          </p>
        </div>
      </div>
      <div class="status-area">
        <span class="status-indicator" data-ref="status-indicator">Sessão ativa</span>
        <div class="status-meta">
          <span data-ref="status-tenant">Tenant:</span>
          <span data-ref="status-user">Usuário:</span>
          <span data-ref="status-storage">Armazenamento vinculado:</span>
          <span data-ref="status-sync">Último sync:</span>
          <span data-ref="status-ready">Tempo até READY:</span>
        </div>
      </div>
      <div class="session-controls">
        <span class="session-controls-label">Preferências</span>
        <div class="theme-toggle" role="group" aria-label="Alternar tema do AppBase">
          <button type="button" data-theme-toggle="light" aria-pressed="false">Claro</button>
          <button type="button" data-theme-toggle="dark" aria-pressed="false">Escuro</button>
          <button type="button" data-theme-toggle="auto" aria-pressed="true">Auto</button>
        </div>
        <span class="theme-status" data-theme-current>Tema automático</span>
      </div>
    </header>

    <main>
      <section id="tela-principal" class="view active">
        <div class="main-layout">
          <section class="card app-block miniapp-list">
            <header>
              <h3>Mini-app resumos</h3>
              <p>
                <span data-ref="miniapp-count">0</span> habilitados para
                <span data-ref="summary-tenant">-</span>
              </p>
            </header>
            <div class="miniapp-rail" id="mini-app-grid"></div>
          </section>
          <section class="card app-block app-metrics">
            <header>
              <span class="eyebrow">Indicadores</span>
              <h2>Snapshot operacional</h2>
              <p>Resumo rápido de fluxo, capacidade e alertas do tenant ativo.</p>
            </header>
            <div class="app-metrics-grid">
              <article class="app-metric">
                <span>Fluxo de tarefas</span>
                <strong data-ref="metric-task-flow">—</strong>
              </article>
              <article class="app-metric">
                <span>Capacidade</span>
                <strong data-ref="metric-capacity">—</strong>
              </article>
              <article class="app-metric">
                <span>Alertas</span>
                <strong data-ref="metric-alerts">—</strong>
              </article>
            </div>
            <div class="app-metrics-highlights">
              <article class="app-highlight">
                <span>Aprovações</span>
                <strong data-ref="highlight-approvals">—</strong>
              </article>
              <article class="app-highlight">
                <span>Equipes em campo</span>
                <strong data-ref="highlight-field-teams">—</strong>
              </article>
              <article class="app-highlight">
                <span>Tarefas críticas</span>
                <strong data-ref="highlight-priority">—</strong>
              </article>
            </div>
          </section>
          <section class="card app-block client-panel">
            <header>
              <span class="eyebrow">Painel cliente</span>
              <h2>Painel principal</h2>
              <p>Área reservada para os componentes do cliente conforme o desenho base.</p>
            </header>
            <div class="placeholder-area large"></div>
          </section>
          <section
            class="card app-block miniapp-panel is-collapsed"
            id="miniapp-panel-card"
            aria-live="polite"
          >
            <header class="miniapp-panel-header">
              <div class="miniapp-panel-context">
                <span class="mini-app-chip" data-panel-chip>Mini-app não selecionado</span>
                <button
                  type="button"
                  class="icon-button"
                  data-panel-menu
                  aria-label="Abrir MiniAppPanel"
                  aria-expanded="false"
                >
                  <svg viewBox="0 0 16 16" aria-hidden="true">
                    <path
                      d="M2.5 8a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm4 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm4 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z"
                    />
                  </svg>
                  <span class="sr-only">Alternar MiniAppPanel</span>
                </button>
              </div>
              <div class="miniapp-panel-meta">
                <p data-panel-meta>Selecione um mini-app na coluna à esquerda para visualizar os masters.</p>
                <button type="button" class="pill-button miniapp-panel-close" data-panel-close hidden>
                  Fechar painel
                </button>
              </div>
            </header>
            <div class="miniapp-panel-body">
              <div class="panel-placeholder" data-panel-placeholder>
                Selecione um mini-app na coluna à esquerda e utilize o menu de três pontos para abrir o MiniAppPanel.
              </div>
              <div class="panel-content" data-panel-content hidden></div>
            </div>
          </section>
        </div>
      </section>

      <template id="panel-template-operations">
        <div class="master-grid">
          <div class="master-card">
            <h3>KPIs do sistema</h3>
            <div class="empty-slot"></div>
          </div>
          <div class="master-card">
            <h3>Dados / Resumos</h3>
            <div class="empty-slot"></div>
          </div>
          <div class="master-card">
            <h3>Outros painéis</h3>
            <div class="empty-slot"></div>
          </div>
        </div>
        <div class="expansion-master">
          <h3>Área p/ expandir</h3>
          <div class="empty-slot tall"></div>
        </div>
      </template>

      <template id="panel-template-tasks">
        <p class="panel-note">
          O painel mestre do Gestor de Tarefas apresentará filtros, status e próximos cards definidos nesta fase.
        </p>
        <div class="placeholder-area large"></div>
      </template>

      <template id="panel-template-account">
        <p class="panel-note">
          Área reservada para vincular dispositivos, backups e livros-razão diretamente no painel central.
        </p>
        <div class="placeholder-area large"></div>
      </template>

      <template id="panel-template-market">
        <p class="panel-note">
          Em breve: catálogo compacto para habilitar ou revogar licenças sem sair da Home.
        </p>
        <div class="placeholder-area large"></div>
      </template>

      <template id="panel-template-settings">
        <p class="panel-note">
          Configurações rápidas do tenant, schemas registrados e observabilidade sumarizada aparecerão aqui.
        </p>
        <div class="placeholder-area large"></div>
      </template>

      <section id="mini-app-painel" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app • Painel de Operações</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Painel de Operações</span>
              </p>
            </div>
          </header>
          <p class="panel-note">Masters base preparados para receber os subcards.</p>
          <div class="master-grid">
            <div class="master-card">
              <h3>KPIs do sistema</h3>
              <div class="empty-slot"></div>
            </div>
            <div class="master-card">
              <h3>Dados / Resumos</h3>
              <div class="empty-slot"></div>
            </div>
            <div class="master-card">
              <h3>Outros painéis</h3>
              <div class="empty-slot"></div>
            </div>
          </div>
          <div class="expansion-master">
            <h3>Área p/ expandir</h3>
            <div class="empty-slot tall"></div>
          </div>
          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>

      <section id="mini-app-tarefas" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app • Gestor de Tarefas</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Gestor de Tarefas</span>
              </p>
            </div>
            <div class="panel-actions">
              <button type="button">Criar nova tarefa</button>
              <button type="button">Exportar planilha</button>
            </div>
          </header>

          <div class="chip-row" style="margin-top: 16px">
            <span class="chip info">Filtro: Hoje</span>
            <span class="chip neutral">Owner: Todos</span>
            <span class="chip warning">4 itens críticos</span>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th scope="col">Tarefas</th>
                  <th scope="col">Responsáveis</th>
                  <th scope="col">Datas</th>
                  <th scope="col">Status</th>
                  <th scope="col">Dados consumidos</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Revisar contrato principal</strong></td>
                  <td>Carla Nogueira</td>
                  <td>12/03 → 14/03</td>
                  <td>
                    <span
                      class="status-indicator"
                      style="background: rgba(56, 189, 248, 0.15); color: var(--accent)"
                      >Em curso</span
                    >
                  </td>
                  <td>Base jurídica v2</td>
                </tr>
                <tr>
                  <td><strong>Sincronizar planilha de fornecedores</strong></td>
                  <td>Equipe Operações</td>
                  <td>12/03 → 13/03</td>
                  <td>
                    <span
                      class="status-indicator"
                      style="background: rgba(34, 197, 94, 0.15); color: var(--success)"
                      >Concluído</span
                    >
                  </td>
                  <td>Inventário homologado</td>
                </tr>
                <tr>
                  <td><strong>Testar backups incrementais</strong></td>
                  <td>Marcos Lima</td>
                  <td>11/03 → 15/03</td>
                  <td>
                    <span
                      class="status-indicator"
                      style="background: rgba(249, 115, 22, 0.15); color: var(--warning)"
                      >Atenção</span
                    >
                  </td>
                  <td>Snapshots AWS 22h</td>
                </tr>
                <tr>
                  <td><strong>Validar checklist de campo</strong></td>
                  <td>Fernanda Dias</td>
                  <td>10/03 → 12/03</td>
                  <td>
                    <span
                      class="status-indicator"
                      style="background: rgba(239, 68, 68, 0.15); color: var(--danger)"
                      >Crítico</span
                    >
                  </td>
                  <td>Dossiê Equipes Norte</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="system-tips">
            <h4>Dicas do sistema</h4>
            <ul>
              <li>Use filtros por status para focar nos itens críticos do dia.</li>
              <li>Os cartões de dados consumidos indicam a fonte principal da tarefa.</li>
              <li>Atualizações automáticas acontecem a cada 15 minutos.</li>
            </ul>
          </div>

          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>

      <section id="mini-app-conta" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app • Conta & Backup</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Conta & Backup</span>
              </p>
            </div>
            <div class="panel-actions">
              <button type="button">Gerar link mágico</button>
              <button type="button">Desvincular dispositivo</button>
            </div>
          </header>

          <div class="grid-two">
            <div class="data-card">
              <h4>Identidade & Sessão</h4>
              <ul>
                <li>
                  Tenant atual: <strong data-ref="detail-tenant">-</strong>
                </li>
                <li>
                  Usuário autenticado: <strong data-ref="detail-user">-</strong>
                </li>
                <li>
                  Login unificado: <span data-ref="detail-logins">-</span>
                </li>
                <li>
                  Modo quiosque: <span data-ref="detail-kiosk">-</span>
                </li>
              </ul>
            </div>
            <div class="data-card">
              <h4>Backup & Storage</h4>
              <ul>
                <li>Backup automático: <strong data-ref="detail-backup">-</strong></li>
                <li>Arquivos sincronizados: <span data-ref="detail-files">-</span></li>
                <li>Última exportação: <span data-ref="detail-export">-</span></li>
              </ul>
            </div>
          </div>

          <div class="storage-grid" id="storage-grid"></div>

          <div class="grid-two">
            <div class="data-card">
              <h4>Dispositivos ativos</h4>
              <div class="device-list" id="device-list"></div>
            </div>
            <div class="data-card">
              <h4>Livro-razão de conformidade</h4>
              <ul class="timeline" id="audit-timeline"></ul>
            </div>
          </div>

          <div class="system-tips">
            <h4>Direitos do titular prontos para 1 clique</h4>
            <ul>
              <li>Acesso completo aos dados exportando o envelope único.</li>
              <li>Retificação centralizada com versionamento por schema.</li>
              <li>Exclusão total com janela de segurança e recibo.</li>
            </ul>
          </div>

          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>

      <section id="mini-app-market" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app • Marketplace</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Marketplace</span>
              </p>
            </div>
            <div class="panel-actions">
              <button type="button">Atualizar catálogos</button>
              <button type="button">Ver licenças ativas</button>
            </div>
          </header>

          <div class="market-grid" id="market-grid"></div>

          <div class="system-tips">
            <h4>Como funciona o marketplace</h4>
            <ul>
              <li>Mini-apps obrigatórios ficam bloqueados para desativação.</li>
              <li>Ativações refletem imediatamente na Home e no AppBase.</li>
              <li>
                Licenças adicionais habilitam recursos como backup multi-dispositivo.
              </li>
            </ul>
          </div>

          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>

      <section id="mini-app-config" class="view">
        <section class="card">
          <header>
            <div>
              <h2>Mini-app • Configuração & Operação</h2>
              <p class="breadcrumbs">
                <span>Home</span><span>Mini-apps</span><span>Configuração</span>
              </p>
            </div>
            <div class="panel-actions">
              <button type="button">Exportar config</button>
              <button type="button">Ver auditoria</button>
            </div>
          </header>

          <div class="config-block">
            <h4>Configuração resolvida</h4>
            <pre id="config-json"></pre>
          </div>

          <div class="grid-two">
            <div class="data-card">
              <h4>Checklist LGPD-first</h4>
              <ul>
                <li>Consentimentos com recibo individual</li>
                <li>Exportação 1-clique no envelope comum</li>
                <li>Retenção configurável por MiniApp</li>
              </ul>
            </div>
            <div class="data-card">
              <h4>Observabilidade</h4>
              <ul>
                <li>Eventos críticos monitorados em tempo real</li>
                <li>KPIs alinhados ao blueprint R1.0</li>
                <li>Logs assinados por tenant e usuário</li>
              </ul>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th scope="col">Evento</th>
                  <th scope="col">Última captura</th>
                  <th scope="col">Notas</th>
                </tr>
              </thead>
              <tbody id="observability-table"></tbody>
            </table>
          </div>

          <a class="back-action" data-action="home" href="#">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path
                d="M12.707 15.707a1 1 0 01-1.414 0L5.586 10l5.707-5.707a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z"
              />
            </svg>
            Voltar para a tela principal
          </a>
        </section>
      </section>
    </main>

    <footer>
      <div class="footer-brand">
        <img
          src="https://5horas.com.br/wp-content/uploads/2025/09/Logo-Banner2.png"
          alt="Logo 5horas"
          loading="lazy"
        />
      </div>
      <div class="footer-content">
        <span>© 2024 Marco • Sistema Operacional Modular</span>
        <span>Versão 0.2.0 • Protótipo navegável AppBase + MiniApps</span>
      </div>
    </footer>

    <script>
      const tenantContext = { tenantId: null, userId: null };
      const GLOBAL_THEME_KEY = 'marco::global::theme-preference';
      let themePreferenceKey = GLOBAL_THEME_KEY;
      let themeControlElements = null;
      let currentThemeMode = null;
      let themeMediaQuery = null;

      function resolveSystemTheme() {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function updateThemeIndicators(mode, resolved) {
        if (!themeControlElements) {
          return;
        }
        themeControlElements.buttons.forEach((button) => {
          button.setAttribute('aria-pressed', button.dataset.themeToggle === mode ? 'true' : 'false');
        });
        if (themeControlElements.statusEl) {
          let label = '';
          if (mode === 'dark') {
            label = 'Tema escuro ativo';
          } else if (mode === 'light') {
            label = 'Tema claro ativo';
          } else {
            label = `Tema automático (${resolved === 'dark' ? 'escuro' : 'claro'})`;
          }
          themeControlElements.statusEl.textContent = label;
        }
      }

      function handleSystemThemeChange() {
        if (currentThemeMode !== 'auto') {
          return;
        }
        const resolved = resolveSystemTheme();
        document.documentElement.dataset.theme = resolved;
        updateThemeIndicators('auto', resolved);
      }

      function configureThemeWatcher(mode) {
        if (themeMediaQuery) {
          themeMediaQuery.removeEventListener('change', handleSystemThemeChange);
          themeMediaQuery = null;
        }
        if (mode === 'auto') {
          themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
          themeMediaQuery.addEventListener('change', handleSystemThemeChange);
        }
      }

      function setThemeMode(mode, { persist = true } = {}) {
        const root = document.documentElement;
        const resolved = mode === 'auto' ? resolveSystemTheme() : mode;
        currentThemeMode = mode;
        root.dataset.themeMode = mode;
        root.dataset.theme = resolved;
        if (persist) {
          localStorage.setItem(themePreferenceKey, mode);
        }
        configureThemeWatcher(mode);
        updateThemeIndicators(mode, resolved);
      }

      function handleThemeToggle(event) {
        const mode = event.currentTarget?.dataset.themeToggle ?? 'auto';
        setThemeMode(mode);
      }

      function resolveThemePreference() {
        const stored = localStorage.getItem(themePreferenceKey);
        if (stored) {
          return stored;
        }
        if (themePreferenceKey !== GLOBAL_THEME_KEY) {
          const fallback = localStorage.getItem(GLOBAL_THEME_KEY);
          if (fallback) {
            localStorage.setItem(themePreferenceKey, fallback);
            return fallback;
          }
        }
        return 'auto';
      }

      function attachThemeListeners() {
        if (!themeControlElements) {
          return;
        }
        themeControlElements.buttons.forEach((button) => {
          button.removeEventListener('click', handleThemeToggle);
          button.addEventListener('click', handleThemeToggle);
        });
      }

      function initThemeControls(force = false) {
        const buttons = Array.from(document.querySelectorAll('[data-theme-toggle]'));
        if (!buttons.length) {
          return;
        }
        const statusEl = document.querySelector('[data-theme-current]');
        themeControlElements = { buttons, statusEl };

        const tenantId = tenantContext?.tenantId ?? null;
        const nextKey = tenantId ? `marco::${tenantId}::theme-preference` : GLOBAL_THEME_KEY;
        const keyChanged = themePreferenceKey !== nextKey;
        themePreferenceKey = nextKey;

        if (force || keyChanged || currentThemeMode === null) {
          const preference = resolveThemePreference();
          setThemeMode(preference, { persist: false });
        } else {
          updateThemeIndicators(currentThemeMode, document.documentElement.dataset.theme);
        }

        attachThemeListeners();
      }

      const lockOverlay = document.querySelector('[data-lock-overlay]');
      const sessionLock = createSessionLock(lockOverlay);
      const authUI = createAuthUI(lockOverlay);
      const authController = createAuthController(sessionLock, authUI, tenantContext);

      initThemeControls();
      authController.initialise();

      const views = document.querySelectorAll('.view');
      const appRoot = document.documentElement;
      const panelCard = document.getElementById('miniapp-panel-card');
      const panelContent = panelCard?.querySelector('[data-panel-content]');
      const panelPlaceholder = panelCard?.querySelector('[data-panel-placeholder]');
      const panelChip = panelCard?.querySelector('[data-panel-chip]');
      const panelMeta = panelCard?.querySelector('[data-panel-meta]');
      const panelClose = panelCard?.querySelector('[data-panel-close]');
      const panelMenu = panelCard?.querySelector('[data-panel-menu]');
      let activePanelKey = null;
      let activePanelTrigger = null;

      function activateView(id) {
        views.forEach((view) => {
          view.classList.toggle('active', view.id === id);
        });
        if (window.scrollY > 0) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        appRoot.setAttribute('data-view', id);
      }

      function createSessionLock(overlay) {
        const body = document.body;
        let locked = body.dataset.locked !== 'false';
        let resolver = null;
        let releasePromise = locked
          ? new Promise((resolve) => {
              resolver = resolve;
            })
          : Promise.resolve();

        function syncOverlay() {
          if (!overlay) {
            return;
          }
          overlay.setAttribute('aria-hidden', locked ? 'false' : 'true');
          if (locked) {
            overlay.setAttribute('tabindex', '-1');
            requestAnimationFrame(() => {
              overlay.focus?.();
            });
          } else {
            overlay.removeAttribute('tabindex');
          }
        }

        syncOverlay();

        function setLocked(state, reason) {
          if (state === locked) {
            return;
          }
          locked = state;
          body.dataset.locked = locked ? 'true' : 'false';
          syncOverlay();
          if (!locked) {
            resolver?.();
            resolver = null;
            releasePromise = Promise.resolve();
          } else {
            releasePromise = new Promise((resolve) => {
              resolver = resolve;
            });
          }
          if (reason) {
            console.info(`[SessionLock] estado=${locked ? 'locked' : 'unlocked'} • ${reason}`);
          }
        }

        return {
          isLocked: () => locked,
          release(reason) {
            setLocked(false, reason ?? 'liberação solicitada');
          },
          lock(reason) {
            setLocked(true, reason ?? 'bloqueio solicitado');
          },
          waitForRelease() {
            return locked ? releasePromise : Promise.resolve();
          },
        };
      }

      function createAuthUI(overlay) {
        const statusEl = overlay?.querySelector('[data-lock-status]');
        const hintEl = overlay?.querySelector('[data-lock-hint]');
        const biometricEl = overlay?.querySelector('[data-lock-biometric]');
        const attemptsEl = overlay?.querySelector('[data-lock-attempts]');
        const pinSetupInputs = overlay
          ? Array.from(overlay.querySelectorAll('[data-lock-pin-new], [data-lock-pin-confirm]'))
          : [];
        const pinSetupButton = overlay?.querySelector('[data-action="lock-pin-set"]');

        return {
          setStatus(message, tone = 'neutral') {
            if (!statusEl) {
              return;
            }
            statusEl.textContent = message;
            statusEl.dataset.tone = tone;
          },
          setHint(message) {
            if (hintEl) {
              hintEl.textContent = message;
            }
          },
          setBiometric(message) {
            if (biometricEl) {
              biometricEl.textContent = message;
            }
          },
          setAttempts(message) {
            if (attemptsEl) {
              attemptsEl.textContent = message;
            }
          },
          enablePinSetup(enabled) {
            pinSetupInputs.forEach((input) => {
              if (enabled) {
                input.removeAttribute('disabled');
              } else {
                input.setAttribute('disabled', '');
              }
            });
            if (pinSetupButton) {
              if (enabled) {
                pinSetupButton.removeAttribute('disabled');
              } else {
                pinSetupButton.setAttribute('disabled', '');
              }
            }
          },
          overlay,
        };
      }

      function createAuthController(sessionLockController, ui, context) {
        const MAX_PIN_ATTEMPTS = 5;
        const AUTH_BASE_URL = 'https://auth.marco.app/tenants';
        const pinInput = lockOverlay?.querySelector('[data-lock-pin-input]');
        const pinSignInButton = lockOverlay?.querySelector('[data-action="lock-pin-signin"]');
        const pinNewInput = lockOverlay?.querySelector('[data-lock-pin-new]');
        const pinConfirmInput = lockOverlay?.querySelector('[data-lock-pin-confirm]');
        const pinSetupForm = lockOverlay?.querySelector('[data-lock-pin-setup]');
        const adminTokenInput = lockOverlay?.querySelector('[data-lock-admin-token]');
        const adminValidateButton = lockOverlay?.querySelector('[data-action="lock-admin-validate"]');
        const adminResetButton = lockOverlay?.querySelector('[data-action="lock-admin-reset"]');
        const pinLoginForm = lockOverlay?.querySelector('[data-lock-pin-login]');
        const webauthnSignInButton = lockOverlay?.querySelector('[data-action="lock-webauthn-signin"]');
        const webauthnRegisterButton = lockOverlay?.querySelector('[data-action="lock-webauthn-register"]');
        let adminValidated = false;
        let conditionalMediationAvailable = false;
        let attemptedConditionalFlow = false;

        pinLoginForm?.addEventListener('submit', (event) => event.preventDefault());
        pinSetupForm?.addEventListener('submit', (event) => event.preventDefault());

        webauthnSignInButton?.addEventListener('click', () => handlePasskeySignIn());
        webauthnRegisterButton?.addEventListener('click', () => handlePasskeyRegistration());
        pinSignInButton?.addEventListener('click', () => handlePinUnlock());
        pinSetupForm
          ?.querySelector('[data-action="lock-pin-set"]')
          ?.addEventListener('click', () => handlePinSetup());
        adminValidateButton?.addEventListener('click', () => handleAdminValidation());
        adminResetButton?.addEventListener('click', () => handleAdminReset());

        function storageKey(suffix) {
          const tenant = context.tenantId ?? 'default';
          return `marco::${tenant}::${suffix}`;
        }

        function getPinRecord() {
          const raw = localStorage.getItem(storageKey('pin-record'));
          if (!raw) {
            return null;
          }
          try {
            return JSON.parse(raw);
          } catch (error) {
            console.warn('Registro de PIN inválido, limpando...', error);
            localStorage.removeItem(storageKey('pin-record'));
            return null;
          }
        }

        function savePinRecord(record) {
          localStorage.setItem(storageKey('pin-record'), JSON.stringify(record));
          resetAttempts();
        }

        function clearPinRecord() {
          localStorage.removeItem(storageKey('pin-record'));
          resetAttempts();
        }

        function getAttempts() {
          const value = sessionStorage.getItem(storageKey('pin-attempts'));
          return value ? Number(value) : 0;
        }

        function setAttempts(value) {
          sessionStorage.setItem(storageKey('pin-attempts'), String(value));
          updateAttemptsLabel(value);
        }

        function resetAttempts() {
          sessionStorage.removeItem(storageKey('pin-attempts'));
          updateAttemptsLabel(0);
        }

        function updateAttemptsLabel(current = getAttempts()) {
          const record = getPinRecord();
          if (!record) {
            ui.setAttempts('Nenhum PIN cadastrado.');
            return;
          }
          const remaining = Math.max(MAX_PIN_ATTEMPTS - current, 0);
          ui.setAttempts(`Tentativas restantes: ${remaining}`);
          if (remaining <= 0) {
            pinSignInButton?.setAttribute('disabled', '');
          } else {
            pinSignInButton?.removeAttribute('disabled');
          }
        }

        function ensureContext() {
          if (!context.tenantId) {
            throw new Error('Tenant ainda não configurado.');
          }
        }

        function updateHint() {
          if (context.tenantId) {
            ui.setHint(
              `Tenant ${context.tenantId} exige desbloqueio com passkey ou PIN derivado com WebCrypto antes de carregar o AppBase.`,
            );
          }
        }

        function updateAdminState(valid) {
          adminValidated = valid;
          ui.enablePinSetup(valid);
        }

        function bufferToBase64Url(buffer) {
          const bytes = buffer instanceof ArrayBuffer ? new Uint8Array(buffer) : new Uint8Array(buffer.buffer ?? buffer);
          let binary = '';
          bytes.forEach((byte) => {
            binary += String.fromCharCode(byte);
          });
          return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
        }

        function base64UrlToBuffer(value) {
          const normalised = value.replace(/-/g, '+').replace(/_/g, '/');
          const pad = normalised.length % 4;
          const padded = pad ? normalised + '='.repeat(4 - pad) : normalised;
          const binary = atob(padded);
          const bytes = new Uint8Array(binary.length);
          for (let index = 0; index < binary.length; index += 1) {
            bytes[index] = binary.charCodeAt(index);
          }
          return bytes.buffer;
        }

        function randomBuffer(length) {
          const bytes = new Uint8Array(length);
          crypto.getRandomValues(bytes);
          return bytes.buffer;
        }

        async function derivePin(secret, saltBase64, iterations = 120000) {
          const encoder = new TextEncoder();
          const saltBuffer = saltBase64 ? base64UrlToBuffer(saltBase64) : randomBuffer(16);
          const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(secret), 'PBKDF2', false, [
            'deriveBits',
          ]);
          const derivedBits = await crypto.subtle.deriveBits(
            {
              name: 'PBKDF2',
              hash: 'SHA-256',
              salt: saltBuffer,
              iterations,
            },
            keyMaterial,
            256,
          );
          return {
            hash: bufferToBase64Url(derivedBits),
            salt: bufferToBase64Url(saltBuffer),
            iterations,
          };
        }

        function normaliseRegistrationOptions(payload) {
          const publicKey = payload?.publicKey ?? payload;
          if (!publicKey) {
            throw new Error('Challenge de registro inválido.');
          }
          if (publicKey.challenge && typeof publicKey.challenge === 'string') {
            publicKey.challenge = base64UrlToBuffer(publicKey.challenge);
          }
          if (publicKey.user?.id && typeof publicKey.user.id === 'string') {
            publicKey.user.id = base64UrlToBuffer(publicKey.user.id);
          }
          if (Array.isArray(publicKey.excludeCredentials)) {
            publicKey.excludeCredentials = publicKey.excludeCredentials.map((item) => ({
              ...item,
              id: typeof item.id === 'string' ? base64UrlToBuffer(item.id) : item.id,
            }));
          }
          return publicKey;
        }

        function normaliseAuthenticationOptions(payload) {
          const publicKey = payload?.publicKey ?? payload;
          if (!publicKey) {
            throw new Error('Challenge de autenticação inválido.');
          }
          if (publicKey.challenge && typeof publicKey.challenge === 'string') {
            publicKey.challenge = base64UrlToBuffer(publicKey.challenge);
          }
          if (Array.isArray(publicKey.allowCredentials)) {
            publicKey.allowCredentials = publicKey.allowCredentials.map((item) => ({
              ...item,
              id: typeof item.id === 'string' ? base64UrlToBuffer(item.id) : item.id,
            }));
          }
          return publicKey;
        }

        function buildFallbackRegistrationOptions() {
          const rpId = window.location.hostname || 'localhost';
          return {
            challenge: randomBuffer(32),
            rp: { name: 'Marco Tenant', id: rpId },
            user: {
              id: new TextEncoder().encode(context.userId ?? 'usuario-demo'),
              name: context.userId ?? 'usuario-demo',
              displayName: context.userId ?? 'Usuário Demo',
            },
            pubKeyCredParams: [
              { type: 'public-key', alg: -7 },
              { type: 'public-key', alg: -257 },
            ],
            authenticatorSelection: {
              residentKey: 'preferred',
              userVerification: 'preferred',
              authenticatorAttachment: 'platform',
            },
            timeout: 60000,
          };
        }

        function buildFallbackAuthenticationOptions() {
          const rpId = window.location.hostname || 'localhost';
          return {
            challenge: randomBuffer(32),
            timeout: 60000,
            rpId,
            userVerification: 'preferred',
          };
        }

        async function requestRegistrationOptions() {
          ensureContext();
          const url = `${AUTH_BASE_URL}/${encodeURIComponent(context.tenantId)}/webauthn/register`;
          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ userId: context.userId }),
            });
            if (!response.ok) {
              throw new Error(`Falha HTTP ${response.status}`);
            }
            const payload = await response.json();
            return normaliseRegistrationOptions(payload);
          } catch (error) {
            console.warn('Usando challenge local de fallback para registro', error);
            return buildFallbackRegistrationOptions();
          }
        }

        async function requestAuthenticationOptions(extra = {}) {
          ensureContext();
          const url = `${AUTH_BASE_URL}/${encodeURIComponent(context.tenantId)}/webauthn/authenticate`;
          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ userId: context.userId, ...extra }),
            });
            if (!response.ok) {
              throw new Error(`Falha HTTP ${response.status}`);
            }
            const payload = await response.json();
            return normaliseAuthenticationOptions(payload);
          } catch (error) {
            console.warn('Usando challenge local de fallback para autenticação', error);
            return buildFallbackAuthenticationOptions();
          }
        }

        async function postCredential(kind, payload) {
          ensureContext();
          const url = `${AUTH_BASE_URL}/${encodeURIComponent(context.tenantId)}/webauthn/${kind}`;
          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ userId: context.userId, credential: payload }),
            });
            if (!response.ok) {
              throw new Error(`Backend respondeu ${response.status}`);
            }
            return response.json().catch(() => ({}));
          } catch (error) {
            console.warn(`Envio de credencial em modo demonstração (${kind})`, error);
            return { mode: 'fallback' };
          }
        }

        function serialiseAttestation(credential) {
          return {
            id: credential.id,
            type: credential.type,
            rawId: bufferToBase64Url(credential.rawId),
            response: {
              clientDataJSON: bufferToBase64Url(credential.response.clientDataJSON),
              attestationObject: bufferToBase64Url(credential.response.attestationObject),
            },
          };
        }

        function serialiseAssertion(credential) {
          return {
            id: credential.id,
            type: credential.type,
            rawId: bufferToBase64Url(credential.rawId),
            response: {
              authenticatorData: bufferToBase64Url(credential.response.authenticatorData),
              clientDataJSON: bufferToBase64Url(credential.response.clientDataJSON),
              signature: bufferToBase64Url(credential.response.signature),
              userHandle: credential.response.userHandle
                ? bufferToBase64Url(credential.response.userHandle)
                : null,
            },
          };
        }

        async function validateAdminToken(token) {
          ensureContext();
          const url = `${AUTH_BASE_URL}/${encodeURIComponent(context.tenantId)}/admin/validate-token`;
          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token }),
            });
            if (!response.ok) {
              throw new Error('Token rejeitado pelo backend');
            }
            const data = await response.json();
            if (!data?.valid) {
              throw new Error('Token administrativo inválido');
            }
            return data;
          } catch (error) {
            console.warn('Validação administrativa em modo de fallback', error);
            if (token && token.length >= 6) {
              return { valid: true, mode: 'fallback' };
            }
            throw error;
          }
        }

        async function requestAdminReset(token) {
          ensureContext();
          const url = `${AUTH_BASE_URL}/${encodeURIComponent(context.tenantId)}/admin/reset-pin`;
          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token }),
            });
            if (!response.ok) {
              throw new Error('Reset não autorizado');
            }
            return response.json().catch(() => ({}));
          } catch (error) {
            console.warn('Reset administrativo em modo fallback', error);
            return { mode: 'fallback' };
          }
        }

        async function handlePasskeyRegistration() {
          if (!window.PublicKeyCredential || !navigator.credentials?.create) {
            ui.setStatus('WebAuthn indisponível neste dispositivo.', 'warning');
            return;
          }
          try {
            ensureContext();
          } catch (error) {
            ui.setStatus('Carregando informações do tenant. Aguarde...', 'warning');
            return;
          }
          ui.setStatus('Solicitando challenge de registro seguro...', 'neutral');
          try {
            const publicKey = await requestRegistrationOptions();
            const credential = await navigator.credentials.create({ publicKey });
            if (!credential) {
              throw new Error('Credencial não criada.');
            }
            const payload = serialiseAttestation(credential);
            await postCredential('register-callback', payload);
            ui.setStatus('Dispositivo registrado com sucesso. Utilize passkey para desbloquear.', 'success');
          } catch (error) {
            console.error('Erro no registro WebAuthn', error);
            ui.setStatus(`Falha ao registrar passkey: ${error.message ?? error}`, 'error');
          }
        }

        async function handlePasskeySignIn(extra = {}) {
          if (!window.PublicKeyCredential || !navigator.credentials?.get) {
            ui.setStatus('WebAuthn indisponível neste dispositivo.', 'warning');
            return;
          }
          try {
            ensureContext();
          } catch (error) {
            ui.setStatus('Carregando informações do tenant. Aguarde...', 'warning');
            return;
          }
          ui.setStatus('Iniciando autenticação passkey...', 'neutral');
          try {
            const publicKey = await requestAuthenticationOptions(extra);
            const credential = await navigator.credentials.get({
              publicKey,
              mediation: extra.mediation,
            });
            if (!credential) {
              throw new Error('Nenhuma credencial retornada.');
            }
            const payload = serialiseAssertion(credential);
            await postCredential('authenticate-callback', payload);
            ui.setStatus('Sessão desbloqueada com passkey. Abrindo AppBase...', 'success');
            setTimeout(() => sessionLockController.release('passkey verificada'), 320);
          } catch (error) {
            if (error?.name === 'NotAllowedError') {
              ui.setStatus('A autenticação passkey foi cancelada ou expirou.', 'warning');
            } else {
              console.error('Erro na autenticação WebAuthn', error);
              ui.setStatus(`Falha na autenticação passkey: ${error.message ?? error}`, 'error');
            }
          }
        }

        async function handlePinUnlock() {
          try {
            ensureContext();
          } catch (error) {
            ui.setStatus('Configuração do tenant ainda não disponível.', 'warning');
            return;
          }
          const record = getPinRecord();
          if (!record) {
            ui.setStatus('Nenhum PIN cadastrado. Utilize o fluxo administrativo.', 'warning');
            return;
          }
          if (getAttempts() >= MAX_PIN_ATTEMPTS) {
            ui.setStatus('Limite de tentativas excedido. Solicite intervenção administrativa.', 'error');
            return;
          }
          const value = pinInput?.value?.trim();
          if (!value || value.length < 4) {
            ui.setStatus('Informe o PIN cadastrado (mínimo 4 dígitos).', 'warning');
            pinInput?.focus();
            return;
          }
          ui.setStatus('Validando PIN com derivação WebCrypto...', 'neutral');
          try {
            const derived = await derivePin(value, record.salt, record.iterations);
            if (derived.hash === record.hash) {
              resetAttempts();
              if (pinInput) {
                pinInput.value = '';
              }
              ui.setStatus('PIN verificado. Sessão será liberada.', 'success');
              setTimeout(() => sessionLockController.release('PIN verificado'), 320);
            } else {
              const attempts = getAttempts() + 1;
              setAttempts(attempts);
              if (attempts >= MAX_PIN_ATTEMPTS) {
                ui.setStatus('PIN incorreto e limite atingido. Contate o administrador.', 'error');
              } else {
                ui.setStatus('PIN incorreto. Tente novamente.', 'warning');
              }
            }
          } catch (error) {
            console.error('Erro ao validar PIN', error);
            ui.setStatus('Erro interno ao validar o PIN.', 'error');
          }
        }

        async function handlePinSetup() {
          if (!adminValidated) {
            ui.setStatus('Valide o token administrativo antes de cadastrar um PIN.', 'warning');
            return;
          }
          const pinValue = pinNewInput?.value?.trim();
          const confirmValue = pinConfirmInput?.value?.trim();
          if (!pinValue || pinValue.length < 4) {
            ui.setStatus('O PIN deve ter ao menos 4 dígitos.', 'warning');
            pinNewInput?.focus();
            return;
          }
          if (pinValue !== confirmValue) {
            ui.setStatus('Os campos de PIN não coincidem.', 'warning');
            return;
          }
          ui.setStatus('Gerando hash seguro para o PIN...', 'neutral');
          try {
            const record = await derivePin(pinValue);
            savePinRecord({
              ...record,
              createdAt: new Date().toISOString(),
            });
            if (pinNewInput) pinNewInput.value = '';
            if (pinConfirmInput) pinConfirmInput.value = '';
            ui.setStatus('PIN cadastrado e pronto para uso.', 'success');
          } catch (error) {
            console.error('Erro ao cadastrar PIN', error);
            ui.setStatus('Não foi possível cadastrar o PIN.', 'error');
          }
        }

        async function handleAdminValidation() {
          const token = adminTokenInput?.value?.trim();
          if (!token) {
            ui.setStatus('Informe o token administrativo fornecido pelo backend.', 'warning');
            adminTokenInput?.focus();
            return;
          }
          ui.setStatus('Validando token administrativo...', 'neutral');
          try {
            const result = await validateAdminToken(token);
            updateAdminState(true);
            if (result?.mode === 'fallback') {
              ui.setStatus('Token aceito em modo demonstração. Confirme no backend para produção.', 'warning');
            } else {
              ui.setStatus('Token validado. Cadastre ou resete o PIN com segurança.', 'success');
            }
          } catch (error) {
            console.error('Token administrativo rejeitado', error);
            updateAdminState(false);
            ui.setStatus('Token inválido ou expirado.', 'error');
          }
        }

        async function handleAdminReset() {
          if (!adminValidated) {
            ui.setStatus('Valide o token administrativo antes de resetar o PIN.', 'warning');
            return;
          }
          const token = adminTokenInput?.value?.trim();
          ui.setStatus('Solicitando reset seguro do PIN...', 'neutral');
          try {
            await requestAdminReset(token ?? '');
            clearPinRecord();
            ui.setStatus('PIN removido. Cadastre um novo antes do próximo acesso.', 'success');
          } catch (error) {
            console.error('Erro ao resetar PIN', error);
            ui.setStatus('Não foi possível resetar o PIN.', 'error');
          }
        }

        async function detectCapabilities() {
          if (!window.PublicKeyCredential) {
            ui.setStatus('Navegador sem suporte a WebAuthn. Utilize o PIN administrativo.', 'warning');
            webauthnSignInButton?.setAttribute('disabled', '');
            webauthnRegisterButton?.setAttribute('disabled', '');
            return;
          }
          try {
            const platformAvailable = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable?.();
            conditionalMediationAvailable = Boolean(
              await PublicKeyCredential.isConditionalMediationAvailable?.().catch(() => false),
            );
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            if (platformAvailable && isMobile) {
              ui.setBiometric('Biometria nativa disponível para desbloqueio instantâneo.');
            } else if (platformAvailable) {
              ui.setBiometric('Plataforma suporta autenticadores embarcados.');
            } else {
              ui.setBiometric('Nenhum autenticador biométrico detectado.');
            }
            ui.setStatus('Autenticação forte habilitada. Escolha passkey ou PIN administrativo.', 'success');
          } catch (error) {
            console.warn('Erro ao detectar suporte WebAuthn', error);
            ui.setStatus('Não foi possível detectar suporte a biometria.', 'warning');
          }
        }

        async function attemptConditionalFlow() {
          if (!conditionalMediationAvailable || attemptedConditionalFlow) {
            return;
          }
          attemptedConditionalFlow = true;
          try {
            await handlePasskeySignIn({ mediation: 'conditional' });
          } catch (error) {
            console.warn('Fluxo condicional de passkey não concluído', error);
          }
        }

        return {
          initialise() {
            ui.setStatus('Inicializando mecanismos de autenticação...', 'neutral');
            detectCapabilities().finally(() => {
              updateAttemptsLabel();
            });
          },
          syncContext(newContext = {}) {
            if (newContext.tenantId) {
              context.tenantId = newContext.tenantId;
            }
            if (newContext.userId) {
              context.userId = newContext.userId;
            }
            updateHint();
            updateAttemptsLabel();
            attemptConditionalFlow();
          },
        };
      }

      const dashboardSnapshot = {
        taskFlow: 82,
        capacity: 92,
        alerts: 3,
        approvals: 12,
        fieldTeams: 9,
        priorityTasks: 4,
      };

      const sessionState = {
        network: 'Online',
        deviceName: 'Marco Tablet Kiosk',
        lastSync: '12/03/2025 17:42',
        timeToReady: '1,4s',
        kioskMode: 'Device Owner • Single-App Kiosk',
        devices: [
          {
            id: 'device-01',
            label: 'Marco Tablet Kiosk',
            type: 'Tablet',
            lastActivity: 'há 2 minutos',
            status: 'Sessão atual',
          },
          {
            id: 'device-02',
            label: 'iPhone 15 — Operações',
            type: 'Celular',
            lastActivity: 'há 1 hora',
            status: 'Login via Passkey',
          },
          {
            id: 'device-03',
            label: 'Desktop Backoffice',
            type: 'Desktop',
            lastActivity: 'há 3 horas',
            status: 'Sessão ativa',
          },
        ],
        auditTrail: [
          {
            event: 'export_completed',
            description: 'Exportação 1-clique concluída',
            timestamp: '12/03 17:21',
          },
          {
            event: 'erasure_requested',
            description: 'Solicitação de eliminação total agendada',
            timestamp: '12/03 14:02',
          },
          {
            event: 'consent_logged',
            description: 'Consentimento LGPD atualizado',
            timestamp: '11/03 18:45',
          },
        ],
      };

      const backupSnapshot = {
        enabled: true,
        filesSynced: '128 itens',
        lastExport: '12/03 17:21',
        storageStatus: {
          drive: {
            name: 'Google Drive',
            status: 'Operacional',
            lastSync: 'há 5 minutos',
          },
          onedrive: {
            name: 'Microsoft OneDrive',
            status: 'Operacional',
            lastSync: 'há 8 minutos',
          },
        },
      };

      const marketCatalog = [
        {
          key: 'operations',
          title: 'Painel de Operações',
          description: 'KPIs, dados mestres e status unificado do tenant.',
          capabilities: ['KPIs', 'Alertas', 'Workflow'],
          license: 'Base',
        },
        {
          key: 'tasks',
          title: 'Gestor de Tarefas',
          description: 'Cronogramas, responsáveis e dependências críticas.',
          capabilities: ['Quadro', 'Alertas', 'Exportação'],
          license: 'Base',
        },
        {
          key: 'account',
          title: 'Conta & Backup',
          description: 'Identidade, dispositivos, direitos do titular e backups.',
          capabilities: ['LGPD', 'Backup', 'Passkeys'],
          license: 'Premium',
        },
        {
          key: 'market',
          title: 'Marketplace',
          description: 'Gestão de catálogos, licenças e habilitação de MiniApps.',
          capabilities: ['Catálogo', 'Licenças', 'Provisionamento'],
          license: 'Base',
        },
        {
          key: 'settings',
          title: 'Configuração & Operação',
          description: 'Parâmetros do AppBase, observabilidade e auditoria.',
          capabilities: ['Schemas', 'Observabilidade', 'LGPD'],
          license: 'Base',
        },
        {
          key: 'analytics',
          title: 'Insights Avançados',
          description: 'Visualizações analíticas e previsões operacionais.',
          capabilities: ['Forecast', 'Análises', 'Dashboards'],
          license: 'Add-on',
          comingSoon: true,
        },
      ];

      const observabilitySnapshot = [
        {
          event: 'boot_start',
          timestamp: '12/03 17:00',
          notes: 'Fluxo nominal',
        },
        {
          event: 'config_loaded',
          timestamp: '12/03 17:00',
          notes: 'Checksum válido',
        },
        {
          event: 'session_ok',
          timestamp: '12/03 17:01',
          notes: 'Token renovado via PKCE',
        },
        {
          event: 'sync_completed',
          timestamp: '12/03 17:42',
          notes: 'Fila zerada',
        },
        {
          event: 'export_completed',
          timestamp: '12/03 17:21',
          notes: 'Envelope distribuído',
        },
      ];

      const AppBase = (() => {
        const modules = new Map();
        const defaults = new Set();
        let enabled = new Set();
        let currentConfig = null;

        function register(key, module) {
          modules.set(key, module);
        }

        async function boot(config) {
          currentConfig = config;
          defaults.clear();
          (config.defaults?.enabledMiniApps ?? []).forEach((key) => defaults.add(key));
          enabled = new Set([
            ...(config.defaults?.enabledMiniApps ?? []),
            ...(config.user?.enabledMiniApps ?? []),
          ]);
          await sessionLock.waitForRelease();
          refreshNav();
          return currentConfig;
        }

        function refreshNav() {
          const enabledKeys = Array.from(enabled).filter((key) => modules.has(key));
          const container = document.getElementById('mini-app-grid');
          if (container) {
            container.innerHTML = '';
            enabledKeys.forEach((key) => {
              const module = modules.get(key);
              container.appendChild(createMiniAppCard(module, key));
            });
          }
          const countRef = document.querySelector('[data-ref="miniapp-count"]');
          if (countRef) {
            countRef.textContent = enabledKeys.length;
          }
          const tenantSummary = document.querySelector('[data-ref="summary-tenant"]');
          if (tenantSummary && currentConfig) {
            tenantSummary.textContent = currentConfig.tenantId;
          }
          connectMiniAppTriggers();
          buildMarketplace();
        }

        function createMiniAppCard(module, key) {
          const article = document.createElement('article');
          article.className = 'mini-app-card';
          article.dataset.miniapp = key;
          article.dataset.miniappView = key;
          article.tabIndex = 0;
          article.setAttribute('role', 'button');
          article.setAttribute('aria-label', `Abrir visão completa de ${module.card.label}`);

          const header = document.createElement('div');
          header.className = 'mini-app-card-header';

          const chip = document.createElement('div');
          chip.className = 'mini-app-chip';

          const title = document.createElement('span');
          title.className = 'mini-app-title';
          title.textContent = module.card.label;
          chip.appendChild(title);

          const trigger = document.createElement('button');
          trigger.type = 'button';
          trigger.className = 'icon-button';
          trigger.dataset.panelTrigger = key;
          trigger.setAttribute('aria-label', `Abrir MiniAppPanel de ${module.card.label}`);
          trigger.setAttribute('aria-expanded', 'false');
          trigger.innerHTML = `
            <svg viewBox="0 0 16 16" aria-hidden="true">
              <path d="M2.5 8a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm4 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm4 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z" />
            </svg>
            <span class="sr-only">Abrir painel de mini-app</span>
          `;

          chip.appendChild(trigger);
          header.appendChild(chip);
          article.appendChild(header);

          if (module.card?.meta) {
            const meta = document.createElement('p');
            meta.className = 'mini-app-meta';
            meta.textContent = module.card.meta;
            article.appendChild(meta);
          }

          article.addEventListener('click', (event) => {
            if (event.target.closest('button')) {
              return;
            }
            activateView(module.id);
          });

          article.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              activateView(module.id);
            }
          });

          article.dataset.bound = 'true';

          return article;
        }

        function toggleMiniApp(key) {
          if (!modules.has(key) && !defaults.has(key)) {
            return;
          }
          const module = modules.get(key);
          if (enabled.has(key)) {
            if (defaults.has(key)) {
              return;
            }
            enabled.delete(key);
            if (activePanelKey === key) {
              hideMiniAppPanel();
            }
            if (module && appRoot.dataset.view === module.id) {
              activateView('tela-principal');
            }
          } else {
            enabled.add(key);
          }
          refreshNav();
        }

        function isEnabled(key) {
          return enabled.has(key);
        }

        function isDefault(key) {
          return defaults.has(key);
        }

        function getResolvedConfig() {
          if (!currentConfig) {
            return null;
          }
          return {
            tenantId: currentConfig.tenantId,
            userId: currentConfig.userId,
            catalogBaseUrl: currentConfig.catalogBaseUrl,
            enabledMiniApps: Array.from(enabled),
            entitlements: currentConfig.user?.entitlements ?? {},
            providers: currentConfig.user?.providers ?? {},
            ui: currentConfig.ui,
            meta: currentConfig.meta,
          };
        }

        function resolve(key) {
          return modules.get(key);
        }

        return {
          register,
          boot,
          toggleMiniApp,
          isEnabled,
          isDefault,
          getResolvedConfig,
          resolve,
        };
      })();

      AppBase.register('operations', {
        id: 'mini-app-painel',
        card: {
          label: 'Painel de Operações',
          meta: 'KPIs, dados mestres e status de recursos',
          cta: 'Abrir painel detalhado',
        },
        badges: ['KPIs', 'Alertas'],
        panel: {
          template: 'panel-template-operations',
          meta: 'Masters do painel operacional prontos para receber subcards.',
        },
      });

      AppBase.register('tasks', {
        id: 'mini-app-tarefas',
        card: {
          label: 'Gestor de Tarefas',
          meta: 'Cronogramas, responsáveis e dados consumidos',
          cta: 'Abrir lista de tarefas',
        },
        badges: ['Workflow', 'Autosave'],
        panel: {
          template: 'panel-template-tasks',
          meta: 'Masters do gestor focados em filtros e status prioritários.',
        },
      });

      AppBase.register('account', {
        id: 'mini-app-conta',
        card: {
          label: 'Conta & Backup',
          meta: 'Identidade, dispositivos e direitos LGPD',
          cta: 'Gerenciar conta',
        },
        badges: ['LGPD', 'Backup'],
        panel: {
          template: 'panel-template-account',
          meta: 'Masters para direitos do titular, dispositivos e backups.',
        },
      });

      AppBase.register('market', {
        id: 'mini-app-market',
        card: {
          label: 'Marketplace',
          meta: 'Catálogo confiável de mini-apps do tenant',
          cta: 'Gerenciar licenças',
        },
        badges: ['Catálogo', 'Provisionamento'],
        panel: {
          template: 'panel-template-market',
          meta: 'Preview compacto para habilitar ou revogar licenças.',
        },
      });

      AppBase.register('settings', {
        id: 'mini-app-config',
        card: {
          label: 'Configuração & Operação',
          meta: 'Parametros, observabilidade e auditoria',
          cta: 'Abrir configurações',
        },
        badges: ['Schemas', 'Logs'],
        panel: {
          template: 'panel-template-settings',
          meta: 'Masters de configuração rápida e observabilidade do tenant.',
        },
      });

      const bootConfig = {
        tenantId: 'tenant-marco',
        userId: 'ribeiro.l',
        catalogBaseUrl: 'https://cdn.marco.app/catalog',
        defaults: { enabledMiniApps: ['home', 'market', 'settings'] },
        user: {
          enabledMiniApps: ['operations', 'tasks', 'account'],
          entitlements: { backup: true, marketplace: true },
          providers: { login: ['google', 'apple'], storage: ['drive', 'onedrive'] },
        },
        ui: { theme: 'dark', layout: 'tabs' },
        meta: { version: '1.0', signature: 'demo-signature', checksum: 'demo-checksum' },
      };

      tenantContext.tenantId = bootConfig.tenantId;
      tenantContext.userId = bootConfig.userId;
      initThemeControls(true);
      authController.syncContext({ tenantId: bootConfig.tenantId, userId: bootConfig.userId });

      AppBase.boot(bootConfig)
        .then(() => {
          initThemeControls();
          updateHeaderSession(bootConfig, sessionState);
          updateHomeSnapshot(dashboardSnapshot);
          updateAccountDetails(bootConfig, sessionState, backupSnapshot);
          buildObservabilityTable();
          connectMiniAppTriggers();
        })
        .catch((error) => {
          console.error('Erro ao inicializar o AppBase após o desbloqueio', error);
        });
      document.querySelectorAll('[data-action="home"]').forEach((element) => {
        element.addEventListener('click', (event) => {
          event.preventDefault();
          activateView('tela-principal');
        });
      });

      function updateHeaderSession(config, session) {
        const indicator = document.querySelector('[data-ref="status-indicator"]');
        if (indicator) {
          indicator.textContent = `Sessão ativa • ${session.network}`;
        }
        const tenantRef = document.querySelector('[data-ref="status-tenant"]');
        if (tenantRef) {
          tenantRef.textContent = `Tenant: ${config.tenantId}`;
        }
        const userRef = document.querySelector('[data-ref="status-user"]');
        if (userRef) {
          userRef.textContent = `Usuário: ${config.userId} • ${session.deviceName}`;
        }
        const storageProviders = config.user?.providers?.storage ?? [];
        const storageRef = document.querySelector('[data-ref="status-storage"]');
        if (storageRef) {
          storageRef.textContent = storageProviders.length
            ? `Armazenamento vinculado: ${storageProviders
                .map((provider) => provider.toUpperCase())
                .join(' • ')}`
            : 'Armazenamento vinculado: não habilitado';
        }
        const syncRef = document.querySelector('[data-ref="status-sync"]');
        if (syncRef) {
          syncRef.textContent = session.lastSync
            ? `Último sync: ${session.lastSync}`
            : 'Sync desativado';
        }
        const readyRef = document.querySelector('[data-ref="status-ready"]');
        if (readyRef) {
          readyRef.textContent = `Tempo até READY: ${session.timeToReady}`;
        }
      }

      function updateHomeSnapshot(snapshot) {
        const flow = document.querySelector('[data-ref="metric-task-flow"]');
        if (flow) {
          flow.textContent = `${snapshot.taskFlow}%`;
        }
        const capacity = document.querySelector('[data-ref="metric-capacity"]');
        if (capacity) {
          capacity.textContent = `${snapshot.capacity}%`;
        }
        const alerts = document.querySelector('[data-ref="metric-alerts"]');
        if (alerts) {
          alerts.textContent = snapshot.alerts;
        }
        const approvals = document.querySelector('[data-ref="highlight-approvals"]');
        if (approvals) {
          approvals.textContent = snapshot.approvals;
        }
        const teams = document.querySelector('[data-ref="highlight-field-teams"]');
        if (teams) {
          teams.textContent = snapshot.fieldTeams;
        }
        const priority = document.querySelector('[data-ref="highlight-priority"]');
        if (priority) {
          priority.textContent = snapshot.priorityTasks;
        }
      }

      function updateAccountDetails(config, session, backup) {
        const tenantDetail = document.querySelector('[data-ref="detail-tenant"]');
        if (tenantDetail) {
          tenantDetail.textContent = config.tenantId;
        }
        const userDetail = document.querySelector('[data-ref="detail-user"]');
        if (userDetail) {
          userDetail.textContent = config.userId;
        }
        const loginDetail = document.querySelector('[data-ref="detail-logins"]');
        if (loginDetail) {
          const providers = config.user?.providers?.login ?? [];
          loginDetail.textContent = providers.length
            ? providers.map((provider) => provider.toUpperCase()).join(' • ')
            : 'Sem provedores configurados';
        }
        const kioskDetail = document.querySelector('[data-ref="detail-kiosk"]');
        if (kioskDetail) {
          kioskDetail.textContent = session.kioskMode;
        }
        const backupDetail = document.querySelector('[data-ref="detail-backup"]');
        if (backupDetail) {
          backupDetail.textContent = backup.enabled ? 'Ativo' : 'Desativado';
        }
        const filesDetail = document.querySelector('[data-ref="detail-files"]');
        if (filesDetail) {
          filesDetail.textContent = backup.filesSynced;
        }
        const exportDetail = document.querySelector('[data-ref="detail-export"]');
        if (exportDetail) {
          exportDetail.textContent = backup.lastExport;
        }

        const storageGrid = document.getElementById('storage-grid');
        if (storageGrid) {
          storageGrid.innerHTML = '';
          const storageProviders = config.user?.providers?.storage ?? [];
          storageProviders.forEach((providerKey) => {
            const data = backup.storageStatus[providerKey];
            const card = document.createElement('article');
            card.className = 'storage-card';
            card.innerHTML = `
              <strong>${data?.name ?? providerKey.toUpperCase()}</strong>
              <span>Status: ${data?.status ?? 'Desconhecido'}</span>
              <span>Último sync: ${data?.lastSync ?? '—'}</span>
            `;
            storageGrid.appendChild(card);
          });
        }

        const deviceList = document.getElementById('device-list');
        if (deviceList) {
          deviceList.innerHTML = '';
          session.devices.forEach((device) => {
            const card = document.createElement('article');
            card.className = 'device-card';
            card.innerHTML = `
              <header>
                <strong>${device.label}</strong>
                <span>${device.status}</span>
              </header>
              <ul>
                <li>Tipo: ${device.type}</li>
                <li>Última atividade: ${device.lastActivity}</li>
                <li>ID: ${device.id}</li>
              </ul>
            `;
            deviceList.appendChild(card);
          });
        }

        const timeline = document.getElementById('audit-timeline');
        if (timeline) {
          timeline.innerHTML = '';
          session.auditTrail.forEach((entry) => {
            const item = document.createElement('li');
            item.textContent = `${entry.timestamp} • ${entry.description}`;
            timeline.appendChild(item);
          });
        }

        const configJson = document.getElementById('config-json');
        if (configJson) {
          const resolved = AppBase.getResolvedConfig();
          configJson.textContent = JSON.stringify(resolved, null, 2);
        }
      }

      function toggleMiniAppPanel(key, trigger) {
        if (!panelCard || !panelContent || !panelPlaceholder) {
          return;
        }
        if (activePanelKey === key && panelCard.classList.contains('is-active')) {
          hideMiniAppPanel();
          return;
        }
        showMiniAppPanel(key, trigger);
      }

      function showMiniAppPanel(key, trigger) {
        const module = AppBase.resolve(key);
        if (!module || !panelCard || !panelContent || !panelPlaceholder) {
          return;
        }

        panelContent.innerHTML = '';
        const templateId = module.panel?.template;
        if (templateId) {
          const template = document.getElementById(templateId);
          if (template) {
            panelContent.appendChild(template.content.cloneNode(true));
          }
        }
        if (!panelContent.hasChildNodes()) {
          const fallback = document.createElement('p');
          fallback.className = 'panel-note';
          fallback.textContent = `Painel em preparação para ${module.card.label}.`;
          panelContent.appendChild(fallback);
        }

        panelPlaceholder.setAttribute('hidden', 'hidden');
        panelContent.removeAttribute('hidden');
        panelCard.classList.add('is-active');
        panelCard.classList.remove('is-collapsed');

        if (panelChip) {
          panelChip.textContent = module.card.label;
        }
        if (panelMeta) {
          panelMeta.textContent = module.panel?.meta ?? module.card?.meta ?? '';
        }

        if (panelClose) {
          panelClose.removeAttribute('hidden');
        }

        if (panelMenu) {
          panelMenu.dataset.panelTrigger = key;
          panelMenu.setAttribute('aria-expanded', 'true');
          panelMenu.setAttribute('aria-label', `Fechar MiniAppPanel de ${module.card.label}`);
        }

        if (activePanelTrigger) {
          activePanelTrigger.setAttribute('aria-expanded', 'false');
        }
        if (trigger) {
          trigger.setAttribute('aria-expanded', 'true');
          activePanelTrigger = trigger;
        } else {
          activePanelTrigger = null;
        }

        activePanelKey = key;
      }

      function hideMiniAppPanel() {
        if (!panelCard || !panelContent || !panelPlaceholder) {
          return;
        }
        panelCard.classList.remove('is-active');
        panelCard.classList.add('is-collapsed');
        panelContent.innerHTML = '';
        panelContent.setAttribute('hidden', 'hidden');
        panelPlaceholder.removeAttribute('hidden');

        if (panelChip) {
          panelChip.textContent = 'Mini-app não selecionado';
        }
        if (panelMeta) {
          panelMeta.textContent = 'Selecione um mini-app na coluna à esquerda para visualizar os masters.';
        }
        if (panelClose) {
          panelClose.setAttribute('hidden', 'hidden');
        }
        if (panelMenu) {
          panelMenu.removeAttribute('data-panel-trigger');
          panelMenu.setAttribute('aria-expanded', 'false');
          panelMenu.setAttribute('aria-label', 'Abrir MiniAppPanel');
        }
        if (activePanelTrigger) {
          activePanelTrigger.setAttribute('aria-expanded', 'false');
        }
        activePanelTrigger = null;
        activePanelKey = null;
      }

      if (panelClose) {
        panelClose.addEventListener('click', (event) => {
          event.stopPropagation();
          hideMiniAppPanel();
        });
      }

      if (panelMenu) {
        panelMenu.addEventListener('click', (event) => {
          event.stopPropagation();
          const targetKey = panelMenu.dataset.panelTrigger ?? activePanelKey;
          if (targetKey) {
            toggleMiniAppPanel(targetKey, panelMenu);
          }
        });
      }

      function connectMiniAppTriggers() {
        document.querySelectorAll('[data-miniapp-view]').forEach((element) => {
          if (element.dataset.bound === 'true') {
            return;
          }
          const module = AppBase.resolve(element.dataset.miniappView);
          if (!module) {
            return;
          }
          element.dataset.bound = 'true';
          element.addEventListener('click', (event) => {
            if (event.target.closest('button')) {
              return;
            }
            activateView(module.id);
          });
        });

        document.querySelectorAll('[data-panel-trigger]').forEach((button) => {
          if (button.dataset.panelBound === 'true') {
            return;
          }
          button.dataset.panelBound = 'true';
          button.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleMiniAppPanel(button.dataset.panelTrigger, button);
          });
        });
      }

      function buildMarketplace() {
        const container = document.getElementById('market-grid');
        if (!container) {
          return;
        }
        container.innerHTML = '';
        marketCatalog.forEach((item) => {
          const card = document.createElement('article');
          card.className = 'market-card';
          card.dataset.marketCard = item.key;

          const header = document.createElement('header');
          header.innerHTML = `
            <div>
              <h4>${item.title}</h4>
              <p>${item.description}</p>
            </div>
          `;
          card.appendChild(header);

          if (item.capabilities?.length) {
            const chips = document.createElement('div');
            chips.className = 'chip-row';
            item.capabilities.forEach((capability) => {
              const chip = document.createElement('span');
              chip.className = 'chip neutral';
              chip.textContent = capability;
              chips.appendChild(chip);
            });
            card.appendChild(chips);
          }

          const statusRow = document.createElement('div');
          statusRow.className = 'chip-row';
          const statusChip = document.createElement('span');
          if (item.comingSoon) {
            statusChip.className = 'chip neutral';
            statusChip.textContent = 'Em breve';
          } else if (AppBase.isEnabled(item.key)) {
            statusChip.className = 'chip success';
            statusChip.textContent = 'Ativo';
          } else {
            statusChip.className = 'chip info';
            statusChip.textContent = 'Disponível';
          }
          statusRow.appendChild(statusChip);

          if (item.license) {
            const licenseChip = document.createElement('span');
            licenseChip.className = 'chip neutral';
            licenseChip.textContent = `Licença: ${item.license}`;
            statusRow.appendChild(licenseChip);
          }
          card.appendChild(statusRow);

          const footer = document.createElement('footer');
          if (item.comingSoon) {
            const info = document.createElement('span');
            info.className = 'chip neutral';
            info.textContent = 'Catálogo agendado para Q3';
            footer.appendChild(info);
          } else {
            const toggle = document.createElement('button');
            toggle.className = 'toggle';
            toggle.type = 'button';
            if (AppBase.isDefault(item.key)) {
              toggle.textContent = 'Obrigatório';
              toggle.disabled = true;
            } else {
              toggle.textContent = AppBase.isEnabled(item.key) ? 'Desabilitar' : 'Habilitar';
              toggle.addEventListener('click', () => {
                AppBase.toggleMiniApp(item.key);
              });
            }
            footer.appendChild(toggle);
          }
          card.appendChild(footer);

          container.appendChild(card);
        });
      }

      function buildObservabilityTable() {
        const tbody = document.getElementById('observability-table');
        if (!tbody) {
          return;
        }
        tbody.innerHTML = '';
        observabilitySnapshot.forEach((entry) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${entry.event}</strong></td>
            <td>${entry.timestamp}</td>
            <td>${entry.notes}</td>
          `;
          tbody.appendChild(row);
        });
      }
    </script>
  </body>
</html>
