"use strict";(function(){const OVERLAY_ID='app-settings-overlay';const CLOSE_ID='app-settings-close';const SEL_ID='sel-locale';const APPLY_ID='btn-apply';const LOG_ID='cmd-log';const OPEN_CLASS='is-open';const ATTR_HIDDEN='aria-hidden';function byId(id){return document.getElementById(id);}function log(msg,data){const el=byId(LOG_ID);if(!el) return;const time=new Date().toISOString();const payload=data?` ${JSON.stringify(data)}`:'';el.textContent+=(el.textContent?'\n':'')+`${time} â€” ${msg}${payload}`;el.scrollTop=el.scrollHeight;}async function ensurePanel(){if(byId(OVERLAY_ID)) return;try{const res=await fetch('./settings/settings.html?ts='+Date.now(),{cache:'no-store'});const html=await res.text();const wrap=document.createElement('div');wrap.innerHTML=html;const fragment=wrap.firstElementChild;if(fragment){document.body.appendChild(fragment);}}catch(e){console.warn('[settings] panel load failed',e);}}function openPanel(focusSection){const overlay=byId(OVERLAY_ID);if(!overlay) return;overlay.classList.add(OPEN_CLASS);overlay.setAttribute(ATTR_HIDDEN,'false');if(focusSection==='lang'){const select=byId(SEL_ID);select&&select.focus();}log('settings:open',{section:focusSection||null});}function closePanel(){const overlay=byId(OVERLAY_ID);if(!overlay) return;overlay.classList.remove(OPEN_CLASS);overlay.setAttribute(ATTR_HIDDEN,'true');log('settings:close');}function populateLocales(){const select=byId(SEL_ID);if(!select) return;select.innerHTML='';const locales=(window.AppBaseI18n?.supported)||['pt-BR'];const current=window.AppBaseI18n?.getLocale?.()||locales[0];locales.forEach(loc=>{const opt=document.createElement('option');opt.value=loc;opt.textContent=loc;opt.selected=loc===current;select.appendChild(opt);});}function applyLocale(){const select=byId(SEL_ID);const locale=select?.value;if(!locale) return;log('i18n:setLocale:req',{locale});window.AppBaseI18n?.setLocale?.(locale);}function syncButtonLabel(selector){const btn=document.querySelector(selector);if(!btn) return;const label=btn.querySelector('[data-i18n]');if(label){const text=label.textContent.trim();if(text){btn.setAttribute('aria-label',text);btn.setAttribute('title',text);}}}function updateHeaderControls(){syncButtonLabel('.ac-header-action[data-action-id="app.locale"]');syncButtonLabel('[data-theme-toggle]');}function bindControls(){byId(CLOSE_ID)?.addEventListener('click',closePanel);byId(APPLY_ID)?.addEventListener('click',applyLocale);document.addEventListener('keydown',event=>{if(event.key==='Escape'){const overlay=byId(OVERLAY_ID);if(overlay&&overlay.classList.contains(OPEN_CLASS)){closePanel();}}});window.addEventListener('click',event=>{const overlay=byId(OVERLAY_ID);if(!overlay) return;if(event.target===overlay){closePanel();}});window.addEventListener('app:header:action:click',ev=>{if(ev.detail?.id==='app.locale'){openPanel('lang');}});window.addEventListener('app:i18n:locale_changed',ev=>{log('i18n:locale_changed',ev.detail||{});populateLocales();updateHeaderControls();});}async function init(){await ensurePanel();populateLocales();bindControls();updateHeaderControls();window.AppSettings={open:openPanel,close:closePanel,log};log('settings:init');}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}})();
