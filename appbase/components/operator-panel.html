<style>
  .op-fab{position:fixed;right:16px;bottom:16px;border:0;border-radius:999px;padding:12px 14px;box-shadow:0 6px 24px rgba(0,0,0,.16);cursor:pointer;background:#111;color:#fff}
  .op-fab svg{width:20px;height:20px;vertical-align:middle}
  .op-wrap{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:saturate(140%) blur(6px);display:none}
  .op-card{position:absolute;right:24px;top:24px;bottom:24px;width:min(520px,95vw);background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:18px;overflow:auto;font-family:system-ui}
  .op-row{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
  .op-row input,.op-row button,select{padding:10px;border-radius:12px;border:1px solid #cfcfcf}
  .op-muted{opacity:.75}
  .op-kv{font-family:ui-monospace,Consolas,monospace;background:#0c0c0c;color:#f3f3f3;border-radius:12px;padding:10px;white-space:pre-wrap;max-height:220px;overflow:auto}
  .op-badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #e6e6e6;margin-left:6px}
  @media (prefers-color-scheme: dark){ .op-card{background:#141414;color:#eaeaea} .op-fab{background:#eaeaea;color:#111} .op-row input,.op-row button,select{border-color:#4b4b4b;background:#1b1b1b;color:#eaeaea} }
</style>
<button id="op-fab" class="op-fab" title="Painel do Operador" style="display:none"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.7 19.3l-6.6-6.6a7 7 0 10-3.4 3.4l6.6 6.6a2.4 2.4 0 003.4-3.4zM4 10a6 6 0 1112 0A6 6 0 014 10z"/></svg></button>
<div id="op-wrap" class="op-wrap">
  <div class="op-card">
    <h2>Operador <span id="op-status" class="op-badge">offline</span></h2>
    <p class="op-muted">Controle de planos e licenças. Atalho: <b>Shift+M</b>.</p>

    <section id="op-login">
      <div class="op-row">
        <input id="op-pass" type="password" placeholder="Passcode do operador" />
        <button id="op-login-btn">Entrar</button>
      </div>
    </section>

    <section id="op-actions" style="display:none">
      <div class="op-row">
        <input id="op-email" type="email" placeholder="email do cliente (ou user ref)" />
        <select id="op-plan">
          <option value="starter">starter</option>
          <option value="pro" selected>pro</option>
          <option value="master">master</option>
        </select>
      </div>
      <div class="op-row">
        <button id="op-validate">Validar licença</button>
        <button id="op-subscribe">Assinar/Upgrade</button>
        <button id="op-refresh">Forçar refresh</button>
      </div>

      <div class="op-row">
        <button id="op-user-switch">Trocar usuário atual</button>
        <button id="op-theme-toggle">Alternar tema</button>
        <button id="op-health">Health</button>
        <button id="op-close">Fechar</button>
      </div>

      <div class="op-row">
        <div id="op-out" class="op-kv"></div>
      </div>
    </section>
  </div>
</div>
<script type="module">
  (async () => {
    const cfg = await fetch("../config/app.config.json").then(r=>r.json());
    const $=s=>document.querySelector(s);
    const wrap=$("#op-wrap"), fab=$("#op-fab"), out=$("#op-out");
    const status=$("#op-status"), loginSec=$("#op-login"), actSec=$("#op-actions");
    const pass=$("#op-pass"), loginBtn=$("#op-login-btn");
    const email=$("#op-email"), plan=$("#op-plan");
    const btnValidate=$("#op-validate"), btnSub=$("#op-subscribe"), btnRefresh=$("#op-refresh");
    const btnUser=$("#op-user-switch"), btnTheme=$("#op-theme-toggle"), btnHealth=$("#op-health"), btnClose=$("#op-close");
    let token=null;

    const log=(o)=>{ out.textContent=((typeof o==="string")?o:JSON.stringify(o,null,2))+"\n"+out.textContent; };
    const show=()=>{ wrap.style.display="block"; };
    const hide=()=>{ wrap.style.display="none"; };
    const setOnline=(v)=>{ status.textContent=v?"online":"offline"; status.style.borderColor=v?"#18a957":"#e6e6e6"; };

    // Mostrar FAB só para operador (salvo em localStorage)
    const opEnabled = localStorage.getItem("opEnabled")==="1";
    if(opEnabled) fab.style.display="inline-flex";

    // Atalho teclado Shift+M
    addEventListener("keydown", (ev)=>{ if(ev.shiftKey && ev.key.toLowerCase()==="m"){ show(); } });

    fab.onclick=show; btnClose.onclick=hide;

    loginBtn.onclick=async ()=>{
      try{
        const r = await fetch(cfg.worker_url.replace(/\/$/,"")+"/op/login", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ passcode: pass.value })
        });
        const data = await r.json();
        if(!r.ok) throw new Error(data?.error||( "HTTP "+r.status));
        token = data.token;
        localStorage.setItem("opEnabled","1");
        fab.style.display="inline-flex";
        loginSec.style.display="none";
        actSec.style.display="block";
        setOnline(true);
        log({ ok:true, msg:"Operador autenticado" });
      }catch(e){ log({error:String(e)}); }
    };

    btnValidate.onclick=async ()=>{
      try{
        const u = email.value.trim()||"guest";
        const r = await fetch(cfg.worker_url.replace(/\/$/,"")+"/license/validate?user="+encodeURIComponent(u));
        log(await r.json());
      }catch(e){ log({error:String(e)}); }
    };

    btnSub.onclick=async ()=>{
      try{
        const r = await fetch(cfg.worker_url.replace(/\/$/,"")+"/subscribe", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ email: email.value.trim(), plan: plan.value })
        });
        const data = await r.json(); log(data);
        if(data?.subscription?.init_point) open(data.subscription.init_point, "_blank");
      }catch(e){ log({error:String(e)}); }
    };

    btnRefresh.onclick=async ()=>{
      try{
        const r = await fetch(cfg.worker_url.replace(/\/$/,"")+"/op/license/refresh", {
          method:"POST", headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
          body: JSON.stringify({ user: email.value.trim() })
        });
        log(await r.json());
      }catch(e){ log({error:String(e)}); }
    };

    btnUser.onclick=()=>{ try{
      const api = window.AppBase?.users;
      const v = email.value.trim()||"guest@local";
      api?.switch?.(v); log({user_switched:v});
    }catch(e){ log({error:String(e)}); } };

    btnTheme.onclick=()=>{ try{
      const theme = window.AppBase?.theme;
      const next = theme?.get?.()==="dark"?"light":"dark";
      theme?.set?.(next); log({theme:next});
    }catch(e){ log({error:String(e)}); } };

    btnHealth.onclick=async ()=>{
      try{
        const w = cfg.worker_url.replace(/\/$/,"");
        const [a,b] = await Promise.all([
          fetch(w+"/health").then(r=>r.json()).catch(()=>({error:true})),
          fetch(w+"/plans").then(r=>r.json()).catch(()=>({error:true}))
        ]);
        log({ health:a, plans:b });
      }catch(e){ log({error:String(e)}); }
    };
  })();
</script>
