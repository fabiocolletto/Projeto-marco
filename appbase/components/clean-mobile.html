<div class="ac-clean" data-clean-shell-root>
  <div class="ac-clean__wrap">
    <header class="ac-clean__header">
      <div class="ac-clean__header-inner">
        <span class="ac-clean__brand">Projeto Marco</span>
        <span class="ac-clean__version">AppBase v3.0 • Clean</span>
      </div>
    </header>

    <main class="ac-clean__main ac-grid">
      <section class="ac-clean__card ac-tile ac-tile--span-12" id="sec-login">
        <div class="ac-clean__card-head">
          <h3 class="ac-clean__card-title">Conta</h3>
          <p class="ac-clean__muted">Entre com seu e-mail para liberar as ações.</p>
        </div>
        <div class="ac-clean__field ac-clean__field--full">
          <label class="ac-clean__label" for="email">E-mail</label>
          <input id="email" type="email" placeholder="seu@email.com" />
        </div>
        <div class="ac-clean__row">
          <button class="ac-clean__button" id="btnLogin">Entrar</button>
          <button class="ac-clean__button ac-clean__button--muted" id="btnLogout">Sair</button>
        </div>
        <div class="ac-clean__muted" id="who" role="status" aria-live="polite"></div>
      </section>

      <section class="ac-clean__card ac-tile ac-tile--span-6" id="sec-billing">
        <div class="ac-clean__card-head">
          <h3 class="ac-clean__card-title">Assinatura</h3>
          <p class="ac-clean__muted">Assinar o plano PRO via Mercado Pago.</p>
        </div>
        <div class="ac-clean__row">
          <button class="ac-clean__button" id="btnSubscribe">Assinar PRO</button>
          <button class="ac-clean__button ac-clean__button--ghost" id="btnPlans">Ver planos (API)</button>
        </div>
        <div class="ac-clean__alert">Após autorização do pagamento, sua licença será validada automaticamente.</div>
      </section>

      <section class="ac-clean__card ac-tile ac-tile--span-6" id="sec-status">
        <div class="ac-clean__card-head">
          <h3 class="ac-clean__card-title">Status da licença</h3>
        </div>
        <div class="ac-clean__row">
          <button class="ac-clean__button" id="btnValidate">Validar agora</button>
        </div>
        <pre id="out" class="ac-clean__mono" aria-live="polite"></pre>
      </section>
    </main>

    <footer class="ac-clean__footer">
      <span class="ac-clean__muted">© 5Horas • Base pronta para receber MiniApp</span>
    </footer>
  </div>

  <div class="ac-clean__desktop-overlay" aria-hidden="true">
    <div class="ac-clean__desktop-overlay-content">
      <h2 class="ac-clean__overlay-title">Modo somente mobile</h2>
      <p class="ac-clean__overlay-text">
        Abra em um smartphone para continuar. Largura de tela detectada como desktop.
      </p>
    </div>
  </div>
</div>

<script type="module">
  import cfg from "../config/app.config.json" assert { type: "json" };
  import { users } from "../modules/users-lite.js";
  import { subscribe, validateLicense } from "../modules/licensing.js";

  const root = document.querySelector('[data-clean-shell-root]');
  if (!root) {
    console.warn('[clean-shell] elemento raiz não encontrado.');
    return;
  }
  const $ = (selector) => root.querySelector(selector);
  const out = $("#out");
  const log = (value) => {
    const text = typeof value === "string" ? value : JSON.stringify(value, null, 2);
    out.textContent = `${text}\n${out.textContent}`.trim();
  };

  const overlay = root.querySelector(".ac-clean__desktop-overlay");
  const wrap = root.querySelector(".ac-clean__wrap");
  const toggleDesktopState = () => {
    const desktop = window.innerWidth > 800 || window.matchMedia("(pointer: fine)").matches;
    const showOverlay = desktop && cfg.mobile_only;
    overlay.classList.toggle("is-visible", showOverlay);
    wrap.classList.toggle("is-blurred", showOverlay);
    overlay.setAttribute("aria-hidden", String(!showOverlay));
  };
  addEventListener("resize", toggleDesktopState);
  toggleDesktopState();

  const who = $("#who");
  const refreshWho = () => {
    const current = users.getCurrent();
    who.textContent = current ? `Logado como ${current.email}` : "Não logado";
  };
  refreshWho();

  $("#btnLogin").onclick = () => {
    const email = $("#email").value.trim();
    if (!email) return alert("Informe seu e-mail.");
    users.login(email);
    refreshWho();
  };

  $("#btnLogout").onclick = () => {
    users.logout();
    refreshWho();
  };

  $("#btnSubscribe").onclick = async () => {
    const current = users.getCurrent();
    if (!current) return alert("Faça login antes.");
    try {
      const response = await subscribe(
        cfg.worker_url,
        current.email,
        cfg.licensing.plan_required || "pro"
      );
      log(response);
      const initPoint = response?.subscription?.init_point;
      if (initPoint) open(initPoint, "_blank");
    } catch (error) {
      log({ error: String(error) });
    }
  };

  $("#btnValidate").onclick = async () => {
    const current = users.getCurrent();
    if (!current) return alert("Faça login antes.");
    log(await validateLicense(cfg.worker_url, current.ref));
  };

  $("#btnPlans").onclick = async () => {
    try {
      const response = await fetch(cfg.worker_url.replace(/\/$/, "") + "/plans");
      log(await response.json());
    } catch (error) {
      log({ error: String(error) });
    }
  };
</script>
