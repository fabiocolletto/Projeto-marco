<!doctype html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AppBase • 5 Horas</title>
  <link rel="stylesheet" href="styles/core.css">
  <link rel="stylesheet" href="styles/tokens.css">
  <link rel="stylesheet" href="styles/themes/light.css">
  <link rel="stylesheet" href="styles/themes/dark.css">
  <link rel="stylesheet" href="styles/utilities.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/miniapp-scope.css">
  <style>body{background:var(--ac-bg);color:var(--ac-ink);font-family:var(--ac-font-sans)}</style>
</head>
<body class="u-col app-body">
  <header class="u-row app-header">
    <div class="u-row app-header__branding">
      <strong data-i18n="app.header.title">5 Horas — AppBase</strong>
    </div>
    <div class="u-row app-header__actions">
      <select id="locale">
        <option value="pt-br">PT-BR</option>
        <option value="en-us">EN</option>
        <option value="es-419">ES</option>
      </select>
      <button class="c-btn" id="toggle-theme" data-i18n="app.header.themeToggle">Tema</button>
    </div>
  </header>

  <main class="u-row app-shell">
    <aside class="u-card app-shell__rail">
      <h3 style="margin-top:0" data-i18n="app.catalog.title">MiniApps</h3>
      <div id="catalog" class="app-catalog"></div>
    </aside>
    <section id="viewport" class="u-col u-gap-4 app-shell__content">
      <div class="u-card">
        <h2 data-i18n="app.viewport.welcome.title">Bem-vindo</h2>
        <p class="u-muted" data-i18n="app.viewport.welcome.subtitle">Abra o MiniApp Gestor de Tarefas para testar.</p>
      </div>
    </section>
  </main>

  <footer id="app-footer" class="app-footer">
    <button type="button" id="version-trigger" class="app-footer__button" aria-haspopup="dialog" aria-controls="version-modal"></button>
  </footer>

  <div id="version-overlay" class="status-overlay" hidden>
    <div id="version-modal" class="status-modal" role="dialog" aria-modal="true" aria-labelledby="status-modal-title">
      <button type="button" id="version-modal-close" class="status-modal__close" aria-label="Fechar">×</button>
      <h2 id="status-modal-title" data-i18n="app.statusModal.title">Status do sistema</h2>
      <dl class="status-modal__details">
        <div class="status-modal__row">
          <dt data-i18n="app.statusModal.fields.version">Versão</dt>
          <dd id="status-modal-version"></dd>
        </div>
        <div class="status-modal__row">
          <dt data-i18n="app.statusModal.fields.date">Data</dt>
          <dd id="status-modal-date"></dd>
        </div>
        <div class="status-modal__row">
          <dt data-i18n="app.statusModal.fields.description">Descrição</dt>
          <dd id="status-modal-description"></dd>
        </div>
        <div class="status-modal__row">
          <dt data-i18n="app.statusModal.fields.status">Status</dt>
          <dd id="status-modal-status"></dd>
        </div>
      </dl>
    </div>
  </div>

  <script type="module">
    import { setTheme } from './scripts/theme.js';
    import { i18n, loadBaseI18n, loadMiniSnippet } from './scripts/i18n-loader.js';
    import { initVersionStatus, refreshVersionTranslations } from './scripts/version-status.js';

    const viewport = document.getElementById('viewport');
    const catalog = document.getElementById('catalog');
    const baseTitle = document.title;

    const ensureRelativePath = (path) => path.startsWith('../') ? path : `../${path}`;

    // Estado
    const miniapps = (await (await fetch('../miniapps/catalog.json')).json()).map(miniapp => ({
      ...miniapp,
      entry: ensureRelativePath(miniapp.entry),
      manifest: ensureRelativePath(miniapp.manifest),
      snippet: ensureRelativePath(miniapp.snippet)
    }));
    let activeMiniapp = null;

    // i18n base
    await loadBaseI18n('pt-br');
    await initVersionStatus();
    renderCatalog();
    applyBaseTranslations();

    // UI catálogo
    function renderCatalog(){
      catalog.innerHTML = '';
      miniapps.forEach(m => {
        const btn = document.createElement('button');
        btn.className = 'c-btn c-btn--primary';
        btn.textContent = m.name;
        const labelKey = `app.catalog.items.${m.id}`;
        btn.dataset.i18n = labelKey;
        btn.dataset.i18nFallback = m.name;
        btn.onclick = async () => {
          await openMiniapp(m);
        };
        catalog.appendChild(btn);
      });
    }

    async function openMiniapp(miniapp){
      activeMiniapp = miniapp;
      await loadMiniSnippet(miniapp.snippet);
      const html = await (await fetch(miniapp.entry)).text();
      viewport.innerHTML = html;
      // i18n placeholders simples: {{ t('key') }}
      viewport.innerHTML = viewport.innerHTML.replace(/\{\{\s*t\('([^']+)'\)\s*\}\}/g, (_, key) => i18n.t(key));
      attachTaskTableHandlers();
    }

    function translateKey(key, fallback){
      const translated = i18n.t(key);
      return translated === key ? fallback : translated;
    }

    function applyBaseTranslations(){
      document.documentElement.lang = i18n.locale;
      document.title = translateKey('app.meta.title', baseTitle);
      const localeSelect = document.getElementById('locale');
      localeSelect.value = i18n.locale;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const fallback = el.dataset.i18nFallback ?? el.textContent;
        if (!el.dataset.i18nFallback && fallback) {
          el.dataset.i18nFallback = fallback;
        }
        const value = translateKey(key, fallback);
        if (el instanceof HTMLInputElement) {
          el.value = value;
        } else {
          el.textContent = value;
        }
      });
      refreshVersionTranslations(i18n);
    }

    // Troca de idioma
    const localeSelect = document.getElementById('locale');
    localeSelect.addEventListener('change', async (e) => {
      await loadBaseI18n(e.target.value);
      applyBaseTranslations();
      // Re-render mínimo: recarrega o MiniApp aberto
      if (activeMiniapp) {
        await openMiniapp(activeMiniapp);
      }
    });

    // Tema
    document.getElementById('toggle-theme').onclick = () => {
      const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      setTheme(next);
    };

    // Funções do MiniApp Gestor de Tarefas (handlers simples)
    function attachTaskTableHandlers(){
      const addBtn = viewport.querySelector('[data-action="add-row"]');
      const tbody = viewport.querySelector('#gt-rows');
      if(addBtn && tbody){
        addBtn.onclick = () => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td contenteditable></td><td contenteditable></td><td><button class="c-btn" data-action="delete">${i18n.t('miniapps.gestor-de-tarefas.tabela.excluir')}</button></td>`;
          tbody.appendChild(tr);
          tr.querySelector('[data-action="delete"]').onclick = () => tr.remove();
        };
      }
    }
  </script>
</body>
</html>
