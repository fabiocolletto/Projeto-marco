<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Cerimonial — Tarefas (V4)</title>
  <link rel="stylesheet" href="/shared/gestaoEventosApp.css">
</head>
<body>
<main class="ac">
  <div class="container">
    <h1>Tarefas</h1>

    <!-- CARD 1: Resumo do evento (somente leitura, segue padrão visual) -->
    <section class="card" id="cardResumo">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h2 id="t_evTitle">—</h2>
          <div id="t_resTipoData" class="small">—</div>
        </div>
      </div>
      <div class="summary-line" id="t_resEndereco">Endereço</div>
      <div class="summary-line" id="t_resAnfitriao">Anfitrião</div>
      <div class="summary-line" id="t_resCerimonial">Cerimonialista</div>
    </section>

    <!-- CARD 2: Painel da checklist -->
    <section class="card">
      <div class="card__header"><h2>Checklist</h2></div>
      <div class="kgrid">
        <div class="kcell">Itens: <strong id="t_pnItens">0</strong></div>
        <div class="kcell">Pendentes: <strong id="t_pnPend">0</strong></div>
        <div class="kcell">Em andamento: <strong id="t_pnAnd">0</strong></div>
        <div class="kcell">Concluídos: <strong id="t_pnFeitos">0</strong></div>
        <div class="kcell" style="grid-column:1/-1">
          Progresso
          <div class="bar"><div id="t_pnBar" class="bar__fill"></div></div>
          <div class="bar__label"><span id="t_pnPct">0%</span> concluído</div>
        </div>
      </div>
    </section>

    <!-- CARD 3: Tabela de tarefas -->
    <section class="card">
      <div class="card__header">
        <h2>Itens</h2>
        <div class="row">
          <button id="t_btnLoadTemplate" class="btn btn--ghost">Carregar padrão</button>
          <button id="t_btnAddTask" class="btn">Adicionar item</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="sticky-header">
          <thead>
            <tr>
              <th>#</th>
              <th><h3>Tarefa</h3></th>
              <th><h3>Responsável</h3></th>
              <th><h3>Prazo</h3></th>
              <th><h3>Status</h3></th>
              <th class="right"><h3>Ações</h3></th>
            </tr>
          </thead>
          <tbody id="t_tasksBody"></tbody>
        </table>
      </div>
      <div class="small" id="t_tasksMeta">0 itens</div>
    </section>

    <!-- CARD 4: Estado -->
    <section class="card">
      <div class="card__header"><h2>Estado</h2></div>
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small">Projeto: <span id="t_estadoMetaId">—</span></div>
          <div class="small">Atualizado em: <span id="t_estadoMetaUpd">—</span></div>
        </div>
        <div class="row">
          <span id="t_pillLink" class="pill warn">Sem evento</span>
          <span id="t_pillSaving" class="pill ok">Pronto</span>
        </div>
      </div>
    </section>
  </div>
</main>

<script type="module">
  const {
    loadAppModules,
    dom,
    text: textUtils,
    format,
    ensureProjectWithChecklist,
    applyEventSummary,
    busSync
  } = await import('/shared/gestaoEventosApp.js');

  const { $, setPill } = dom;
  const { esc } = textUtils;
  const { fmtDateTime } = format;
  const ensureProject = ensureProjectWithChecklist;
  const { requestCurrentProject } = busSync;

  const { store, bus } = await loadAppModules();
  await store?.init?.();

  // Estado
  const AUTO_SAVE_MS = 700;
  const state = { currentId:null, project:null, checklist:[], dirty:false, saving:false, timer:null };

  function setDirty(v){ state.dirty=!!v; if(!state.saving){ setPill(pillSaving, v? 'warn':'ok', v? 'Alterações não salvas':'Pronto'); } }
  function setSaving(v){ state.saving=!!v; setPill(pillSaving, v? 'saving':'ok', v? 'Salvando…':'Pronto'); }

  const renderResumo = ()=> applyEventSummary({
    project: state.project,
    currentId: state.currentId,
    elements: {
      title: evTitle,
      tipoData: resTipoData,
      endereco: resEndereco,
      anfitriao: resAnfitriao,
      cerimonial: resCerimonial,
      linkPill: pillLink,
      metaId: estadoMetaId,
      metaAtualizado: estadoMetaUpd
    }
  });

  function checklistStats(rows){
    let feitos=0, pend=0, and=0; for(const r of (rows||[])){
      if(r.status==='feito') feitos++; else if(r.status==='andamento') and++; else pend++;
    }
    return {feitos,pend,and,total:(rows||[]).length};
  }
  function updatePanel(){
    const st = checklistStats(state.checklist);
    pnItens.textContent=String(st.total); pnPend.textContent=String(st.pend); pnAnd.textContent=String(st.and); pnFeitos.textContent=String(st.feitos);
    const pct = st.total? Math.round(st.feitos*100/st.total) : 0; pnBar.style.width=pct+'%'; pnPct.textContent=pct+'%';
  }

  function labelStatus(s){ return s==='feito'?'Concluído': s==='andamento'?'Em andamento':'Pendente'; }

  function isoToLocalDTValue(iso){ if(!iso) return ''; const [d,t='00:00:00']=iso.split('T'); return `${d}T${t.slice(0,5)}`; }
  function localDTValueToISO(val){ if(!val) return ''; const [d,t] = val.split('T'); const hhmm = (t||'00:00').slice(0,5); return `${d}T${hhmm}:00`; }

  function renderTasks(){
    const rows = state.checklist||[]; tasksMeta.textContent = `${rows.length} itens`;
    if(!rows.length){ tasksBody.innerHTML = '<tr><td colspan="6" class="small">Nenhum item.</td></tr>'; updatePanel(); return; }
    tasksBody.innerHTML = rows.map((t,i)=>`
      <tr data-i="${i}">
        <td>${i+1}</td>
        <td>${esc(t.titulo||'')}</td>
        <td>${esc(t.responsavel||'')}</td>
        <td>${esc(t.prazoISO? isoToLocalDTValue(t.prazoISO).replace('T',' '):'')}</td>
        <td>${esc(labelStatus(t.status))}</td>
        <td class="right"><button class="btn btn--ghost small" data-act="edit">Editar</button> <button class="btn btn--ghost small danger" data-act="del">Excluir</button></td>
      </tr>`).join('');
    updatePanel();
  }

  function editRow(i){
    const t = state.checklist[i]||{}; const tr = tasksBody.querySelector(`tr[data-i="${i}"]`); if(!tr) return;
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input type="text" value="${esc(t.titulo||'')}" data-f="titulo"/></td>
      <td><input type="text" value="${esc(t.responsavel||'')}" data-f="responsavel"/></td>
      <td><input type="datetime-local" value="${esc(isoToLocalDTValue(t.prazoISO||''))}" data-f="dt"/></td>
      <td>
        <select data-f="status">
          <option value="pendente"${t.status==='pendente'?' selected':''}>Pendente</option>
          <option value="andamento"${t.status==='andamento'?' selected':''}>Em andamento</option>
          <option value="feito"${t.status==='feito'?' selected':''}>Concluído</option>
        </select>
      </td>
      <td class="right">
        <button class="btn small" data-act="save">Salvar</button>
        <button class="btn btn--ghost small" data-act="cancel">Cancelar</button>
      </td>`;
  }

  function scheduleSave(){ if(state.timer) clearTimeout(state.timer); state.timer = setTimeout(doSave, AUTO_SAVE_MS); }

  async function doSave(){
    if(!state.currentId) return;
    setSaving(true);
    const next = ensureProject(JSON.parse(JSON.stringify(state.project||{})));
    next.plano.checklist = state.checklist;
    next.updatedAt = Date.now();
    await store.updateProject?.(state.currentId,next);
    state.project = await store.getProject?.(state.currentId);
    setSaving(false); setDirty(false);
    renderResumo(); updatePanel();
    bus.publish('ac:project-updated',{ id: state.currentId, updatedAt: next.updatedAt });
  }

  function onTasksClick(ev){
    const btn = ev.target.closest('button[data-act]'); if(!btn) return;
    const tr = btn.closest('tr'); const i = Number(tr?.dataset.i);
    const act = btn.dataset.act;
    if(act==='edit'){ editRow(i); return; }
    if(act==='del'){ state.checklist.splice(i,1); setDirty(true); renderTasks(); scheduleSave(); return; }
    if(act==='cancel'){ renderTasks(); return; }
    if(act==='save'){
      const titulo = tr.querySelector('[data-f="titulo"]').value.trim();
      const responsavel = tr.querySelector('[data-f="responsavel"]').value.trim();
      const dt = tr.querySelector('[data-f="dt"]').value;
      const status = tr.querySelector('[data-f="status"]').value;
      state.checklist[i] = { titulo, responsavel, prazoISO: localDTValueToISO(dt), status };
      setDirty(true); renderTasks(); scheduleSave(); return;
    }
  }

  function loadTemplate(){
    const base = [
      { titulo:'Conferir lista de convidados e contatos', offsetDays:-30, status:'pendente' },
      { titulo:'Validar fornecedores e contratos', offsetDays:-30, status:'pendente' },
      { titulo:'Definir roteiro do evento', offsetDays:-15, status:'pendente' },
      { titulo:'Enviar lembrete geral', offsetDays:-7, status:'pendente' },
      { titulo:'Briefing com equipe', offsetDays:-2, status:'pendente' },
      { titulo:'Chegada da equipe e montagem', offsetDays:0, status:'pendente' },
      { titulo:'Recepção dos convidados', offsetDays:0, status:'pendente' },
      { titulo:'Encerramento e desmontagem', offsetDays:0, status:'pendente' }
    ];
    state.checklist = base.map(t=>({ titulo:t.titulo, responsavel:'', prazoISO:'', status:t.status }));
    setDirty(true); renderTasks(); scheduleSave();
  }

  function addTask(){ state.checklist.push({ titulo:'', responsavel:'', prazoISO:'', status:'pendente' }); setDirty(true); renderTasks(); editRow(state.checklist.length-1); }

  // Eventos dos botões e tabela
  btnLoadTemplate.addEventListener('click', loadTemplate);
  btnAddTask.addEventListener('click', addTask);
  tasksBody.addEventListener('click', onTasksClick);

  // BUS — recebe id atual e atualizações
  bus.subscribe('ac:open-event', async ({ id })=>{ if(!id) return; await setCurrent(id); });
  bus.subscribe('ac:project-updated', async ({ id, updatedAt })=>{
    if(id && id===state.currentId){
      if(updatedAt){ estadoMetaUpd.textContent = fmtDateTime(updatedAt); }
      await loadCurrent(id);
    }
  });

  async function loadCurrent(id){
    state.currentId = id;
    state.project = id? await store.getProject?.(id) : null;
    ensureProject(state.project);
    state.checklist = [...(state.project.plano.checklist||[])];
    setDirty(false); setSaving(false);
    renderResumo(); renderTasks(); updatePanel();
  }

  async function setCurrent(id){ await loadCurrent(id); }

  // Handshake com a aba Eventos + fallback
const trySyncWithEventos = (maxTries=8, interval=400)=> requestCurrentProject(bus, ()=>state.currentId, { maxTries, interval });

async function bootstrap(){
  // 1) tentar sincronizar com a aba Eventos (se ela já estiver carregada)
  const synced = await trySyncWithEventos();
  if(synced && state.currentId){ return; }
  // 2) fallback local: tenta último id salvo ou o primeiro do store
  const metas = (store.listProjects?.()||[]);
  const last = localStorage.getItem('ac:lastId');
  const initial = (metas.find(m=>m.id===last)?.id) || metas[0]?.id || null;
  if(initial){ await setCurrent(initial); }
  // 3) se ainda não houver nada, apenas renderiza vazio aguardando um 'ac:open-event'
  if(!initial){ ensureProject(state.project); renderResumo(); renderTasks(); updatePanel(); }
}
await bootstrap();
</script>
</body>
</html>
