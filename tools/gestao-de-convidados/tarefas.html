<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Cerimonial — Tarefas (V4)</title>
  <style>
    :root{color-scheme: light}
    .ac{background:#fff;color:#111}
    .ac .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .threecol{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:900px){.twocol,.threecol{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:#555}
    .field input,.field select{width:100%;padding:8px 10px;border:1px solid #ccc;border-radius:8px;background:#fff;font-size:14px}
    .pill{display:inline-block;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid #ddd}
    .pill.ok{background:#f0fff4;border-color:#b6f2c7;color:#0a7a2e}
    .pill.warn{background:#fff7ed;border-color:#ffd6ae;color:#9a4b00}
    .pill.saving{background:#fffdea;border-color:#ffe9a6;color:#6a4b00}
    .btn{border-radius:8px;border:1px solid #ccc;background:#0b65c2;color:#fff;padding:8px 12px;cursor:pointer}
    .btn--ghost{background:#fff;color:#111}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .list{display:grid;gap:8px}
    .summary-line{font-size:14px;margin:4px 0}
    .kgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .kcell{border:1px solid #eee;border-radius:10px;padding:10px;font-size:13px}
    .kcell strong{font-size:15px}
    .bar{height:8px;background:#f1f1f1;border-radius:999px;overflow:hidden;margin-top:6px}
    .bar__fill{height:100%;background:linear-gradient(90deg,#59b,#378);width:0%}
    .bar__label{font-size:12px;color:#555;margin-top:4px}
    @media(max-width:900px){.kgrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:600px){.kgrid{grid-template-columns:1fr}}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;border-bottom:1px solid #ddd}
    thead th{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;text-align:left;padding:8px;font-size:12px;color:#555}
    tbody td{border-bottom:1px solid #f0f0f0;padding:8px;font-size:14px}
    td.right{text-align:right}
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
<main class="ac">
  <div class="container">
    <h1>Tarefas</h1>

    <!-- CARD 1: Resumo do evento (somente leitura, segue padrão visual) -->
    <section class="card" id="cardResumo">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h2 id="t_evTitle">—</h2>
          <div id="t_resTipoData" class="small">—</div>
        </div>
      </div>
      <div class="summary-line" id="t_resEndereco">Endereço</div>
      <div class="summary-line" id="t_resAnfitriao">Anfitrião</div>
      <div class="summary-line" id="t_resCerimonial">Cerimonialista</div>
    </section>

    <!-- CARD 2: Painel da checklist -->
    <section class="card">
      <div class="card__header"><h2>Checklist</h2></div>
      <div class="kgrid">
        <div class="kcell">Itens: <strong id="t_pnItens">0</strong></div>
        <div class="kcell">Pendentes: <strong id="t_pnPend">0</strong></div>
        <div class="kcell">Em andamento: <strong id="t_pnAnd">0</strong></div>
        <div class="kcell">Concluídos: <strong id="t_pnFeitos">0</strong></div>
        <div class="kcell" style="grid-column:1/-1">
          Progresso
          <div class="bar"><div id="t_pnBar" class="bar__fill"></div></div>
          <div class="bar__label"><span id="t_pnPct">0%</span> concluído</div>
        </div>
      </div>
    </section>

    <!-- CARD 3: Tabela de tarefas -->
    <section class="card">
      <div class="card__header">
        <h2>Itens</h2>
        <div class="row">
          <button id="t_btnLoadTemplate" class="btn btn--ghost">Carregar padrão</button>
          <button id="t_btnAddTask" class="btn">Adicionar item</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="sticky-header">
          <thead>
            <tr>
              <th>#</th>
              <th><h3>Tarefa</h3></th>
              <th><h3>Responsável</h3></th>
              <th><h3>Prazo</h3></th>
              <th><h3>Status</h3></th>
              <th class="right"><h3>Ações</h3></th>
            </tr>
          </thead>
          <tbody id="t_tasksBody"></tbody>
        </table>
      </div>
      <div class="small" id="t_tasksMeta">0 itens</div>
    </section>

    <!-- CARD 4: Estado -->
    <section class="card">
      <div class="card__header"><h2>Estado</h2></div>
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small">Projeto: <span id="t_estadoMetaId">—</span></div>
          <div class="small">Atualizado em: <span id="t_estadoMetaUpd">—</span></div>
        </div>
        <div class="row">
          <span id="t_pillLink" class="pill warn">Sem evento</span>
          <span id="t_pillSaving" class="pill ok">Pronto</span>
        </div>
      </div>
    </section>
  </div>
</main>

<script type="module">
  // Módulos compartilhados
  const PATH_BUS   = "/shared/marcoBus.js";
  const PATH_STORE = "/shared/projectStore.js";
  const CANDIDATES = [
    "https://cdn.jsdelivr.net/gh/fabiocolletto/Projeto-marco@main",
    "https://rawcdn.githack.com/fabiocolletto/Projeto-marco/main"
  ];
  async function tryImport(url){ try{ return await import(url); } catch(e1){ try{ return await import(url+(url.includes('?')?'&':'?')+'t='+Date.now()); } catch(e2){ return null; } } }
  async function loadShared(rel){ for(const base of CANDIDATES){ const mod = await tryImport(base+rel); if(mod) return mod; } return null; }

  const store = await loadShared(PATH_STORE);
  const bus   = await loadShared(PATH_BUS);
  await store?.init?.();

  // Estado
  const AUTO_SAVE_MS = 700;
  const state = { currentId:null, project:null, checklist:[], dirty:false, saving:false, timer:null };
  const $ = (s)=> document.querySelector(s);
  const setPill = (el, kind, txt)=>{ el.className = 'pill '+kind; el.textContent = txt; };
  const esc = (s)=> String(s==null?'':s).replace(/[&<>]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]));

  // Resumo
  const evTitle = $('#t_evTitle');
  const resTipoData = $('#t_resTipoData');
  const resEndereco = $('#t_resEndereco');
  const resAnfitriao = $('#t_resAnfitriao');
  const resCerimonial = $('#t_resCerimonial');
  const pillLink = $('#t_pillLink');

  // Painel
  const pnItens=$('#t_pnItens'), pnPend=$('#t_pnPend'), pnAnd=$('#t_pnAnd'), pnFeitos=$('#t_pnFeitos'), pnBar=$('#t_pnBar'), pnPct=$('#t_pnPct');

  // Tabela
  const tasksBody = $('#t_tasksBody');
  const tasksMeta = $('#t_tasksMeta');
  const btnLoadTemplate = $('#t_btnLoadTemplate');
  const btnAddTask = $('#t_btnAddTask');
  const pillDirty = $('#t_pillDirty');

  // Estado (rodapé)
  const estadoMetaId = $('#t_estadoMetaId');
  const estadoMetaUpd = $('#t_estadoMetaUpd');
  const pillSaving = $('#t_pillSaving');

  const fmtDateTime = (ts)=> ts? new Date(ts).toLocaleString() : '—';

  function ensureShape(o){
    o ||= {}; o.cerimonialista ||= { nomeCompleto:"", telefone:"", redeSocial:"" };
    o.evento ||= { nome:"", data:"", hora:"", local:"", tipo:"", endereco:{}, anfitriao:{} };
    o.evento.endereco ||= {}; o.evento.anfitriao ||= {};
    o.plano ||= {}; o.plano.checklist ||= [];
    return o;
  }

  function setDirty(v){ state.dirty=!!v; if(!state.saving){ setPill(pillSaving, v? 'warn':'ok', v? 'Alterações não salvas':'Pronto'); } }
  function setSaving(v){ state.saving=!!v; setPill(pillSaving, v? 'saving':'ok', v? 'Salvando…':'Pronto'); }

  function renderResumo(){
    const p = state.project||{}; const ev=p.evento||{}; const end=ev.endereco||{}; const anf=ev.anfitriao||{}; const cer=p.cerimonialista||{};
    evTitle.textContent = ev.nome||'—';
    resTipoData.textContent = [ev.tipo,ev.data,ev.hora].filter(Boolean).join(' • ')||'—';
    resEndereco.textContent = 'Endereço' + (end.logradouro||end.numero||end.bairro||end.cidade? ': '+[end.logradouro,end.numero,end.bairro,end.cidade].filter(Boolean).join(', '):'');
    resAnfitriao.textContent = 'Anfitrião' + (anf.nome? ': '+anf.nome:'');
    resCerimonial.textContent = 'Cerimonialista' + (cer.nomeCompleto? ': '+cer.nomeCompleto:'');
    setPill(pillLink, state.currentId? 'ok':'warn', state.currentId? 'Vinculado':'Sem evento');
    estadoMetaId.textContent = state.currentId||'—';
    estadoMetaUpd.textContent = fmtDateTime(p.updatedAt);
  }

  function checklistStats(rows){
    let feitos=0, pend=0, and=0; for(const r of (rows||[])){
      if(r.status==='feito') feitos++; else if(r.status==='andamento') and++; else pend++;
    }
    return {feitos,pend,and,total:(rows||[]).length};
  }
  function updatePanel(){
    const st = checklistStats(state.checklist);
    pnItens.textContent=String(st.total); pnPend.textContent=String(st.pend); pnAnd.textContent=String(st.and); pnFeitos.textContent=String(st.feitos);
    const pct = st.total? Math.round(st.feitos*100/st.total) : 0; pnBar.style.width=pct+'%'; pnPct.textContent=pct+'%';
  }

  function labelStatus(s){ return s==='feito'?'Concluído': s==='andamento'?'Em andamento':'Pendente'; }

  function isoToLocalDTValue(iso){ if(!iso) return ''; const [d,t='00:00:00']=iso.split('T'); return `${d}T${t.slice(0,5)}`; }
  function localDTValueToISO(val){ if(!val) return ''; const [d,t] = val.split('T'); const hhmm = (t||'00:00').slice(0,5); return `${d}T${hhmm}:00`; }

  function renderTasks(){
    const rows = state.checklist||[]; tasksMeta.textContent = `${rows.length} itens`;
    if(!rows.length){ tasksBody.innerHTML = '<tr><td colspan="6" class="small">Nenhum item.</td></tr>'; updatePanel(); return; }
    tasksBody.innerHTML = rows.map((t,i)=>`
      <tr data-i="${i}">
        <td>${i+1}</td>
        <td>${esc(t.titulo||'')}</td>
        <td>${esc(t.responsavel||'')}</td>
        <td>${esc(t.prazoISO? isoToLocalDTValue(t.prazoISO).replace('T',' '):'')}</td>
        <td>${esc(labelStatus(t.status))}</td>
        <td class="right"><button class="btn btn--ghost small" data-act="edit">Editar</button> <button class="btn btn--ghost small danger" data-act="del">Excluir</button></td>
      </tr>`).join('');
    updatePanel();
  }

  function editRow(i){
    const t = state.checklist[i]||{}; const tr = tasksBody.querySelector(`tr[data-i="${i}"]`); if(!tr) return;
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input type="text" value="${esc(t.titulo||'')}" data-f="titulo"/></td>
      <td><input type="text" value="${esc(t.responsavel||'')}" data-f="responsavel"/></td>
      <td><input type="datetime-local" value="${esc(isoToLocalDTValue(t.prazoISO||''))}" data-f="dt"/></td>
      <td>
        <select data-f="status">
          <option value="pendente"${t.status==='pendente'?' selected':''}>Pendente</option>
          <option value="andamento"${t.status==='andamento'?' selected':''}>Em andamento</option>
          <option value="feito"${t.status==='feito'?' selected':''}>Concluído</option>
        </select>
      </td>
      <td class="right">
        <button class="btn small" data-act="save">Salvar</button>
        <button class="btn btn--ghost small" data-act="cancel">Cancelar</button>
      </td>`;
  }

  function scheduleSave(){ if(state.timer) clearTimeout(state.timer); state.timer = setTimeout(doSave, AUTO_SAVE_MS); }

  async function doSave(){
    if(!state.currentId) return;
    setSaving(true);
    const next = ensureShape(JSON.parse(JSON.stringify(state.project||{})));
    next.plano.checklist = state.checklist;
    next.updatedAt = Date.now();
    await store.updateProject?.(state.currentId,next);
    state.project = await store.getProject?.(state.currentId);
    setSaving(false); setDirty(false);
    renderResumo(); updatePanel();
    bus.publish('ac:project-updated',{ id: state.currentId, updatedAt: next.updatedAt });
  }

  function onTasksClick(ev){
    const btn = ev.target.closest('button[data-act]'); if(!btn) return;
    const tr = btn.closest('tr'); const i = Number(tr?.dataset.i);
    const act = btn.dataset.act;
    if(act==='edit'){ editRow(i); return; }
    if(act==='del'){ state.checklist.splice(i,1); setDirty(true); renderTasks(); scheduleSave(); return; }
    if(act==='cancel'){ renderTasks(); return; }
    if(act==='save'){
      const titulo = tr.querySelector('[data-f="titulo"]').value.trim();
      const responsavel = tr.querySelector('[data-f="responsavel"]').value.trim();
      const dt = tr.querySelector('[data-f="dt"]').value;
      const status = tr.querySelector('[data-f="status"]').value;
      state.checklist[i] = { titulo, responsavel, prazoISO: localDTValueToISO(dt), status };
      setDirty(true); renderTasks(); scheduleSave(); return;
    }
  }

  function loadTemplate(){
    const base = [
      { titulo:'Conferir lista de convidados e contatos', offsetDays:-30, status:'pendente' },
      { titulo:'Validar fornecedores e contratos', offsetDays:-30, status:'pendente' },
      { titulo:'Definir roteiro do evento', offsetDays:-15, status:'pendente' },
      { titulo:'Enviar lembrete geral', offsetDays:-7, status:'pendente' },
      { titulo:'Briefing com equipe', offsetDays:-2, status:'pendente' },
      { titulo:'Chegada da equipe e montagem', offsetDays:0, status:'pendente' },
      { titulo:'Recepção dos convidados', offsetDays:0, status:'pendente' },
      { titulo:'Encerramento e desmontagem', offsetDays:0, status:'pendente' }
    ];
    state.checklist = base.map(t=>({ titulo:t.titulo, responsavel:'', prazoISO:'', status:t.status }));
    setDirty(true); renderTasks(); scheduleSave();
  }

  function addTask(){ state.checklist.push({ titulo:'', responsavel:'', prazoISO:'', status:'pendente' }); setDirty(true); renderTasks(); editRow(state.checklist.length-1); }

  // Eventos dos botões e tabela
  btnLoadTemplate.addEventListener('click', loadTemplate);
  btnAddTask.addEventListener('click', addTask);
  tasksBody.addEventListener('click', onTasksClick);

  // BUS — recebe id atual e atualizações
  bus.subscribe('ac:open-event', async ({ id })=>{ if(!id) return; await setCurrent(id); });
  bus.subscribe('ac:project-updated', async ({ id, updatedAt })=>{
    if(id && id===state.currentId){
      if(updatedAt){ estadoMetaUpd.textContent = fmtDateTime(updatedAt); }
      await loadCurrent(id);
    }
  });

  async function loadCurrent(id){
    state.currentId = id;
    state.project = id? await store.getProject?.(id) : null;
    ensureShape(state.project);
    state.checklist = [...(state.project.plano.checklist||[])];
    setDirty(false); setSaving(false);
    renderResumo(); renderTasks(); updatePanel();
  }

  async function setCurrent(id){ await loadCurrent(id); }

  // Handshake com a aba Eventos + fallback
async function trySyncWithEventos(maxTries=8, interval=400){
  return new Promise(resolve=>{
    let tries = 0; let got = false;
    const ask = ()=>{ try{ bus.publish('ac:request-current'); }catch{}
      tries++;
      if(state.currentId){ got=true; resolve(true); return; }
      if(tries<maxTries){ setTimeout(ask, interval); } else { resolve(false); }
    };
    // já está ouvindo 'ac:open-event' acima, então basta perguntar em loop
    ask();
  });
}

async function bootstrap(){
  // 1) tentar sincronizar com a aba Eventos (se ela já estiver carregada)
  const synced = await trySyncWithEventos();
  if(synced && state.currentId){ return; }
  // 2) fallback local: tenta último id salvo ou o primeiro do store
  const metas = (store.listProjects?.()||[]);
  const last = localStorage.getItem('ac:lastId');
  const initial = (metas.find(m=>m.id===last)?.id) || metas[0]?.id || null;
  if(initial){ await setCurrent(initial); }
  // 3) se ainda não houver nada, apenas renderiza vazio aguardando um 'ac:open-event'
  if(!initial){ ensureShape(state.project); renderResumo(); renderTasks(); updatePanel(); }
}
await bootstrap();
</script>
</body>
</html>
