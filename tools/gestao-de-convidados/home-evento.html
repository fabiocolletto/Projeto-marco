<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Cerimonial — Home do Evento</title>
  <!-- CSS único do app (repo). Troque para seu path local se preferir servir pelo WP. -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/Projeto-marco@main/Tools/gestao-de-convidados/ac.css" />
</head>
<body>
  <main class="ac">
    <div class="container">
      <h1>Assistente Cerimonial — Home do Evento</h1>
      <p class="muted">Visão geral, cadastro fixo do Cerimonial (aplicado a todos os eventos), dados do Evento e do Anfitrião. Sincronização via BUS é obrigatória.</p>

      <div class="grid">
        <!-- Resumo / KPIs -->
        <section class="card">
          <div class="card__header">
            <h3>Resumo</h3>
            <div class="row">
              <button id="btnNovo" class="btn btn--primary">Novo evento</button>
            </div>
          </div>
          <div class="kpis">
            <div class="kpi">Eventos cadastrados: <strong id="kTotalEventos">0</strong></div>
          </div>
          <div>
            <div class="muted small">Principais eventos</div>
            <ul id="listaPrincipais" class="list"></ul>
          </div>
        </section>

        <!-- 1) Cerimonial (fixo, aplicado a todos os eventos) -->
        <section class="card">
          <div class="card__header">
            <h3>Cerimonial (fixo)</h3>
            <div class="status"><span id="stCerimonial" class="pill ok">Pronto</span></div>
          </div>
          <div class="grid-2">
            <label class="row">
              <span class="muted">Nome completo</span>
              <input type="text" id="ceNome" />
            </label>
            <label class="row">
              <span class="muted">Telefone</span>
              <input type="tel" id="ceTel" />
            </label>
            <label class="row">
              <span class="muted">Rede social</span>
              <input type="text" id="ceRede" />
            </label>
            <label class="row">
              <span class="muted">E-mail</span>
              <input type="email" id="ceEmail" />
            </label>
          </div>
          <div class="muted small">Esses dados são padrão e serão aplicados a todos os eventos automaticamente.</div>
          <div class="actions">
            <button id="btnSaveCerimonial" class="btn btn--primary" disabled>Salvar</button>
          </div>
        </section>

        <!-- 2) Dados do Evento -->
        <section class="card">
          <div class="card__header">
            <h3>Evento</h3>
            <div class="status"><span id="stEvento" class="pill ok">Pronto</span></div>
          </div>
          <div class="grid-2">
            <label class="row">
              <span class="muted">Nome do evento</span>
              <input type="text" id="evNome" placeholder="Ex.: Aniversário da Laura" />
            </label>
            <div class="row">
              <label class="row">
                <span class="muted">Data</span>
                <input type="date" id="evData" />
              </label>
              <label class="row">
                <span class="muted">Hora</span>
                <input type="time" id="evHora" />
              </label>
            </div>
          </div>
          <div class="grid-2">
            <label class="row">
              <span class="muted">Tipo do evento</span>
              <select id="evTipo">
                <option value="">(selecione)</option>
                <option>Aniversário</option>
                <option>Casamento</option>
                <option>Formatura</option>
                <option>Chá revelação</option>
                <option>Batizado</option>
                <option>Corporativo</option>
                <option>Jantar</option>
                <option>Outro</option>
              </select>
            </label>
            <label class="row">
              <span class="muted">Público estimado</span>
              <input type="number" id="evPublicoPrevisto" min="0" step="1" placeholder="Ex.: 120" />
            </label>
          </div>
          <label class="row">
            <span class="muted">Local</span>
            <input type="text" id="evLocal" placeholder="Salão, chácara etc." />
          </label>
          <details>
            <summary class="muted">Endereço do evento (opcional)</summary>
            <div class="grid-2">
              <label class="row"><span class="muted">Logradouro</span><input type="text" id="endLogradouro" /></label>
              <label class="row"><span class="muted">Número</span><input type="text" id="endNumero" /></label>
              <label class="row"><span class="muted">Bairro</span><input type="text" id="endBairro" /></label>
              <label class="row"><span class="muted">Cidade</span><input type="text" id="endCidade" /></label>
              <label class="row"><span class="muted">Estado</span><input type="text" id="endEstado" /></label>
              <label class="row"><span class="muted">CEP</span><input type="text" id="endCep" /></label>
              <label class="row" style="grid-column: 1 / -1"><span class="muted">Complemento</span><input type="text" id="endComp" /></label>
            </div>
          </details>
          <div class="actions">
            <button id="btnSaveEvento" class="btn btn--primary" disabled>Salvar</button>
          </div>
        </section>

        <!-- 3) Anfitrião -->
        <section class="card">
          <div class="card__header">
            <h3>Anfitrião</h3>
            <div class="status"><span id="stAnfitriao" class="pill ok">Pronto</span></div>
          </div>
          <div class="grid-2">
            <label class="row">
              <span class="muted">Nome completo</span>
              <input type="text" id="anNome" />
            </label>
            <label class="row">
              <span class="muted">Telefone</span>
              <input type="tel" id="anTel" />
            </label>
            <label class="row">
              <span class="muted">E-mail</span>
              <input type="email" id="anEmail" />
            </label>
            <label class="row">
              <span class="muted">Rede social</span>
              <input type="text" id="anRede" />
            </label>
          </div>
          <details>
            <summary class="muted">Dados para convite (opcional)</summary>
            <div class="grid-2">
              <label class="row">
                <span class="muted">Canal preferido</span>
                <select id="anConvCanal">
                  <option value="">(selecione)</option>
                  <option>WhatsApp</option>
                  <option>SMS</option>
                  <option>Ligação</option>
                  <option>E-mail</option>
                </select>
              </label>
              <label class="row">
                <span class="muted">Horário preferido</span>
                <input type="time" id="anConvHorario" />
              </label>
              <label class="row">
                <span class="muted">Link do convite digital</span>
                <input type="url" id="anConvLink" placeholder="https://..." />
              </label>
            </div>
          </details>
          <label class="row">
            <span class="muted">Observações</span>
            <textarea id="anObs" placeholder="Detalhes importantes para a recepção..."></textarea>
          </label>
          <div class="actions">
            <button id="btnSaveAnfitriao" class="btn btn--primary" disabled>Salvar</button>
          </div>
        </section>
      </div>
    </div>

    <!-- Modal BUS ausente -->
    <div id="modalBus" class="ac-modal" role="dialog" aria-modal="true" hidden>
      <div class="box">
        <h3>Erro de inicialização</h3>
        <p class="muted">O barramento de eventos (BUS) é obrigatório para sincronização entre as telas. Verifique o caminho de <code>/shared/marcoBus.js</code> e recarregue a página.</p>
        <div class="row-end"><button id="btnCloseBus" class="btn">Fechar</button></div>
      </div>
    </div>
  </main>

  <script type="module">
    // --- Imports obrigatórios do repositório (apenas /shared) ---
    const PATH_STORE = "/shared/projectStore.js";
    const PATH_BUS   = "/shared/marcoBus.js";

    const CANDIDATES = [
      "https://cdn.jsdelivr.net/gh/fabiocolletto/Projeto-marco@main",
      "https://rawcdn.githack.com/fabiocolletto/Projeto-marco/main",
    ];

    async function tryImport(url){
      try { return await import(url); } catch(e1){
        try { return await import(url + (url.includes("?")?"&":"?") + "t=" + Date.now()); } catch(e2){ return null; }
      }
    }
    async function loadShared(rel){
      for (const base of CANDIDATES){
        const mod = await tryImport(base + rel);
        if (mod) return mod;
      }
      return null;
    }

    const store = await loadShared(PATH_STORE);
    const bus   = await loadShared(PATH_BUS);

    // BUS é obrigatório
    const modalBus = document.querySelector('#modalBus');
    document.querySelector('#btnCloseBus')?.addEventListener('click', ()=> modalBus.setAttribute('hidden',''));
    if (!bus || typeof bus.publish !== 'function' || typeof bus.subscribe !== 'function'){
      modalBus.removeAttribute('hidden');
      throw new Error('BUS obrigatório não carregou.');
    }

    // Store requerido
    if (!store || typeof store.init !== 'function'){
      console.warn('projectStore não disponível. A tela não funcionará corretamente.');
    }
    await store?.init?.();

    // --- Estado ---
    const state = {
      currentId: null,
      project: null,
      dirty: { evento:false, cerimonial:false, anfitriao:false },
    };

    // --- Helpers DOM ---
    const $ = (s)=> document.querySelector(s);
    const setPill = (el, dirty)=> { el.textContent = dirty ? 'Alterações não salvas' : 'Pronto'; el.className = 'pill ' + (dirty? 'warn':'ok'); };
    const isEq = (a,b)=> JSON.stringify(a) === JSON.stringify(b);

    // Gera nome automático combinando Nome + Data + Hora
    function computeEventName(ev){
      const nome = (ev?.nome||'').trim();
      const data = (ev?.data||'').trim();
      const hora = (ev?.hora||'').trim();
      const parts = [];
      if (nome) parts.push(nome);
      if (data && hora) parts.push(`${data} ${hora}`);
      else if (data) parts.push(data);
      else if (hora) parts.push(hora);
      return (parts.join(' — ').trim()) || `Evento ${new Date().toLocaleString()}`;
    }

    // --- Campos ---
    const kTotalEventos = $('#kTotalEventos');
    const listaPrincipais = $('#listaPrincipais');

    // Evento
    const evNome = $('#evNome');
    const evData = $('#evData');
    const evHora = $('#evHora');
    const evTipo = $('#evTipo');
    const evPublicoPrevisto = $('#evPublicoPrevisto');
    const evLocal = $('#evLocal');
    const endLogradouro = $('#endLogradouro');
    const endNumero = $('#endNumero');
    const endBairro = $('#endBairro');
    const endCidade = $('#endCidade');
    const endEstado = $('#endEstado');
    const endCep = $('#endCep');
    const endComp = $('#endComp');
    const stEvento = $('#stEvento');
    const btnSaveEvento = $('#btnSaveEvento');

    // Cerimonial
    const ceNome = $('#ceNome');
    const ceTel = $('#ceTel');
    const ceRede = $('#ceRede');
    const ceEmail = $('#ceEmail');
    const stCerimonial = $('#stCerimonial');
    const btnSaveCerimonial = $('#btnSaveCerimonial');

    // Anfitrião
    const anNome = $('#anNome');
    const anTel = $('#anTel');
    const anEmail = $('#anEmail');
    const anRede = $('#anRede');
    const anObs = $('#anObs');
    const anConvCanal = $('#anConvCanal');
    const anConvHorario = $('#anConvHorario');
    const anConvLink = $('#anConvLink');
    const stAnfitriao = $('#stAnfitriao');
    const btnSaveAnfitriao = $('#btnSaveAnfitriao');

    // Ações gerais
    $('#btnNovo').addEventListener('click', async ()=>{
      const seed = readEvento();
      const created = await store.createProject?.({ nome: computeEventName(seed), cerimonialista: loadCerimonialLocal() });
      const id = created?.payload?.id || created?.id;
      await loadCurrent(id);
      bus.publish('ac:open-event', { id });
    });

    // --- Cerimonial padrão (localStorage) ---
    const LS_CE = 'marco:cerimonial:preset:v1';
    const loadCerimonialLocal = ()=> { try { return JSON.parse(localStorage.getItem(LS_CE)||'null') || {}; } catch { return {}; } };
    const saveCerimonialLocal = (o)=> { try { localStorage.setItem(LS_CE, JSON.stringify(o||{})); } catch {} };

    // --- Snapshots ---
    const savedEvento = ()=> (state.project?.evento)||{ endereco:{} };
    const savedAnfitriao = ()=> (state.project?.evento?.anfitriao)||{};
    const savedCerimonial = ()=> (state.project?.cerimonialista)||loadCerimonialLocal();

    const readEvento = ()=> ({
      nome: evNome.value.trim(),
      data: evData.value,
      hora: evHora.value,
      tipo: evTipo.value.trim(),
      publicoPrevisto: Math.max(0, parseInt(evPublicoPrevisto.value, 10) || 0),
      local: evLocal.value.trim(),
      endereco: {
        logradouro: endLogradouro.value.trim(),
        numero: endNumero.value.trim(),
        bairro: endBairro.value.trim(),
        cidade: endCidade.value.trim(),
        estado: endEstado.value.trim(),
        cep: endCep.value.trim(),
        complemento: endComp.value.trim(),
      }
    });
    const writeEvento = (ev={})=>{
      evNome.value = ev.nome||'';
      evData.value = ev.data||'';
      evHora.value = ev.hora||'';
      evTipo.value = ev.tipo||'';
      evPublicoPrevisto.value = ev.publicoPrevisto ?? '';
      evLocal.value = ev.local||'';
      const e = ev.endereco||{};
      endLogradouro.value = e.logradouro||'';
      endNumero.value = e.numero||'';
      endBairro.value = e.bairro||'';
      endCidade.value = e.cidade||'';
      endEstado.value = e.estado||'';
      endCep.value = e.cep||'';
      endComp.value = e.complemento||'';
    };

    const readAnfitriao = ()=> ({
      nomeCompleto: anNome.value.trim(),
      telefone: anTel.value.trim(),
      email: anEmail.value.trim(),
      redeSocial: anRede.value.trim(),
      convite: {
        canal: anConvCanal.value.trim(),
        horario: anConvHorario.value,
        link: anConvLink.value.trim(),
      },
      obs: anObs.value.trim(),
    });
    const writeAnfitriao = (a={})=>{
      anNome.value = a.nomeCompleto||'';
      anTel.value = a.telefone||'';
      anEmail.value = a.email||'';
      anRede.value = a.redeSocial||'';
      anConvCanal.value = a?.convite?.canal || '';
      anConvHorario.value = a?.convite?.horario || '';
      anConvLink.value = a?.convite?.link || '';
      anObs.value = a.obs||'';
    };

    const readCerimonial = ()=> ({
      nomeCompleto: ceNome.value.trim(),
      telefone: ceTel.value.trim(),
      redeSocial: ceRede.value.trim(),
      email: ceEmail.value.trim(),
    });
    const writeCerimonial = (c={})=>{
      ceNome.value = c.nomeCompleto||'';
      ceTel.value = c.telefone||'';
      ceRede.value = c.redeSocial||'';
      ceEmail.value = c.email||'';
    };

    function bindDirty(){
      const setDirty = (which, val)=>{
        state.dirty[which] = !!val;
        if (which==='evento'){ setPill(stEvento, state.dirty.evento); btnSaveEvento.disabled = !state.dirty.evento; }
        if (which==='cerimonial'){ setPill(stCerimonial, state.dirty.cerimonial); btnSaveCerimonial.disabled = !state.dirty.cerimonial; }
        if (which==='anfitriao'){ setPill(stAnfitriao, state.dirty.anfitriao); btnSaveAnfitriao.disabled = !state.dirty.anfitriao; }
      };
      const onEv = ()=> setDirty('evento', !isEq(readEvento(), savedEvento()));
      const onCe = ()=> setDirty('cerimonial', !isEq(readCerimonial(), savedCerimonial()));
      const onAn = ()=> setDirty('anfitriao', !isEq(readAnfitriao(), savedAnfitriao()));

      [evNome, evData, evHora, evTipo, evPublicoPrevisto, evLocal, endLogradouro, endNumero, endBairro, endCidade, endEstado, endCep, endComp].forEach(el=> el.addEventListener('input', onEv));
      [ceNome, ceTel, ceRede, ceEmail].forEach(el=> el.addEventListener('input', onCe));
      [anNome, anTel, anEmail, anRede, anConvCanal, anConvHorario, anConvLink, anObs].forEach(el=> el.addEventListener('input', onAn));
    }

    // --- Persistência ---
    async function ensureProject(){
      if (state.currentId) return state.currentId;
      const seed = readEvento();
      const created = await store.createProject?.({ nome: computeEventName(seed), cerimonialista: loadCerimonialLocal() });
      const id = created?.payload?.id || created?.id;
      state.currentId = id;
      state.project = created?.payload || created || null;
      await refreshResumo();
      return id;
    }

    async function saveEvento(){
      const id = await ensureProject();
      const ev = readEvento();
      const nomeAuto = computeEventName(ev);
      await store.updateProject?.(id, { evento: { ...(state.project?.evento||{}), ...ev }, nome: nomeAuto });
      await loadCurrent(id);
      bus.publish('ac:project-updated', { id });
    }

    async function saveCerimonial(){
      // Sempre aplica para TODOS os eventos e salva como preset local
      const ce = readCerimonial();
      saveCerimonialLocal(ce);

      // Atualiza projeto atual (criando se necessário)
      const id = await ensureProject();
      await store.updateProject?.(id, { cerimonialista: ce });

      // Aplica em todos os projetos existentes
      for (const m of (store.listProjects?.()||[])){
        try { await store.updateProject?.(m.id, { cerimonialista: ce }); } catch {}
      }

      await loadCurrent(id);
      bus.publish('ac:cerimonial-updated', { id, ce, global:true });
    }

    async function saveAnfitriao(){
      const id = await ensureProject();
      const an = readAnfitriao();
      const ev = { ...(state.project?.evento||{}), anfitriao: an };
      await store.updateProject?.(id, { evento: ev });
      await loadCurrent(id);
      bus.publish('ac:project-updated', { id });
    }

    btnSaveEvento.addEventListener('click', saveEvento);
    btnSaveCerimonial.addEventListener('click', saveCerimonial);
    btnSaveAnfitriao.addEventListener('click', saveAnfitriao);

    // --- Ações na lista: Abrir, Excluir ---
    async function openEvent(id){
      await loadCurrent(id);
      bus.publish('ac:open-event', { id });
    }

    async function deleteEvent(id){
      const p = await store.getProject?.(id);
      const name = p?.evento?.nome || p?.nome || 'evento';
      if (typeof window.confirm !== 'function') {
        console.warn('confirmação (confirm) indisponível neste ambiente; a exclusão pode não abrir pop-up durante o teste.');
      }
      const ok = window.confirm ? window.confirm(`Excluir "${name}"? Esta ação não pode ser desfeita.`) : true;
      if (!ok) return;
      if (typeof store.deleteProject === 'function'){
        await store.deleteProject(id);
      } else {
        // Fallback: marca como deletado quando deleteProject não existir
        await store.updateProject?.(id, { _deleted: true });
      }
      // Se o evento atual foi removido, limpa a tela
      if (state.currentId === id){
        state.currentId = null;
        state.project = null;
        writeEvento({}); writeAnfitriao({}); writeCerimonial(loadCerimonialLocal());
        setPill(stEvento, false); setPill(stCerimonial, false); setPill(stAnfitriao, false);
        btnSaveEvento.disabled = true; btnSaveCerimonial.disabled = true; btnSaveAnfitriao.disabled = true;
      }
      await refreshResumo();
      bus.publish('ac:project-deleted', { id });
    }

    // --- Resumo ---
    async function refreshResumo(){
      let metas = store.listProjects?.() || [];
      const filtered = [];
      for (const m of metas){
        if (m._deleted) continue;
        let full = null;
        try { full = await store.getProject?.(m.id); } catch {}
        if (full?._deleted) continue;
        filtered.push({ meta: m, full });
      }
      kTotalEventos.textContent = String(filtered.length);
      listaPrincipais.innerHTML = '';
      filtered.slice(0,5).forEach(({meta:m, full}) => {
        const ev = full?.evento || m?.evento || {};
        const display = computeEventName(ev) || m.nome || 'Sem nome';
        const li = document.createElement('li');
        const name = document.createElement('span'); name.textContent = display;
        const when = document.createElement('span'); when.className = 'muted small'; when.textContent = (m.updatedAt || full?.updatedAt) ? new Date(m.updatedAt || full?.updatedAt).toLocaleString() : '';
        const actions = document.createElement('div'); actions.className = 'list-actions';

        const bOpen = document.createElement('button'); bOpen.className = 'btn btn--ghost'; bOpen.textContent = 'Abrir';
        bOpen.addEventListener('click', ()=> openEvent(m.id));

        const bDel = document.createElement('button'); bDel.className = 'btn btn--danger'; bDel.textContent = 'Excluir';
        bDel.addEventListener('click', ()=> deleteEvent(m.id));

        actions.append(bOpen, bDel);
        li.append(name, when, actions);
        listaPrincipais.appendChild(li);
      });
    }

    async function loadCurrent(id){
      state.currentId = id || state.currentId;
      state.project = state.currentId ? await store.getProject?.(state.currentId) : null;
      const p = state.project || { evento:{ endereco:{} }, cerimonialista:{}, lista:[], vars:{}, anfitriao:{} };
      writeEvento(p.evento||{});
      writeAnfitriao(p.evento?.anfitriao||{});
      writeCerimonial(p.cerimonialista||loadCerimonialLocal());
      setPill(stEvento, false); setPill(stCerimonial, false); setPill(stAnfitriao, false);
      btnSaveEvento.disabled = true; btnSaveCerimonial.disabled = true; btnSaveAnfitriao.disabled = true;
      await refreshResumo();
    }

    // --- BUS subscriptions ---
    bus.subscribe('ac:open-event', ({ id }) => { if (id) loadCurrent(id); });
    bus.subscribe('ac:project-updated', ({ id }) => { if (id === state.currentId) loadCurrent(id); });
    bus.subscribe('ac:cerimonial-updated', ({ id }) => { if (id === state.currentId) loadCurrent(id); });
    bus.subscribe('ac:project-deleted', ({ id }) => { if (id === state.currentId) { state.currentId = null; refreshResumo(); } });

    // --- Inicialização ---
    bindDirty();
    await refreshResumo();
    // opcionalmente tente abrir o último by design futuramente
  </script>
</body>
</html>
