<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestão de Eventos</title>
    <style>
      :root {
        color-scheme: dark light;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        height: 100%;
        background: #0f1824;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: #f5f7fa;
      }

      iframe {
        border: 0;
        width: 100%;
        height: 100%;
        display: block;
      }

      .fallback {
        display: grid;
        place-content: center;
        padding: 3rem 1.5rem;
        text-align: center;
        gap: 1rem;
      }

      .fallback h1 {
        font-size: 1.25rem;
        margin: 0;
      }

      .fallback p {
        margin: 0;
        opacity: 0.72;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <iframe
      id="gestao-eventos-frame"
      src="about:blank"
      allow="clipboard-write"
      referrerpolicy="no-referrer"
      loading="lazy"
      title="Gestão de Eventos"
    ></iframe>

    <template id="fallback-template">
      <div class="fallback">
        <h1>Não foi possível carregar o aplicativo agora.</h1>
        <p>Tente novamente mais tarde ou verifique a disponibilidade das CDNs configuradas.</p>
      </div>
    </template>

    <script>
      const APP_REPO_PATH = "/tools/gestao-de-convidados/app.html";
      const CDN_BASES = [
        (() => {
          try {
            const current = new URL(window.location.href);
            return current.origin.startsWith("http") ? current.origin : null;
          } catch {
            return null;
          }
        })(),
        "https://cdn.jsdelivr.net/gh/fabiocolletto/Projeto-marco@main",
        "https://rawcdn.githack.com/fabiocolletto/Projeto-marco/main"
      ].filter(Boolean);

      const buildUrl = (base, rel) => {
        if (!base) return rel;
        const cleanRel = rel.startsWith("/") ? rel.slice(1) : rel;
        const normalized = base.endsWith("/") ? base : `${base}/`;
        return `${normalized}${cleanRel}`;
      };

      const resolveLocalApp = () => {
        try {
          return new URL("app.html", window.location.href).href;
        } catch {
          return "app.html";
        }
      };

      const APP_SOURCES = [
        resolveLocalApp(),
        ...CDN_BASES.map((base) => buildUrl(base, APP_REPO_PATH))
      ].reduce((list, src) => {
        if (src && !list.includes(src)) list.push(src);
        return list;
      }, []);

      const ATTEMPT_TIMEOUT = 10000;

      const frame = document.getElementById("gestao-eventos-frame");
      const fallbackTemplate = document.getElementById("fallback-template");

      const allowedOrigins = APP_SOURCES.reduce((origins, src) => {
        try {
          const origin = new URL(src).origin;
          if (!origins.includes(origin)) {
            origins.push(origin);
          }
        } catch (err) {
          console.warn("URL inválida configurada", src, err);
        }
        return origins;
      }, []);

      let currentAttempt = null;
      let timeoutId = null;
      let fallbackVisible = false;

      function clearTimer() {
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
      }

      function showFallback() {
        if (fallbackVisible) {
          return;
        }
        fallbackVisible = true;
        clearTimer();
        frame.setAttribute("hidden", "hidden");
        const fallback = fallbackTemplate.content.cloneNode(true);
        document.body.appendChild(fallback);
      }

      function withCacheBuster(url) {
        const separator = url.includes("?") ? "&" : "?";
        return `${url}${separator}v=${Date.now()}`;
      }

      function getSignature(url) {
        try {
          const parsed = new URL(url);
          return `${parsed.origin}${parsed.pathname}`;
        } catch {
          return null;
        }
      }

      function loadFromIndex(index) {
        if (index >= APP_SOURCES.length) {
          showFallback();
          return;
        }

        const baseUrl = APP_SOURCES[index];
        let finalUrl = baseUrl;

        try {
          finalUrl = withCacheBuster(baseUrl);
        } catch (err) {
          console.warn("Não foi possível preparar URL", baseUrl, err);
        }

        currentAttempt = {
          index,
          url: finalUrl,
          signature: getSignature(baseUrl)
        };

        frame.removeAttribute("hidden");
        frame.src = finalUrl;

        clearTimer();
        timeoutId = setTimeout(() => {
          if (!currentAttempt || currentAttempt.index !== index) {
            return;
          }
          loadFromIndex(index + 1);
        }, ATTEMPT_TIMEOUT);
      }

      window.addEventListener("message", (event) => {
        if (event.source !== frame.contentWindow) {
          return;
        }

        if (!allowedOrigins.includes(event.origin)) {
          return;
        }

        const data = event.data;
        if (!data || typeof data !== "object") {
          return;
        }

        if (!currentAttempt) {
          return;
        }

        const hrefSignature = typeof data.href === "string" ? getSignature(data.href) : null;
        if (hrefSignature && currentAttempt.signature && hrefSignature !== currentAttempt.signature) {
          return;
        }

        if (data.type === "gestao-eventos-app:ready") {
          clearTimer();
          currentAttempt = null;
          return;
        }

        if (data.type === "gestao-eventos-app:error") {
          clearTimer();
          const nextIndex = currentAttempt.index + 1;
          currentAttempt = null;
          loadFromIndex(nextIndex);
        }
      });

      loadFromIndex(0);
    </script>
  </body>
</html>
