<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Cerimonial — Fornecedores</title>
  <link rel="stylesheet" href="/shared/gestaoEventosApp.css">
</head>
<body>
<main class="ac">
  <div class="container">
    <h1>Fornecedores</h1>

    <!-- CARD 1: Resumo do evento (prefixo f2_) -->
    <section class="card" id="f2_cardResumo">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h2 id="f2_evTitle">—</h2>
          <div id="f2_resTipoData" class="small">—</div>
        </div>
      </div>
      <div class="summary-line" id="f2_resEndereco">Endereço</div>
      <div class="summary-line" id="f2_resAnfitriao">Anfitrião</div>
      <div class="summary-line" id="f2_resCerimonial">Cerimonialista</div>
    </section>

    <!-- CARD 2: Indicadores de custos -->
    <section class="card">
      <div class="card__header"><h2>Indicadores</h2></div>
      <div class="kpi-cards">
        <div class="mini-card">
          <h3>Custos</h3>
          <div class="mini-grid">
            <div><strong id="f2_kpiFornecedores">0</strong><div class="small">Fornecedores</div></div>
            <div><strong id="f2_kpiPrevisto">R$ 0,00</strong><div class="small">Previsto</div></div>
            <div><strong id="f2_kpiPago">R$ 0,00</strong><div class="small">Pago</div></div>
            <div><strong id="f2_kpiPendente">R$ 0,00</strong><div class="small">Pendente</div></div>
            <div><strong id="f2_kpiPercentPago">0%</strong><div class="small">% Pago</div></div>
          </div>
        </div>
        <div class="mini-card">
          <h3>Pagamentos</h3>
          <div class="mini-grid">
            <div><strong id="f2_kpiQtdPago">0</strong><div class="small">Quitados</div></div>
            <div><strong id="f2_kpiQtdPendente">0</strong><div class="small">Pendentes</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CARD 3: Adicionar / atualizar lista -->
    <section class="card">
      <div class="card__header"><h2>Adicionar / atualizar fornecedores</h2></div>
      <div class="field">
        <label for="f2_raw"><h3>Cole uma ou mais linhas com nome, serviço, valor e contato (um fornecedor por linha). Nós padronizamos e mesclamos automaticamente.</h3></label>
        <textarea id="f2_raw" placeholder=""></textarea>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="f2_btnGerar" class="btn" type="button">Gerar/mesclar</button>
        <button id="f2_btnSubstituir" class="btn btn--ghost" type="button">Substituir lista</button>
      </div>
      <div class="small" id="f2_lastGen">—</div>
    </section>

    <!-- CARD 4: Lista de fornecedores -->
    <section class="card">
      <div class="card__header"><h2>Lista</h2></div>
      <div class="table-wrap table-wrap--scroll">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th><h3>Fornecedor / Serviço</h3></th>
              <th><h3>Previsto</h3></th>
              <th><h3>Pago</h3></th>
              <th><h3>Status</h3></th>
              <th><h3>Contato</h3></th>
              <th class="right col-actions"><h3>Ações</h3></th>
            </tr>
          </thead>
          <tbody id="f2_listBody"></tbody>
          <tfoot>
            <tr>
              <td colspan="7" id="f2_listSummary" class="small" style="text-align:right">—</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="small" id="f2_listMeta" style="display:none"></div>
    </section>

    <!-- CARD 5: Estado -->
    <section class="card">
      <div class="card__header"><h2>Estado</h2></div>
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small">Projeto: <span id="f2_estadoMetaId">—</span></div>
          <div class="small">Atualizado em: <span id="f2_estadoMetaUpd">—</span></div>
        </div>
        <div class="row">
          <span id="f2_pillLink" class="pill warn">Sem evento</span>
          <span id="f2_pillSaving" class="pill ok">Pronto</span>
        </div>
      </div>
    </section>
  </div>
</main>

<script type="module">
  // Módulos compartilhados
  const PATH_BUS   = "/shared/marcoBus.js";
  const PATH_STORE = "/shared/projectStore.js";
  const CDN_BASES = [
    (() => {
      try {
        const url = new URL(import.meta.url);
        return url.origin.startsWith('http') ? url.origin : null;
      } catch {
        return null;
      }
    })(),
    "https://cdn.jsdelivr.net/gh/fabiocolletto/Projeto-marco@main",
    "https://rawcdn.githack.com/fabiocolletto/Projeto-marco/main"
  ].filter(Boolean);

  const buildUrl = (base, rel) => {
    if (!base) return rel;
    const cleanRel = rel.startsWith('/') ? rel.slice(1) : rel;
    const normalized = base.endsWith('/') ? base : base + '/';
    return normalized + cleanRel;
  };

  async function loadShared(rel){
    const attempts = [rel, ...CDN_BASES.map((base) => buildUrl(base, rel))];
    for (const url of attempts) {
      try {
        const mod = await import(url);
        if (mod) return mod;
      } catch (err) {
        console.warn('[fornecedores] Falha ao importar', url, err);
      }
    }
    return null;
  }

  const store = await loadShared(PATH_STORE);
  const bus   = await loadShared(PATH_BUS);

  if(!store || !bus){
    const errorMessage = 'Não foi possível carregar os módulos compartilhados. Atualize a página ou tente novamente mais tarde.';
    showLoadError(errorMessage);
    throw new Error(errorMessage);
  }

  await store.init?.();

  // Estado e utilitários (nomes/ids exclusivos com prefixo f2_)
  const AUTO_SAVE_MS = 700;
  const state = { currentId:null, project:null, fornecedores:[], dirty:false, saving:false, timer:null };
  const $ = (s)=> document.querySelector(s);
  const setPill = (el, kind, txt)=>{ el.className = 'pill '+kind; el.textContent = txt; };
  const esc = (s)=> String(s==null?'':s).replace(/[&<>]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]));
  const escAttr = (s)=> String(s==null?'':s).replace(/[&<>"'`]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','`':'&#96;' }[m]));
  const fmtDateTime = (ts)=> ts? new Date(ts).toLocaleString() : '—';
  const money = (v)=> (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  // Resumo
  const evTitle = $('#f2_evTitle');
  const resTipoData = $('#f2_resTipoData');
  const resEndereco = $('#f2_resEndereco');
  const resAnfitriao = $('#f2_resAnfitriao');
  const resCerimonial = $('#f2_resCerimonial');
  const pillLink = $('#f2_pillLink');

  // KPIs
  const kFornec   = $('#f2_kpiFornecedores');
  const kPrevisto = $('#f2_kpiPrevisto');
  const kPago     = $('#f2_kpiPago');
  const kPendente = $('#f2_kpiPendente');
  const kPercent  = $('#f2_kpiPercentPago');
  const kQtdPago  = $('#f2_kpiQtdPago');
  const kQtdPend  = $('#f2_kpiQtdPendente');

  // Form importar/adicionar
  const txtRaw = $('#f2_raw');
  const btnGerar = $('#f2_btnGerar');
  const btnSubstituir = $('#f2_btnSubstituir');
  const lastGen = $('#f2_lastGen');

  // Lista
  const listBody = $('#f2_listBody');
  const listMeta = $('#f2_listMeta');
  const listSummary = $('#f2_listSummary');

  // Estado (rodapé)
  const estadoMetaId = $('#f2_estadoMetaId');
  const estadoMetaUpd = $('#f2_estadoMetaUpd');
  const pillSaving = $('#f2_pillSaving');

  function ensureShape(o){
    o ||= {}; o.fornecedores ||= [];
    o.cerimonialista ||= { nomeCompleto:"", telefone:"", redeSocial:"" };
    o.evento ||= { nome:"", data:"", hora:"", local:"", tipo:"", endereco:{}, anfitriao:{} };
    o.evento.endereco ||= {}; o.evento.anfitriao ||= {};
    return o;
  }

  function setDirty(v){ state.dirty=!!v; if(!state.saving){ setPill(pillSaving, v? 'warn':'ok', v? 'Alterações não salvas':'Pronto'); } }
  function setSaving(v){ state.saving=!!v; setPill(pillSaving, v? 'saving':'ok', v? 'Salvando…':'Pronto'); }

  // ======= KPIs =======
  function stats(){
    const rows = state.fornecedores||[];
    const n = rows.length;
    let previsto=0, pago=0, pend=0, qtdPago=0, qtdPend=0;
    for(const f of rows){
      const p = Number(f.previsto)||0;
      const r = Number(f.pago)||0;
      previsto += p;
      pago += r;
      const d = p - r; pend += d>0? d:0;
      if((f.status||'').toLowerCase()==='pago' || r>=p){ qtdPago++; } else { qtdPend++; }
    }
    const percent = previsto>0 ? Math.round((pago/previsto)*100) : 0;
    return {n, previsto, pago, pend, percent, qtdPago, qtdPend};
  }
  function updateKPIs(){
    const st = stats();
    if(kFornec)   kFornec.textContent = String(st.n);
    if(kPrevisto) kPrevisto.textContent = money(st.previsto);
    if(kPago)     kPago.textContent = money(st.pago);
    if(kPendente) kPendente.textContent = money(st.pend);
    if(kPercent)  kPercent.textContent = st.percent+"%";
    if(kQtdPago)  kQtdPago.textContent = String(st.qtdPago);
    if(kQtdPend)  kQtdPend.textContent = String(st.qtdPend);
    if(listSummary) listSummary.textContent = `${st.n} fornecedores • ${money(st.previsto)} previsto • ${money(st.pago)} pagos • ${money(st.pend)} pendentes`;
  }

  // ======= Render =======
  function renderResumo(){
    const p=state.project||{}; const ev=p.evento||{}; const end=ev.endereco||{}; const anf=ev.anfitriao||{}; const cer=p.cerimonialista||{};
    evTitle.textContent=ev.nome||'—';
    resTipoData.textContent=[ev.tipo,ev.data,ev.hora].filter(Boolean).join(' • ')||'—';
    resEndereco.textContent='Endereço'+(end.logradouro||end.numero||end.bairro||end.cidade? ': '+[end.logradouro,end.numero,end.bairro,end.cidade].filter(Boolean).join(', '):'');
    resAnfitriao.textContent='Anfitrião'+(anf.nome? ': '+anf.nome:'');
    resCerimonial.textContent='Cerimonialista'+(cer.nomeCompleto? ': '+cer.nomeCompleto:'');
    setPill(pillLink, state.currentId? 'ok':'warn', state.currentId? 'Vinculado':'Sem evento');
    estadoMetaId.textContent=state.currentId||'—';
    estadoMetaUpd.textContent=fmtDateTime(p.updatedAt);
  }

  function renderList(){
    const rows = state.fornecedores||[];
    listMeta.textContent = `${rows.length} itens`;
    if(!rows.length){ listBody.innerHTML = '<tr><td colspan="7" class="small">Nenhum fornecedor.</td></tr>'; updateKPIs(); return; }
    listBody.innerHTML = rows.map((f,i)=>{
      const nomeServ = [f.nome||'', f.servico||''].filter(Boolean).join(' — ');
      return `<tr data-i="${i}">\n        <td>${i+1}</td>\n        <td>${esc(nomeServ)}</td>\n        <td>${money(f.previsto)}</td>\n        <td>${money(f.pago)}</td>\n        <td>${esc(f.status||'pendente')}</td>\n        <td>${esc(f.contato||'')}</td>\n        <td class="right col-actions"><button class="icon-btn" data-act="edit" title="Editar" aria-label="Editar">✎</button></td>\n      </tr>`;
    }).join('');
    updateKPIs();
  }

  function editRow(i){
    const f = state.fornecedores[i]||{}; const tr = listBody.querySelector(`tr[data-i="${i}"]`); if(!tr) return;
    tr.innerHTML = `\n      <td>${i+1}</td>\n      <td class="twocol">\n        <input type="text" value="${escAttr(f.nome||'')}" data-f="nome" placeholder="Fornecedor"/>\n        <input type="text" value="${escAttr(f.servico||'')}" data-f="servico" placeholder="Serviço"/>\n      </td>\n      <td><input type="number" step="0.01" value="${escAttr(f.previsto||0)}" data-f="previsto" placeholder="0,00"/></td>\n      <td><input type="number" step="0.01" value="${escAttr(f.pago||0)}" data-f="pago" placeholder="0,00"/></td>\n      <td>\n        <select data-f="status">\n          <option value="pendente"${(f.status||'')==='pendente'?' selected':''}>Pendente</option>\n          <option value="pago"${(f.status||'')==='pago'?' selected':''}>Pago</option>\n        </select>\n      </td>\n      <td><input type="text" value="${escAttr(f.contato||'')}" data-f="contato" placeholder="Telefone/Email"/></td>\n      <td class="right col-actions">\n        <button class="btn small" data-act="save" title="Salvar">Salvar</button>\n        <button class="btn btn--ghost small" data-act="cancel" title="Cancelar">⟲</button>\n        <button class="btn btn--ghost small danger" data-act="del" title="Excluir">🗑</button>\n      </td>`;
  }

  function onListClick(ev){
    const btn = ev.target.closest('button[data-act]'); if(!btn) return;
    const tr = btn.closest('tr'); const i = Number(tr?.dataset.i);
    const act = btn.dataset.act;
    if(act==='edit'){ editRow(i); return; }
    if(act==='del'){ state.fornecedores.splice(i,1); setDirty(true); renderList(); scheduleSave(); return; }
    if(act==='cancel'){ renderList(); return; }
    if(act==='save'){
      const nome = tr.querySelector('[data-f="nome"]').value.trim();
      const servico = tr.querySelector('[data-f="servico"]').value.trim();
      const previsto = Number(tr.querySelector('[data-f="previsto"]').value)||0;
      const pago = Number(tr.querySelector('[data-f="pago"]').value)||0;
      const status = tr.querySelector('[data-f="status"]').value;
      const contato = tr.querySelector('[data-f="contato"]').value.trim();
      state.fornecedores[i] = {
        id: state.fornecedores[i]?.id || (crypto.randomUUID?.()||('id_'+Date.now())),
        nome, servico, previsto, pago, status, contato
      };
      setDirty(true); renderList(); scheduleSave(); return;
    }
  }
  listBody.addEventListener('click', onListClick);

  // ======= Parser simples de linhas livres (robusto a ; , — - /) =======
  function splitParts(line){
    const parts = String(line||'').split(/\s*[;|—\-\/,]\s*/).map(s=>s.trim()).filter(Boolean);
    return parts;
  }
  function applyParser(mode){
    const raw = txtRaw.value.trim(); if(!raw) return;
    const linhas = raw.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    const novo = linhas.map(l=>{
      const p = splitParts(l);
      const nome = p[0]||'';
      const servico = p[1]||'';
      const previsto = Number(String(p[2]||'').replace(/[^0-9.,]/g,'').replace(',','.'))||0;
      const statusRaw = (p[3]||'').toLowerCase();
      const status = /pago/.test(statusRaw)? 'pago' : 'pendente';
      const contato = p.slice(4).join(' ') || '';
      return { id:(crypto.randomUUID?.()||('id_'+Date.now()+Math.random().toString(16).slice(2))), nome, servico, previsto, pago: status==='pago'? previsto: 0, status, contato };
    });
    if(mode==='substituir'){ state.fornecedores = novo; }
    else {
      // mescla por chave nome|serviço
      const map = new Map(state.fornecedores.map(f=>[[f.nome||'',f.servico||''].join('|'), f]));
      for(const it of novo){ const k=[it.nome||'',it.servico||''].join('|'); if(map.has(k)){ const prev=map.get(k); map.set(k,{...prev,...it,id:prev.id||it.id}); } else { map.set(k,it); } }
      state.fornecedores = [...map.values()];
    }
    lastGen.textContent = `Gerado em ${new Date().toLocaleString()} • ${novo.length} fornecedores`;
    txtRaw.value=''; setDirty(true); renderList(); scheduleSave();
  }
  btnGerar.addEventListener('click', ()=> applyParser('mesclar'));
  btnSubstituir.addEventListener('click', ()=> applyParser('substituir'));

  // ======= Persistência =======
  function scheduleSave(){ if(state.timer) clearTimeout(state.timer); state.timer = setTimeout(doSave, AUTO_SAVE_MS); }
  async function doSave(){
    if(!state.currentId) return;
    setSaving(true);
    const next = ensureShape(JSON.parse(JSON.stringify(state.project||{})));
    next.fornecedores = state.fornecedores;
    next.updatedAt = Date.now();
    await store.updateProject?.(state.currentId,next);
    state.project = await store.getProject?.(state.currentId);
    setSaving(false); setDirty(false);
    renderResumo(); updateKPIs();
    bus.publish('ac:project-updated',{ id: state.currentId, updatedAt: next.updatedAt });
  }

  // ======= BUS / sincronização =======
  bus.subscribe('ac:open-event', async ({ id })=>{ if(!id) return; await setCurrent(id); });
  bus.subscribe('ac:project-updated', async ({ id, updatedAt })=>{
    if(id && id===state.currentId){ if(updatedAt){ estadoMetaUpd.textContent = fmtDateTime(updatedAt); } await loadCurrent(id); }
  });
  bus.subscribe('ac:request-current', ()=>{ if(state.currentId){ try{ bus.publish('ac:open-event',{ id: state.currentId, from:'fornecedores' }); }catch{} } });

  async function loadCurrent(id){
    state.currentId = id;
    state.project = id? await store.getProject?.(id) : null;
    ensureShape(state.project);
    state.fornecedores = [...(state.project.fornecedores||[])];
    setDirty(false); setSaving(false);
    // resumo
    const p = state.project||{}; const ev=p.evento||{}; const end=ev.endereco||{}; const anf=ev.anfitriao||{}; const cer=p.cerimonialista||{};
    evTitle.textContent = ev.nome||'—';
    resTipoData.textContent = [ev.tipo,ev.data,ev.hora].filter(Boolean).join(' • ')||'—';
    resEndereco.textContent = 'Endereço' + (end.logradouro||end.numero||end.bairro||end.cidade? ': '+[end.logradouro,end.numero,end.bairro,end.cidade].filter(Boolean).join(', '):'');
    resAnfitriao.textContent = 'Anfitrião' + (anf.nome? ': '+anf.nome:'');
    resCerimonial.textContent = 'Cerimonialista' + (cer.nomeCompleto? ': '+cer.nomeCompleto:'');
    setPill(pillLink, state.currentId? 'ok':'warn', state.currentId? 'Vinculado':'Sem evento');
    estadoMetaId.textContent = state.currentId||'—';
    estadoMetaUpd.textContent = fmtDateTime(p.updatedAt);
    renderList(); updateKPIs();
  }
  async function setCurrent(id){ await loadCurrent(id); }

  async function trySyncWithEventos(maxTries=8, interval=400){
    return new Promise(resolve=>{ let tries=0; const ask=()=>{ try{ bus.publish('ac:request-current'); }catch{} tries++; if(state.currentId){ resolve(true); return; } if(tries<maxTries){ setTimeout(ask,interval);} else { resolve(false);} }; ask(); });
  }

  (async function bootstrap(){
    const synced = await trySyncWithEventos();
    if(synced && state.currentId){ return; }
    const metas = (store.listProjects?.()||[]);
    const last = localStorage.getItem('ac:lastId');
    const initial = (metas.find(m=>m.id===last)?.id) || metas[0]?.id || null;
    if(initial){ await setCurrent(initial); }
    if(!initial){ ensureShape(state.project); /* render vazio */ }
  })();
</script>
</body>
</html>
