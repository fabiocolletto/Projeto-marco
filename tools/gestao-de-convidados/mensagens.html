<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerenciar Mensagens</title>
  <style>
    :root{color-scheme: light}
    .ac{background:#fff;color:#111}
    .ac .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.twocol{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:#555}
    .field input,.field select{width:100%;padding:8px 10px;border:1px solid #ccc;border-radius:8px;background:#fff;font-size:14px}
    .pill{display:inline-block;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid #ddd}
    .pill.ok{background:#f0fff4;border-color:#b6f2c7;color:#0a7a2e}
    .pill.warn{background:#fff7ed;border-color:#ffd6ae;color:#9a4b00}
    .pill.saving{background:#fffdea;border-color:#ffe9a6;color:#6a4b00}
    .btn{border-radius:8px;border:1px solid #ccc;background:#0b65c2;color:#fff;padding:8px 12px;cursor:pointer}
    .btn--ghost{background:#fff;color:#111}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .danger{color:#a40000}
    .summary-line{font-size:14px;margin:4px 0}

    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;border-bottom:1px solid #ddd}
    thead th{position:sticky;top:0;background:#fafafa;border-bottom:1px solid #eee}
    th,td{border:1px solid #eee;padding:8px;text-align:left}
    .right{text-align:right}

    .tpls-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:8px}
    @media(max-width:900px){.tpls-grid{grid-template-columns:1fr}}
    .tpl-card{border:1px solid #eee;border-radius:10px;padding:10px;display:flex;gap:8px;align-items:flex-start;background:#fff}
    .tpl-card input{margin-top:4px}
    .tpl-card pre{margin:0;white-space:pre-wrap;font-size:13px}
    .tpl-card:hover{box-shadow:0 1px 0 rgba(0,0,0,.03)}
  </style>
</head>
<body>
<main class="ac">
  <div class="container">
    <h1>Gerenciar Mensagens</h1>

    <section class="card" id="m_cardResumo">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h2 id="m_evTitle">‚Äî</h2>
          <div id="m_resTipoData" class="small muted">‚Äî</div>
        </div>
      </div>
      <div class="summary-line" id="m_resEndereco">Endere√ßo</div>
      <div class="summary-line" id="m_resAnfitriao">Anfitri√£o</div>
      <div class="summary-line" id="m_resCerimonial">Cerimonialista</div>
    </section>

    <section class="card">
      <div class="card__header"><h2>Indicadores</h2></div>
      <div class="twocol">
        <div><strong id="m_kpiTotal">0</strong><div class="small muted">Mensagens programadas</div></div>
        <div><strong id="m_kpiProx">‚Äî</strong><div class="small muted">Pr√≥ximo envio</div></div>
      </div>
    </section>

    <section class="card">
      <div class="card__header"><h2>Criar envio</h2></div>
      <div class="twocol">
        <div class="field"><label for="m_selCat"><h3>Categoria</h3></label>
          <select id="m_selCat">
            <option value="save">Save the Date</option>
            <option value="convite">Convite Formal</option>
            <option value="lembrete7">Lembrete (7 dias)</option>
            <option value="lembrete24">Lembrete (24h)</option>
            <option value="agradecimento">Agradecimento</option>
          </select>
        </div>
        <div class="field"><label for="m_sendWhen"><h3>Data e hora</h3></label><input id="m_sendWhen" type="datetime-local"/></div>
      </div>
      <div id="m_tpls" class="tpls-grid"></div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="m_btnAdd" class="btn" type="button" disabled>Adicionar</button>
      </div>
    </section>

    <section class="card">
      <div class="card__header"><h2>Calend√°rio de envios</h2></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Categoria</th>
              <th>Mensagem</th>
              <th>Envio</th>
              <th class="right">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="m_schedBody"></tbody>
        </table>
      </div>
      <div class="small muted" id="m_schedMeta">0 itens</div>
    </section>

    <section class="card">
      <div class="card__header"><h2>Estado</h2></div>
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small muted">Projeto: <span id="m_estadoMetaId">‚Äî</span></div>
          <div class="small muted">Atualizado em: <span id="m_estadoMetaUpd">‚Äî</span></div>
        </div>
        <div class="row">
          <span id="m_pillLink" class="pill warn">Sem evento</span>
          <span id="m_pillSaving" class="pill ok">Pronto</span>
          <button id="m_btnExport" class="btn btn--ghost" type="button">Exportar relat√≥rio (PDF)</button>
        </div>
      </div>
    </section>
  </div>
</main>

<script type="module">
  const {
    loadAppModules,
    dom,
    text: textUtils,
    format,
    ensureProjectWithMessages,
    applyEventSummary,
    busSync
  } = await import('/shared/gestaoEventosApp.js');

  const { $, setPill } = dom;
  const { esc } = textUtils;
  const { fmtDate, fmtDateTime, fmtWhen } = format;
  const ensureProject = ensureProjectWithMessages;
  const { requestCurrentProject } = busSync;

  const { store, bus } = await loadAppModules();
  await store?.init?.();

  const AUTO_SAVE_MS = 700;
  const state = { currentId:null, project:null, programacao:[], dirty:false, saving:false, timer:null, metas:[] };

  const evTitle      = $('#m_evTitle');
  const resTipoData  = $('#m_resTipoData');
  const resEndereco  = $('#m_resEndereco');
  const resAnfitriao = $('#m_resAnfitriao');
  const resCerimonial= $('#m_resCerimonial');

  const kpiTotal = $('#m_kpiTotal');
  const kpiProx  = $('#m_kpiProx');

  const estadoMetaId  = $('#m_estadoMetaId');
  const estadoMetaUpd = $('#m_estadoMetaUpd');
  const pillLink      = $('#m_pillLink');
  const pillSaving    = $('#m_pillSaving');

  const selCat    = $('#m_selCat');
  const sendWhen  = $('#m_sendWhen');
  const btnAdd    = $('#m_btnAdd');
  const tpls      = $('#m_tpls');
  const schedBody = $('#m_schedBody');
  const schedMeta = $('#m_schedMeta');
  const btnExport = $('#m_btnExport');

  function canAdd(){ return !!(state.currentId && sendWhen.value && document.querySelector('input[name="tpl"]:checked')); }
  function updateAddState(){ btnAdd.disabled = !canAdd(); }


  function setDirty(v){ state.dirty=!!v; if(!state.saving) setPill(pillSaving, v? 'warn':'ok', v? 'Altera√ß√µes n√£o salvas':'Pronto'); }
  function setSaving(v){ state.saving=!!v; setPill(pillSaving, v? 'saving':'ok', v? 'Salvando‚Ä¶':'Pronto'); }

  const TEMPLATES = {
    save:[
      'Ol√°, {{nomeConvidado}}! Reserve esta data: {{dataEvento}} √†s {{horaEvento}}. {{nomeEvento}} est√° chegando! üéâ',
      'Save the Date: {{dataEvento}} ‚Äî {{nomeEvento}}. Contamos com voc√™, {{nomeConvidado}}! ‚ú®',
      '{{nomeConvidado}}, anote a√≠: {{nomeEvento}} em {{dataEvento}} √†s {{horaEvento}}. Em breve, mais detalhes!',
      '√â oficial! {{nomeEvento}} ser√° em {{dataEvento}} √†s {{horaEvento}}. Aguarde o convite! üíå',
      'Oi {{nomeConvidado}}! Guarde o dia {{dataEvento}} para o {{nomeEvento}}. Vai ser especial!',
      'Agenda a√≠: {{dataEvento}} ‚Äî {{nomeEvento}}. Presen√ßa sua faz toda a diferen√ßa, {{nomeConvidado}}.'
    ],
    convite:[
      'Ol√°, {{nomeConvidado}}! Voc√™ √© nosso(a) convidado(a) para {{nomeEvento}} em {{dataEvento}} √†s {{horaEvento}}. Confirme sua presen√ßa!',
      '{{nomeConvidado}}, esperamos voc√™ no {{nomeEvento}} ‚Äî {{dataEvento}} √†s {{horaEvento}}. Contamos com sua presen√ßa!',
      'Convite: {{nomeEvento}} acontece em {{dataEvento}} √†s {{horaEvento}}. Sua presen√ßa √© muito importante, {{nomeConvidado}}.',
      '√â com alegria que convidamos voc√™ para {{nomeEvento}} em {{dataEvento}} √†s {{horaEvento}}. At√© l√°!',
      '{{nomeConvidado}}, junte-se a n√≥s no {{nomeEvento}}. Data: {{dataEvento}} ‚Ä¢ Hora: {{horaEvento}}.',
      'Convite especial para {{nomeEvento}} ‚Äî {{dataEvento}} √†s {{horaEvento}}. Esperamos por voc√™, {{nomeConvidado}}!'
    ],
    lembrete7:[
      'Faltam 7 dias! {{nomeEvento}} em {{dataEvento}} √†s {{horaEvento}}. Te esperamos, {{nomeConvidado}}!',
      'Contagem regressiva: 1 semana para {{nomeEvento}}. Dia {{dataEvento}} √†s {{horaEvento}}.',
      '{{nomeConvidado}}, daqui a 7 dias nos vemos no {{nomeEvento}} ‚Äî {{dataEvento}} √†s {{horaEvento}}.',
      'Lembrete: falta pouco para {{nomeEvento}} ({{dataEvento}}). Prepare-se! üéâ',
      'Tudo certo para {{nomeEvento}}? Dia {{dataEvento}} √†s {{horaEvento}}. Falta 1 semana!',
      'Falta uma semana para {{nomeEvento}}! Anote: {{dataEvento}} ‚Ä¢ {{horaEvento}}.'
    ],
    lembrete24:[
      'Amanh√£ √© o dia! {{nomeEvento}} em {{dataEvento}} √†s {{horaEvento}}. At√© breve, {{nomeConvidado}}!',
      'Lembrete 24h: {{nomeEvento}} acontece amanh√£ ‚Äî {{dataEvento}} ‚Ä¢ {{horaEvento}}.',
      '{{nomeConvidado}}, nos vemos amanh√£ no {{nomeEvento}} √†s {{horaEvento}}!',
      'Est√° chegando! Amanh√£: {{nomeEvento}} ({{dataEvento}} √†s {{horaEvento}}).',
      'Falta 1 dia: {{nomeEvento}} em {{dataEvento}} ‚Ä¢ {{horaEvento}}. Contamos com voc√™!',
      'N√£o esque√ßa: amanh√£ tem {{nomeEvento}}! Hor√°rio: {{horaEvento}}.'
    ],
    agradecimento:[
      'Obrigado por celebrar conosco no {{nomeEvento}}! Sua presen√ßa fez a diferen√ßa, {{nomeConvidado}}.',
      'Gratid√£o pela presen√ßa no {{nomeEvento}}. Foi especial ter voc√™!',
      '{{nomeConvidado}}, agradecemos por participar do {{nomeEvento}}. At√© a pr√≥xima!',
      'Nosso muito obrigado! {{nomeEvento}} foi incr√≠vel com voc√™ l√°. üíõ',
      'Valeu por estar no {{nomeEvento}}! Sua presen√ßa tornou tudo melhor.',
      'Agradecemos o carinho no {{nomeEvento}}. Esperamos te ver em breve, {{nomeConvidado}}.'
    ]
  };
  function compile(tpl, v){ return tpl.replaceAll('{{nomeConvidado}}',v.nomeConvidado).replaceAll('{{dataEvento}}',v.dataEvento).replaceAll('{{horaEvento}}',v.horaEvento).replaceAll('{{nomeEvento}}',v.nomeEvento); }

  function varsEvento(){
    const ev = state.project?.evento || {};
    const nomeEvento = (ev?.nome || state.project?.nome || 'Nosso Evento').trim();
    const dataEvento = fmtDate(ev?.data || '') || 'dd/mm/aaaa';
    const horaEvento = ev?.hora || 'hh:mm';
    const nomeConvidado = (state.project?.lista?.[0]?.nome) || 'Convidado(a)';
    return { nomeEvento, dataEvento, horaEvento, nomeConvidado };
  }

  function renderTemplates(){
    const cat=selCat.value; const list=TEMPLATES[cat]||[]; const v=varsEvento();
    tpls.innerHTML = list.map((tpl,i)=>
      `<label class="tpl-card"><input type="radio" name="tpl" value="${i}" ${i===0?'checked':''} />
        <pre>${esc(compile(tpl,v))}</pre>
      </label>`
    ).join('');
  }

  function labelCat(cat){ return ({save:'Save the Date',convite:'Convite Formal',lembrete7:'Lembrete (7 dias)',lembrete24:'Lembrete (24h)',agradecimento:'Agradecimento'})[cat]||cat; }

  function updateKPIs(){
    const rows = state.programacao||[]; kpiTotal.textContent = String(rows.length);
    if(!rows.length){ kpiProx.textContent = '‚Äî'; return; }
    const soonest = rows.map(r=>r.whenISO).filter(Boolean).sort()[0];
    kpiProx.textContent = fmtWhen(soonest);
  }

  function renderSchedule(){
    const rows = state.programacao||[]; schedMeta.textContent = `${rows.length} itens`;
    if(!rows.length){ schedBody.innerHTML = '<tr><td colspan="5" class="muted">Nenhum envio programado.</td></tr>'; updateKPIs(); return; }
    schedBody.innerHTML = rows.map((it,i)=>{
      const when = fmtWhen(it.whenISO);
      return `<tr data-i="${i}">
        <td>${i+1}</td>
        <td>${labelCat(it.cat)}</td>
        <td style="max-width:640px">${esc(it.message)}</td>
        <td>${when}</td>
        <td class="right">
          <button class="btn btn--ghost small" data-act="edit" type="button">Editar</button>
          <button class="btn btn--ghost small danger" data-act="del" type="button">Excluir</button>
        </td>
      </tr>`;
    }).join('');
    updateKPIs();
  }

  function onTableClick(ev){
    const btn = ev.target.closest && ev.target.closest('button[data-act]'); if(!btn) return;
    const tr = btn.closest('tr'); const i = parseInt(tr.getAttribute('data-i'),10); const it = state.programacao[i]; const act = btn.getAttribute('data-act'); if(!it) return;
    if(act==='del'){ state.programacao.splice(i,1); setDirty(true); renderSchedule(); scheduleSave(); return; }
    if(act==='edit'){
      const dt = (it.whenISO||'');
      tr.innerHTML = `<td>${i+1}</td><td>${labelCat(it.cat)}</td><td style="max-width:640px">${esc(it.message)}</td>
      <td><input type="datetime-local" value="${dt.replace('Z','')}" data-f="dt" /></td>
      <td class="right"><button class="btn small" data-act="save">Salvar</button><button class="btn btn--ghost small" data-act="cancel">Cancelar</button><button class="btn btn--ghost small danger" data-act="del">Excluir</button></td>`;
      return;
    }
    if(act==='cancel'){ renderSchedule(); return; }
    if(act==='save'){
      const ndt = tr.querySelector('input[data-f="dt"]').value;
      if(!ndt) return; it.whenISO = `${ndt}:00`; setDirty(true); renderSchedule(); scheduleSave();
    }
  }
  schedBody.addEventListener('click', onTableClick);

  function addItem(){
    const cat = selCat.value; const pick = document.querySelector('input[name="tpl"]:checked'); const idx = pick? parseInt(pick.value,10):0; const tpl = (TEMPLATES[cat]||[])[idx] || '';
    const when = sendWhen.value; if(!when) return;
    const v = varsEvento(); const msg = compile(tpl, v); const whenISO = `${when}:00`;
    state.programacao.push({ cat, modelIdx:idx, message:msg, whenISO });
    sendWhen.value=''; setDirty(true); renderSchedule(); scheduleSave();
  }
  btnAdd.addEventListener('click', addItem);
  selCat.addEventListener('change', ()=>{ renderTemplates(); updateAddState(); });
  tpls.addEventListener('change', updateAddState);
  sendWhen.addEventListener('input', updateAddState);

  async function doSave(){
    if(!state.currentId || !state.dirty) return;
    setSaving(true);
    const next = { ...state.project, mensagens: state.programacao, updatedAt: Date.now() };
    await store.updateProject?.(state.currentId, next);
    state.project = await store.getProject?.(state.currentId);
    setSaving(false); setDirty(false);
    renderSchedule(); renderResumo();
    bus.publish('ac:project-updated', { id: state.currentId, updatedAt: next.updatedAt });
  }
  function scheduleSave(){ if(state.timer) clearTimeout(state.timer); state.timer = setTimeout(doSave, AUTO_SAVE_MS); }

  const renderResumo = ()=> {
    const p = state.project||{};
    applyEventSummary({
      project: p,
      currentId: state.currentId,
      elements: {
        title: evTitle,
        tipoData: resTipoData,
        endereco: resEndereco,
        anfitriao: resAnfitriao,
        cerimonial: resCerimonial,
        linkPill: pillLink,
        metaId: estadoMetaId,
        metaAtualizado: estadoMetaUpd
      }
    });
    const ev = p.evento || {};
    const nome = (ev?.nome || p?.nome || 'Evento').trim() || 'Evento';
    const rows = state.programacao || [];
    evTitle.textContent = nome;
    const soonest = rows.filter(r=>r.whenISO).map(r=>r.whenISO).sort()[0]||'';
    kpiTotal.textContent = String(rows.length);
    kpiProx.textContent = fmtWhen(soonest);
    updateAddState();
  };

  function renderTemplatesSafe(){ try{ renderTemplates(); }catch(e){} }

  function publishCurrent(){ if(state.currentId) bus.publish('ac:open-event',{ id: state.currentId, from:'mensagens' }); }
  async function loadCurrent(id){ state.currentId=id||state.currentId; state.project = state.currentId? await store.getProject?.(state.currentId):null; ensureProject(state.project); state.programacao = Array.isArray(state.project?.mensagens)? [...state.project.mensagens] : []; setDirty(false); renderResumo(); renderTemplatesSafe(); renderSchedule(); }
  async function setCurrent(id){ if(!id){ state.currentId=null; state.project=null; state.programacao=[]; renderResumo(); renderTemplatesSafe(); renderSchedule(); setDirty(false); return; }
    state.currentId=id; setPill(pillLink,'ok','Vinculado');
    await loadCurrent(id); localStorage.setItem('ac:lastId', id); }

  // Responde pedidos de estado: ajuda outras abas a sincronizarem
  bus.subscribe('ac:request-current', ()=>{ if(state.currentId) publishCurrent(); });

  // BUS ‚Äî recebe id atual e atualiza√ß√µes
  bus.subscribe('ac:open-event', async ({ id })=>{ if(!id) return; await setCurrent(id); });
  bus.subscribe('ac:project-updated', async ({ id, updatedAt })=>{
    if(id && id===state.currentId){
      if(updatedAt){ estadoMetaUpd.textContent = fmtDateTime(updatedAt); }
      await loadCurrent(id);
    }
  });

  function buildReportHTML(){
    const ev = state.project?.evento || {}; const nome = (ev?.nome || state.project?.nome || 'Evento').trim() || 'Evento'; const data = fmtDate(ev?.data||''); const hora = ev?.hora||''; const rows = state.programacao || [];
    const tr = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${labelCat(r.cat)}</td><td>${esc(r.message)}</td><td style=\"text-align:right\">${fmtWhen(r.whenISO)}</td></tr>`).join('');
    return `<!doctype html><html><head><meta charset=\"utf-8\" /><title>Relat√≥rio ‚Äî Programa√ß√£o de Mensagens</title><style>body{font-family:system-ui,Arial,sans-serif}.report{padding:24px}h1{margin:0 0 4px 0;font-size:20px}h2{margin:16px 0 6px 0;font-size:16px}.meta{color:#333;font-size:12px;margin-bottom:8px}table{width:100%;border-collapse:collapse;font-size:12px}th,td{border:1px solid #888;padding:6px;text-align:left}</style></head><body onload=\"window.print()\"><section class=\"report\"><h1>Programa√ß√£o de Mensagens ‚Äî ${esc(nome)}</h1><div class=\"meta\">${data? 'Data: '+data+' ‚Ä¢ ' : ''}${hora? 'Hora: '+hora+' ‚Ä¢ ' : ''}Gerado em ${new Date().toLocaleString()}</div><h2>Itens</h2><table><thead><tr><th>#</th><th>Categoria</th><th>Mensagem</th><th style=\"text-align:right\">Envio</th></tr></thead><tbody>${tr}</tbody></table></section></body></html>`;
  }
  function exportReport(){ const win = window.open('', '_blank'); if(!win){ alert('Pop-up bloqueado. Libere pop-ups para exportar o PDF.'); return; } win.document.open(); win.document.write(buildReportHTML()); win.document.close(); }
  btnExport.addEventListener('click', exportReport);

  // Handshake id√™ntico ao das Tarefas + fallback
  const trySyncWithEventos = (maxTries=8, interval=400)=> requestCurrentProject(bus, ()=>state.currentId, { maxTries, interval });

  async function bootstrap(){
    // 1) tenta sincronizar com outra aba
    const synced = await trySyncWithEventos();
    if(synced && state.currentId){ publishCurrent(); renderTemplatesSafe(); return; }
    // 2) fallback local: √∫ltimo id salvo ou primeiro
    state.metas = store.listProjects?.()||[];
    const last = localStorage.getItem('ac:lastId');
    const initial = (state.metas.find(m=>m.id===last)?.id) || state.metas[0]?.id || null;
    if(initial){ await setCurrent(initial); publishCurrent(); }
    // 3) render vazio aguardando ac:open-event
    if(!initial){ renderResumo(); renderTemplatesSafe(); renderSchedule(); }
  }
  await bootstrap();

  (function __tests(){
    try{
      console.assert(typeof compile==='function','compile ok');
      console.assert(Object.keys(TEMPLATES).length>=5,'templates ok');
      console.assert(typeof buildReportHTML==='function','report ok');
    }catch(e){ console.warn('tests falharam', e); }
  })();
</script>
</body>
</html>
