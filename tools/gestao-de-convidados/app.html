<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerenciar Eventos — AC (v2) + Mini‑App Fornecedores</title>
  <!-- Estilos locais, mínimos e escopados -->
  <style>
    /* ===== KPIs / MiniApps ===== */
    #cardIndicadores .mini.kpi{position:relative;display:flex;flex-direction:column;justify-content:center;min-height:150px}
    #cardIndicadores .mini.kpi .label{font-weight:600;margin-bottom:8px;display:flex;align-items:center;justify-content:flex-start}
    #cardIndicadores .mini.kpi .label .title{color:#0b65c2}
    /* h3 nos títulos dos KPIs para padronizar com os badges acima */
    #cardIndicadores .mini.kpi .label h3{margin:0 48px 2px 0;font-size:14px;line-height:1.2;color:#0b65c2;display:flex;align-items:center}
    /* Destaque laranja quando o mini-app estiver expandido */
    #cardIndicadores .mini.kpi.active{border-color:#ffa245;background:#fff7ed;box-shadow:0 0 0 1px #ffa245 inset}
    #cardIndicadores #secTarefas[open] .details-wrap{border:1px solid #ffa245;border-radius:12px;background:#fff7ed;padding:12px}
    #cardIndicadores #secFornecedores[open] .details-wrap{border:1px solid #ffa245;border-radius:12px;background:#fff7ed;padding:12px}
    #cardIndicadores .mini.kpi .actions{position:absolute;top:10px;right:10px}
    #cardIndicadores .mini.kpi .edit-btn{border:1px solid #cccccc;background:#ffffff;border-radius:10px;padding:4px 8px;cursor:pointer;line-height:1}

    #cardIndicadores .progress.progress--lg .progress__track{height:10px;border-radius:6px;background:#eef2f6}
    #cardIndicadores .progress.progress--lg .progress__bar{height:10px;border-radius:6px;background:#0b65c2;transition:width .25s ease}
    #cardIndicadores .hbar-legend{display:flex;justify-content:space-between;gap:8px;margin-top:8px;font-size:.875rem;color:#555}
    #cardIndicadores .progress--segments .progress__track{display:flex;gap:2px;align-items:center}
    #cardIndicadores .progress--segments .seg{height:10px;border-radius:4px;background:#0b65c2;flex:0 0 auto}
    #cardIndicadores .muted{opacity:.75}
    #cardIndicadores details>summary{display:none}
    @media (max-width:640px){#cardIndicadores .mini.kpi{min-height:140px}}
  </style>
</head>
<body>
  <main class="ac">
    <div class="container">
      <!-- ===================== TOP / RESUMO ===================== -->
      <section class="card" id="cardResumo">
        <div class="row">
          <div>
            <h1 class="app-title">Gestão de eventos</h1>
            <h2 id="evTitle">—</h2>
            <div class="small muted" id="updatedWrap">Atualizado: <span id="updatedAt">—</span></div>
          </div>

          <div class="select-block" style="margin-left:auto">
            <label class="small" for="switchEvent">Selecionar evento</label>
            <select id="switchEvent"></select>

            <div class="row" style="align-items:center">
              <button id="btnNew" class="btn btn--ghost" type="button">Novo</button>
              <button id="btnDelete" class="btn btn--ghost danger" type="button">Excluir</button>
              <!-- Pílulas de status ALINHADAS ao lado dos botões -->
              <span id="chipReady"  class="pill pillok" style="margin-left:8px">Pronto</span>
              <span id="chipDirty"  class="pill pillwarn"   style="display:none;margin-left:8px">Edição não salva</span>
              <span id="chipSaving" class="pill pillsaving" style="display:none;margin-left:8px">Salvando…</span>
            </div>
          </div>
        </div>

        <!-- BADGES -->
        <div class="badge-grid" aria-label="Resumo do evento">
          <div class="badge" id="badgeEvento">
            <h3>Evento</h3>
            <div><dl class="kv" id="kvEvento"></dl></div>
            <div class="actions"><button class="edit-btn" data-open="#secEvento" aria-label="Editar">✎</button></div>
          </div>

          <div class="badge" id="badgeAnfitriao">
            <h3>Anfitrião</h3>
            <div><dl class="kv" id="kvAnfitriao"></dl></div>
            <div class="actions"><button class="edit-btn" data-open="#secAnfitriao" aria-label="Editar">✎</button></div>
          </div>

          <div class="badge" id="badgeCerimonial">
            <h3>Cerimonialista</h3>
            <div><dl class="kv" id="kvCerimonial"></dl></div>
            <div class="actions"><button class="edit-btn" data-open="#secCerimonial" aria-label="Editar">✎</button></div>
          </div>
        </div>

        <!-- EDIÇÃO (um aberto por vez) -->
        <details id="secEvento"><summary>Evento</summary>
          <div class="details-wrap">
            <div class="twocol">
              <div class="field">
                <label><span class="small">Nome do evento</span></label>
                <input data-bind="evento.nome" type="text" />
              </div>
              <div class="field">
                <label><span class="small">Tipo</span></label>
                <select data-bind="evento.tipo">
                  <option value=""></option>
                  <option>Casamento</option><option>Aniversário</option><option>Formatura</option>
                  <option>Debutante</option><option>Corporativo</option><option>Batizado</option>
                  <option>Chá de Panela</option><option>Chá de Bebê</option><option>Bodas</option><option>Outro</option>
                </select>
              </div>
            </div>

            <div class="twocol">
              <div class="field">
                <label><span class="small">Quando</span></label>
                <input id="ev-datetime" type="datetime-local" />
              </div>
              <div class="field">
                <label><span class="small">Local</span></label>
                <input data-bind="evento.local" type="text" />
              </div>
            </div>

            <div><strong class="small">Endereço do evento</strong></div>

            <div class="twocol">
              <div class="field">
                <label><span class="small">CEP</span></label>
                <input data-bind="evento.endereco.cep" type="text" inputmode="numeric" maxlength="9" data-cep="evento.endereco" />
              </div>
              <div class="field">
                <label><span class="small">Logradouro</span></label>
                <input data-bind="evento.endereco.logradouro" type="text" />
              </div>
            </div>

            <div class="threecol">
              <div class="field">
                <label><span class="small">Número</span></label>
                <input data-bind="evento.endereco.numero" type="text" />
              </div>
              <div class="field">
                <label><span class="small">Bairro</span></label>
                <input data-bind="evento.endereco.bairro" type="text" />
              </div>
              <div class="field">
                <label><span class="small">Cidade</span></label>
                <input data-bind="evento.endereco.cidade" type="text" />
              </div>
            </div>

            <div class="twocol">
              <div class="field">
                <label><span class="small">UF</span></label>
                <input data-bind="evento.endereco.uf" type="text" maxlength="2" />
              </div>
              <div class="field">
                <label><span class="small">Complemento / Referência</span></label>
                <input data-bind="evento.endereco.complemento" type="text" />
              </div>
            </div>

            <div class="close-hint">Pressione <strong>Esc</strong> ou clique no lápis novamente para fechar.</div>
          </div>
        </details>

        <details id="secAnfitriao"><summary>Anfitrião</summary>
          <div class="details-wrap">
            <div class="twocol">
              <div class="field">
                <label><span class="small">Nome</span></label>
                <input data-bind="evento.anfitriao.nome" type="text" />
              </div>
              <div class="field">
                <label><span class="small">Telefone</span></label>
                <input data-bind="evento.anfitriao.telefone" type="text" />
              </div>
            </div>

            <div class="field">
              <label><span class="small">Rede social / contato</span></label>
              <input data-bind="evento.anfitriao.redeSocial" type="text" />
            </div>

            <div><strong class="small">Endereço para correspondência</strong></div>

            <div class="twocol">
              <div class="field">
                <label><span class="small">CEP</span></label>
                <input data-bind="evento.anfitriao.endCorrespondencia.cep" type="text" inputmode="numeric" maxlength="9" data-cep="evento.anfitriao.endCorrespondencia" />
              </div>
              <div class="field">
                <label><span class="small">Logradouro</span></label>
                <input data-bind="evento.anfitriao.endCorrespondencia.logradouro" type="text" />
              </div>
            </div>

            <div class="threecol">
              <div class="field">
                <label><span class="small">Número</span></label>
                <input data-bind="evento.anfitriao.endCorrespondencia.numero" type="text" />
              </div>
              <div class="field">
                <label><span class="small">Bairro</span></label>
                <input data-bind="evento.anfitriao.endCorrespondencia.bairro" type="text" />
              </div>
              <div class="field">
                <label><span class="small">Cidade</span></label>
                <input data-bind="evento.anfitriao.endCorrespondencia.cidade" type="text" />
              </div>
            </div>

            <div class="twocol">
              <div class="field">
                <label><span class="small">UF</span></label>
                <input data-bind="evento.anfitriao.endCorrespondencia.uf" type="text" maxlength="2" />
              </div>
              <div class="field">
                <label><span class="small">Complemento</span></label>
                <input data-bind="evento.anfitriao.endCorrespondencia.complemento" type="text" />
              </div>
            </div>

            <div><strong class="small">Endereço para entrega de presentes</strong></div>

            <div class="twocol">
              <div class="field">
                <label><span class="small">CEP</span></label>
                <input data-bind="evento.anfitriao.endEntrega.cep" type="text" inputmode="numeric" maxlength="9" data-cep="evento.anfitriao.endEntrega" />
              </div>
              <div class="field">
                <label><span class="small">Logradouro</span></label>
                <input data-bind="evento.anfitriao.endEntrega.logradouro" type="text" />
              </div>
            </div>

            <div class="threecol">
              <div class="field">
                <label><span class="small">Número</span></label>
                <input data-bind="evento.anfitriao.endEntrega.numero" type="text" />
              </div>
              <div class="field">
                <label><span class="small">Bairro</span></label>
                <input data-bind="evento.anfitriao.endEntrega.bairro" type="text" />
              </div>
              <div class="field">
                <label><span class="small">Cidade</span></label>
                <input data-bind="evento.anfitriao.endEntrega.cidade" type="text" />
              </div>
            </div>

            <div class="twocol">
              <div class="field">
                <label><span class="small">UF</span></label>
                <input data-bind="evento.anfitriao.endEntrega.uf" type="text" maxlength="2" />
              </div>
              <div class="field">
                <label><span class="small">Complemento</span></label>
                <input data-bind="evento.anfitriao.endEntrega.complemento" type="text" />
              </div>
            </div>

            <div class="close-hint">Pressione <strong>Esc</strong> ou clique no lápis novamente para fechar.</div>
          </div>
        </details>

        <details id="secCerimonial"><summary>Cerimonialista</summary>
          <div class="details-wrap">
            <div class="twocol">
              <div class="field">
                <label><span class="small">Nome</span></label>
                <input data-bind="cerimonialista.nomeCompleto" type="text" />
              </div>
              <div class="field">
                <label><span class="small">Telefone</span></label>
                <input data-bind="cerimonialista.telefone" type="text" />
              </div>
            </div>

            <div class="field">
              <label><span class="small">Rede social</span></label>
              <input data-bind="cerimonialista.redeSocial" type="text" />
            </div>

            <div class="close-hint">Pressione <strong>Esc</strong> ou clique no lápis novamente para fechar.</div>
          </div>
        </details>
      </section>

      <!-- ===================== INDICADORES (v2, unificados) ===================== -->
      <section class="card" id="cardIndicadores">
        <h2>Indicadores do evento</h2>
        <div class="mini-grid">
          <!-- ===== 1) Tarefas (Checklist unificado) ===== -->
          <div class="mini kpi" id="kpi_tasks">
            <div class="label"><h3 class="title" id="kpi_task_title">Tarefas</h3></div>
            <div class="actions"><button class="edit-btn" data-open="#secTarefas" aria-label="Editar tarefas" title="Abrir painel de tarefas">✎</button></div>
            <div class="progress progress--lg"><div class="progress__track"><div id="kpi_task_bar" class="progress__bar" style="width:0%"></div></div></div>
            <div class="hbar-legend"><span id="kpi_task_lbl1">0 concluídas — 0%</span><span id="kpi_task_lbl2">Total: 0</span></div>
          </div>

          <!-- ===== 2) Fornecedores ===== -->
          <div class="mini kpi" id="kpi_for">
            <div class="label"><h3 class="title" id="kpi_for_title">Fornecedores</h3></div>
            <div class="actions"><button class="edit-btn" data-open="#secFornecedores" aria-label="Editar fornecedores" title="Abrir painel de fornecedores">✎</button></div>
            <div class="progress progress--lg"><div class="progress__track"><div id="kpi_for_bar" class="progress__bar" style="width:0%"></div></div></div>
            <div class="hbar-legend"><span id="kpi_for_lbl1">R$ 0,00 pagos — 0%</span><span id="kpi_for_lbl2">Total: R$ 0,00</span></div>
          </div>

          <!-- ===== 3) Convidados & Convites ===== -->
          <div class="mini kpi" id="kpi_guests">
            <div class="label"><h3 class="title" id="kpi_guest_title">Convidados &amp; Convites</h3></div>
            <div class="actions"><button class="edit-btn" data-open="#secConvidados" aria-label="Editar convidados" title="Em breve" disabled>✎</button></div>
            <div class="progress progress--lg"><div class="progress__track"><div id="kpi_guest_bar" class="progress__bar" style="width:0%"></div></div></div>
            <div class="hbar-legend"><span id="kpi_guest_lbl1">0 confirmados — 0%</span><span id="kpi_guest_lbl2">Total: 0</span></div>
            <div class="progress progress--lg progress--segments" aria-label="Distribuição por mesas/grupos"><div class="progress__track" id="kpi_guest_bands"></div></div>
            <div class="small muted" id="kpi_guest_legend"></div>
          </div>

          <!-- ===== 4) Mensagens ===== -->
          <div class="mini kpi" id="kpi_msgs">
            <div class="label"><h3 class="title">Mensagens — próximos 7 dias</h3></div>
            <div class="actions"><button class="edit-btn" data-open="#secMensagens" aria-label="Editar mensagens" title="Em breve" disabled>✎</button></div>
            <div class="progress progress--lg progress--segments"><div class="progress__track" id="kpi_msg_track"></div></div>
            <div class="hbar-legend"><span id="kpi_msg_lbl1">Total na semana: 0</span><span id="kpi_msg_lbl2">Pico: 0/dia</span></div>
          </div>
        </div>

        <!-- ===== MiniApp Tarefas ===== -->
        <details id="secTarefas"><summary>Tarefas</summary>
          <div class="details-wrap"><div id="tasks_host"></div><div class="close-hint">Pressione <strong>Esc</strong> ou clique no lápis novamente para fechar.</div></div>
        </details>

        <!-- ===== MiniApp Fornecedores ===== -->
        <details id="secFornecedores"><summary>Fornecedores</summary>
          <div class="details-wrap"><div id="fornecedores_host"></div><div class="close-hint">Pressione <strong>Esc</strong> ou clique no lápis novamente para fechar.</div></div>
        </details>
      </section>
    </div>
  </main>

  <script type="module">
    // ====================== Shared Modules ======================
    const PATH_BUS    = "/shared/marcoBus.js";
    const PATH_STORE  = "/shared/projectStore.js";
    const PATH_CORE   = "/shared/acEventsCore.v2.mjs";
    const PATH_TASKS  = "/shared/acTasks.v1.mjs";            // MiniApp tarefas
    const PATH_FORNEC = "/tools/gestao-de-fornecedores/fornecedores.minapp.js"; // MiniApp fornecedores (tools minúsculo)

    const CANDIDATES = [
      "https://cdn.jsdelivr.net/gh/fabiocolletto/Projeto-marco@main",
      "https://rawcdn.githack.com/fabiocolletto/Projeto-marco/main"
    ];
    async function tryImport(url){
      try{ return await import(url); }
      catch(e1){ try{ return await import(url+(url.includes('?')?'&':'?')+'t='+Date.now()); } catch(e2){ return null; }
      }
    }
    async function loadShared(rel){ for(const base of CANDIDATES){ const mod = await tryImport(base+rel); if(mod) return mod; } return null; }

    const store    = await loadShared(PATH_STORE);
    const bus      = await loadShared(PATH_BUS);
    const ac       = await loadShared(PATH_CORE);
    const tasksMod = await loadShared(PATH_TASKS);
    await loadShared(PATH_FORNEC); // importa e registra <ac-fornecedores>
    await store?.init?.();

    // ====================== Estado & helpers ======================
    const AUTO_SAVE_MS = 700;
    const state = { currentId:null, project:null, metas:[], dirty:false, saving:false, timer:null };
    const $  = (s)=> document.querySelector(s);
    const $$ = (s)=> [...document.querySelectorAll(s)];

    // Header UI refs
    const evTitle   = $('#evTitle');
    const updatedAt = $('#updatedAt');
    const switchEvent = $('#switchEvent');
    const btnNew    = $('#btnNew');
    const btnDelete = $('#btnDelete');

    // Pills
    const chipReady = $('#chipReady');
    const chipDirty = $('#chipDirty');
    const chipSaving= $('#chipSaving');

    // Form bind
    const dtInput = $('#ev-datetime');
    const boundInputs = $$('[data-bind]');

    // KPI refs
    const kpiForTitle = $('#kpi_for_title');
    const kpiForBar   = $('#kpi_for_bar');
    const kpiForLbl1  = $('#kpi_for_lbl1');
    const kpiForLbl2  = $('#kpi_for_lbl2');

    const kpiTaskTitle= $('#kpi_task_title');
    const kpiTaskBar  = $('#kpi_task_bar');
    const kpiTaskLbl1 = $('#kpi_task_lbl1');
    const kpiTaskLbl2 = $('#kpi_task_lbl2');

    const kpiGuestTitle  = $('#kpi_guest_title');
    const kpiGuestBar    = $('#kpi_guest_bar');
    const kpiGuestLbl1   = $('#kpi_guest_lbl1');
    const kpiGuestLbl2   = $('#kpi_guest_lbl2');
    const kpiGuestBands  = $('#kpi_guest_bands');
    const kpiGuestLegend = $('#kpi_guest_legend');

    const kpiMsgTrack = $('#kpi_msg_track');

    function renderStatus(){
      chipReady.style.display = (!state.dirty && !state.saving)? 'inline-block':'none';
      chipDirty.style.display = (state.dirty && !state.saving)? 'inline-block':'none';
      chipSaving.style.display= state.saving? 'inline-block':'none';
    }
    function setDirty(v){ state.dirty=!!v; renderStatus(); }
    function setSaving(v){ state.saving=!!v; renderStatus(); }

    const fmtDateTime   = (ts)=> ac.format.fmtDateTime(ts);
    const fmtDateBR     = (d)=> ac.format?.fmtDateBR ? ac.format.fmtDateBR(d) : (d? d.split('-').reverse().join('/') : '');
    const fmtDateCompact= (d,h)=>{ const ddmmyyyy = fmtDateBR(d); const hhmm = (h||'').slice(0,5); return [ddmmyyyy, hhmm].filter(Boolean).join(' '); };
    function setKV(sel, pairs){ const el=$(sel); if(!el) return; el.innerHTML = (pairs&&pairs.length)? pairs.map(([k,v])=>`<dt>${k}</dt><dd>${v}</dd>`).join(''):''; }

    function renderBadges(){
      const p = ac.model.ensureShape(state.project||{});
      const ev = p.evento||{};
      const rowsEv=[];
      if(ev.nome) rowsEv.push(['Evento', ev.nome]);
      if(ev.tipo) rowsEv.push(['Tipo', ev.tipo]);
      const dStr = fmtDateCompact(ev.data, ev.hora); if(dStr) rowsEv.push(['Data', dStr]);
      if(ev.local) rowsEv.push(['Local', ev.local]);
      setKV('#kvEvento', rowsEv);

      const a=ev.anfitriao||{}; const rowsA=[];
      if(a.nome) rowsA.push(['Nome', a.nome]);
      if(a.telefone) rowsA.push(['Telefone', a.telefone]);
      if(a.redeSocial) rowsA.push(['Contato', a.redeSocial]);
      setKV('#kvAnfitriao', rowsA);

      const c=p.cerimonialista||{}; const rowsC=[]; const nomeC=c.nomeCompleto||c.nome;
      if(nomeC) rowsC.push(['Nome', nomeC]);
      if(c.telefone) rowsC.push(['Telefone', c.telefone]);
      if(c.redeSocial) rowsC.push(['Rede social', c.redeSocial]);
      setKV('#kvCerimonial', rowsC);
    }

    function renderHeader(){
      const p = state.project||{}; const ev=p.evento||{};
      evTitle.textContent = ev.nome || '—';
      updatedAt.textContent = fmtDateTime(p.updatedAt)||'—';
      renderBadges();
    }

    function renderSwitcher(){
      const metas=state.metas||[];
      switchEvent.innerHTML = metas.map(m=>`<option value="${m.id}"${m.id===state.currentId?' selected':''}>${m.nome||m.id}</option>`).join('');
    }
    switchEvent.addEventListener('change', async ()=>{ const id=switchEvent.value; if(id){ await setCurrent(id); publishCurrent(); }});
    async function renderSaved(){ state.metas = store.listProjects?.()||[]; renderSwitcher(); }

    // Form <-> State
    function fillForm(p){
      ac.model.ensureShape(p);
      boundInputs.forEach(inp=>{
        const path=inp.dataset.bind;
        const val=path.split('.').reduce((a,k)=>a? a[k] : undefined,p)??'';
        inp.value = val;
      });
      const ev=p?.evento||{}; const hh=(ev.hora||'').slice(0,5); const hasDate=!!ev.data;
      if(dtInput){ dtInput.value = hasDate? `${ev.data}T${hh||'00:00'}`: ''; }
    }
    function readForm(){
      const p=ac.model.ensureShape(JSON.parse(JSON.stringify(state.project||{})));
      boundInputs.forEach(inp=>{
        const path=inp.dataset.bind.split('.'); let ref=p;
        for(let i=0;i<path.length-1;i++){ const k=path[i]; if(typeof ref[k]!=='object'||ref[k]===null) ref[k]={}; ref=ref[k]; }
        ref[path.at(-1)] = inp.value;
      });
      return p;
    }
    function applyDateTime(prj){
      const v=dtInput?.value?.trim();
      if(!v){ prj.evento ||= {}; if(!prj.evento.hora) prj.evento.hora=''; if(!prj.evento.data) prj.evento.data=''; return prj; }
      const [date,time]=v.split('T'); prj.evento ||= {}; prj.evento.data=date||''; prj.evento.hora=(time||'').slice(0,5); return prj;
    }

    async function doSave(){
      if(!state.currentId || !state.dirty) return;
      setSaving(true);
      let next = readForm(); next = applyDateTime(next); next.updatedAt = Date.now();
      await store.updateProject?.(state.currentId,next);
      state.project = await store.getProject?.(state.currentId);
      setSaving(false); setDirty(false);
      await renderSaved(); fillForm(state.project); renderHeader(); renderIndicators();
      bus.publish('ac:project-updated',{ id: state.currentId, updatedAt: next.updatedAt });
      updateFornecedoresProject();
    }
    function scheduleSave(){ if(state.timer) clearTimeout(state.timer); state.timer = setTimeout(doSave, AUTO_SAVE_MS); }

    document.addEventListener('input', (ev)=>{
      const inp=ev.target.closest('[data-bind]'); if(!inp) return;
      setDirty(true); if(inp.dataset.bind==='evento.nome'){ evTitle.textContent = inp.value.trim()||'—'; }
      scheduleSave(); renderBadges();
    });
    if(dtInput){ dtInput.addEventListener('input', ()=>{ setDirty(true); scheduleSave(); renderBadges(); }); }

    // CEP
    function wireCepInputs(){
      document.querySelectorAll('[data-cep]').forEach(inp=>{
        inp.addEventListener('input', ()=>{ inp.value = ac.cep.maskCep(inp.value); });
        inp.addEventListener('blur', async ()=>{
          const prefix=inp.getAttribute('data-cep'); const data=await ac.cep.fetchCep(inp.value); if(!data) return;
          const map={logradouro:'logradouro',bairro:'bairro',cidade:'cidade',uf:'uf'};
          for(const [k,v] of Object.entries(map)){
            const el=document.querySelector(`[data-bind="${prefix}.${k}"]`); if(el && data[v]) el.value=data[v];
          }
          setDirty(true); scheduleSave(); renderBadges();
        });
      });
    }

    // ====================== KPIs (v2) ======================
    function syncTasksKpiActive(){ try{ const kpi=document.querySelector('#kpi_tasks'); const det=document.querySelector('#secTarefas'); if(kpi&&det){ kpi.classList.toggle('active', !!det.open); } }catch{} }
    function syncForKpiActive(){ try{ const kpi=document.querySelector('#kpi_for'); const det=document.querySelector('#secFornecedores'); if(kpi&&det){ kpi.classList.toggle('active', !!det.open); } }catch{} }

    function clearChildren(node){ while(node && node.firstChild) node.removeChild(node.firstChild); }
    function pushSeg(container, pct, title){ const seg=document.createElement('div'); seg.className='seg'; seg.style.width=Math.max(0,Math.min(100,pct)).toFixed(2)+'%'; if(title) seg.title=title; container.appendChild(seg); }

    function renderIndicators(){
      const p = ac.model.ensureShape(state.project||{});

      // Fornecedores
      const kFor = ac.stats.kpiFornecedores(p.fornecedores||[]);
      if(kpiForTitle) kpiForTitle.textContent = `Fornecedores (${ac.format.money(kFor.pendente)} pendentes)`;
      if(kpiForBar)   kpiForBar.style.width = Math.min(100, Math.max(0, kFor.pctPago)) + '%';
      if(kpiForLbl1)  kpiForLbl1.textContent = `${ac.format.money(kFor.pago)} pagos — ${kFor.pctPago}%`;
      if(kpiForLbl2)  kpiForLbl2.textContent = `Total: ${ac.format.money(kFor.total)}`;

      // Tarefas (checklist)
      const kTk = ac.stats.kpiTarefas(p.checklist||[]);
      if(kpiTaskTitle) kpiTaskTitle.textContent = `Tarefas (${kTk.pendentes} pendentes)`;
      if(kpiTaskBar)   kpiTaskBar.style.width = Math.min(100, Math.max(0, kTk.pctConcluidas)) + '%';
      if(kpiTaskLbl1)  kpiTaskLbl1.textContent = `${kTk.concluidas} concluídas — ${kTk.pctConcluidas}%`;
      if(kpiTaskLbl2)  kpiTaskLbl2.textContent = `Total: ${kTk.total}`;

      // Convidados & Convites
      const kG = ac.stats.kpiConvidados(p.convidados||[]);
      const kpiGuestBar    = $('#kpi_guest_bar');
      const kpiGuestLbl1   = $('#kpi_guest_lbl1');
      const kpiGuestLbl2   = $('#kpi_guest_lbl2');
      const kpiGuestBands  = $('#kpi_guest_bands');
      const kpiGuestLegend = $('#kpi_guest_legend');
      if($('#kpi_guest_title')) $('#kpi_guest_title').textContent = `Convidados & Convites (${kG.pendentes} pendentes)`;
      if(kpiGuestBar)   kpiGuestBar.style.width = Math.min(100, Math.max(0, kG.pctConfirmados)) + '%';
      if(kpiGuestLbl1)  kpiGuestLbl1.textContent = `${kG.confirmados} confirmados — ${kG.pctConfirmados}%`;
      if(kpiGuestLbl2)  kpiGuestLbl2.textContent = `Total: ${kG.total}`;
      if(kpiGuestBands){
        clearChildren(kpiGuestBands);
        const bands = (kG.mesas && kG.mesas.some(x=>x[1]>0)) ? kG.mesas : (kG.grupos||[]);
        const sum = Math.max(1, bands.reduce((a,[,v])=>a+(v||0),0));
        const top = bands.slice(0,10);
        top.forEach(([name,val])=> pushSeg(kpiGuestBands, (val/sum)*100, `${name||'—'}: ${val}`));
        if(kpiGuestLegend){ kpiGuestLegend.textContent = top.length ? top.map(([n,v])=>`${(n||'—').slice(0,12)}: ${v}`).join(' • ') : 'Sem distribuição registrada'; }
      }

      // Mensagens próximos 7 dias
      const kM = ac.stats.kpiMensagens(p.mensagens||[]);
      const kpiMsgLbl1  = $('#kpi_msg_lbl1');
      const kpiMsgLbl2  = $('#kpi_msg_lbl2');
      if(kpiMsgTrack){
        clearChildren(kpiMsgTrack);
        const arr = Array.isArray(kM.perDay)? kM.perDay.slice(0,7) : [0,0,0,0,0,0,0];
        const total = arr.reduce((a,b)=>a+b,0);
        if(total===0){ for(let i=0;i<7;i++) pushSeg(kpiMsgTrack, 100/7, `D${i}: 0`); }
        else{ arr.forEach((v,i)=> pushSeg(kpiMsgTrack, (v/total)*100, `D${i}: ${v}`)); }
      }
      if(kpiMsgLbl1) kpiMsgLbl1.textContent = `Total na semana: ${kM.total}`;
      if(kpiMsgLbl2) kpiMsgLbl2.textContent = `Pico: ${kM.pico}/dia`;
    }

    // ====================== Novo / Excluir ======================
    btnNew.addEventListener('click', async ()=>{
      const blank = ac.model.ensureShape({
        cerimonialista:{},
        evento:{ endereco:{}, anfitriao:{ endCorrespondencia:{}, endEntrega:{} } },
        fornecedores:[], convidados:[], checklist:[], tipos:[], modelos:{}, vars:{}
      });
      const { meta } = await store.createProject?.(blank);
      await setCurrent(meta.id); await renderSaved(); publishCurrent(); mountTasksIfNeeded(); mountFornecedoresIfNeeded(); updateFornecedoresProject();
    });

    btnDelete.addEventListener('click', async ()=>{
      if(!state.currentId) return;
      if(!confirm('Excluir este evento? Esta ação não pode ser desfeita.')) return;
      try{
        if(store.deleteProject){ await store.deleteProject(state.currentId); }
        else if(store.removeProject){ await store.removeProject(state.currentId); }
      }catch(e){ console.error(e); }
      state.currentId=null; await renderSaved();
      const nextId=(state.metas[0]&&state.metas[0].id)||null;
      await setCurrent(nextId); publishCurrent(); mountTasksIfNeeded(); mountFornecedoresIfNeeded(); updateFornecedoresProject();
    });

    function publishCurrent(){ if(state.currentId) bus.publish('ac:open-event',{ id: state.currentId, from:'eventos' }); }

    function mountTasksIfNeeded(){
      const host = document.querySelector('#tasks_host');
      if(host && !host?.dataset?.mounted && tasksMod?.mountTasksMiniApp){
        tasksMod.mountTasksMiniApp(host, { ac, store, bus, getCurrentId: ()=> state.currentId });
        host.dataset.mounted = '1';
      }
    }

    function mountFornecedoresIfNeeded(){
      const host = document.querySelector('#fornecedores_host');
      if(host && !host.dataset.mounted){
        const el = document.createElement('ac-fornecedores');
        if(state.currentId) el.setAttribute('project-id', state.currentId);
        host.appendChild(el);
        host.dataset.mounted = '1';
      }
    }
    function updateFornecedoresProject(){
      const el = document.querySelector('#fornecedores_host ac-fornecedores');
      if(el){ const pid = state.currentId || ''; if(pid) el.setAttribute('project-id', pid); }
    }

    async function loadCurrent(id){
      state.currentId=id||state.currentId;
      state.project = state.currentId? await store.getProject?.(state.currentId) : null;
      ac.model.ensureShape(state.project);
      fillForm(state.project||{}); setDirty(false); renderHeader(); renderIndicators();
      mountTasksIfNeeded(); mountFornecedoresIfNeeded(); updateFornecedoresProject();
    }
    async function setCurrent(id){
      if(!id){ state.currentId=null; state.project=null; await renderSaved(); fillForm(ac.model.ensureShape({})); renderHeader(); setDirty(false); renderIndicators(); mountTasksIfNeeded(); mountFornecedoresIfNeeded(); updateFornecedoresProject(); return; }
      await loadCurrent(id); localStorage.setItem('ac:lastId', id); renderSwitcher();
    }

    // BUS: refletir atualizações externas (com refresh do projeto atual)
    bus.subscribe('ac:project-updated', async ({ id, updatedAt:ts })=>{
      try{
        if(id){
          await renderSaved();
          if(id===state.currentId){
            state.project = await store.getProject?.(state.currentId);
            if(ts && updatedAt){ updatedAt.textContent = fmtDateTime(ts)||'—'; }
            renderIndicators(); updateFornecedoresProject();
          }
        }
      }catch(err){ console.error(err); }
    });

    // Abrir/fechar seções
    function updateEditActives(){
      document.querySelectorAll('[data-open]')?.forEach(b=>b.classList.remove('active'));
      ['#secEvento','#secAnfitriao','#secCerimonial','#secTarefas','#secFornecedores'].forEach(sel=>{
        const d=document.querySelector(sel); if(d && d.open){ const btn=document.querySelector(`[data-open="${sel}"]`); if(btn) btn.classList.add('active'); }
      });
    }
    function closeAll(){ ['#secEvento','#secAnfitriao','#secCerimonial','#secTarefas','#secFornecedores'].forEach(sel=>{ const el=document.querySelector(sel); if(el) el.open=false; }); updateEditActives(); }
    function toggleSection(selector){ const target = document.querySelector(selector); if(!target) return; const willOpen = !target.open; closeAll(); target.open = willOpen; updateEditActives(); if(willOpen){ if(selector==='#secTarefas'){ mountTasksIfNeeded(); } if(selector==='#secFornecedores'){ mountFornecedoresIfNeeded(); } } syncTasksKpiActive(); syncForKpiActive(); }
    document.addEventListener('click', (ev)=>{ const btn = ev.target.closest('[data-open]'); if(!btn) return; const sel = btn.getAttribute('data-open'); if(sel) toggleSection(sel); });
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ closeAll(); }});
    ['#secEvento','#secAnfitriao','#secCerimonial','#secTarefas','#secFornecedores'].forEach(sel=>{ const d=document.querySelector(sel); if(d) d.addEventListener('toggle', ()=>{ updateEditActives(); syncTasksKpiActive(); syncForKpiActive(); }); });

    // ====================== Boot ======================
    async function bootstrap(){
      await renderSaved();
      wireCepInputs();
      const metas = store.listProjects?.()||[];
      if(!metas.length){
        const blank = ac.model.ensureShape({
          cerimonialista:{},
          evento:{ endereco:{}, anfitriao:{ endCorrespondencia:{}, endEntrega:{} } },
          fornecedores:[], convidados:[], checklist:[], tipos:[], modelos:{}, vars:{}
        });
        const { meta } = await store.createProject?.(blank);
        await setCurrent(meta.id); publishCurrent(); mountTasksIfNeeded(); mountFornecedoresIfNeeded(); updateFornecedoresProject(); return;
      }
      const last = localStorage.getItem('ac:lastId');
      const initial = (metas.find(m=>m.id===last)?.id) || metas[0]?.id || null;
      await setCurrent(initial); if(initial) publishCurrent();
      closeAll();
      renderStatus();
      mountTasksIfNeeded();
      mountFornecedoresIfNeeded();
      updateFornecedoresProject();
    }
    await bootstrap();
    // garantir estado visual correto no carregamento
    syncTasksKpiActive();
    syncForKpiActive();
  </script>
</body>
</html>
