<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Assistente Cerimonial ‚Äì Planejamento em 4 passos</title>
<style>
  :root{--bd:#e5e7eb;--mut:#6b7280;--pri:#2563eb;--bg:#ffffff}
  *{box-sizing:border-box} body{margin:0;background:#fff;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{margin:0 0 4px;font-size:22px} .sub{color:var(--mut);margin:0 0 16px}
  .steps{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 20px}
  .step{padding:8px 12px;border:1px solid var(--bd);border-radius:999px;background:#fff;cursor:pointer}
  .step[aria-current="step"]{background:var(--pri);color:#fff;border-color:var(--pri)}
  .card{border:1px solid var(--bd);border-radius:12px;padding:16px;background:#fff;margin-bottom:16px}
  label{font-weight:600} input,select,textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px}
  textarea{min-height:100px;resize:vertical}
  table{width:100%;border-collapse:collapse} th,td{border-top:1px solid var(--bd);padding:8px;text-align:left}
  .row{display:grid;gap:12px} .r2{grid-template-columns:1fr 1fr} .r3{grid-template-columns:1fr 1fr 1fr}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer;text-decoration:none;color:#111}
  .primary{background:var(--pri);color:#fff;border-color:var(--pri)}
  .muted{color:var(--mut)} .right{text-align:right}
  .badge{display:inline-block;border:1px solid var(--bd);border-radius:20px;padding:2px 8px;font-size:12px}
  .hide{display:none}
  .thumb{max-width:260px;max-height:160px;object-fit:contain;border:1px dashed var(--bd);padding:6px;border-radius:8px;background:#fafafa}
  @media print{
    body{background:#fff}
    .steps,.actions,.sub,.savebar{display:none!important}
    .card{border:none;padding:0;margin:0 0 10px}
    .wrap{max-width:800px}
    #sec-1,#sec-2,#sec-3{display:none!important}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Assistente Cerimonial ‚Äì Planejamento</h1>
  <p class="sub">Quatro passos para organizar seu evento. Voc√™ pode salvar, imprimir e pedir cota√ß√£o.</p>

  <!-- Navega√ß√£o das etapas -->
  <div class="steps" id="steps">
    <button class="step" data-go="sec-1" aria-current="step">1) Convidados</button>
    <button class="step" data-go="sec-2">2) Evento</button>
    <button class="step" data-go="sec-3">3) Mensagem</button>
    <button class="step" data-go="sec-4">4) Resumo</button>
  </div>

  <!-- Barra de salvar/carregar -->
  <div class="card savebar">
    <div class="actions">
      <button id="btn-save" class="btn">üíæ Salvar projeto (.json)</button>
      <label class="btn" for="file-load" style="margin:0">üìÅ Carregar projeto
        <input id="file-load" type="file" accept="application/json" class="hide"/>
      </label>
      <button id="btn-print" class="btn">üñ®Ô∏è Imprimir resumo</button>
      <button id="btn-export-csv" class="btn">üìÑ Exportar convites (CSV)</button>
    </div>
    <div class="muted" id="autosave-status" style="margin-top:6px">Auto-salvando no navegador‚Ä¶</div>
  </div>

  <!-- ====== SE√á√ÉO 1 ‚Äì CONVIDADOS ====== -->
  <section id="sec-1" class="card">
    <h3>1) Inserir convidados</h3>
    <textarea id="cv-imp" placeholder="Uma linha por convite
(41) 99999-0000 Ana Silva
Ana Silva, (41) 99999-0000
+44 7700 900123 John Doe"></textarea>
    <p class="muted">Separe m√∫ltiplos nomes por v√≠rgula ou use ‚Äúe‚Äù.</p>

    <div style="overflow:auto">
      <table>
        <thead><tr><th>Telefone (informado)</th><th>Convidados (nomes)</th><th>Intl</th><th>Telefone (E.164)</th><th>Qtd</th></tr></thead>
        <tbody id="cv-tb"></tbody>
      </table>
    </div>

    <div class="row r3" style="margin-top:8px">
      <div>Total de convites: <b id="cv-t1">0</b></div>
      <div>Total de convidados: <b id="cv-t2">0</b></div>
      <div>Telefones inv√°lidos: <b id="cv-t3">0</b></div>
      <div>Internacionais marcados: <b id="cv-t4">0</b></div>
    </div>

    <div class="actions">
      <button class="btn primary" id="cv-next">Continuar ‚Üí</button>
    </div>
  </section>

  <!-- ====== SE√á√ÉO 2 ‚Äì EVENTO ====== -->
  <section id="sec-2" class="card hide">
    <h3>2) Dados do evento</h3>
    <div class="row r2">
      <div>
        <label for="ev-nome">Nome do evento</label>
        <input id="ev-nome" placeholder="Ex.: Casamento Ana & Jo√£o"/>
      </div>
      <div>
        <label for="ev-dtpick">Data e hora do evento</label>
        <input id="ev-dtpick" type="datetime-local"/>
        <div id="ev-dt-err" class="muted"></div>
      </div>
    </div>
    <div class="row r2">
      <div>
        <label for="ev-end">Endere√ßo</label>
        <input id="ev-end" placeholder="Rua, n√∫mero, bairro, cidade"/>
      </div>
      <div>
        <label for="ev-obs">Observa√ß√µes</label>
        <textarea id="ev-obs" placeholder="Ex.: Traje, estacionamento, portaria, observa√ß√µes gerais"></textarea>
      </div>
    </div>

    <h4 style="margin-top:8px">Headers (opcionais)</h4>
    <div class="row r2">
      <div>
        <label for="ev-url-hdr-intro">Header da introdu√ß√£o (URL)</label>
        <input id="ev-url-hdr-intro" placeholder="https://.../logo.jpg"/>
        <div class="muted" id="ev-url-hdr-intro-err"></div>
        <label for="ev-file-hdr-intro" style="margin-top:6px">ou selecione um arquivo:</label>
        <input id="ev-file-hdr-intro" type="file" accept="image/*"/>
        <img id="ev-preview-intro" class="thumb hide" alt="Pr√©via header introdu√ß√£o"/>
      </div>
      <div>
        <label for="ev-url-hdr-envio">Header do envio (URL)</label>
        <input id="ev-url-hdr-envio" placeholder="https://.../convite.jpg"/>
        <div class="muted" id="ev-url-hdr-envio-err"></div>
        <label for="ev-file-hdr-envio" style="margin-top:6px">ou selecione um arquivo:</label>
        <input id="ev-file-hdr-envio" type="file" accept="image/*"/>
        <img id="ev-preview-envio" class="thumb hide" alt="Pr√©via header envio"/>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="ev-back">‚Üê Voltar</button>
      <button class="btn primary" id="ev-next" aria-disabled="true">Continuar ‚Üí</button>
    </div>
  </section>

  <!-- ====== SE√á√ÉO 3 ‚Äì MENSAGEM ====== -->
  <section id="sec-3" class="card hide">
    <h3>3) Dados da mensagem</h3>
    <div class="row r2">
      <div>
        <label for="msg-tipo">Tipo de envio</label>
        <select id="msg-tipo"></select>
      </div>
      <div>
        <label for="msg-modelo">Modelo</label>
        <select id="msg-modelo"></select>
        <div id="msg-modelo-hint" class="muted"></div>
      </div>
    </div>

    <fieldset style="margin-top:8px">
      <legend>Vari√°veis</legend>
      <div class="row r3">
        <div><label for="msg-conv1">Convidado principal ({convidado1})</label><input id="msg-conv1" placeholder="Convidado"/></div>
        <div><label for="msg-evento">Evento ({evento})</label><input id="msg-evento" placeholder="Seu Evento"/></div>
        <div><label for="msg-data">Data ({data})</label><input id="msg-data" placeholder="dd/mm/aaaa"/></div>
        <div><label for="msg-hora">Hora ({hora})</label><input id="msg-hora" placeholder="HH:mm"/></div>
        <div class="row" style="grid-column:1/-1"><label for="msg-end">Endere√ßo ({endereco})</label><input id="msg-end" placeholder="Rua, n√∫mero, cidade"/></div>
      </div>
    </fieldset>

    <div class="row r2" style="margin-top:8px">
      <div>
        <h4>Pr√©via da introdu√ß√£o</h4>
        <pre id="msg-prev-intro">‚Äî sem pr√©via ‚Äî</pre>
      </div>
      <div>
        <h4>Pr√©via do envio</h4>
        <pre id="msg-prev-envio">‚Äî sem pr√©via ‚Äî</pre>
      </div>
    </div>

    <fieldset style="margin-top:8px">
      <legend>Contato do cerimonial (opcional)</legend>
      <div><input id="msg-contact-on" type="checkbox"/> <label for="msg-contact-on">Incluir bot√£o de contato</label></div>
      <div class="row r3">
        <div><label for="msg-contact-label">T√≠tulo do bot√£o</label><input id="msg-contact-label" placeholder="Fale com o cerimonial"/></div>
        <div><label for="msg-contact-nome">Nome</label><input id="msg-contact-nome"/></div>
        <div><label for="msg-contact-tel">WhatsApp</label><input id="msg-contact-tel" placeholder="(41) 99999-0000"/></div>
        <div><label for="msg-contact-mail">E-mail</label><input id="msg-contact-mail" placeholder="contato@exemplo.com"/></div>
        <div class="row" style="grid-column:1/-1">
          <label for="msg-contact-link">Link externo (opcional)</label>
          <input id="msg-contact-link" placeholder="https://wa.me/55..."/>
          <div id="msg-contact-link-err" class="muted"></div>
        </div>
      </div>
    </fieldset>

    <div class="actions">
      <button class="btn" id="msg-back">‚Üê Voltar</button>
      <button class="btn primary" id="msg-next" aria-disabled="true">Continuar ‚Üí</button>
    </div>
  </section>

  <!-- ====== SE√á√ÉO 4 ‚Äì RESUMO ====== -->
  <section id="sec-4" class="card hide">
    <h3>4) Resumo, pre√ßos e aprova√ß√£o</h3>

    <div class="card">
      <h4>Evento</h4>
      <div><b>Nome:</b> <span id="sum-evt-nome">‚Äî</span></div>
      <div><b>Data:</b> <span id="sum-evt-data">‚Äî</span> <b>Hora:</b> <span id="sum-evt-hora">‚Äî</span></div>
      <div><b>Endere√ßo:</b> <span id="sum-evt-end">‚Äî</span></div>
      <div><b>Observa√ß√µes:</b> <span id="sum-evt-obs">‚Äî</span></div>
    </div>

    <div class="card">
      <h4>Mensagem</h4>
      <div><b>Tipo:</b> <span id="sum-msg-tipo">‚Äî</span> <b>Modelo:</b> <span id="sum-msg-modelo">‚Äî</span></div>
      <div style="margin-top:6px"><b>Pr√©via (introdu√ß√£o):</b><pre id="sum-prev-intro">‚Äî</pre></div>
      <div><b>Pr√©via (envio):</b><pre id="sum-prev-envio">‚Äî</pre></div>
      <div><b>Contato do cerimonial:</b> <span id="sum-contact-on">n√£o</span></div>
      <div id="sum-contact-box" class="hide">
        <div><b>Bot√£o:</b> <span id="sum-contact-label">‚Äî</span></div>
        <div><b>Nome:</b> <span id="sum-contact-nome">‚Äî</span></div>
        <div><b>WhatsApp:</b> <span id="sum-contact-tel">‚Äî</span></div>
        <div><b>E-mail:</b> <span id="sum-contact-mail">‚Äî</span></div>
        <div><b>Link:</b> <span id="sum-contact-link">‚Äî</span></div>
      </div>
    </div>

    <div class="card">
      <h4>Convidados (resumo)</h4>
      <div><b>Total de convites:</b> <span id="sum-tot-conv">0</span></div>
      <div><b>Total de convidados estimado:</b> <span id="sum-tot-guests">0</span></div>
      <div><b>Telefones inv√°lidos:</b> <span id="sum-tot-invalid">0</span></div>
      <div><b>Internacionais:</b> <span id="sum-tot-intl">0</span></div>
    </div>

    <div class="card">
      <h4>Pre√ßos e op√ß√µes</h4>
      <div class="row r3">
        <div>
          <label for="sum-produto">Produto/Plano</label>
          <select id="sum-produto">
            <option value="disparo_unitario">Disparo unit√°rio (por convite)</option>
            <option value="pacote_50">Pacote 50 convites</option>
            <option value="pacote_100">Pacote 100 convites</option>
            <option value="custom">Personalizado</option>
          </select>
        </div>
        <div>
          <label for="sum-preco-msg">Pre√ßo por convite (R$)</label>
          <input id="sum-preco-msg" type="number" step="0.01" min="0" placeholder="1.50"/>
        </div>
        <div>
          <label for="sum-qtd-override">Quantidade para cobran√ßa</label>
          <input id="sum-qtd-override" type="number" min="0" placeholder="(usa total de convites se vazio)"/>
        </div>
        <div>
          <label for="sum-extra">Extras (R$)</label>
          <input id="sum-extra" type="number" step="0.01" min="0" value="0"/>
        </div>
        <div>
          <label for="sum-desc">Desconto (R$)</label>
          <input id="sum-desc" type="number" step="0.01" min="0" value="0"/>
        </div>
      </div>
      <div class="actions">
        <button id="sum-recalc" class="btn">Recalcular</button>
      </div>
      <div class="row r3" style="margin-top:6px">
        <div><b>Subtotal convites:</b> R$ <span id="sum-subtotal">0,00</span></div>
        <div><b>Extras:</b> R$ <span id="sum-extra-v">0,00</span></div>
        <div><b>Desconto:</b> R$ <span id="sum-desc-v">0,00</span></div>
        <div><b>Total:</b> R$ <span id="sum-total">0,00</span></div>
      </div>
    </div>

    <div class="card">
      <h4>Aprova√ß√£o e envio</h4>
      <div><input id="sum-aceite" type="checkbox"/> <label for="sum-aceite">Concordo com o valor e autorizo a solicita√ß√£o.</label></div>
      <div class="actions">
        <button class="btn primary" id="sum-enviar" aria-disabled="true">Pedir cota√ß√£o / Contratar com a 5 Horas</button>
      </div>
      <p class="muted">Sem compromisso: voc√™ pode usar este arquivo para organizar seu evento e imprimir o resumo. Para contratar, basta enviar.</p>
    </div>

    <div class="actions">
      <button class="btn" id="sum-back">‚Üê Voltar</button>
    </div>
  </section>
</div>

<script>
(function(){
  // ========= Helpers =========
  const $ = (sel,root=document)=> root.querySelector(sel);
  const $$ = (sel,root=document)=> Array.from(root.querySelectorAll(sel));
  const onlyDigits = s => (s||"").replace(/\\D+/g,"");
  const normSpaces = s => (s||"").replace(/\\s+/g," ").trim();
  const safe = s => (s==null||s==='')? '‚Äî' : String(s);
  const LOWER_PT = new Set(["da","de","do","das","dos"]);
  const titleCasePt = s => { s=normSpaces(String(s||"").toLowerCase()); if(!s) return ""; return s.split(" ").map((w,i)=> i>0 && LOWER_PT.has(w) ? w : w.charAt(0).toUpperCase()+w.slice(1)).join(" "); };
  const PROTO_RE=/^[a-zA-Z][a-zA-Z0-9+.-]*:\\/\\//, LIKE_DOMAIN=/^(?:www\\.)?[a-zA-Z0-9-]+(?:\\.[a-zA-Z0-9-]+)+(?:\\/.*)?$/;
  const coerceUrl=(input)=>{ if(!input) return {ok:false,url:""}; let s=String(input).trim(); if(/^http\\.[^\\/]+/i.test(s)) s=s.replace(/^http\\./i,"http://"); if(!PROTO_RE.test(s) && LIKE_DOMAIN.test(s)) s=`https://${s}`; try{const u=new URL(s); if(!/^https?:$/.test(u.protocol)) return {ok:false,url:""}; return {ok:true,url:u.toString()}; }catch{ return {ok:false,url:""} } };
  const brMoney = n => (isFinite(n)? Number(n):0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  function go(stepId){
    ['sec-1','sec-2','sec-3','sec-4'].forEach(id=> { const el=document.getElementById(id); if(!el) return; el.classList.toggle('hide', id!==stepId); });
    $$('#steps .step').forEach(btn=> btn.setAttribute('aria-current', btn.dataset.go===stepId? 'step':'false'));
    if(stepId==='sec-4') updateSummary();
  }
  function saveLocal(){
    const data = collectAll();
    try{ localStorage.setItem('assist-cer-4passos', JSON.stringify(data)); $('#autosave-status').textContent = 'Auto-salvo √†s ' + new Date().toLocaleTimeString(); }catch{}
  }
  function loadLocal(){
    try{ const raw=localStorage.getItem('assist-cer-4passos'); if(!raw) return; applyAll(JSON.parse(raw)); }catch{}
  }

  // ========= SE√á√ÉO 1: Convidados =========
  const cv_imp = $('#cv-imp'), cv_tb=$('#cv-tb');
  const cv_t1=$('#cv-t1'), cv_t2=$('#cv-t2'), cv_t3=$('#cv-t3'), cv_t4=$('#cv-t4');
  function normalizeIntlPhone(raw){
    if(!raw) return {e164:"",ok:false};
    let s=String(raw).trim(); if(s.startsWith("00")) s="+"+s.slice(2); if(!s.startsWith("+")) s="+"+onlyDigits(s);
    const d=onlyDigits(s); if(d.length<8||d.length>15) return {e164:"",ok:false}; return {e164:"+"+d,ok:true};
  }
  function normalizeBRPhone(raw){
    const digits=onlyDigits(raw); if(digits.length<10) return {e164:"",ok:false};
    let d=digits; if(d.startsWith("55") && d.length>=12) d=d.slice(2);
    const ddd=d.slice(0,2); let base=d.slice(2);
    if(base.length===8) base="9"+base; else if(base.length>9) base=base.slice(-9);
    const final=`55${ddd}${base}`; const ok=final.length===13; return {e164: ok?`+${final}`:"", ok};
  }
  function parseGuests(str){ return (str||"").replace(/\\se\\s/gi,",").split(",").map(x=> titleCasePt(x)).filter(Boolean).slice(0,5); }
  let rows=[];
  function extractRows(multiline){
    const lines = String(multiline||"").split(/\\r?\\n/).map(l=>l.trim()).filter(Boolean);
    return lines.map(line=>{
      const matches = Array.from(line.matchAll(/\\+?[\\d\\s().-]{8,}/g));
      let telefone="", convidados="";
      if(matches.length>0){
        const best = matches.sort((a,b)=> onlyDigits(b[0]).length - onlyDigits(a[0]).length)[0][0];
        telefone = best.trim(); convidados = normSpaces(line.replace(best," "));
      } else {
        let parts = line.includes("\\t")? line.split("\\t"): line.split(",");
        if(parts.length>1){
          const scored=parts.map(p=>({p:p.trim(),score:onlyDigits(p).length})).sort((a,b)=>b.score-a.score);
          telefone = scored[0].p; convidados = parts.filter(p=>p!==telefone).join(", ");
        } else { telefone=line; convidados=""; }
      }
      return { telefone, convidados, intl:false };
    });
  }
  function recalcTable(){
    cv_tb.innerHTML="";
    let totalConv=0,totalGuests=0,invalid=0,intlCount=0;
    rows.forEach((r,i)=>{
      const phone = r.intl ? normalizeIntlPhone(r.telefone) : normalizeBRPhone(r.telefone);
      const convidadosArr = parseGuests(r.convidados);
      const tr=document.createElement('tr');
      const btn=document.createElement('button');
      btn.className='badge'; btn.textContent=r.intl?'Intl ‚úì':'Intl';
      btn.addEventListener('click',ev=>{ev.preventDefault(); rows[i].intl=!rows[i].intl; recalcTable(); saveLocal(); });
      tr.innerHTML=`<td>${r.telefone}</td><td>${convidadosArr.join(", ")}</td><td></td><td>${phone.ok? phone.e164 : '<span>inv√°lido</span>'}</td><td>${convidadosArr.length}</td>`;
      tr.children[2].appendChild(btn);
      cv_tb.appendChild(tr);
      totalConv++; totalGuests+=convidadosArr.length; if(!phone.ok) invalid++; if(r.intl) intlCount++;
    });
    cv_t1.textContent=String(totalConv); cv_t2.textContent=String(totalGuests); cv_t3.textContent=String(invalid); cv_t4.textContent=String(intlCount);
    updateSummary();
  }
  cv_imp.addEventListener('input', e=>{ rows = extractRows(e.target.value); recalcTable(); saveLocal(); });

  // ========= SE√á√ÉO 2: Evento =========
  const ev_nome=$('#ev-nome'), ev_dtpick=$('#ev-dtpick'), ev_end=$('#ev-end'), ev_obs=$('#ev-obs');
  const ev_url_intro=$('#ev-url-hdr-intro'), ev_url_envio=$('#ev-url-hdr-envio');
  const ev_err_dt=$('#ev-dt-err'), ev_err_intro=$('#ev-url-hdr-intro-err'), ev_err_envio=$('#ev-url-hdr-envio-err');
  const ev_file_intro=$('#ev-file-hdr-intro'), ev_file_envio=$('#ev-file-hdr-envio');
  const ev_prev_intro=$('#ev-preview-intro'), ev_prev_envio=$('#ev-preview-envio');
  const ev_files={ hdr_intro:null, hdr_envio:null }; // File objects
  function dtValid(s){ return /^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}$/.test(String(s||'')); }
  function formatBR(ymd){ const [Y,M,D]=ymd.split('-'); return `${D}/${M}/${Y}`; }
  function validateEvent(){
    const dt=(ev_dtpick.value||'').trim(); const ok=dtValid(dt);
    ev_err_dt.textContent = dt && !ok ? 'Data e hora inv√°lidas' : '';
    const i=ev_url_intro.value.trim(), e=ev_url_envio.value.trim();
    ev_err_intro.textContent = i && !coerceUrl(i).ok ? 'URL inv√°lida' : '';
    ev_err_envio.textContent = e && !coerceUrl(e).ok ? 'URL inv√°lida' : '';
    return (ev_nome.value||'').trim().length>2 && ok;
  }
  function previewFile(input,img,key){
    const f=(input.files && input.files[0])? input.files[0]:null;
    ev_files[key]=f;
    if(f){ img.src=URL.createObjectURL(f); img.classList.remove('hide'); } else { img.removeAttribute('src'); img.classList.add('hide'); }
    saveLocal(); updateSummary();
  }
  [ev_nome, ev_dtpick, ev_end, ev_obs, ev_url_intro, ev_url_envio].forEach(el=> el.addEventListener('input', ()=>{ validateEvent(); saveLocal(); updateSummary(); }));
  ev_file_intro.addEventListener('change', ()=> previewFile(ev_file_intro, ev_prev_intro, 'hdr_intro'));
  ev_file_envio.addEventListener('change', ()=> previewFile(ev_file_envio, ev_prev_envio, 'hdr_envio'));

  // ========= SE√á√ÉO 3: Mensagem =========
  const msg_tipo=$('#msg-tipo'), msg_modelo=$('#msg-modelo'), msg_hint=$('#msg-modelo-hint');
  const msg_conv1=$('#msg-conv1'), msg_evento=$('#msg-evento'), msg_data=$('#msg-data'), msg_hora=$('#msg-hora'), msg_end=$('#msg-end');
  const msg_prev_intro=$('#msg-prev-intro'), msg_prev_envio=$('#msg-prev-envio');
  const c_on=$('#msg-contact-on'), c_label=$('#msg-contact-label'), c_nome=$('#msg-contact-nome'), c_tel=$('#msg-contact-tel'), c_mail=$('#msg-contact-mail'), c_link=$('#msg-contact-link'), c_link_err=$('#msg-contact-link-err');

  const MODELOS={
    "Convite com confirma√ß√£o":[
      {id:"cc1",nome:"Padr√£o curto",texto:"Ol√° {convidado1}! Voc√™ est√° convidado para {evento} em {data} {hora}. Toque para confirmar presen√ßa."},
      {id:"cc2",nome:"Com endere√ßo",texto:"{convidado1}, convite para {evento} em {data} {hora}. Local: {endereco}. Confirme sua presen√ßa aqui."}
    ],
    "Convite sem confirma√ß√£o":[
      {id:"sc1",nome:"Informativo",texto:"{convidado1}, voc√™ est√° convidado para {evento} em {data} {hora}. Informa√ß√µes completas no convite."},
      {id:"sc2",nome:"Com lembrete",texto:"{convidado1}, veja os detalhes de {evento} em {data} {hora}. Em breve enviaremos mais informa√ß√µes."}
    ],
    "Save the date":[
      {id:"sd1",nome:"Save the date",texto:"{convidado1}, reserve a data: {evento} em {data} {hora}. Em breve enviaremos o convite."}
    ]
  };
  const INTRO="Ol√° {convidado1}, temos uma mensagem especial para voc√™. Clique em aceitar para receber detalhes.";
  function renderTemplate(t,ctx){ return t.replace(/\\{(\\w+)\\}/g,(_,k)=> ctx[k] ?? ""); }
  function ctxMsg(){ return {
    convidado1:(msg_conv1.value||'').trim()||'Convidado',
    evento:(msg_evento.value||'').trim()||'Seu Evento',
    data:(msg_data.value||'').trim()||'dd/mm/aaaa',
    hora:(msg_hora.value||'').trim()||'',
    endereco:(msg_end.value||'').trim()||''
  }; }
  function textEnvio(){ const list=MODELOS[msg_tipo.value]||[]; const m=list.find(x=>x.id===msg_modelo.value) || list[0] || {texto:''}; return renderTemplate(m.texto, ctxMsg()); }
  (function initSelects(){
    Object.keys(MODELOS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; msg_tipo.appendChild(o); });
    msg_tipo.value="Convite com confirma√ß√£o"; refillModelos();
  })();
  function refillModelos(){
    const list=MODELOS[msg_tipo.value]||[]; msg_modelo.innerHTML="";
    list.forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.nome; msg_modelo.appendChild(o); });
    if(list[0]) msg_modelo.value=list[0].id;
    msg_hint.textContent = list.length ? `Modelos: ${list.map(x=>x.nome).join(', ')}` : '';
  }
  function updatePreviews(){
    msg_prev_intro.textContent = renderTemplate(INTRO, ctxMsg());
    msg_prev_envio.textContent = textEnvio();
    validateMsg(); saveLocal(); updateSummary();
  }
  function validateMsg(){
    const hasTipo=!!msg_tipo.value, hasModelo=!!msg_modelo.value, hasEvento=(msg_evento.value||'').trim().length>2;
    const link=(c_link.value||'').trim(); const ok=link? coerceUrl(link).ok : true;
    c_link_err.textContent = link && !ok ? 'URL inv√°lida' : '';
    return hasTipo && hasModelo && hasEvento && ok;
  }
  msg_tipo.addEventListener('change', ()=>{ refillModelos(); updatePreviews(); });
  msg_modelo.addEventListener('change', updatePreviews);
  [msg_conv1,msg_evento,msg_data,msg_hora,msg_end].forEach(el=> el.addEventListener('input', updatePreviews));
  [c_on,c_label,c_nome,c_tel,c_mail,c_link].forEach(el=> el.addEventListener('input', ()=>{ validateMsg(); saveLocal(); updateSummary(); }));

  // ========= SE√á√ÉO 4: Resumo/Pre√ßo =========
  const sum={
    evtNome:$('#sum-evt-nome'), evtData:$('#sum-evt-data'), evtHora:$('#sum-evt-hora'), evtEnd:$('#sum-evt-end'), evtObs:$('#sum-evt-obs'),
    msgTipo:$('#sum-msg-tipo'), msgModelo:$('#sum-msg-modelo'), prevIntro:$('#sum-prev-intro'), prevEnvio:$('#sum-prev-envio'),
    cOn:$('#sum-contact-on'), cBox:$('#sum-contact-box'), cLabel:$('#sum-contact-label'), cNome:$('#sum-contact-nome'), cTel:$('#sum-contact-tel'), cMail:$('#sum-contact-mail'), cLink:$('#sum-contact-link'),
    tConv:$('#sum-tot-conv'), tGuests:$('#sum-tot-guests'), tInv:$('#sum-tot-invalid'), tIntl:$('#sum-tot-intl'),
    plano:$('#sum-produto'), preco:$('#sum-preco-msg'), qtd:$('#sum-qtd-override'), extra:$('#sum-extra'), desc:$('#sum-desc'),
    vSub:$('#sum-subtotal'), vEx:$('#sum-extra-v'), vDc:$('#sum-desc-v'), vTot:$('#sum-total'),
    aceite:$('#sum-aceite'), enviar:$('#sum-enviar')
  };
  function readEvent(){
    const v = el=> (el?.value||'').trim();
    const dt = v(ev_dtpick);
    let dataBR=null,hora=null; if(/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}$/.test(dt)){ const [ymd,hm]=dt.split('T'); dataBR=formatBR(ymd); hora=hm.slice(0,5); }
    return {
      evento: v(ev_nome),
      datetime_local: dt || null,
      data: dataBR,
      hora: hora,
      endereco: v(ev_end),
      observacoes: v(ev_obs),
      url_header_intro: v(ev_url_intro) || null,
      url_header_envio: v(ev_url_envio) || null,
      _files: { hdr_intro: ev_files.hdr_intro, hdr_envio: ev_files.hdr_envio }
    };
  }
  function readMsg(){
    const link=(c_link.value||'').trim() || null;
    return {
      tipo: msg_tipo.value || null,
      modelo: msg_modelo.value || null,
      contexto: ctxMsg(),
      preview_intro: renderTemplate(INTRO, ctxMsg()),
      preview_envio: textEnvio(),
      contato: c_on.checked ? {
        label:(c_label.value||'').trim() || 'Fale com o cerimonial',
        nome:(c_nome.value||'').trim() || null,
        whatsapp:(c_tel.value||'').trim() || null,
        email:(c_mail.value||'').trim() || null,
        link:link
      } : null
    };
  }
  function readCv(){
    return {
      total_convites: Number(cv_t1.textContent)||0,
      total_convidados: Number(cv_t2.textContent)||0,
      invalidos: Number(cv_t3.textContent)||0,
      internacionais: Number(cv_t4.textContent)||0
    };
  }
  function applyProdutoDefaults(){
    const tot=readCv().total_convites||0;
    if(!sum.qtd.value) sum.qtd.value = String(tot);
    switch(sum.plano.value){
      case 'disparo_unitario': if(!sum.preco.value) sum.preco.value='1.50'; break;
      case 'pacote_50': if(!sum.preco.value) sum.preco.value=((50*1.50-10)/50).toFixed(2); if(!sum.qtd.value) sum.qtd.value='50'; break;
      case 'pacote_100': if(!sum.preco.value) sum.preco.value=((100*1.50-30)/100).toFixed(2); if(!sum.qtd.value) sum.qtd.value='100'; break;
      case 'custom': break;
    }
  }
  function recalc(){
    applyProdutoDefaults();
    const q=Number(sum.qtd.value||0)||0, p=Number(sum.preco.value||0)||0, ex=Number(sum.extra.value||0)||0, dc=Number(sum.desc.value||0)||0;
    const subtotal=q*p, total=Math.max(0, subtotal+ex-dc);
    sum.vSub.textContent=brMoney(subtotal); sum.vEx.textContent=brMoney(ex); sum.vDc.textContent=brMoney(dc); sum.vTot.textContent=brMoney(total);
    return {subtotal,total,q,p,ex,dc};
  }
  function validateCanSend(){
    const ev=readEvent(), msg=readMsg(), cv=readCv();
    const hasEv=!!(ev && ev.evento && ev.data && ev.hora);
    const hasMsg=!!(msg && msg.tipo && msg.modelo);
    const tot=cv.total_convites||0;
    const can = hasEv && hasMsg && tot>0 && sum.aceite.checked;
    sum.enviar.setAttribute('aria-disabled', can? 'false':'true');
    return can;
  }
  function setEventSummary(ev){
    sum.evtNome.textContent = safe(ev?.evento);
    sum.evtData.textContent = safe(ev?.data);
    sum.evtHora.textContent = safe(ev?.hora);
    sum.evtEnd.textContent  = safe(ev?.endereco);
    sum.evtObs.textContent  = safe(ev?.observacoes);
  }
  function setMsgSummary(m){
    sum.msgTipo.textContent = safe(m?.tipo);
    sum.msgModelo.textContent = safe(m?.modelo);
    sum.prevIntro.textContent = safe(m?.preview_intro);
    sum.prevEnvio.textContent = safe(m?.preview_envio);
    const c = m?.contato||null, on=!!c;
    sum.cOn.textContent = on? 'sim':'n√£o';
    sum.cBox.classList.toggle('hide', !on);
    if(on){ sum.cLabel.textContent=safe(c.label); sum.cNome.textContent=safe(c.nome); sum.cTel.textContent=safe(c.whatsapp); sum.cMail.textContent=safe(c.email); sum.cLink.textContent=safe(c.link); }
  }
  function setCvSummary(cv){
    sum.tConv.textContent=String(cv.total_convites||0);
    sum.tGuests.textContent=String(cv.total_convidados||0);
    sum.tInv.textContent=String(cv.invalidos||0);
    sum.tIntl.textContent=String(cv.internacionais||0);
    if(!sum.qtd.value) sum.qtd.value = String(cv.total_convites||0);
  }
  function updateSummary(){
    setEventSummary(readEvent()); setMsgSummary(readMsg()); setCvSummary(readCv());
    recalc(); validateCanSend();
  }

  // ========= Navega√ß√£o =========
  function goNext(cur){ const order=['sec-1','sec-2','sec-3','sec-4']; const i=order.indexOf(cur); if(i>-1 && order[i+1]) go(order[i+1]); }
  function goPrev(cur){ const order=['sec-1','sec-2','sec-3','sec-4']; const i=order.indexOf(cur); if(i>0) go(order[i-1]); }
  $('#cv-next').addEventListener('click', ()=> goNext('sec-1'));
  $('#ev-back').addEventListener('click', ()=> goPrev('sec-2'));
  $('#ev-next').addEventListener('click', ()=> { if(validateEvent()) goNext('sec-2'); });
  $('#msg-back').addEventListener('click', ()=> goPrev('sec-3'));
  $('#msg-next').addEventListener('click', ()=> { if(validateMsg()) goNext('sec-3'); });
  $('#sum-back').addEventListener('click', ()=> goPrev('sec-4'));
  $$('#steps .step').forEach(b=> b.addEventListener('click', ()=> go(b.dataset.go)));

  // ========= Exportar / Importar / Imprimir =========
  function collectAll(){
    const ev=readEvent(), msg=readMsg(), cv=readCv(), price=recalc();
    const dataUrlIntro = ev_files.hdr_intro ? null : (ev_url_intro.value.trim() || null);
    const dataUrlEnvio = ev_files.hdr_envio ? null : (ev_url_envio.value.trim() || null);
    return {
      version:"1.0",
      convidados:{ input: cv_imp.value, resumo: cv },
      evento:{
        nome: ev.evento, datetime_local: ev.datetime_local, data: ev.data, hora: ev.hora,
        endereco: ev.endereco, observacoes: ev.observacoes,
        url_header_intro: dataUrlIntro, url_header_envio: dataUrlEnvio
      },
      mensagem: msg,
      pricing:{
        produto: sum.plano.value,
        preco_unit: Number(sum.preco.value||0)||0,
        quantidade: Number(sum.qtd.value||0)||0,
        extras: Number(sum.extra.value||0)||0,
        desconto: Number(sum.desc.value||0)||0,
        totals: recalc()
      }
    };
  }
  function applyAll(obj){
    try{
      cv_imp.value = obj?.convidados?.input || '';
      rows = extractRows(cv_imp.value); recalcTable();

      ev_nome.value = obj?.evento?.nome || '';
      ev_dtpick.value = obj?.evento?.datetime_local || '';
      ev_end.value = obj?.evento?.endereco || '';
      ev_obs.value = obj?.evento?.observacoes || '';
      ev_url_intro.value = obj?.evento?.url_header_intro || '';
      ev_url_envio.value = obj?.evento?.url_header_envio || '';
      validateEvent();

      const m = obj?.mensagem || {};
      msg_tipo.value = m?.tipo || msg_tipo.value; refillModelos(); if(m?.modelo) msg_modelo.value = m.modelo;
      msg_conv1.value = m?.contexto?.convidado1 || ''; msg_evento.value = m?.contexto?.evento || '';
      msg_data.value = m?.contexto?.data || ''; msg_hora.value = m?.contexto?.hora || ''; msg_end.value = m?.contexto?.endereco || '';
      const c=m?.contato||null; c_on.checked=!!c; c_label.value=c?.label||''; c_nome.value=c?.nome||''; c_tel.value=c?.whatsapp||''; c_mail.value=c?.email||''; c_link.value=c?.link||'';
      updatePreviews();

      sum.plano.value = obj?.pricing?.produto || sum.plano.value;
      sum.preco.value = (obj?.pricing?.preco_unit ?? '');
      sum.qtd.value = (obj?.pricing?.quantidade ?? '');
      sum.extra.value = (obj?.pricing?.extras ?? 0);
      sum.desc.value = (obj?.pricing?.desconto ?? 0);
      recalc(); updateSummary();
    }catch(e){ console.error(e); }
  }

  $('#btn-save').addEventListener('click', ()=>{
    const data = collectAll();
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='planejamento-evento-5horas.json'; a.click();
  });
  $('#file-load').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); applyAll(obj); saveLocal(); }catch{ alert('Arquivo inv√°lido.'); } };
    r.readAsText(f);
    e.target.value="";
  });
  $('#btn-print').addEventListener('click', ()=>{ go('sec-4'); setTimeout(()=>window.print(), 50); });

  // CSV de convites (telefone-informado, nomes, intl, e164, qtd)
  $('#btn-export-csv').addEventListener('click', ()=>{
    const lines=[['telefone_informado','nomes','intl','telefone_e164','qtd']];
    rows.forEach(r=>{
      const phone = r.intl ? normalizeIntlPhone(r.telefone) : normalizeBRPhone(r.telefone);
      const convidadosArr = parseGuests(r.convidados);
      lines.push([r.telefone, convidadosArr.join(' | '), r.intl? '1':'0', phone.ok? phone.e164:'', String(convidadosArr.length)]);
    });
    const csv = lines.map(arr=> arr.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='convites-5horas.csv'; a.click();
  });

  // ========= Envio / Marketing CTA =========
  sum.enviar.addEventListener('click', async ()=>{
    if(!validateCanSend()) return;
    const ev=readEvent(), payload = {
      event: ev,
      message: readMsg(),
      convidados_resumo: readCv(),
      pricing: {
        produto: sum.plano.value,
        preco_unit: Number(sum.preco.value||0)||0,
        quantidade: Number(sum.qtd.value||0)||0,
        extras: Number(sum.extra.value||0)||0,
        desconto: Number(sum.desc.value||0)||0,
        ...recalc()
      },
      aprovado_em: new Date().toISOString(),
      marketing: { source: "html-offline-tool", version:"1.0" }
    };

    // Envia FormData (JSON + poss√≠veis imagens)
    const fd = new FormData();
    fd.append('json', JSON.stringify(payload));
    if(ev._files?.hdr_intro) fd.append('file_hdr_intro', ev._files.hdr_intro);
    if(ev._files?.hdr_envio) fd.append('file_hdr_envio', ev._files.hdr_envio);

    // >>> Troque a URL abaixo pelo seu webhook Make/API quando quiser operacionalizar:
    const ENDPOINT = ""; // ex.: "https://hook.make.com/xxxxx"
    if(!ENDPOINT){
      alert('Pedido preparado! Este arquivo √© offline. Para contratar agora, configure um endpoint no c√≥digo (Make/PIX).');
      return;
    }
    try{
      const res = await fetch(ENDPOINT, { method:'POST', body: fd });
      if(!res.ok) throw new Error('Falha no envio');
      alert('Solicita√ß√£o enviada com sucesso! Em breve voc√™ receber√° a proposta/cobran√ßa.');
    }catch(e){
      console.error(e); alert('N√£o foi poss√≠vel enviar agora. Tente novamente mais tarde.');
    }
  });

  // ========= Auto-save =========
  ['input','change'].forEach(evt=>{
    document.addEventListener(evt, ()=>{ clearTimeout(document.__saveT); document.__saveT=setTimeout(saveLocal,120); }, true);
  });

  // ========= Bot√µes topo (steps) =========
  $$('#steps .step').forEach(btn=> btn.addEventListener('click', ()=> go(btn.dataset.go)));

  // ========= Inicializa√ß√£o =========
  loadLocal(); recalcTable(); validateEvent(); updatePreviews(); updateSummary(); go('sec-1');
})();
</script>
</body>
</html>
