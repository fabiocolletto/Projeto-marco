<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Cerimonial — Aplicativo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/Projeto-marco@main/Tools/gestao-de-convidados/ac.css" />
</head>
<body>
  <main class="ac">
    <div class="container">
      <h1>Assistente Cerimonial — Aplicativo</h1>
      <p class="muted">Shell único com navegação por abas e telas carregadas do repositório.</p>

      <section class="card">
        <div class="card__header">
          <h3>Menu</h3>
          <nav class="tabs" aria-label="Navegação principal">
            <button class="tab tab--active" data-tab="home">Eventos</button>
            <button class="tab" data-tab="convites">Convites</button>
            <button class="tab" data-tab="mensagens">Mensagens</button>
            <button class="tab" data-tab="relatorio">Relatórios</button>
          </nav>
        </div>
        <div class="note">O painel fixo do evento é exibido no topo de cada aba.</div>
      </section>

      <section class="card" id="framesCard">
        <div id="frames" class="frames" style="display:grid; grid-template-columns:1fr; gap:0;">
          <!-- iframes são criados sob demanda -->
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    const CANDIDATES = [
      "https://rawcdn.githack.com/fabiocolletto/Projeto-marco/main",
      "https://cdn.jsdelivr.net/gh/fabiocolletto/Projeto-marco@main",
      "https://cdn.statically.io/gh/fabiocolletto/Projeto-marco/main"
    ];
    const BASE_PATH = "/Tools/gestao-de-convidados/";
    const PAGES = {
      home: "home-evento.html",
      convites: "convites.html",
      mensagens: "mensagens.html",
      relatorio: "relatorio.html"
    };
    const WIDGET = "Widget-card-resumo.html";
    const PATH_BUS = "/shared/marcoBus.js";

    const $ = (s)=> document.querySelector(s);
    const framesWrap = $('#frames');

    const state = { base:null, iframes:{}, widgetSrc:null, bus:null, lastEventId:null };

    const seenImports = new Set();

    function preferredBases(){
      if(!state.base) return [...CANDIDATES];
      const rest = CANDIDATES.filter(b => b !== state.base);
      return [state.base, ...rest];
    }

    async function tryImport(url){
      if(seenImports.has(url)) return null;
      seenImports.add(url);
      try {
        return await import(url);
      } catch (e1) {
        try {
          const bust = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
          return await import(bust);
        } catch (e2) {
          return null;
        }
      }
    }

    async function loadShared(rel){
      for(const base of preferredBases()){
        const mod = await tryImport(base + rel);
        if(mod) return mod;
      }
      return null;
    }

    async function resolveBase(){
      for(const base of CANDIDATES){
        try{
          const htmlOk = await candidateHasHtml(base);
          if(htmlOk){
            state.base = base;
            break;
          }
        }catch(e){ /* tenta próxima */ }
      }
      if(!state.base) state.base = CANDIDATES[0];
      state.widgetSrc = state.base + BASE_PATH + WIDGET;
    }

    function addCacheBuster(url, stamp){
      return url + (url.includes('?') ? '&' : '?') + 't=' + stamp;
    }

    function isHtml(contentType){
      return !!contentType && contentType.includes('text/html');
    }

    function isPlain(contentType){
      return !!contentType && contentType.includes('text/plain');
    }

    async function fetchContentType(url, method){
      try{
        const res = await fetch(url, { method, cache:'no-store', redirect:'follow' });
        const contentType = (res.headers.get('content-type') || '').toLowerCase();
        if(method !== 'HEAD'){
          try{ res.body && res.body.cancel && res.body.cancel(); }catch(_){}
        }
        return { ok: res.ok, contentType };
      }catch(e){
        return { ok:false, contentType:'' };
      }
    }

    async function candidateHasHtml(base){
      const now = Date.now();
      const htmlUrl = addCacheBuster(base + BASE_PATH + PAGES.home, now);

      const headCheck = await fetchContentType(htmlUrl, 'HEAD');
      if(headCheck.ok){
        if(isHtml(headCheck.contentType)) return true;
        if(isPlain(headCheck.contentType)) return false;
      }

      const getCheck = await fetchContentType(htmlUrl, 'GET');
      if(getCheck.ok && isHtml(getCheck.contentType)) return true;
      if(isPlain(getCheck.contentType)) return false;

      return false;
    }

    function announceCurrentEvent(){
      if(state.lastEventId && state.bus?.publish){
        state.bus.publish('ac:open-event', { id: state.lastEventId });
      }
    }

    function makeIframe(src){
      const f = document.createElement('iframe');
      f.src = src;
      f.loading = 'lazy';
      f.style.width = '100%';
      f.style.border = '0';
      f.style.minHeight = '1200px';
      f.setAttribute('referrerpolicy', 'no-referrer');
      f.addEventListener('load', ()=> setTimeout(announceCurrentEvent, 50));
      return f;
    }

    function ensureView(tab){
      // cria container do tab caso não exista
      if(!state.iframes[tab]){
        const wrap = document.createElement('div');
        wrap.dataset.tab = tab;
        wrap.style.display = 'none';
        wrap.style.gap = '12px';
        wrap.style.gridTemplateColumns = '1fr';

        // 1) Widget fixo no topo
        const w = makeIframe(state.widgetSrc);
        wrap.appendChild(w);

        // 2) Tela
        const src = state.base + BASE_PATH + PAGES[tab];
        const fr = makeIframe(src);
        wrap.appendChild(fr);

        framesWrap.appendChild(wrap);
        state.iframes[tab] = wrap;
      }
    }

    function activate(tab){
      for(const k in state.iframes){ state.iframes[k].style.display = (k===tab? 'grid':'none'); }
      document.querySelectorAll('.tab').forEach(btn=> btn.classList.toggle('tab--active', btn.dataset.tab===tab));
      history.replaceState({}, '', '#'+tab);
    }

    function openTab(tab, { fromBus=false } = {}){
      if(!PAGES[tab]) return;
      ensureView(tab);
      activate(tab);
      if(!fromBus){
        state.bus?.publish?.('ac:navigate', { tab });
      }
    }

    function onNav(e){
      const btn = e.target.closest && e.target.closest('.tab');
      if(!btn) return;
      const tab = btn.dataset.tab;
      openTab(tab);
    }

    document.querySelector('.tabs').addEventListener('click', onNav);

    // deep-link / hash
    (async function init(){
      await resolveBase();
      state.bus = await loadShared(PATH_BUS);
      state.bus?.subscribe?.('ac:navigate', ({ tab }) => { if(tab) openTab(tab, { fromBus:true }); });
      state.bus?.subscribe?.('ac:open-event', ({ id }) => { if(id) state.lastEventId = id; });
      const hash = (location.hash||'').replace('#','');
      const first = PAGES[hash] ? hash : 'home';
      openTab(first, { fromBus:true });
    })();

    // opcional: rolar para topo ao trocar aba
    window.addEventListener('hashchange', ()=> window.scrollTo({top:0, behavior:'smooth'}));
  </script>
</body>
</html>
