<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Assistente Cerimonial ‚Äî Tela √önica</title>
<style>
  :root{--bg:#0b0c0f;--paper:#fff;--ink:#0f172a;--mut:#64748b;--line:#e5e7eb;--pri:#2563eb;--radius:16px;--shadow:0 10px 30px rgba(2,6,23,.12);--fs-xxl:26px;--fs-xl:19px;--fs-md:14px;--fs-sm:12px}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:400 var(--fs-md)/1.55,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:22px}
  .app{background:var(--paper);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;padding:20px;display:grid;gap:24px}
  .hdr{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:start}
  h1{font-size:var(--fs-xxl);margin:0}
  .btns-top{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .card{border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff}
  h2{font-size:var(--fs-xl);margin:0 0 12px}
  label{display:block;font-weight:600;margin-bottom:6px}
  input,textarea,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font-size:var(--fs-md);background:#fff}
  textarea{min-height:120px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-8{grid-column:span 8}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .actions.right{justify-content:flex-end}
  .btn{appearance:none;border:none;background:var(--pri);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px}
  .btn.secondary{background:#f1f5f9;color:var(--ink)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
  .preview{border:1px dashed var(--line);border-radius:8px;padding:10px;background:#fcfcfd;white-space:pre-wrap}
  .split{display:grid;grid-template-columns:320px 1fr;gap:14px}
  @media (max-width:900px){.split{grid-template-columns:1fr}}
  .panel{border:1px solid var(--line);border-radius:10px;padding:12px;background:#fff}
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:10px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
  td.qty, th.qty{width:80px;text-align:center}
  .icon-btn{border:1px solid var(--line);background:#f8fafc;border-radius:6px;padding:4px 8px;cursor:pointer}
  td.actions{white-space:nowrap}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.6);z-index:1000;padding:16px}
  .modal.open{display:flex}
  .modal .box{background:#fff;border-radius:12px;max-width:680px;width:100%;max-height:80vh;overflow:auto;padding:16px;display:grid;gap:12px}
  .saves{list-style:none;padding:0;margin:0;display:grid;gap:8px}
  .saves li{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:10px}
  .saves .meta{font-size:12px;color:var(--mut)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="app" id="app">
      <div class="hdr">
        <h1>Programa√ß√£o de Mensagens</h1>
        <div class="btns-top">
          <button class="btn" id="navSave">Salvar</button>
          <button class="btn secondary" id="navLoad">Carregar</button>
          <button class="btn ghost" id="navClear">Limpar</button>
        </div>
      </div>

      <section class="card" id="sec-evento">
        <h2>Coleta dos dados do evento</h2>
        <div class="row">
          <div class="col-12"><label for="s1_evt_nome">Nome do evento</label><input id="s1_evt_nome" type="text" placeholder="Ex.: Casamento Ana & Marco"></div>
          <div class="col-6"><label for="s1_evt_data">Data</label><input id="s1_evt_data" type="date"></div>
          <div class="col-6"><label for="s1_evt_hora">Hora</label><input id="s1_evt_hora" type="time"></div>
          <div class="col-6"><label for="s1_evt_local">Local</label><input id="s1_evt_local" type="text" placeholder="Ex.: Espa√ßo Jardins"></div>
          <div class="col-6"><label for="s1_evt_endereco">Endere√ßo</label><input id="s1_evt_endereco" type="text" placeholder="Rua, n¬∫, bairro, cidade"></div>
          <div class="col-12"><label for="s1_evt_anfitriao">Anfitri√£o/Contato</label><input id="s1_evt_anfitriao" type="text" placeholder="Ex.: Ana (41) 99999-0000"></div>
        </div>
        <div class="actions right">
          <button class="btn" id="btnCopyTag">Copiar etiqueta</button>
          <button class="btn secondary" id="btnDownloadTag">Exportar etiqueta (.txt)</button>
        </div>
      </section>

      <section class="card" id="sec-lista">
        <h2>Importar / editar / visualizar lista de convidados</h2>
        <div class="split">
          <div class="panel">
            <div class="actions">
              <button class="btn secondary" id="btnImportJSON">Importar JSON</button>
              <button class="btn ghost" id="btnProcessarLista">Normalizar</button>
            </div>
            <label for="lista" style="margin-top:10px">Colar/editar convites</label>
            <textarea id="lista" placeholder="Ex.: Jo√£o da Silva, 41 99999-9999, Maria"></textarea>
          </div>
          <div class="panel">
            <div class="table-wrap">
              <table>
                <thead><tr><th>#</th><th>Nome</th><th>Telefone</th><th>Acompanhantes</th><th class="qty">Qtd.</th><th>A√ß√µes</th></tr></thead>
                <tbody id="tblLista"><tr><td>1</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td class="qty">‚Äî</td><td class="actions"><button class="icon-btn" disabled>‚úèÔ∏è</button> <button class="icon-btn" disabled>üóëÔ∏è</button></td></tr></tbody>
              </table>
            </div>
            <pre id="outLista" class="preview" style="margin-top:10px"></pre>
            <div class="actions right"><button class="btn secondary" id="btnExportLista">Exportar lista</button></div>
          </div>
        </div>
      </section>

      <section class="card" id="sec-msgs">
        <h2>Crie/Defina mensagens e cronograma de envio</h2>
        <div class="split">
          <div class="panel">
            <label for="amostra_nome">Convidado (exemplo)</label>
            <input id="amostra_nome" type="text" placeholder="Ex.: Maria">
            <div class="actions" style="margin-top:10px">
              <label><input type="checkbox" class="chk-tipo" value="save_the_date"> Save the date</label>
              <label><input type="checkbox" class="chk-tipo" value="convite"> Convite</label>
              <label><input type="checkbox" class="chk-tipo" value="rsvp"> RSVP</label>
              <label><input type="checkbox" class="chk-tipo" value="lembrete_vespera"> Lembrete v√©spera</label>
              <label><input type="checkbox" class="chk-tipo" value="agradecimento"> Agradecimento</label>
            </div>
          </div>
          <div class="panel">
            <div class="preview" id="autoPreviewText">Pr√©via das mensagens selecionadas.</div>
            <div class="actions right"><button class="btn" id="btnExportMsgs">Exportar texto de mensagens</button></div>
          </div>
        </div>
        <div id="painelTipos" class="row" style="margin-top:10px"></div>
      </section>

      <section class="card" id="sec-relatorio">
        <h2>Relat√≥rio do evento</h2>
        <pre id="planPreview" class="preview">Clique em "Atualizar".</pre>
        <div class="actions right">
          <button class="btn" id="btnPlanUpdate">Atualizar</button>
          <button class="btn secondary" id="btnPlanCopy">Copiar</button>
          <button class="btn ghost" id="btnPlanDownload">Baixar .txt</button>
        </div>
      </section>
    </div>
  </div>

  <div id="modalLoad" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0">Seus eventos salvos</h2>
      <div id="savesEmpty">Voc√™ ainda n√£o tem eventos salvos.</div>
      <ul id="savesList" class="saves"></ul>
      <div class="actions right">
        <button class="btn ghost" id="closeLoad">Fechar</button>
      </div>
    </div>
  </div>

<script>
(function(){
  function $(s,el){return (el||document).querySelector(s)}
  function $$(s,el){return Array.prototype.slice.call((el||document).querySelectorAll(s))}
  var K_EVT='ac_evt_v1',K_LIST='ac_list_v2',K_MSGS='ac_msgs_v1';
  var K_BINDEX='ac_bundles_index_v1',K_BUND_PREF='ac_bundle_v1:';
  function fmtDateBR(iso){if(!iso)return'';var a=iso.split('-');return a.length<3?'':a[2]+'/'+a[1]+'/'+a[0]}
  function nowISO(){return new Date().toISOString()}
  function slug(s){return String(s||'evento').toLowerCase().normalize('NFD').replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-').slice(0,40)}
  function keyFromEvento(e){var nm=slug(e.nome||'evento');var dt=e.data||'sem-data';return nm+'__'+dt}
  function getEvento(){return{nome:($('#s1_evt_nome')&&$('#s1_evt_nome').value.trim())||'',data:($('#s1_evt_data')&&$('#s1_evt_data').value)||'',hora:($('#s1_evt_hora')&&$('#s1_evt_hora').value)||'',local:($('#s1_evt_local')&&$('#s1_evt_local').value.trim())||'',endereco:($('#s1_evt_endereco')&&$('#s1_evt_endereco').value.trim())||'',anfitriao:($('#s1_evt_anfitriao')&&$('#s1_evt_anfitriao').value.trim())||''}}
  function setEvento(e){if(!e)return;var m={'#s1_evt_nome':'nome','#s1_evt_data':'data','#s1_evt_hora':'hora','#s1_evt_local':'local','#s1_evt_endereco':'endereco','#s1_evt_anfitriao':'anfitriao'};Object.keys(m).forEach(function(sel){var el=$(sel);if(el)el.value=e[m[sel]]||''})}
  function saveDraft(){try{localStorage.setItem(K_EVT,JSON.stringify(getEvento()));localStorage.setItem(K_LIST,JSON.stringify(state.invites));localStorage.setItem(K_MSGS,JSON.stringify({types:selectedTypes(),guest:($('#amostra_nome')&&$('#amostra_nome').value.trim())||''}))}catch(e){} }
  function clearAll(){['#s1_evt_nome','#s1_evt_data','#s1_evt_hora','#s1_evt_local','#s1_evt_endereco','#s1_evt_anfitriao','#lista','#amostra_nome'].forEach(function(sel){var el=$(sel);if(el)el.value=''});var tb=$('#tblLista');if(tb)tb.innerHTML='<tr><td>1</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td class="qty">‚Äî</td><td class="actions"><button class="icon-btn" disabled>‚úèÔ∏è</button> <button class="icon-btn" disabled>üóëÔ∏è</button></td></tr>';var ol=$('#outLista');if(ol)ol.textContent='';var ap=$('#autoPreviewText');if(ap)ap.textContent='Pr√©via das mensagens selecionadas.';var pp=$('#planPreview');if(pp)pp.textContent='Clique em "Atualizar".';$$('.chk-tipo').forEach(function(n){n.checked=false});try{localStorage.removeItem(K_LIST);localStorage.removeItem(K_MSGS)}catch(e){} }
  function etiquetaTexto(e){e=e||getEvento();return['Evento: '+(e.nome||'-'),'Data: '+(e.data?fmtDateBR(e.data):'-')+(e.hora?' √†s '+e.hora:''),'Local: '+(e.local||'-'),'Endere√ßo: '+(e.endereco||'-'),'Contato: '+(e.anfitriao||'-')].join('\n')}
  function copyText(t){function fb(){var ta=document.createElement('textarea');ta.value=t;ta.style.position='fixed';ta.style.opacity='0';document.body.appendChild(ta);ta.select();try{document.execCommand('copy');alert('Pronto! Copiamos o texto para voc√™.')}catch(_){alert(t)}ta.remove()}if(window.isSecureContext&&navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(t).then(function(){alert('Pronto! Copiamos o texto para voc√™.')}).catch(function(){fb()})}else{fb()}}

  $('#btnCopyTag')?.addEventListener('click',function(){copyText(etiquetaTexto())});
  $('#btnDownloadTag')?.addEventListener('click',function(){var blob=new Blob([etiquetaTexto()],{type:'text/plain'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='etiqueta.txt';document.body.appendChild(a);a.click();setTimeout(function(){URL.revokeObjectURL(url);a.remove()},0)});

  function isLikelyPhone(part){var d=String(part||'').replace(/\D+/g,'');return d.length>=8||/^\+\d{7,15}$/.test(String(part||''))}
  function extractPhoneName(parts){var phoneIdx=-1;for(var i=0;i<parts.length;i++){if(isLikelyPhone(parts[i])){phoneIdx=i;break}}var nameIdx=-1;for(var j=0;j<parts.length;j++){if(j===phoneIdx)continue;if(parts[j]){nameIdx=j;break}}var phone=phoneIdx>-1?parts[phoneIdx].trim():'';var name=nameIdx>-1?parts[nameIdx].trim():'';var acomp=[];for(var k=0;k<parts.length;k++){if(k!==phoneIdx&&k!==nameIdx&&parts[k])acomp.push(parts[k].trim())}return{name:name,phone:phone,acomp:acomp}}
  function parseInvites(raw){if(!raw)return[];var lines=raw.replace(/\r\n?/g,'\n').split('\n');var out=[];for(var i=0;i<lines.length;i++){var t=lines[i].trim();if(!t)continue;var parts=t.split(',').map(function(p){return p.trim()}).filter(Boolean);var ex=extractPhoneName(parts);var qty=1+(ex.acomp?ex.acomp.length:0);out.push({id:0,name:ex.name,phone:ex.phone,acomp:ex.acomp,qty:qty})}return out}

  var state={invites:[],seq:1};
  function linesForExport(list){return list.map(function(it){var seg=[it.name||''];if(it.phone)seg.push(it.phone);if(it.acomp&&it.acomp.length)seg=seg.concat(it.acomp);return seg.filter(Boolean).join(', ')}).join('\n')}

  function beginRowEdit(tr,id){var it=state.invites.find(function(x){return x.id===id});if(!it)return;var acompStr=(it.acomp&&it.acomp.length)?it.acomp.join(', '):'';tr.className='';tr.innerHTML='<td class="muted">'+(state.invites.indexOf(it)+1)+'</td>'+
    '<td><input type="text" class="inp-name" value="'+(it.name||'').replace(/"/g,'&quot;')+'"></td>'+
    '<td><input type="text" class="inp-phone" value="'+(it.phone||'').replace(/"/g,'&quot;')+'"></td>'+
    '<td><input type="text" class="inp-acomp" value="'+acompStr.replace(/"/g,'&quot;')+'"></td>'+
    '<td class="qty"><input type="number" class="inp-qty" min="1" value="'+(it.qty||1)+'"></td>'+
    '<td class="actions"><button type="button" class="icon-btn save">‚úîÔ∏è</button> <button type="button" class="icon-btn cancel">‚Ü©Ô∏è</button></td>';
    tr.querySelector('.save').addEventListener('click',function(){var name=tr.querySelector('.inp-name').value.trim();var phone=tr.querySelector('.inp-phone').value.trim();var acompRaw=tr.querySelector('.inp-acomp').value.trim();var ac=acompRaw?acompRaw.split(',').map(function(s){return s.trim()}).filter(Boolean):[];var qty=parseInt(tr.querySelector('.inp-qty').value,10);if(isNaN(qty)||qty<1)qty=1+ac.length;it.name=name;it.phone=phone;it.acomp=ac;it.qty=qty;renderInvites(state.invites)});
    tr.querySelector('.cancel').addEventListener('click',function(){renderInvites(state.invites)});
  }

  function renderInvites(list){var tbody=$('#tblLista');if(!tbody)return;state.invites=list.slice();for(var i=0;i<state.invites.length;i++){state.invites[i].id=i+1}if(!state.invites.length){tbody.innerHTML='<tr><td>1</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td class="qty">‚Äî</td><td class="actions"><button class="icon-btn" disabled>‚úèÔ∏è</button> <button class="icon-btn" disabled>üóëÔ∏è</button></td></tr>';$('#outLista').textContent='';return}var rows='';for(var n=0;n<state.invites.length;n++){var it=state.invites[n];var acomp=(it.acomp&&it.acomp.length)?it.acomp.join(', '):'‚Äî';rows+='<tr data-id="'+it.id+'">'+
      '<td class="muted">'+(n+1)+'</td>'+
      '<td>'+(it.name||'‚Äî')+'</td>'+
      '<td>'+(it.phone||'‚Äî')+'</td>'+
      '<td>'+(acomp)+'</td>'+
      '<td class="qty">'+(it.qty||1)+'</td>'+
      '<td class="actions"><button type="button" class="icon-btn edit">‚úèÔ∏è</button> <button type="button" class="icon-btn del">üóëÔ∏è</button></td>'+
    '</tr>'}
    tbody.innerHTML=rows;$('#outLista').textContent=linesForExport(state.invites);
    tbody.querySelectorAll('button.edit').forEach(function(btn){btn.addEventListener('click',function(){var tr=btn.closest('tr');beginRowEdit(tr,parseInt(tr.getAttribute('data-id'),10))})});
    tbody.querySelectorAll('button.del').forEach(function(btn){btn.addEventListener('click',function(){var tr=btn.closest('tr');var id=parseInt(tr.getAttribute('data-id'),10);state.invites=state.invites.filter(function(x){return x.id!==id});renderInvites(state.invites)})});
    try{localStorage.setItem(K_LIST,JSON.stringify(state.invites))}catch(e){}
  }

  function processList(){var l=$('#lista');var items=parseInvites(l?l.value:'');for(var i=0;i<items.length;i++){items[i].id=i+1}renderInvites(items)}
  $('#btnProcessarLista')?.addEventListener('click',processList);

  $('#btnExportLista')?.addEventListener('click',function(){var txt=$('#outLista')&&$('#outLista').textContent||'';var blob=new Blob([txt],{type:'text/plain'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='lista.txt';document.body.appendChild(a);a.click();setTimeout(function(){URL.revokeObjectURL(url);a.remove()},0)});

  $('#btnImportJSON')?.addEventListener('click',function(){var input=document.createElement('input');input.type='file';input.accept='application/json';input.addEventListener('change',function(ev){var f=ev.target.files[0];if(!f)return;var fr=new FileReader();fr.onload=function(e){try{var data=JSON.parse(e.target.result);var list=Array.isArray(data)?data:(Array.isArray(data.invites)?data.invites:[]);list=list.map(function(it){return{id:0,name:it.name||it[0]||'',phone:it.phone||it[1]||'',acomp:it.acomp||[],qty:it.qty||1+(it.acomp?it.acomp.length:0)}});renderInvites(list)}catch(err){alert('Arquivo inv√°lido. Tente novamente.')}};fr.readAsText(f)});input.click()});

  var TYPES={save_the_date:'Save the date',convite:'Convite',rsvp:'RSVP',lembrete_vespera:'Lembrete v√©spera',agradecimento:'Agradecimento'};
  function selectedTypes(){var arr=[];$$('.chk-tipo').forEach(function(ch){if(ch.checked)arr.push(ch.value)});return arr}
  function msgForType(t,guest,e){var oi=guest?('Ol√°, '+guest+'! '):'';var quando=(e.data?fmtDateBR(e.data):'')+(e.hora?' √†s '+e.hora:'');var loc=e.local?' no '+e.local:'';if(t==='save_the_date')return oi+'Guarde a data: '+quando+loc+'.';if(t==='convite')return oi+'Voc√™ √© nosso convidado'+(e.nome?' para '+e.nome:'')+'. Ser√° '+quando+loc+'.';if(t==='rsvp')return oi+'Pode confirmar presen√ßa?';if(t==='lembrete_vespera')return oi+'Nos vemos amanh√£! '+(quando||'');if(t==='agradecimento')return oi+'Obrigado por fazer parte!';return''}
  function updateAutoPreview(){var e=getEvento();var names=state.invites.map(function(it){return it.name}).filter(Boolean);var guest=$('#amostra_nome')&&$('#amostra_nome').value.trim()||names[0]||'';var types=selectedTypes();var ap=$('#autoPreviewText');if(!ap)return;if(!types.length){ap.textContent='Selecione ao menos um tipo.'}else{var lines=[];for(var i=0;i<types.length;i++){var t=types[i];lines.push('--- '+TYPES[t]+' ---');lines.push(msgForType(t,guest,e));lines.push('')}ap.textContent=lines.join('\n')}try{localStorage.setItem(K_MSGS,JSON.stringify({types:types,guest:guest}))}catch(e){}
  }
  $$('.chk-tipo').forEach(function(ch){ch.addEventListener('change',updateAutoPreview)});
  $('#amostra_nome')?.addEventListener('input',updateAutoPreview);
  $('#btnExportMsgs')?.addEventListener('click',function(){var txt=$('#autoPreviewText')&&$('#autoPreviewText').textContent||'';var blob=new Blob([txt],{type:'text/plain'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='mensagens.txt';document.body.appendChild(a);a.click();setTimeout(function(){URL.revokeObjectURL(url);a.remove()},0)});

  function buildReport(){var e=getEvento();var txt=[];txt.push('Relat√≥rio do evento');txt.push('');txt.push('Evento: '+(e.nome||'‚Äî'));txt.push('Quando: '+((e.data?fmtDateBR(e.data):'‚Äî')+(e.hora?' √†s '+e.hora:'')));txt.push('Local: '+(e.local||'‚Äî'));txt.push('Endere√ßo: '+(e.endereco||'‚Äî'));txt.push('Contato: '+(e.anfitriao||'‚Äî'));txt.push('');txt.push('Convidados ('+state.invites.length+')');txt.push(state.invites.length?state.invites.map(function(it,i){return String(i+1).padStart(2,'0')+'. '+(it.name||'‚Äî')+(it.phone?' ‚Äî '+it.phone:'')}).join('\n'):'‚Äî');txt.push('');txt.push('Mensagens selecionadas');var types=selectedTypes();if(!types.length)txt.push('‚Äî');else types.forEach(function(t){txt.push('- '+TYPES[t])});return txt.join('\n')}
  $('#btnPlanUpdate')?.addEventListener('click',function(){var pv=$('#planPreview');if(pv)pv.textContent=buildReport()});
  $('#btnPlanCopy')?.addEventListener('click',function(){var pv=$('#planPreview');var t=(pv&&pv.textContent)||buildReport();(function fb(){var ta=document.createElement('textarea');ta.value=t;ta.style.position='fixed';ta.style.opacity='0';document.body.appendChild(ta);ta.select();try{document.execCommand('copy');alert('Pronto! Copiamos o texto para voc√™.')}catch(_){alert(t)}ta.remove()})()});
  $('#btnPlanDownload')?.addEventListener('click',function(){var pv=$('#planPreview');var blob=new Blob([(pv&&pv.textContent)||buildReport()],{type:'text/plain'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='relatorio.txt';document.body.appendChild(a);a.click();setTimeout(function(){URL.revokeObjectURL(url);a.remove()},0)});

  function getIndex(){try{var raw=localStorage.getItem(K_BINDEX);var arr=raw?JSON.parse(raw):[];return Array.isArray(arr)?arr:[]}catch(e){return[]}}
  function setIndex(arr){try{localStorage.setItem(K_BINDEX,JSON.stringify(arr))}catch(e){}}
  function saveBundle(){var e=getEvento();var nm=e.nome||'Evento';var id=keyFromEvento(e);var bundle={id:id,name:nm,updatedAt:nowISO(),evento:e,invites:state.invites,msgs:{types:selectedTypes(),guest:($('#amostra_nome')&&$('#amostra_nome').value.trim())||''}};try{var idx=getIndex().filter(function(x){return x&&x.id});var i=idx.findIndex(function(x){return x.id===id});var entry={id:id,name:nm,date:e.data||'',updatedAt:bundle.updatedAt};if(i>-1){if(!confirm('J√° existe um evento com esse nome e data. Quer atualizar o arquivo existente?'))return; idx[i]=entry;localStorage.setItem(K_BUND_PREF+id,JSON.stringify(bundle));alert('Evento atualizado com sucesso.')}else{localStorage.setItem(K_BUND_PREF+id,JSON.stringify(bundle));idx.push(entry);alert('Evento salvo com sucesso.')}idx.sort(function(a,b){return (b.updatedAt||'').localeCompare(a.updatedAt||'')});setIndex(idx);saveDraft()}catch(err){}
  }
  function renderLoadList(){var idx=getIndex();var ul=$('#savesList');var emp=$('#savesEmpty');if(!ul||!emp)return;ul.innerHTML='';if(!idx.length){emp.style.display='block';return}emp.style.display='none';for(var i=0;i<idx.length;i++){var it=idx[i];var li=document.createElement('li');var meta=document.createElement('div');var label='<strong>'+it.name.replace(/</g,'&lt;')+'</strong>';if(it.date){label+=' <span class="meta">‚Äî '+fmtDateBR(it.date)+'</span>'}meta.innerHTML='<div>'+label+'<div class="meta">'+(new Date(it.updatedAt||nowISO())).toLocaleString()+'</div></div>';
      var actions=document.createElement('div');var b1=document.createElement('button');b1.className='btn act-load';b1.type='button';b1.dataset.id=it.id;b1.textContent='Carregar';var b2=document.createElement('button');b2.className='btn ghost act-del';b2.type='button';b2.style.marginLeft='8px';b2.dataset.id=it.id;b2.textContent='Excluir';actions.appendChild(b1);actions.appendChild(b2);li.appendChild(meta);li.appendChild(actions);ul.appendChild(li)}
  }
  function openLoadModal(){renderLoadList();$('#modalLoad')?.classList.add('open')}
  function closeLoadModal(){$('#modalLoad')?.classList.remove('open')}
  function loadBundle(id){try{var raw=localStorage.getItem(K_BUND_PREF+id);if(!raw){alert('Registro n√£o encontrado.');renderLoadList();return}var b=JSON.parse(raw);if(!confirm('Carregar este evento e substituir o que est√° na tela?'))return;setEvento(b.evento||{});renderInvites(Array.isArray(b.invites)?b.invites:[]);$$('.chk-tipo').forEach(function(ch){ch.checked=(b.msgs&&Array.isArray(b.msgs.types)?b.msgs.types:[]).indexOf(ch.value)>-1});var an=$('#amostra_nome');if(an)an.value=(b.msgs&&b.msgs.guest)||'';updateAutoPreview();saveDraft();closeLoadModal();alert('Evento carregado com sucesso.')}catch(e){}
  }
  function deleteBundle(id){if(!confirm('Remover este evento salvo da sua lista?'))return;try{localStorage.removeItem(K_BUND_PREF+id);var idx=getIndex().filter(function(x){return x.id!==id});setIndex(idx);renderLoadList();var emp=$('#savesEmpty');if(emp&&idx.length===0)emp.style.display='block';alert('Evento removido.')}catch(e){}
  }

  $('#navSave')?.addEventListener('click',saveBundle);
  $('#navLoad')?.addEventListener('click',openLoadModal);
  $('#navClear')?.addEventListener('click',function(){if(confirm('Limpar a tela atual? Seus eventos salvos n√£o ser√£o apagados.')){clearAll();saveDraft()}});
  $('#closeLoad')?.addEventListener('click',closeLoadModal);
  $('#modalLoad')?.addEventListener('click',function(ev){if(ev.target&&ev.target.id==='modalLoad')closeLoadModal()});
  $('#savesList')?.addEventListener('click',function(ev){var btn=ev.target.closest('button');if(!btn)return;var id=btn.dataset.id;if(btn.classList.contains('act-load'))loadBundle(id);else if(btn.classList.contains('act-del'))deleteBundle(id)});

  (function restore(){try{var raw=localStorage.getItem(K_EVT);if(raw)setEvento(JSON.parse(raw));var rl=localStorage.getItem(K_LIST);if(rl){var data=JSON.parse(rl);if(Array.isArray(data)&&data.length&&typeof data[0]==='object'){state.invites=data}else if(Array.isArray(data)){state.invites=data.map(function(nm,i){return{id:i+1,name:nm,phone:'',acomp:[],qty:1}})}renderInvites(state.invites)}var rm=localStorage.getItem(K_MSGS);if(rm){var o=JSON.parse(rm)||{};$$('.chk-tipo').forEach(function(ch){ch.checked=(o.types||[]).indexOf(ch.value)>-1});var an=$('#amostra_nome');if(an&&o.guest)an.value=o.guest}}catch(e){}updateAutoPreview()})();

  (function tests(){
    var _confirm=window.confirm,_alert=window.alert;window.confirm=function(){return true};window.alert=function(){};
    try{console.assert(typeof etiquetaTexto(getEvento())==='string','etiquetaTexto deve retornar string')}catch(e){}
    try{var it=parseInvites('Jo√£o, 41 99999-9999, Maria')[0];console.assert(it.name&&it.phone&&it.acomp.length===1&&it.qty===2,'parseInvites extrai nome/telefone/acomp/qtd') }catch(e){}
    try{var it2=parseInvites('41 99999-9999, Ana')[0];console.assert(/Ana/i.test(it2.name),'quando telefone vem antes, nome √© reconhecido')}catch(e){}
    try{var e={nome:'Unit',data:'2025-01-01'};var id=keyFromEvento(e);localStorage.setItem(K_BUND_PREF+id,JSON.stringify({id:id,name:'Unit',updatedAt:nowISO(),evento:e,invites:[{id:1}],msgs:{}}));var idx=getIndex();if(idx.findIndex(function(x){return x.id===id})<0){idx.push({id:id,name:'Unit',date:e.data,updatedAt:nowISO()});setIndex(idx)}deleteBundle(id);var gone=!localStorage.getItem(K_BUND_PREF+id);var idx2=getIndex();console.assert(gone&&idx2.findIndex(function(x){return x.id===id})===-1,'excluir funciona')}catch(e){}
    window.confirm=_confirm;window.alert=_alert;
  })();
})();
</script>
</body>
</html>
