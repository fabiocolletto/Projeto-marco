(function(){
  const $  =(s,el=document)=>el.querySelector(s);
  const $$ =(s,el=document)=>Array.from(el.querySelectorAll(s));
  const KEY='ac_evt_v1';

  const state={ evento:{nome:'',data:'',hora:'',local:'',endereco:'',anfitriao:''} };

  try{ Object.assign(state.evento, JSON.parse(localStorage.getItem(KEY)||'{}')); }catch(_){}

  const fmt = iso => !iso ? '' : iso.split('-').reverse().join('/');
  const dataHora = e => [fmt(e.data), e.hora].filter(Boolean).join(' ');
  const fone = s => (s||'').match(/(\(?\d{2}\)?\s*\d{4,5}[- ]?\d{4})/)?.[0] || (s||'');

  const map = [
    ['#s1_evt_nome','nome'],['#s1_evt_data','data'],['#s1_evt_hora','hora'],
    ['#s1_evt_local','local'],['#s1_evt_endereco','endereco'],['#s1_evt_anfitriao','anfitriao']
  ];

  function paintInputs(){
    map.forEach(([sel,key])=>{ const el=$(sel); if(el) el.value = state.evento[key]||''; });
  }

  function syncBinds(){
    const e=state.evento;
    $$('[data-bind]').forEach(el=>{
      const k=el.dataset.bind;
      el.textContent =
        k==='datahora' ? (dataHora(e)||'—') :
        k==='fone'     ? (fone(e.anfitriao)||'—') :
        (e[k]||'—');
    });
  }

  function persist(){ localStorage.setItem(KEY, JSON.stringify(state.evento)); }

  map.forEach(([sel,key])=>{
    const el=$(sel); if(!el) return;
    el.addEventListener('input', ev=>{
      state.evento[key] = ev.target.value.trim();
      persist(); syncBinds();
    });
  });

  $('#btnS1PreencherExemplo')?.addEventListener('click', ()=>{
    state.evento = {
      nome:'Casamento Ana & Marco',
      data:'2025-12-20',
      hora:'19:30',
      local:'Espaço Jardins',
      endereco:'Rua das Palmeiras, 123 – Curitiba',
      anfitriao:'Ana (41) 99999-0000'
    };
    persist(); paintInputs(); syncBinds();
  });

  $('#lista')?.addEventListener('input', e=>{
    const tokens=String(e.target.value)
      .replace(/\r\n?/g,'\n')
      .split(/\n|,|;|\t/g)
      .map(s=>s.trim())
      .filter(Boolean);
    const uniq=[]; tokens.forEach(t=>{ if(!uniq.some(x=>x.toLowerCase()===t.toLowerCase())) uniq.push(t); });
    const out=$('#outLista'); if(out) out.textContent=uniq.join('\n');
  });

  $('#btnCopyTag')?.addEventListener('click', ()=>{
    const e=state.evento;
    const txt=[
      `Evento: ${e.nome||'-'}`,
      `Data: ${fmt(e.data)||'-'}${e.hora?` às ${e.hora}`:''}`,
      `Local: ${e.local||'-'}`,
      `Endereço: ${e.endereco||'-'}`,
      `Contato: ${e.anfitriao||'-'}`
    ].join('\n');
    (navigator.clipboard?.writeText(txt) || Promise.reject()).catch(()=>{
      const ta=document.createElement('textarea'); ta.value=txt; ta.style.position='fixed'; ta.style.top='-1000px';
      document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    });
  });

  $('#btnDownloadTag')?.addEventListener('click', ()=>{
    const e=state.evento;
    const txt=[
      `Evento: ${e.nome||'-'}`,
      `Data: ${fmt(e.data)||'-'}${e.hora?` às ${e.hora}`:''}`,
      `Local: ${e.local||'-'}`,
      `Endereço: ${e.endereco||'-'}`,
      `Contato: ${e.anfitriao||'-'}`
    ].join('\n');
    const blob=new Blob([txt],{type:'text/plain'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='etiqueta.txt'; document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
  });

  paintInputs(); syncBinds();
})();
