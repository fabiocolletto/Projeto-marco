<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Assistente Cerimonial – Lista e PDF</title>
<style>
  :root{
    --azul:#1a59a4;--laranja:#ff6a00;--ink:#202020;--muted:#6b7280;--line:#e6e9ef;--paper:#fff;--tint:rgba(26,89,164,.05);
    --amarelo:#ffd54a;--verde:#1a7f37;--vermelho:#c62828;--ico-gap:4px
  }
  *{box-sizing:border-box}
  body{margin:0;background:#f7f9fc;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink)}
  #app{max-width:1000px;margin:24px auto;padding:16px;background:var(--paper);border:1px solid var(--line);border-radius:12px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff}
  header .title{font-weight:800;color:var(--azul)}
  header .meta{display:flex;gap:16px;color:#3b4a5a;font-size:13px}
  header .meta span[contenteditable]{border-bottom:1px dashed #b9c3cf;min-width:60px;display:inline-block;padding:0 2px}

  section{border:1px solid var(--line);border-radius:10px;padding:14px;margin:12px 0;background:#fff}
  section.summary{background:var(--tint);border-color:rgba(26,89,164,.25)}
  h2{margin:0 0 10px;font-size:16px;color:var(--azul);border-left:4px solid var(--laranja);padding-left:8px}
  label{display:block;margin:8px 0 6px;color:var(--muted);font-weight:600}
  .help{color:var(--muted);font-size:12px;margin:6px 0}
  .field{margin-bottom:10px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:768px){.grid-2{grid-template-columns:1fr}}
  input,textarea,select{width:100%;padding:12px;border:2px solid rgba(26,89,164,.35);border-radius:10px;outline:0;background:#fff;transition:border-color .15s ease,box-shadow .15s ease}
  textarea{min-height:120px;resize:vertical}
  input::placeholder,textarea::placeholder{color:#98a6b5}
  input:hover,textarea:hover,select:hover{border-color:var(--laranja);box-shadow:0 0 0 2px rgba(255,106,0,.15)}
  input:focus,textarea:focus,select:focus{border-color:var(--azul);box-shadow:0 0 0 3px rgba(26,89,164,.15)}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:var(--laranja);box-shadow:0 0 0 2px rgba(255,106,0,.12)}
  .btn.primary{background:var(--azul);color:#fff;border-color:var(--azul)}
  .btn.primary:hover{box-shadow:0 0 0 3px rgba(26,89,164,.18)}
  .btn.warn{background:#fff4e5;border-color:#ffc074}
  .btn.success{background:#18a957;color:#fff;border-color:#0a8c45}
  .btn:disabled{opacity:.65;cursor:not-allowed}

  /* === TABELA === */
  .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;border:1px solid var(--line);border-radius:10px}
  table{width:100%;min-width:640px;border-collapse:separate;border-spacing:0;font-size:12px;table-layout:auto}
  th,td{padding:4px 6px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle;background:#fff}
  tbody td{border-bottom:1px solid #f1f5fb} /* linhas mais suaves entre convidados */
  thead th{background:#f7f9fc;color:#3b4a5a;font-weight:700;position:sticky;top:0;z-index:2;white-space:nowrap;box-shadow:0 1px 0 var(--line)}
  tbody tr:last-child td{border-bottom:none}
  td.qty,th.qty,td.confirmados,th.confirmados{text-align:center}
  td.phone{white-space:normal;overflow-wrap:anywhere;word-break:break-word}
  td.scol,th.scol{text-align:center}
  tr.has-sub td{border-bottom:0}
  tr.subrow td{font-size:12px;color:var(--muted);padding:0 8px 6px;background:transparent;position:relative;top:-6px;border-bottom:1px solid #f1f5fb}
  .status-ico{font-weight:700;margin-right:3px;font-size:.9em;vertical-align:middle}
  .badge-intl{display:inline-block;font-size:12px;line-height:1;border:1px solid rgba(26,89,164,.25);color:var(--azul);background:var(--tint);padding:1px 4px;border-radius:999px;margin-left:4px;white-space:nowrap}
  .badge-status{display:inline-block;font-size:10px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);margin-left:6px;white-space:nowrap;line-height:1;text-align:center}
  .s-nao{background:var(--amarelo);color:#5b4a00;border-color:#e6c33d}
  .s-env{background:rgba(26,89,164,.08);color:#1a59a4;border-color:rgba(26,89,164,.35)}
  .s-resp{background:rgba(26,155,84,.12);color:var(--verde);border-color:rgba(26,155,84,.35)}
  .muted{color:var(--muted)}
  .ok{color:var(--verde)}
  .bad{color:var(--vermelho)}
  td.actions{display:flex;gap:4px;align-items:center;white-space:nowrap}
  th.actions{white-space:nowrap}
  .icon-btn{background:#fff;border:1px solid var(--line);border-radius:6px;padding:2px 6px;font-size:12px;line-height:1;cursor:pointer;flex:0 0 auto}
  .icon-btn:hover{border-color:var(--laranja);box-shadow:0 0 0 2px rgba(255,106,0,.12)}

  /* Dropdown simples */
  .dropdown{position:relative;display:inline-block}
  .menu{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:6px;z-index:20;min-width:220px}
  .menu button{width:100%;text-align:left;margin:2px 0}

  /* === CARDS DE INDICADORES === */
  .totals-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0}
  .totals-card{border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff;min-height:100px}
  .totals-card h3{margin:0 0 8px;font-size:14px;color:var(--azul)}
  .totals-list{display:flex;flex-direction:column;gap:6px}
  .totals-item{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .totals-item .label{color:#3b4a5a}
  .totals-item .value{font-weight:800;min-width:36px;text-align:right}
  .meter{width:100%;height:6px;background:#eef2f7;border-radius:999px;overflow:hidden}
  .meter>span{display:block;height:100%;width:0}
  .bar-nao{background:#ffcc33}
  .bar-env{background:#1a59a4}
  .bar-resp{background:#1a7f37}
  .bar-gconf{background:#1a7f37}
  .bar-gpend{background:#7b8a99}
  .bar-gnao{background:#c62828}
  .bar-tinv{background:#1a59a4}
  .bar-tguests{background:#7b8a99}
  .bar-tconf{background:#1a7f37}

  .footer-actions{display:flex;flex-wrap:wrap;justify-content:flex-end;gap:8px;margin-top:12px}

  /* Responsividade: mobile */
  @media (max-width:480px){
    body{font-size:13px}
    table{font-size:11px}
    .btn{padding:10px}
    .footer-actions{justify-content:stretch}
    .footer-actions .btn{flex:1 1 calc(50% - 8px)}
    .menu{left:0;right:0;min-width:unset}
  }

  /* impressão */
  .confirmados-print{display:none}
  @media print{
    @page{size:A4;margin:12mm}
    *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .btn,.help,.descr,.import-wrap,.dropdown .menu{display:none!important}
    section:not(.summary):not(.export){display:none!important}
    body{background:#fff}
    #app{border:0;max-width:100%}
    h2{page-break-after:avoid}
    .totals-card{page-break-inside:avoid}
    .table-wrap{border:0;overflow:visible}
    /* Suavização do grid no PDF: apenas linhas horizontais leves */
    table{border-collapse:separate;border-spacing:0;min-width:0;table-layout:auto;font-size:12px;width:100%}
    th,td{border:0;padding:4px 6px;max-width:none}
    thead{display:table-header-group}
    thead th{background:#fff;border-bottom:1px solid #dfe7f3}
    tbody td{border-bottom:1px solid #edf2f9}
    tbody tr:last-child td{border-bottom:0}
    tbody tr{page-break-inside:avoid}
    tr.subrow td{top:0;border-top:0;padding-top:0;border-bottom:1px solid #edf2f9}
    .confirmados-screen{display:none}
    .confirmados-print{display:inline}
    /* Ajuste de tamanho e leveza dos badges no PDF */
    .badge-status{font-size:10px;padding:1px 6px;border-radius:999px;border-color:#e9eef6}
    .badge-intl{font-size:10px;padding:1px 4px;border-color:#e9eef6}
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="title">5 Horas P&amp;A — Lista de Convidados</div>
    <div class="meta">
      <div>Revisão: <span id="rev-tag" contenteditable>2.2.2</span></div>
      <div>Doc: <span id="doc-id" contenteditable>0011</span></div>
    </div>
  </header>

  <section aria-label="Dados do evento">
    <h2>Evento</h2>
    <p class="help">Preencha com o que você já tem. Você pode voltar e ajustar a qualquer momento.</p>
    <div class="grid-2">
      <div class="field"><label for="ev-name">Nome do evento</label><input id="ev-name" type="text" placeholder="Ex.: Aniversário da Marina"></div>
      <div class="field"><label for="ev-dt">Data e horário</label><input id="ev-dt" type="datetime-local" step="60"></div>
      <div class="field"><label for="ev-venue">Espaço/Local</label><input id="ev-venue" type="text" placeholder="Ex.: Espaço Jardim das Águas"></div>
      <div class="field"><label for="ev-address">Endereço</label><input id="ev-address" type="text" placeholder="Rua Exemplo, 123 – Bairro – Cidade/UF"></div>
      <div class="field"><label for="ev-ref">Ponto de referência</label><input id="ev-ref" type="text" placeholder="Ao lado do parque municipal"></div>
      <div class="field"><label for="ev-type">Tipo do evento</label><input id="ev-type" type="text" placeholder="Ex.: Corporativo, Casamento, Social…"></div>
      <div class="field"><label for="ev-dress">Traje</label><input id="ev-dress" type="text" placeholder="Esporte fino, gala, casual…"></div>
      <div class="field"><label for="ev-org">Organizador</label><input id="ev-org" type="text" placeholder="Nome do responsável / cerimonial"></div>
    </div>
  </section>

  <section aria-label="Convidados">
    <h2>Convidados</h2>
    <div class="field">
      <label for="cv-raw">Lista de convites</label>
      <p class="help">Cole ou digite um convidado por linha. Se houver acompanhantes, separe por vírgula. Ex.: “João da Silva, 41 99999-9999, Maria Silva”. Para contatos de fora do Brasil, comece com “+”.</p>
      <textarea id="cv-raw" placeholder="Exemplo BR — João da Silva, 41 99999-9999, Maria Silva
Exemplo INTL — +1 415 555 1234, Ana Souza"></textarea>
    </div>
    <div class="row">
      <button id="cv-add" type="button" class="btn primary" title="Adicionar os nomes acima na lista">Adicionar à lista</button>
      <span class="muted" id="cv-feedback"></span>
    </div>
  </section>

  <section class="summary export" aria-label="Resumo e indicadores">
    <h2>Resumo</h2>
    <p class="help">Um retrato do seu evento — atualiza automaticamente conforme você preenche.</p>
    <div class="summary-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:10px">
      <div><p><strong>Nome:</strong> <span id="s-name"></span></p><p><strong>Data:</strong> <span id="s-date"></span></p><p><strong>Horário:</strong> <span id="s-time"></span></p></div>
      <div><p><strong>Espaço:</strong> <span id="s-venue"></span></p><p><strong>Endereço:</strong> <span id="s-address"></span></p><p><strong>Referência:</strong> <span id="s-ref"></span></p></div>
      <div><p><strong>Tipo:</strong> <span id="s-type"></span></p><p><strong>Traje:</strong> <span id="s-dress"></span></p><p><strong>Organizador:</strong> <span id="s-org"></span></p></div>
    </div>

    <h2 style="margin-top:6px">Indicadores</h2>
    <div id="report-totals" class="totals-grid">
      <div class="totals-card" id="totals-left">
        <h3>Totais</h3>
        <div class="totals-list">
          <div class="totals-item"><span class="label">Convites</span><span class="value" id="t-convites">0</span></div>
          <div class="meter" aria-hidden="true"><span id="t-convites-bar" class="bar-tinv"></span></div>
          <div class="totals-item"><span class="label">Convidados</span><span class="value" id="t-convidados">0</span></div>
          <div class="meter" aria-hidden="true"><span id="t-convidados-bar" class="bar-tguests"></span></div>
          <div class="totals-item"><span class="label">Confirmados</span><span class="value" id="t-confirmados">0</span></div>
          <div class="meter" aria-hidden="true"><span id="t-confirmados-bar" class="bar-tconf"></span></div>
        </div>
      </div>
      <div class="totals-card" id="totals-mid">
        <h3>Status dos convites</h3>
        <div class="totals-list">
          <div class="totals-item"><span class="label">% Não iniciados</span><span class="value" id="p-nao">0%</span></div>
          <div class="meter" aria-hidden="true"><span class="bar-nao" id="p-nao-bar"></span></div>
          <div class="totals-item"><span class="label">% Enviados</span><span class="value" id="p-env">0%</span></div>
          <div class="meter" aria-hidden="true"><span class="bar-env" id="p-env-bar"></span></div>
          <div class="totals-item"><span class="label">% Respondidos</span><span class="value" id="p-resp">0%</span></div>
          <div class="meter" aria-hidden="true"><span class="bar-resp" id="p-resp-bar"></span></div>
        </div>
      </div>
      <div class="totals-card" id="totals-right">
        <h3>Status dos convidados</h3>
        <div class="totals-list">
          <div class="totals-item"><span class="label">% Confirmados</span><span class="value" id="pg-conf">0%</span></div>
          <div class="meter" aria-hidden="true"><span class="bar-gconf" id="pg-conf-bar"></span></div>
          <div class="totals-item"><span class="label">% Pendentes</span><span class="value" id="pg-pend">0%</span></div>
          <div class="meter" aria-hidden="true"><span class="bar-gpend" id="pg-pend-bar"></span></div>
          <div class="totals-item"><span class="label">% Não irão</span><span class="value" id="pg-nao">0%</span></div>
          <div class="meter" aria-hidden="true"><span class="bar-gnao" id="pg-nao-bar"></span></div>
        </div>
      </div>
    </div>
  </section>

  <section class="export export-list" aria-label="Lista para exportação e impressão">
    <h2>Lista de convidados</h2>
    <p class="descr">Aqui você visualiza sua lista pronta para operação e impressão. Use a edição rápida quando precisar ajustar nomes, telefones ou status. Tudo foi pensado para leitura clara na tela e uma impressão limpa.</p>
    <div id="cv-list" class="field"></div>
  </section>

  <div class="footer-actions">
    <button id="btn-import" type="button" class="btn" title="Carregue um arquivo salvo anteriormente">Importar JSON</button>
    <div class="import-wrap" style="display:none"><input id="file-input" type="file" accept="application/json"></div>
    <button id="btn-export" type="button" class="btn" title="Baixe um arquivo com os dados atuais">Exportar JSON</button>
    <button id="btn-quote"  type="button" class="btn warn" title="Enviar uma solicitação de cotação">Pedir cotação</button>
    <div class="dropdown">
      <button id="btn-clear"  type="button" class="btn" aria-haspopup="true" aria-expanded="false" title="Limpar dados">Limpar ▾</button>
      <div id="clear-menu" class="menu" hidden>
        <button id="clear-guests" class="btn" type="button">Limpar convidados</button>
        <button id="clear-event"  class="btn" type="button">Limpar dados do evento</button>
      </div>
    </div>
    <button id="btn-pdf"    type="button" class="btn" title="Imprimir ou salvar como PDF">Imprimir / PDF</button>
  </div>
</div>

<script>
(()=>{
  const WEBHOOK_COTACAO  = "https://hook.eu2.make.com/mnn3jwccg6jalg5myld2oe8oqs8ea71b";
  const $=(sel, root=document)=> root.querySelector(sel);
  const $$=(sel, root=document)=> Array.from(root.querySelectorAll(sel));

  function init(){
    const root = $('#app'); if(!root) return;
    const nameEl=$('#ev-name'), dtEl=$('#ev-dt'), venueEl=$('#ev-venue'), addrEl=$('#ev-address'), refEl=$('#ev-ref'), typeEl=$('#ev-type'), dressEl=$('#ev-dress'), orgEl=$('#ev-org');
    const sName=$('#s-name'), sDate=$('#s-date'), sTime=$('#s-time'), sVenue=$('#s-venue'), sAddress=$('#s-address'), sRef=$('#s-ref'), sType=$('#s-type'), sDress=$('#s-dress'), sOrg=$('#s-org');
    const cvRaw=$('#cv-raw'), cvList=$('#cv-list'), cvAdd=$('#cv-add'), cvFeedback=$('#cv-feedback');
    const btnPdf=$('#btn-pdf'), btnClear=$('#btn-clear'), btnExport=$('#btn-export'), btnImport=$('#btn-import'), fileInput=$('#file-input'), btnQuote=$('#btn-quote');
    const clearMenu=$('#clear-menu');
    const tConvites=$('#t-convites'), tConvidados=$('#t-convidados'), tConfirmados=$('#t-confirmados');
    const pNao=$('#p-nao'), pEnv=$('#p-env'), pResp=$('#p-resp');
    const pgConf=$('#pg-conf'), pgPend=$('#pg-pend'), pgNao=$('#pg-nao');
    const bars={ tConvites:$('#t-convites-bar'), tConvidados:$('#t-convidados-bar'), tConfirmados:$('#t-confirmados-bar'), pNao:$('#p-nao-bar'), pEnv:$('#p-env-bar'), pResp:$('#p-resp-bar'), pgConf:$('#pg-conf-bar'), pgPend:$('#pg-pend-bar'), pgNao:$('#pg-nao-bar') };

    const STATUS=[{key:'nao',label:'Não iniciado',cls:'s-nao'},{key:'env',label:'Enviado',cls:'s-env'},{key:'resp',label:'Respondido',cls:'s-resp'}];
    const state={invites:[],seq:1};

    const formatDateTime=(val)=>{ if(!val) return {d:'',t:''}; const [date,time]=val.split('T'); const p=date?date.split('-'):[]; const d=(p.length===3)? `${p[2]}/${p[1]}/${p[0]}` : ''; const t=(time||'').slice(0,5); return {d,t}; };
    const titleCase=s=>{ if(!s) return ''; const words=s.toLowerCase().split(' ').filter(w=>w!==''); const preps={da:1,de:1,do:1,das:1,dos:1,e:1,di:1,du:1}; return words.map((w,i)=> (i>0 && preps[w])? w : w.charAt(0).toUpperCase()+w.slice(1)).join(' '); };

    const padronizaBR=digits=>{ if(!digits) return null; if(digits.slice(0,2)==='55') return null; if(digits.length!==10 && digits.length!==11) return null; const ddd=digits.slice(0,2), sub0=digits.slice(2); const sub=(sub0.length===8 && /^[6-9]/.test(sub0.charAt(0)))? '9'+sub0 : sub0; return ddd+sub; };
    const normalizeIntlE164=raw=>{ if(!raw) return null; const d=String(raw).replace(/\D+/g,''); if(d.length<8||d.length>15) return null; return '+'+d; };
    const isLikelyPhone=part=>{ const digits=String(part||'').replace(/\D+/g,''); return digits.length>=8 || /^\+\d{1,15}$/.test(String(part||'')); };

    const extractPhoneName=parts=>{ let phoneIdx=-1; for(let i=0;i<parts.length;i++){ if(isLikelyPhone(parts[i])){ phoneIdx=i; break; } } let nameIdx=-1; for(let j=0;j<parts.length;j++){ if(j===phoneIdx) continue; if(parts[j]){ nameIdx=j; break; } } const phoneRaw=phoneIdx>-1? parts[phoneIdx] : ''; const name=nameIdx>-1? titleCase(parts[nameIdx]):''; const acomp=[]; for(let k=0;k<parts.length;k++){ if(k!==phoneIdx && k!==nameIdx && parts[k]) acomp.push(titleCase(parts[k])); } return {phoneRaw,name,acomp}; };

    function validateInvite(it){
      const issues=[]; let intl=false; let normalized=null; const raw=String(it.phone||'').trim();
      const preferIntl=(typeof it.manualIntl==="boolean")? it.manualIntl : null;
      if(preferIntl===true){
        if(!/^\+/.test(raw)) { issues.push('telefone internacional deve iniciar com +'); }
        else { const digits=raw.replace(/\D+/g,''); if(digits.slice(0,2)==='55'){ issues.push('número brasileiro não deve usar +55'); } else { normalized=normalizeIntlE164(raw); if(!normalized) issues.push('telefone internacional inválido'); else intl=true; } }
      } else if(preferIntl===false){
        if(/^\+/.test(raw)) { issues.push('número brasileiro não deve iniciar com +'); }
        else { const digitsOnly=raw.replace(/\D+/g,''); if(digitsOnly.slice(0,2)==='55' && (digitsOnly.length===12 || digitsOnly.length===13)){ issues.push('número brasileiro não deve usar código 55'); } else { normalized=padronizaBR(digitsOnly); if(!normalized) issues.push('formato BR inválido'); } }
      } else {
        if(/^\+/.test(raw)){
          const d=raw.replace(/\D+/g,''); if(d.slice(0,2)==='55'){ issues.push('número brasileiro não deve usar +55'); }
          else { normalized=normalizeIntlE164(raw); if(!normalized) issues.push('telefone internacional inválido'); else intl=true; }
        } else {
          const digitsOnly2=raw.replace(/\D+/g,''); if(digitsOnly2.slice(0,2)==='55' && (digitsOnly2.length===12 || digitsOnly2.length===13)){ issues.push('número brasileiro não deve usar código 55'); }
          else { normalized=padronizaBR(digitsOnly2); if(!normalized) issues.push('formato BR inválido'); }
        }
      }
      if(issues.length===0){ it.phone = normalized; it.intl=intl; } else { it.intl=intl; }
      if(!it.name || !String(it.name).trim()) issues.push('sem nome');
      it.validPhone = issues.length===0;
      it.issues = issues;
      if(typeof it.qty!=="number" || !(it.qty>0)) it.qty = 1 + (it.acomp? it.acomp.length : 0);
      if(!it.status){ it.status='nao'; }
      return it;
    }

    const parseLines=raw=>{ if(!raw) return {items:[],bad:0}; const lines=raw.split(/\r?\n/); const out=[]; let bad=0; for(let i=0;i<lines.length;i++){ const t=lines[i].trim(); if(!t) continue; const parts=t.split(',').map(p=>p.trim()).filter(x=>x!=='\"' && x!==''); const ex=extractPhoneName(parts); const item={id:0, phone:ex.phoneRaw, name:ex.name, acomp:ex.acomp, intl:false, manualIntl:null, validPhone:false, issues:[], confirmed:0, qty:0, status:'nao'}; out.push(item); const tmp=JSON.parse(JSON.stringify(item)); validateInvite(tmp); if(!tmp.validPhone) bad++; } return {items:out,bad}; };

    const sumGuests=list=> list.reduce((tot,it)=> tot + ((typeof it.qty==="number"&&it.qty>0)? it.qty : (1+(it.acomp?it.acomp.length:0))), 0);
    const sumConfirmed=list=> list.reduce((n,it)=>{ let v=parseInt(it.confirmed,10); const cap=(typeof it.qty==="number"&&it.qty>0)?it.qty:(1+(it.acomp?it.acomp.length:0)); if(isNaN(v)) v=0; return n + Math.max(0, Math.min(v, cap)); }, 0);
    const sumGuestsWhere=(list,pred)=> list.reduce((tot,it)=> pred(it)? tot + ((typeof it.qty==="number"&&it.qty>0)? it.qty : (1+(it.acomp?it.acomp.length:0))) : tot, 0);

    const statusLabel=key=>{ const f=STATUS.find(s=>s.key===key); return f? f.label : key; };
    const statusClass=key=>{ const f=STATUS.find(s=>s.key===key); return f? f.cls : 's-nao'; };

    const calcInvitePercents=list=>{ const n=list.length||0; const counts={nao:0,env:0,resp:0}; list.forEach(it=>{ const k=it.status||'nao'; counts[k]=(counts[k]||0)+1; }); const pct=x=> n? Math.round((x/n)*100) : 0; return {nao:pct(counts.nao||0), env:pct(counts.env||0), resp:pct(counts.resp||0)}; };
    const calcGuestPercents=list=>{ const total=sumGuests(list); if(!total) return {conf:0, pend:0, nao:0}; const confirmed=sumConfirmed(list); let nao=0; list.forEach(it=>{ const cap=(typeof it.qty==="number"&&it.qty>0)?it.qty:(1+(it.acomp?it.acomp.length:0)); const conf=Math.max(0, Math.min(parseInt(it.confirmed||0,10)||0, cap)); if(it.status==='resp'){ nao += Math.max(0, cap - conf); } }); const pend=Math.max(total - confirmed - nao, 0); const pct=x=> Math.round((x/total)*100); return {conf:pct(confirmed), pend:pct(pend), nao:pct(nao)}; };

    const updateMeters=values=>{
      if(bars.pNao) bars.pNao.style.width = (values.perInv.nao||0)+'%';
      if(bars.pEnv) bars.pEnv.style.width = (values.perInv.env||0)+'%';
      if(bars.pResp) bars.pResp.style.width = (values.perInv.resp||0)+'%';
      if(bars.pgConf) bars.pgConf.style.width = (values.perGuest.conf||0)+'%';
      if(bars.pgPend) bars.pgPend.style.width = (values.perGuest.pend||0)+'%';
      if(bars.pgNao) bars.pgNao.style.width = (values.perGuest.nao||0)+'%';
      const invBase = Math.max(values.counts.totalInvites,1);
      const guestBase = Math.max(values.counts.totalGuests,1);
      if(bars.tConvites) bars.tConvites.style.width = Math.round(values.counts.sentInvites/invBase*100)+'%';
      if(bars.tConvidados) bars.tConvidados.style.width = Math.round(values.counts.guestsWithInvite/guestBase*100)+'%';
      if(bars.tConfirmados) bars.tConfirmados.style.width = Math.round(values.counts.confirmados/guestBase*100)+'%';
    };

    const updateTotals=()=>{
      const totalInvites=state.invites.length;
      const totalGuests=sumGuests(state.invites);
      const sentInvites=state.invites.filter(it=>it.status!=='nao').length;
      const guestsWithInvite=sumGuestsWhere(state.invites, it=>it.status!=='nao');
      const confirmados=sumConfirmed(state.invites);
      const perInv=calcInvitePercents(state.invites);
      const perGuest=calcGuestPercents(state.invites);
      if(tConvites) tConvites.textContent = `${sentInvites} / ${totalInvites}`;
      if(tConvidados) tConvidados.textContent = `${guestsWithInvite} / ${totalGuests}`;
      if(tConfirmados) tConfirmados.textContent = `${confirmados} / ${totalGuests}`;
      if(pNao) pNao.textContent=perInv.nao+'%';
      if(pEnv) pEnv.textContent=perInv.env+'%';
      if(pResp) pResp.textContent=perInv.resp+'%';
      if(pgConf) pgConf.textContent=perGuest.conf+'%';
      if(pgPend) pgPend.textContent=perGuest.pend+'%';
      if(pgNao) pgNao.textContent=perGuest.nao+'%';
      updateMeters({ perInv, perGuest, counts:{ totalInvites, totalGuests, sentInvites, guestsWithInvite, confirmados } });
    };

    const updateSummary=()=>{
      const dtfmt=formatDateTime(dtEl && dtEl.value || '');
      sName.textContent=(nameEl && nameEl.value)||'';
      sDate.textContent=dtfmt.d; sTime.textContent=dtfmt.t;
      sVenue.textContent=(venueEl&&venueEl.value)||'';
      sAddress.textContent=(addrEl&&addrEl.value)||'';
      sRef.textContent=(refEl&&refEl.value)||'';
      sType.textContent=(typeEl&&typeEl.value)||'';
      sDress.textContent=(dressEl&&dressEl.value)||'';
      sOrg.textContent=(orgEl&&orgEl.value)||'';
      updateTotals();
    };

    function renderTable(){
      if(!cvList) return;
      if(state.invites.length===0){
        cvList.innerHTML='<p class="muted">Nenhum convite adicionado ainda.</p>';
        updateTotals();
        return;
      }
      let rows='';
      for(let i=0;i<state.invites.length;i++){
        const it=state.invites[i];
        const num=i+1;
        const acomp=(it.acomp&&it.acomp.length)?it.acomp.join(', '):'—';
        const qtd=(typeof it.qty==="number"&&it.qty>0)? it.qty : (1+(it.acomp?it.acomp.length:0));
        const confVal=(it.confirmed===0)?'0':(it.confirmed||'');
        const confPrint=(confVal!==''? String(confVal) : '<span class="fill-line" style="min-width:60px"></span>');
        const hasSub=(it.issues&&it.issues.length);
        rows += `
          <tr data-id="${it.id}"${hasSub?' class="has-sub"':''}>
            <td class="muted">${num}</td>
            <td class="phone">${hasSub?'<span class="status-ico bad">✖</span>':'<span class="status-ico ok">✓</span>'}${it.phone?it.phone:''}${it.intl?'<span class="badge-intl">INTL</span>':''}</td>
            <td>${it.name||'—'}</td>
            <td>${acomp}</td>
            <td class="qty">${qtd}</td>
            <td class="confirmados"><span class="confirmados-screen">${confVal!==''? String(confVal) : '—'}</span><span class="confirmados-print">${confPrint}</span></td>
            <td class="scol"><span class="badge-status ${statusClass(it.status)}">${statusLabel(it.status)}</span></td>
            <td class="actions">
              <button type="button" class="icon-btn edit" title="Editar">✏️</button>
              <button type="button" class="icon-btn del" title="Excluir">🗑️</button>
            </td>
          </tr>
          ${hasSub?`<tr class="subrow" data-id="${it.id}"><td colspan="8">${it.issues.join('; ')}</td></tr>`:''}
        `;
      }
      cvList.innerHTML=`<div class="table-wrap"><table><thead><tr><th>#</th><th>Telefone</th><th>Nome</th><th>Acompanhantes</th><th class="qty">Qtd.</th><th class="confirmados">Conf.</th><th class="scol">Situação</th><th class="actions">Ações</th></tr></thead><tbody>${rows}</tbody></table></div>`;
      bindRowActions();
      updateTotals();
    }

    function beginRowEdit(tr,id){
      const it=state.invites.find(x=>x.id===id); if(!it) return;
      const origAcompLen=(it.acomp&&it.acomp.length)?it.acomp.length:0;
      const origQty=(typeof it.qty==="number"&&it.qty>0)? it.qty : (1+(it.acomp?it.acomp.length:0));
      const acompStr=(it.acomp&&it.acomp.length)?it.acomp.join(', '):'';
      const qtd=origQty;
      tr.classList.add('row-edit');
      const statusOpts=STATUS.map(s=> `<option value="${s.key}" ${it.status===s.key?'selected':''}>${s.label}</option>`).join('');
      tr.innerHTML=
        `<td class="muted">${(state.invites.indexOf(it)+1)}</td>`+
        `<td><div><input type="text" class="inp-phone" value="${it.phone||''}">`+
        `<label style="display:inline-flex;align-items:center;gap:6px;margin-top:6px"><input type="checkbox" class="inp-intl" ${it.intl?'checked':''}> Internacional (+CC)</label></div></td>`+
        `<td><input type="text" class="inp-name" value="${it.name||''}"></td>`+
        `<td><input type="text" class="inp-acomp" value="${acompStr}"></td>`+
        `<td class="qty"><input type="number" class="inp-qty" min="1" value="${qtd}"></td>`+
        `<td class="confirmados"><input type="number" class="inp-conf" min="0" value="${it.confirmed||0}"></td>`+
        `<td class="scol"><select class="inp-status">${statusOpts}</select></td>`+
        `<td class="actions">
          <button type="button" class="icon-btn save" title="Salvar">✔️</button>
          <button type="button" class="icon-btn cancel" title="Cancelar">↩️</button>
        </td>`;
      tr.querySelector('.save').addEventListener('click',()=>{
        const phone=tr.querySelector('.inp-phone').value;
        const intl=tr.querySelector('.inp-intl').checked;
        const name=tr.querySelector('.inp-name').value;
        const acompRaw=tr.querySelector('.inp-acomp').value;
        const ac=acompRaw? acompRaw.split(',').map(s=>titleCase(s.trim())).filter(Boolean):[];
        const qtyInputVal=tr.querySelector('.inp-qty').value;
        const qty=parseInt(qtyInputVal,10);
        const conf=parseInt(tr.querySelector('.inp-conf').value,10);
        const status=tr.querySelector('.inp-status').value;
        it.phone=phone; it.name=titleCase(name); it.acomp=ac; const defQty=1 + ac.length; if(isNaN(qty) || qty<=0){ it.qty=defQty; } else if(qtyInputVal==String(origQty) && ac.length!==origAcompLen){ it.qty=defQty; } else { it.qty=qty; }
        it.confirmed=isNaN(conf)? 0 : conf; it.manualIntl = intl ? true : false; it.intl=!!intl; it.status=status; validateInvite(it); renderTable(); updateSummary();
      });
      tr.querySelector('.cancel').addEventListener('click',()=>{ renderTable(); });
    }

    function bindRowActions(){
      if(!cvList) return;
      cvList.querySelectorAll('button.edit').forEach(btn=>{
        btn.addEventListener('click',()=>{ const tr=btn.closest('tr'); const id=parseInt(tr.getAttribute('data-id'),10); beginRowEdit(tr,id); });
      });
      cvList.querySelectorAll('button.del').forEach(btn=>{
        btn.addEventListener('click',()=>{ const tr=btn.closest('tr'); const id=parseInt(tr.getAttribute('data-id'),10); state.invites=state.invites.filter(x=>x.id!==id); renderTable(); updateSummary(); });
      });
    }

    if(btnPdf){ btnPdf.addEventListener('click', ()=> {
      const oldTitle=document.title;
      const pdfBase=arquivoBase();
      document.title = pdfBase;
      window.print();
      setTimeout(()=>{ document.title=oldTitle; }, 600);
    }); }

    if(btnClear){
      btnClear.addEventListener('click', ()=>{
        const open = !clearMenu.hasAttribute('hidden');
        if(open){ clearMenu.setAttribute('hidden',''); btnClear.setAttribute('aria-expanded','false'); }
        else { clearMenu.removeAttribute('hidden'); btnClear.setAttribute('aria-expanded','true'); }
      });
      document.addEventListener('click', (e)=>{
        if(!clearMenu.contains(e.target) && e.target!==btnClear){
          if(!clearMenu.hasAttribute('hidden')){ clearMenu.setAttribute('hidden',''); btnClear.setAttribute('aria-expanded','false'); }
        }
      });
    }

    const doClearGuests=()=>{
      if(confirm('Limpar a lista de convidados? Os dados do evento serão mantidos.')){
        state.invites=[]; renderTable(); updateSummary(); if(cvRaw) cvRaw.value=''; if(cvFeedback) {cvFeedback.textContent='Lista limpa.'; setTimeout(()=> cvFeedback.textContent='',1500);} }
    };
    const doClearEvent=()=>{
      if(confirm('Limpar os dados do evento? A lista de convidados será mantida.')){
        [nameEl,dtEl,venueEl,addrEl,refEl,typeEl,dressEl,orgEl].forEach(el=>{ if(el){ el.value=''; }});
        updateSummary();
      }
    };
    $('#clear-guests')?.addEventListener('click', ()=>{ doClearGuests(); clearMenu.setAttribute('hidden',''); btnClear.setAttribute('aria-expanded','false'); });
    $('#clear-event')?.addEventListener('click', ()=>{ doClearEvent(); clearMenu.setAttribute('hidden',''); btnClear.setAttribute('aria-expanded','false'); });

    if(cvAdd){ cvAdd.addEventListener('click',()=>{
      const res=parseLines(cvRaw?cvRaw.value:'');
      if(res.items.length){
        for(let i=0;i<res.items.length;i++){ const it=res.items[i]; it.id=state.seq++; validateInvite(it); }
        state.invites=state.invites.concat(res.items);
        renderTable();
        if(cvFeedback) cvFeedback.textContent=res.items.length+' convite(s) adicionados.';
        if(cvRaw){cvRaw.value='';}
      } else {
        if(cvFeedback) cvFeedback.textContent='Nada para adicionar.';
      }
      updateSummary();
      setTimeout(()=>{ if(cvFeedback) cvFeedback.textContent=''; },2000);
    }); }

    ['input','change'].forEach(evt=>{ [nameEl,dtEl,venueEl,addrEl,refEl,typeEl,dressEl,orgEl].forEach(el=> el && el.addEventListener(evt,updateSummary)); });

    function getState(){
      const data={
        meta:{ rev:($('#rev-tag')?.textContent||'').trim(), docId:($('#doc-id')?.textContent||'').trim(), exportAt:new Date().toISOString() },
        evento:{ nome:nameEl?.value||'', dt:dtEl?.value||'', local:venueEl?.value||'', endereco:addrEl?.value||'', referencia:refEl?.value||'', tipo:typeEl?.value||'', traje:dressEl?.value||'', organizador:orgEl?.value||'' },
        invites: state.invites
      };
      try{ localStorage.setItem('assistenteCerimonial_draft', JSON.stringify(data)); }catch(e){}
      return data;
    }

    function setState(data){
      if(!data) return;
      const ev=data.evento||{};
      if(nameEl) nameEl.value = ev.nome||'';
      if(dtEl) dtEl.value = ev.dt||'';
      if(venueEl) venueEl.value = ev.local||'';
      if(addrEl) addrEl.value = ev.endereco||'';
      if(refEl) refEl.value = ev.referencia||'';
      if(typeEl) typeEl.value = ev.tipo||'';
      if(dressEl) dressEl.value = ev.traje||'';
      if(orgEl) orgEl.value = ev.organizador||'';
      state.invites = Array.isArray(data.invites)? data.invites.map((it,i)=>{ it.id = i+1; return validateInvite(it); }) : [];
      state.seq = state.invites.length + 1;
      renderTable(); updateSummary();
      try{ localStorage.setItem('assistenteCerimonial_draft', JSON.stringify(getState())); }catch(e){}
    }

    function sanitizeFilename(name){ return String(name||'').replace(/\s+/g,'_').replace(/[^\w\-\.]+/g,'_').slice(0,80); }
    function arquivoBase(){
      const nm=(nameEl?.value||'Evento').trim()||'Evento';
      const dt=(dtEl?.value||'');
      let dateLabel='sem-data';
      if(dt){ const [d,h]=dt.split('T'); const [Y,M,D]=d.split('-'); dateLabel=`${D}-${M}-${Y}`; }
      const doc=($('#doc-id')?.textContent||'').trim()||'0000';
      return sanitizeFilename(`${nm}__${dateLabel}__Doc-${doc}`);
    }
    function arquivoSugestivo(){ return arquivoBase()+'.json'; }

    function downloadJSON(obj, filename='evento.json'){
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
      return blob;
    }

    if(btnExport){ btnExport.addEventListener('click', ()=>{ const data=getState(); let suggested=arquivoSugestivo(); const chosen=prompt('Salvar como:', suggested); const fname=sanitizeFilename(chosen||suggested); downloadJSON(data, fname.endsWith('.json')? fname : (fname+'.json')); }); }
    if(btnImport){ btnImport.addEventListener('click', ()=> fileInput?.click()); }
    if(fileInput){ fileInput.addEventListener('change', ev=>{ const f=ev.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=e=>{ try{ const data=JSON.parse(e.target.result); if(confirm('Importar arquivo e substituir o evento atual?')){ setState(data); alert('Evento importado com sucesso.'); } }catch(err){ alert('Arquivo JSON inválido.'); } }; reader.readAsText(f); }); }

    const QUOTE_LOCK_SECONDS=60;
    function shortId(){ try{ return crypto.randomUUID().split('-')[0]; }catch(e){ return Math.random().toString(36).slice(2,10); } }
    function getLockRemaining(){ const until=parseInt(localStorage.getItem('quoteLockUntil')||'0',10)||0; const now=Date.now(); return Math.max(0, Math.floor((until-now)/1000)); }
    function setLock(seconds){ const until=Date.now()+seconds*1000; localStorage.setItem('quoteLockUntil', String(until)); }

    function applyQuoteLockUI(){ const rem=getLockRemaining(); if(!btnQuote) return; if(rem>0){ btnQuote.disabled=true; btnQuote.classList.add('success'); btnQuote.textContent=`Cotação enviada (aguarde ${rem}s)`; let t=rem; const timer=setInterval(()=>{ t--; if(t<=0){ clearInterval(timer); btnQuote.disabled=false; btnQuote.classList.remove('success'); btnQuote.textContent='Pedir cotação'; } else { btnQuote.textContent=`Cotação enviada (aguarde ${t}s)`; } },1000); } }

    if(btnQuote){ applyQuoteLockUI(); btnQuote.addEventListener('click', ()=>{
      if(getLockRemaining()>0){ alert('Aguarde um minuto para reenviar a cotação.'); return; }
      const dados = getState();
      const totalConvites = Array.isArray(dados.invites) ? dados.invites.length : 0;
      const contato = coletaContato();
      if(!contato) return;

      const meta = {
        origin: 'assistente-cerimonial',
        appVersion: ($('#rev-tag')?.textContent||'').trim(),
        docId: ($('#doc-id')?.textContent||'').trim(),
        exportAt: dados?.meta?.exportAt || new Date().toISOString(),
        sentAt: new Date().toISOString(),
        requestId: shortId()
      };

      const payload = {
        filename: arquivoSugestivo(),
        mime: 'application/json',
        totalConvites,
        contato,
        meta,
        data: dados
      };
      postWebhook(payload);
      setLock(QUOTE_LOCK_SECONDS);
      btnQuote.classList.add('success');
      btnQuote.disabled=true;
      let t=QUOTE_LOCK_SECONDS;
      btnQuote.textContent=`Cotação enviada (aguarde ${t}s)`;
      const timer=setInterval(()=>{ t--; if(t<=0){ clearInterval(timer); btnQuote.disabled=false; btnQuote.classList.remove('success'); btnQuote.textContent='Pedir cotação'; } else { btnQuote.textContent=`Cotação enviada (aguarde ${t}s)`; } },1000);
      alert('Solicitação enviada via webhook. Em breve responderemos no WhatsApp informado.');
    }); }

    function coletaContato(){
      try{
        const last = JSON.parse(localStorage.getItem('assistenteCerimonial_contato')||'{}');
        const nome = prompt('Seu nome completo para contato:', last.nome||'');
        if(nome===null) return null;
        const tel = prompt('Seu WhatsApp/telefone com DDD:', last.telefone||'');
        if(tel===null) return null;
        const contato={ nome: (nome||'').trim(), telefone: (tel||'').trim(), telefone_digits: (tel||'').replace(/\D+/g,'') };
        localStorage.setItem('assistenteCerimonial_contato', JSON.stringify(contato));
        return contato;
      }catch(e){ return null; }
    }

    function postWebhook(payload){
      if(!WEBHOOK_COTACAO) { alert('Webhook não configurado.'); return; }
      try{
        fetch(WEBHOOK_COTACAO, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
          .catch(()=>{});
      }catch(e){ /* silencioso */ }
    }

    try{ const draft = localStorage.getItem('assistenteCerimonial_draft'); if(draft){ setState(JSON.parse(draft)); } }catch(e){}
    renderTable(); updateSummary();

    // ===== TESTES (console) =====
    ;(function runTests(){
      // Extração telefone/nome com ordem variada
      const partsA=['Joao da Silva','41 99999-9999'];
      const partsB=['41 99999-9999','Joao'];
      const exA=extractPhoneName(partsA);
      const exB=extractPhoneName(partsB);
      console.assert(exA.name.toLowerCase().includes('joao'), 'Nome deve ser capturado quando vier antes.');
      console.assert(/41/.test(exB.phoneRaw), 'Telefone deve ser capturado quando vier antes.');

      // Validações BR e INTL
      const okBR=validateInvite({phone:'41999999999',name:'Teste',acomp:[]});
      console.assert(okBR.validPhone && !okBR.intl, 'BR válido deve passar e não ser intl.');
      const okUS=validateInvite({phone:'+1 415 555 1234',name:'Ana',acomp:[]});
      console.assert(okUS.validPhone && okUS.intl, 'INTL com +CC deve ser intl.');

      // Erros esperados
      const bad55=validateInvite({phone:'55 41 999999999',name:'Fabio',acomp:[]});
      console.assert(!bad55.validPhone, 'BR com 55 deve ser erro.');
      const badIntl=validateInvite({phone:'+55 41 999999999',name:'Fabio',acomp:[]});
      console.assert(!badIntl.validPhone, '+55 não deve ser aceito.');

      // 8 dígitos adiciona 9
      const add9=validateInvite({phone:'4198765432',name:'Cel',acomp:[]});
      console.assert(add9.validPhone && /^41\d{9}$/.test(add9.phone), 'Celular de 8 dígitos deve ganhar 9.');

      // Cálculo de totais
      const list=[
        validateInvite({phone:'41999999999',name:'A',acomp:['B'],qty:0,status:'resp',confirmed:2}),
        validateInvite({phone:'+1 415 555 0000',name:'C',acomp:[],qty:1,status:'env',confirmed:0})
      ];
      console.assert(sumGuests(list)===3, 'Total de convidados deve ser 3.');
      console.assert(sumConfirmed(list)===2, 'Confirmados devem somar 2.');

      // Nome base e sanitização
      const base=arquivoBase();
      console.assert(/Doc-/.test(base), 'Nome base deve conter Doc-');
      const fn=sanitizeFilename('Meu Evento: *PDF* teste?.json');
      console.assert(!/\*/.test(fn) && fn.endsWith('.json'), 'sanitizeFilename deve limpar caracteres e manter extensão .json');

      // Lock de cotação
      setLock(1); console.assert(getLockRemaining()<=1 && getLockRemaining()>=0, 'Lock deve registrar tempo restante.');
    })();
  }

  if(document.readyState!=='loading') init(); else document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
