<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MiniApp Painel do Usu√°rio</title>
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#E9C182" />
    <link rel="apple-touch-icon" href="../icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="icon" type="image/png" sizes="192x192" href="../icons/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="../icons/icon-512.png" />
    <link rel="stylesheet" href="./panel.css" />
  </head>
  <body>
    <div class="dashboard dashboard--user" data-panel-root data-state="loading">
      <header class="dashboard__header">
        <div class="dashboard__intro">
          <p class="dashboard__eyebrow">Centro de prefer√™ncias</p>
          <h1 class="dashboard__title">Painel do usu√°rio</h1>
          <p class="dashboard__lead">
            Gerencie seus dados pessoais, controle notifica√ß√µes e mantenha a seguran√ßa das integra√ß√µes conectadas ao
            shell base.
          </p>
        </div>
        <dl class="dashboard__meta" data-panel-meta>
          <div>
            <dt>Atualiza√ß√£o de perfil</dt>
            <dd data-profile-updated>‚Äî</dd>
          </div>
          <div>
            <dt>√öltima sincroniza√ß√£o</dt>
            <dd data-preferences-updated>‚Äî</dd>
          </div>
          <div>
            <dt>Dispositivos confi√°veis</dt>
            <dd data-meta-devices>‚Äî</dd>
          </div>
        </dl>
      </header>
      <section class="dashboard__empty" data-empty-state hidden>
        <h2>Fa√ßa login para continuar</h2>
        <p>
          Conecte-se ao shell para atualizar suas informa√ß√µes, salvar prefer√™ncias personalizadas e liberar o acesso a
          integra√ß√µes exclusivas.
        </p>
        <button type="button" class="button button--primary" data-action="open-login">Acessar autentica√ß√£o</button>
      </section>
      <main class="dashboard__content" data-authenticated-content hidden>
        <div class="dashboard__layout">
          <section class="card card--profile" aria-labelledby="profile-settings-title">
            <header class="card__header">
              <div>
                <h2 id="profile-settings-title" class="card__title">Dados pessoais</h2>
                <p class="card__subtitle">
                  Atualize as informa√ß√µes exibidas para a equipe e para aplica√ß√µes que consomem o cat√°logo de miniapps.
                </p>
              </div>
              <span class="badge" data-profile-badge>Perfil ativo</span>
            </header>
            <form class="form" data-profile-form novalidate>
              <div class="form__grid">
                <div class="form__field">
                  <label for="profile-name">Nome completo</label>
                  <input id="profile-name" name="name" type="text" autocomplete="name" required />
                </div>
                <div class="form__field">
                  <label for="profile-email">E-mail</label>
                  <input id="profile-email" name="email" type="email" autocomplete="email" required />
                </div>
                <div class="form__field">
                  <label for="profile-phone">Celular</label>
                  <input id="profile-phone" name="phone" type="tel" autocomplete="tel" />
                </div>
                <div class="form__field">
                  <label for="profile-role">Papel no workspace</label>
                  <select id="profile-role" name="role">
                    <option value="owner">Propriet√°rio</option>
                    <option value="member">Colaborador</option>
                  </select>
                </div>
                <div class="form__field">
                  <label for="profile-job">Cargo</label>
                  <input id="profile-job" name="jobTitle" type="text" placeholder="Ex.: Product Manager" />
                </div>
                <div class="form__field">
                  <label for="profile-department">Equipe</label>
                  <input id="profile-department" name="department" type="text" placeholder="Ex.: Opera√ß√µes" />
                </div>
                <div class="form__field">
                  <label for="profile-workspace">Espa√ßo de trabalho</label>
                  <input id="profile-workspace" name="workspace" type="text" placeholder="Ex.: Portal 5Horas" />
                </div>
              </div>
              <div class="form__actions">
                <button type="submit" class="button button--primary">Salvar altera√ß√µes</button>
                <button type="reset" class="button button--ghost">Descartar</button>
              </div>
              <p class="form__feedback" role="status" aria-live="polite" data-profile-feedback></p>
            </form>
          </section>
          <aside class="card card--summary" aria-labelledby="profile-summary-title">
            <header class="card__header">
              <div>
                <h2 id="profile-summary-title" class="card__title">Resumo da conta</h2>
                <p class="card__subtitle">Visualize o impacto das configura√ß√µes em toda a experi√™ncia do shell.</p>
              </div>
            </header>
            <div class="summary-identity">
              <div class="summary-avatar" aria-hidden="true" data-summary-avatar>üë§</div>
              <div>
                <p class="summary-role" data-summary-role>‚Äî</p>
                <h3 class="summary-name" data-summary-name>‚Äî</h3>
                <p class="summary-email" data-summary-email>‚Äî</p>
              </div>
            </div>
            <dl class="summary-details">
              <div>
                <dt>Cargo</dt>
                <dd data-summary-job>‚Äî</dd>
              </div>
              <div>
                <dt>Equipe</dt>
                <dd data-summary-department>‚Äî</dd>
              </div>
              <div>
                <dt>Espa√ßo de trabalho</dt>
                <dd data-summary-workspace>‚Äî</dd>
              </div>
            </dl>
            <dl class="summary-metrics">
              <div>
                <dt>Notifica√ß√µes</dt>
                <dd data-summary-notifications>‚Äî</dd>
              </div>
              <div>
                <dt>Automa√ß√£o</dt>
                <dd data-summary-automation>‚Äî</dd>
              </div>
              <div>
                <dt>Dispositivos</dt>
                <dd data-summary-devices>‚Äî</dd>
              </div>
            </dl>
            <div class="summary-list" data-summary-notifications-list>
              <p class="summary-empty">Nenhum canal de notifica√ß√£o habilitado.</p>
            </div>
          </aside>
          <section class="card card--preferences" aria-labelledby="preference-settings-title">
            <header class="card__header">
              <div>
                <h2 id="preference-settings-title" class="card__title">Prefer√™ncias de uso</h2>
                <p class="card__subtitle">Defina idioma, tema e alertas entregues pelo shell em todos os dispositivos.</p>
              </div>
            </header>
            <form class="form" data-preferences-form novalidate>
              <fieldset class="form__fieldset">
                <legend>Experi√™ncia</legend>
                <div class="form__grid form__grid--columns-3">
                  <div class="form__field">
                    <label for="pref-theme">Tema</label>
                    <select id="pref-theme" name="theme">
                      <option value="system">Seguir sistema</option>
                      <option value="light">Claro</option>
                      <option value="dark">Escuro</option>
                    </select>
                  </div>
                  <div class="form__field">
                    <label for="pref-language">Idioma</label>
                    <select id="pref-language" name="language">
                      <option value="auto">Detectar automaticamente</option>
                      <option value="pt-BR">Portugu√™s (Brasil)</option>
                      <option value="en-US">English (US)</option>
                      <option value="es-419">Espa√±ol (LatAm)</option>
                    </select>
                  </div>
                  <div class="form__field">
                    <label for="pref-timezone">Fuso hor√°rio</label>
                    <select id="pref-timezone" name="timezone">
                      <option value="America/Sao_Paulo">Am√©rica/S√£o Paulo (GMT-3)</option>
                      <option value="America/New_York">Am√©rica/Nova York (GMT-4)</option>
                      <option value="Europe/Lisbon">Europa/Lisboa (GMT+1)</option>
                      <option value="UTC">UTC</option>
                    </select>
                  </div>
                </div>
              </fieldset>
              <fieldset class="form__fieldset">
                <legend>Notifica√ß√µes</legend>
                <div class="switch-list">
                  <label class="switch" for="pref-notify-updates">
                    <input id="pref-notify-updates" name="notifyUpdates" type="checkbox" />
                    <span class="switch__visual" aria-hidden="true"></span>
                    <span class="switch__label">Novidades de produto e roadmap</span>
                  </label>
                  <label class="switch" for="pref-notify-security">
                    <input id="pref-notify-security" name="notifySecurity" type="checkbox" />
                    <span class="switch__visual" aria-hidden="true"></span>
                    <span class="switch__label">Alertas cr√≠ticos de seguran√ßa</span>
                  </label>
                  <label class="switch" for="pref-notify-summary">
                    <input id="pref-notify-summary" name="notifySummary" type="checkbox" />
                    <span class="switch__visual" aria-hidden="true"></span>
                    <span class="switch__label">Resumo semanal por e-mail</span>
                  </label>
                </div>
              </fieldset>
              <fieldset class="form__fieldset">
                <legend>Automa√ß√£o e seguran√ßa</legend>
                <div class="switch-list">
                  <label class="switch" for="pref-auto-sync">
                    <input id="pref-auto-sync" name="autoSync" type="checkbox" />
                    <span class="switch__visual" aria-hidden="true"></span>
                    <span class="switch__label">Sincronizar prefer√™ncias automaticamente entre dispositivos</span>
                  </label>
                  <label class="switch" for="pref-auto-backup">
                    <input id="pref-auto-backup" name="autoBackup" type="checkbox" />
                    <span class="switch__visual" aria-hidden="true"></span>
                    <span class="switch__label">Gerar backup criptografado a cada login</span>
                  </label>
                  <label class="switch" for="pref-beta-program">
                    <input id="pref-beta-program" name="betaProgram" type="checkbox" />
                    <span class="switch__visual" aria-hidden="true"></span>
                    <span class="switch__label">Participar de recursos em vers√£o beta</span>
                  </label>
                </div>
              </fieldset>
              <div class="form__actions">
                <button type="submit" class="button button--primary">Salvar prefer√™ncias</button>
                <button type="reset" class="button button--ghost">Restaurar valores</button>
              </div>
              <p class="form__feedback" role="status" aria-live="polite" data-preferences-feedback></p>
            </form>
          </section>
          <section class="card card--devices" aria-labelledby="devices-title">
            <header class="card__header">
              <div>
                <h2 id="devices-title" class="card__title">Dispositivos conectados</h2>
                <p class="card__subtitle">
                  Revise quais dispositivos t√™m sess√£o ativa e desative aqueles que voc√™ n√£o reconhece.
                </p>
              </div>
            </header>
            <ul class="device-list" data-device-list></ul>
            <p class="form__feedback" role="status" aria-live="polite" data-devices-feedback></p>
          </section>
        </div>
      </main>
      <p class="dashboard__footnote">
        Prefer√™ncias armazenadas localmente. Altera√ß√µes no perfil sincronizam com os demais fluxos do shell base.
      </p>
    </div>
    <script src="../register-sw.js"></script>
    <script type="module">
      import {
        currentUser,
        onAuthChange,
        updateUserProfile
      } from '../../../packages/base.security/auth.js';

      const STORAGE_KEY_PREFIX = 'miniapp.base.user-panel.state';
      const FEEDBACK_TIMEOUT = 4500;
      const loginUrl = new URL('../auth/login.html', import.meta.url);
      const panelRoot = document.querySelector('[data-panel-root]');
      const emptyState = document.querySelector('[data-empty-state]');
      const content = document.querySelector('[data-authenticated-content]');
      const profileForm = document.querySelector('[data-profile-form]');
      const preferencesForm = document.querySelector('[data-preferences-form]');
      const profileFeedback = document.querySelector('[data-profile-feedback]');
      const preferencesFeedback = document.querySelector('[data-preferences-feedback]');
      const devicesFeedback = document.querySelector('[data-devices-feedback]');
      const summaryName = document.querySelector('[data-summary-name]');
      const summaryEmail = document.querySelector('[data-summary-email]');
      const summaryRole = document.querySelector('[data-summary-role]');
      const summaryJob = document.querySelector('[data-summary-job]');
      const summaryDepartment = document.querySelector('[data-summary-department]');
      const summaryWorkspace = document.querySelector('[data-summary-workspace]');
      const summaryNotifications = document.querySelector('[data-summary-notifications]');
      const summaryAutomation = document.querySelector('[data-summary-automation]');
      const summaryDevices = document.querySelector('[data-summary-devices]');
      const summaryList = document.querySelector('[data-summary-notifications-list]');
      const summaryAvatar = document.querySelector('[data-summary-avatar]');
      const profileBadge = document.querySelector('[data-profile-badge]');
      const profileUpdated = document.querySelector('[data-profile-updated]');
      const preferencesUpdated = document.querySelector('[data-preferences-updated]');
      const metaDevices = document.querySelector('[data-meta-devices]');
      const devicesList = document.querySelector('[data-device-list]');
      const loginButton = document.querySelector('[data-action="open-login"]');
      const feedbackTimers = new WeakMap();

      const DEFAULT_DEVICES = [
        {
          id: 'device-mac',
          name: 'MacBook Pro 14‚Äù',
          location: 'S√£o Paulo, Brasil',
          lastActive: '2024-04-28T13:22:00.000Z',
          status: 'trusted'
        },
        {
          id: 'device-iphone',
          name: 'iPhone 15 Pro',
          location: 'Campinas, Brasil',
          lastActive: '2024-04-27T22:45:00.000Z',
          status: 'trusted'
        },
        {
          id: 'device-web',
          name: 'Navegador Web',
          location: 'Lisboa, Portugal',
          lastActive: '2024-04-18T09:12:00.000Z',
          status: 'revoked'
        }
      ];

      function createDefaultState() {
        return {
          profileExtras: {
            jobTitle: '',
            department: '',
            workspace: ''
          },
          preferences: {
            theme: 'system',
            language: 'auto',
            timezone: 'America/Sao_Paulo',
            notifications: {
              productUpdates: true,
              securityAlerts: true,
              weeklySummary: false
            },
            automation: {
              autoSync: true,
              autoBackup: false,
              betaProgram: false
            }
          },
          devices: DEFAULT_DEVICES.map(device => ({ ...device })),
          meta: {
            profileUpdatedAt: null,
            preferencesUpdatedAt: null,
            devicesUpdatedAt: null
          }
        };
      }

      function mergeState(base, extra) {
        const fallback = createDefaultState();
        const target = { ...fallback, ...base };
        if (!extra || typeof extra !== 'object') {
          return target;
        }
        target.profileExtras = {
          ...fallback.profileExtras,
          ...base?.profileExtras,
          ...(extra.profileExtras || {})
        };
        target.preferences = {
          ...fallback.preferences,
          ...base?.preferences,
          ...(extra.preferences || {})
        };
        target.preferences.notifications = {
          ...fallback.preferences.notifications,
          ...base?.preferences?.notifications,
          ...(extra.preferences?.notifications || {})
        };
        target.preferences.automation = {
          ...fallback.preferences.automation,
          ...base?.preferences?.automation,
          ...(extra.preferences?.automation || {})
        };
        if (Array.isArray(extra.devices)) {
          target.devices = extra.devices.map(device => ({ ...device }));
        } else if (Array.isArray(base?.devices)) {
          target.devices = base.devices.map(device => ({ ...device }));
        }
        target.meta = {
          ...fallback.meta,
          ...base?.meta,
          ...(extra.meta || {})
        };
        return target;
      }

      function getStorageKey(userId) {
        return `${STORAGE_KEY_PREFIX}::${userId}`;
      }

      function loadState(userId) {
        const fallback = createDefaultState();
        if (!userId || typeof window === 'undefined') {
          return fallback;
        }
        try {
          const raw = window.localStorage?.getItem(getStorageKey(userId));
          if (!raw) {
            return fallback;
          }
          const parsed = JSON.parse(raw);
          return mergeState(fallback, parsed);
        } catch (error) {
          console.warn('user-panel: unable to load stored preferences', error);
          return fallback;
        }
      }

      function saveState(userId, state) {
        if (!userId || typeof window === 'undefined') {
          return;
        }
        try {
          window.localStorage?.setItem(getStorageKey(userId), JSON.stringify(state));
        } catch (error) {
          console.warn('user-panel: unable to persist preferences', error);
        }
      }

      function formatDateTime(value) {
        if (!value) {
          return 'Nunca sincronizado';
        }
        try {
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) {
            return 'Nunca sincronizado';
          }
          return new Intl.DateTimeFormat('pt-BR', {
            dateStyle: 'short',
            timeStyle: 'short'
          }).format(date);
        } catch (error) {
          return 'Nunca sincronizado';
        }
      }

      function showFeedback(target, message, tone = 'success') {
        if (!target) {
          return;
        }
        target.dataset.state = tone;
        target.textContent = message;
        const previousTimer = feedbackTimers.get(target);
        if (previousTimer) {
          clearTimeout(previousTimer);
        }
        const timer = window.setTimeout(() => {
          target.textContent = '';
          target.dataset.state = '';
        }, FEEDBACK_TIMEOUT);
        feedbackTimers.set(target, timer);
      }

      function clearFeedback(target) {
        if (!target) {
          return;
        }
        const previousTimer = feedbackTimers.get(target);
        if (previousTimer) {
          clearTimeout(previousTimer);
        }
        target.textContent = '';
        target.dataset.state = '';
      }

      function setFormDisabled(form, disabled) {
        if (!form) {
          return;
        }
        const controls = form.querySelectorAll('input, select, button');
        controls.forEach(control => {
          control.disabled = disabled;
        });
      }

      function updateSummary(user, state) {
        if (summaryName) {
          summaryName.textContent = user?.name || 'Usu√°rio sem nome';
        }
        if (summaryEmail) {
          summaryEmail.textContent = user?.email || 'E-mail n√£o cadastrado';
        }
        if (summaryRole) {
          const roleLabel = user?.role === 'owner' ? 'Propriet√°rio' : 'Colaborador';
          summaryRole.textContent = `${roleLabel}${state?.profileExtras?.department ? ' ‚Ä¢ ' + state.profileExtras.department : ''}`;
        }
        if (summaryAvatar) {
          const initial = user?.name ? user.name.trim().charAt(0).toUpperCase() : 'üë§';
          summaryAvatar.textContent = initial || 'üë§';
        }
        if (summaryJob) {
          summaryJob.textContent = state?.profileExtras?.jobTitle || '‚Äî';
        }
        if (summaryDepartment) {
          summaryDepartment.textContent = state?.profileExtras?.department || '‚Äî';
        }
        if (summaryWorkspace) {
          summaryWorkspace.textContent = state?.profileExtras?.workspace || '‚Äî';
        }
        const notifications = state?.preferences?.notifications || {};
        const enabledNotifications = Object.entries(notifications).filter(([, value]) => Boolean(value));
        if (summaryNotifications) {
          summaryNotifications.textContent = `${enabledNotifications.length} de ${Object.keys(notifications).length} ativas`;
        }
        if (summaryList) {
          summaryList.innerHTML = '';
          if (!enabledNotifications.length) {
            const empty = document.createElement('p');
            empty.className = 'summary-empty';
            empty.textContent = 'Nenhum canal de notifica√ß√£o habilitado.';
            summaryList.append(empty);
          } else {
            enabledNotifications.forEach(([key]) => {
              const item = document.createElement('div');
              item.className = 'summary-list-item';
              const label = document.createElement('span');
              const map = {
                productUpdates: 'Novidades de produto',
                securityAlerts: 'Alertas de seguran√ßa',
                weeklySummary: 'Resumo semanal'
              };
              label.textContent = map[key] || key;
              const status = document.createElement('span');
              status.textContent = 'Ativo';
              item.append(label, status);
              summaryList.append(item);
            });
          }
        }
        const automation = state?.preferences?.automation || {};
        const enabledAutomation = Object.entries(automation).filter(([, value]) => Boolean(value));
        if (summaryAutomation) {
          summaryAutomation.textContent = `${enabledAutomation.length} fluxos ativos`;
        }
        const trustedDevices = Array.isArray(state?.devices)
          ? state.devices.filter(device => device.status !== 'revoked').length
          : 0;
        if (summaryDevices) {
          summaryDevices.textContent = `${trustedDevices} confi√°veis`;
        }
        if (profileBadge) {
          profileBadge.textContent = user?.role === 'owner' ? 'Propriet√°rio' : 'Colaborador';
        }
      }

      function updateMeta(state) {
        if (profileUpdated) {
          profileUpdated.textContent = formatDateTime(state?.meta?.profileUpdatedAt);
        }
        if (preferencesUpdated) {
          preferencesUpdated.textContent = formatDateTime(state?.meta?.preferencesUpdatedAt);
        }
        if (metaDevices) {
          const trusted = state?.devices?.filter(device => device.status !== 'revoked').length || 0;
          const revoked = state?.devices?.filter(device => device.status === 'revoked').length || 0;
          metaDevices.textContent = `${trusted} ativos ‚Ä¢ ${revoked} revogados`;
        }
      }

      function renderDevices(state) {
        if (!devicesList) {
          return;
        }
        devicesList.innerHTML = '';
        const devices = Array.isArray(state?.devices) ? state.devices : [];
        if (!devices.length) {
          const empty = document.createElement('li');
          empty.className = 'summary-empty';
          empty.textContent = 'Nenhum dispositivo autorizado.';
          devicesList.append(empty);
          return;
        }
        devices.forEach(device => {
          const item = document.createElement('li');
          item.className = 'device';
          item.dataset.status = device.status || 'trusted';

          const info = document.createElement('div');
          info.className = 'device__info';
          const name = document.createElement('span');
          name.className = 'device__name';
          name.textContent = device.name || 'Dispositivo desconhecido';
          const meta = document.createElement('span');
          meta.className = 'device__meta';
          const lastActiveLabel = formatDateTime(device.lastActive);
          meta.textContent = `${device.location || 'Localiza√ß√£o n√£o informada'} ‚Ä¢ √öltimo acesso ${lastActiveLabel}`;
          info.append(name, meta);

          const actions = document.createElement('div');
          actions.className = 'device__actions';
          const badge = document.createElement('span');
          badge.className = 'device__badge';
          badge.textContent = device.status === 'revoked' ? 'Revogado' : 'Confi√°vel';
          const toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.className = 'button button--ghost';
          toggle.dataset.deviceToggle = 'true';
          toggle.dataset.deviceId = device.id || '';
          toggle.textContent = device.status === 'revoked' ? 'Confiar novamente' : 'Revogar acesso';
          actions.append(badge, toggle);

          item.append(info, actions);
          devicesList.append(item);
        });
      }

      function renderForms(user, state) {
        if (!profileForm || !preferencesForm) {
          return;
        }
        const extras = state?.profileExtras || {};
        const profileValues = {
          name: user?.name || '',
          email: user?.email || '',
          phone: user?.phone || '',
          role: user?.role || 'member',
          jobTitle: extras.jobTitle || '',
          department: extras.department || '',
          workspace: extras.workspace || ''
        };
        Object.entries(profileValues).forEach(([name, value]) => {
          const field = profileForm.querySelector(`[name="${name}"]`);
          if (field) {
            field.value = value;
          }
        });
        const prefs = state?.preferences || {};
        const notify = prefs.notifications || {};
        const automation = prefs.automation || {};
        const preferenceValues = {
          theme: prefs.theme || 'system',
          language: prefs.language || 'auto',
          timezone: prefs.timezone || 'America/Sao_Paulo',
          notifyUpdates: Boolean(notify.productUpdates),
          notifySecurity: Boolean(notify.securityAlerts),
          notifySummary: Boolean(notify.weeklySummary),
          autoSync: Boolean(automation.autoSync),
          autoBackup: Boolean(automation.autoBackup),
          betaProgram: Boolean(automation.betaProgram)
        };
        Object.entries(preferenceValues).forEach(([name, value]) => {
          const field = preferencesForm.querySelector(`[name="${name}"]`);
          if (!field) {
            return;
          }
          if (field instanceof HTMLInputElement && field.type === 'checkbox') {
            field.checked = Boolean(value);
          } else {
            field.value = value;
          }
        });
      }

      let activeUser = currentUser();
      let state = loadState(activeUser?.id);

      function applyState() {
        const signedIn = Boolean(activeUser);
        panelRoot?.setAttribute('data-state', signedIn ? 'ready' : 'signed-out');
        if (emptyState) {
          emptyState.hidden = signedIn;
        }
        if (content) {
          content.hidden = !signedIn;
        }
        setFormDisabled(profileForm, !signedIn);
        setFormDisabled(preferencesForm, !signedIn);
        if (!signedIn) {
          return;
        }
        renderForms(activeUser, state);
        updateSummary(activeUser, state);
        updateMeta(state);
        renderDevices(state);
      }

      function handleProfileSubmit(event) {
        event.preventDefault();
        if (!activeUser) {
          showFeedback(profileFeedback, 'Fa√ßa login para editar o perfil.', 'error');
          return;
        }
        const formData = new FormData(profileForm);
        const nextState = {
          name: String(formData.get('name') || '').trim(),
          email: String(formData.get('email') || '').trim(),
          phone: String(formData.get('phone') || '').trim(),
          role: String(formData.get('role') || 'member')
        };
        try {
          const updated = updateUserProfile(activeUser.id, nextState);
          state.profileExtras = {
            jobTitle: String(formData.get('jobTitle') || '').trim(),
            department: String(formData.get('department') || '').trim(),
            workspace: String(formData.get('workspace') || '').trim()
          };
          state.meta.profileUpdatedAt = new Date().toISOString();
          activeUser = updated;
          saveState(activeUser.id, state);
          applyState();
          showFeedback(profileFeedback, 'Perfil atualizado com sucesso.');
        } catch (error) {
          let message = 'N√£o foi poss√≠vel atualizar os dados agora.';
          if (error instanceof Error) {
            if (error.message === 'auth:user-exists') {
              message = 'J√° existe um usu√°rio com este e-mail.';
            } else if (error.message === 'auth:owner-required') {
              message = 'Mantenha ao menos um propriet√°rio ativo no workspace.';
            }
          }
          showFeedback(profileFeedback, message, 'error');
        }
      }

      function handlePreferencesSubmit(event) {
        event.preventDefault();
        if (!activeUser) {
          showFeedback(preferencesFeedback, 'Fa√ßa login para salvar prefer√™ncias.', 'error');
          return;
        }
        const formData = new FormData(preferencesForm);
        state.preferences = {
          theme: String(formData.get('theme') || 'system'),
          language: String(formData.get('language') || 'auto'),
          timezone: String(formData.get('timezone') || 'America/Sao_Paulo'),
          notifications: {
            productUpdates: formData.get('notifyUpdates') === 'on',
            securityAlerts: formData.get('notifySecurity') === 'on',
            weeklySummary: formData.get('notifySummary') === 'on'
          },
          automation: {
            autoSync: formData.get('autoSync') === 'on',
            autoBackup: formData.get('autoBackup') === 'on',
            betaProgram: formData.get('betaProgram') === 'on'
          }
        };
        state.meta.preferencesUpdatedAt = new Date().toISOString();
        saveState(activeUser.id, state);
        applyState();
        showFeedback(preferencesFeedback, 'Prefer√™ncias salvas com sucesso.');
      }

      function handleDeviceToggle(deviceId) {
        if (!activeUser) {
          showFeedback(devicesFeedback, 'Fa√ßa login para gerenciar dispositivos.', 'error');
          return;
        }
        const devices = Array.isArray(state.devices) ? state.devices : [];
        const index = devices.findIndex(device => device.id === deviceId);
        if (index === -1) {
          return;
        }
        const current = devices[index];
        const nextStatus = current.status === 'revoked' ? 'trusted' : 'revoked';
        devices[index] = {
          ...current,
          status: nextStatus,
          lastActive: nextStatus === 'trusted' ? new Date().toISOString() : current.lastActive
        };
        state.devices = devices;
        state.meta.devicesUpdatedAt = new Date().toISOString();
        saveState(activeUser.id, state);
        applyState();
        const message =
          nextStatus === 'trusted'
            ? 'Dispositivo reativado com sucesso.'
            : 'Sess√£o revogada. O dispositivo precisar√° fazer login novamente.';
        showFeedback(devicesFeedback, message);
      }

      if (profileForm) {
        profileForm.addEventListener('submit', handleProfileSubmit);
        profileForm.addEventListener('reset', event => {
          if (event.isTrusted) {
            window.setTimeout(applyState, 0);
            clearFeedback(profileFeedback);
          }
        });
      }

      if (preferencesForm) {
        preferencesForm.addEventListener('submit', handlePreferencesSubmit);
        preferencesForm.addEventListener('reset', event => {
          if (event.isTrusted) {
            window.setTimeout(applyState, 0);
            clearFeedback(preferencesFeedback);
          }
        });
      }

      if (devicesList) {
        devicesList.addEventListener('click', event => {
          const toggle = event.target.closest('[data-device-toggle]');
          if (!toggle) {
            return;
          }
          event.preventDefault();
          handleDeviceToggle(toggle.dataset.deviceId || '');
        });
      }

      if (loginButton) {
        loginButton.addEventListener('click', () => {
          try {
            if (window.top) {
              window.top.location.href = loginUrl.href;
              return;
            }
          } catch (error) {
            console.warn('user-panel: unable to open login on top window', error);
          }
          window.location.href = loginUrl.href;
        });
      }

      function syncUser(user) {
        activeUser = user;
        state = loadState(user?.id);
        applyState();
      }

      onAuthChange(syncUser);
      syncUser(activeUser);
      console.info('user-panel: painel do usu√°rio aberto', { timestamp: new Date().toISOString() });
    </script>
  </body>
</html>
